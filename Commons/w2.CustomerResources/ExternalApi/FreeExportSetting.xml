<?xml version="1.0" encoding="utf-8"?>

<!--
=========================================================================================================
  Module      : 外部連携APIバッチ FreeExport設定XML(FreeExportSetting.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2019 All Rights Reserved.
=========================================================================================================
-->
<Root>

  <!-- ☆サンプル:注文情報 -->
  <!-- ◇ 実行設定 CommandKey:ExternalApiバッチ実行時のコマンドラインキー -->
  <!-- デバックモード
        ・ExecModeType:
           production:本番：FTP連携がONの場合は外部に出力 更新用のクエリが存在する場合は更新を実行
           debug:デバック：FTP連携がONの場合での外部出力されない 更新用のクエリが存在する場合でも更新が実行されない
           debug_exportOn_updateOff:デバック_出力ON_更新OFF：FTP連携がONの場合は外部に出力 更新用のクエリが存在する場合でも更新が実行されない
           debug_exportOff_updateOn:デバック_出力OFF_更新ON ：FTP連携がONの場合での外部出力されない 更新用のクエリが存在する場合は更新を実行
         ※ デフォルトはdebug指定となります。
      -->
  <ExportSetting CommandKey="order" ExecModeType="debug">
    <!-- ■ FTP連携設定
    ・Use:利用有無
    ・IsActiveMode:アクティブモードか
    ・EnableSsl:SSL利用か
    -->
    <FtpSetting Use="false" IsActiveMode="true" EnableSsl="false">
      <!-- ホスト名 -->
      <Host><![CDATA[]]></Host>
      <!-- ID -->
      <Id><![CDATA[]]></Id>
      <!-- Password -->
      <Password><![CDATA[]]></Password>
      <!-- 出力先ディレクトリ -->
      <ExportDir><![CDATA[\dir]]></ExportDir>
    </FtpSetting>

    <!-- ■ 出力ファイル設定 -->
    <FileSetting>
      <!-- 外部連携を実施しない場合の出力先 -->
      <ExportDir><![CDATA[]]></ExportDir>
      <!-- 出力ファイル名
        ・Type:
           string:文字列
           dateString:日付 nowの場合は現在時刻 Formatにて形式を指定
      -->
      <FileName>
        <Value Type="string">order_</Value>
        <Value Type="dateString" Format="yyyyMMddHHmmss">now</Value>
      </FileName>
      <!-- 出力ファイルの拡張子 -->
      <Extension>csv</Extension>
      <!-- 区切り文字
        ・Type:
           input:入力内容を区切り文字とする
           tab:タブ記号を区切り文字とする
      -->
      <Separator Type="input"><![CDATA[,]]></Separator>
      <!-- ヘッダ行出力有無 -->
      <HeaderExport>true</HeaderExport>
      <!-- 列の引用符
        ※ 出力フィールド毎に付ける付けない、空欄の場合は不要などの場合は<Fields>タグ内に直接記載してください。
      -->
      <QuotationMark><![CDATA["]]></QuotationMark>
      <!-- エスケープ対象の文字
           指定した文字がカラムに含まれていた場合、エスケープ処理を行います。
      -->
      <EscapeTarget>
        <Value><![CDATA["]]></Value>
        <Value><![CDATA[,]]></Value>
        <Value><![CDATA[/r/n]]></Value>
      </EscapeTarget>
      <!-- 文字コード Encoding.GetEncoding(【文字コード】)にて指定できる形式で記載してください。
        ※ UTF-8 BOMなしを指定する場合は、utf-8nを記載してください -->
      <Encoding>shift_jis</Encoding>
      <!-- アップロードタイプ
        overWrite 上書き許可
        append 上書き禁止(デフォルト)
        skip アップロード先に同一ファイルが存在する場合にアップロードをスキップ
      -->
      <UploadType>append</UploadType>
    </FileSetting>

    <!-- ■ 抽出設定 -->
    <SearchSetting>
      <!-- 抽出用SQLクエリ
      ・ExecTimeOut 実行タイムアウト時間(秒) デフォルト60
      ・内容 抽出用SQL @@ fields @@は<Fields>タグの設定で置換されます。
      -->
      <ExportSql ExecTimeOut="120">
        <Sql>
          <![CDATA[
            /* ダーティリードを許可して共有ロックを掛けなくする */
            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
            
            SELECT  order_id
              INTO  #FreeExportTempTable
              FROM  w2_Order
             WHERE  date_created <= DATEADD(MINUTE, 1, GETDATE())
               AND  date_created >= DATEADD(DAY, -1, GETDATE())
          ORDER BY  date_created DESC
          
            SELECT  @@ fields @@
              FROM  #FreeExportTempTable
                    INNER JOIN w2_Order ON
                    (
                      w2_Order.order_id = #FreeExportTempTable.order_id
                    )
                    INNER JOIN w2_OrderOwner ON
                    (
                      w2_Order.order_id = w2_OrderOwner.order_id
                    )
                    INNER JOIN w2_OrderShipping ON
                    (
                      w2_Order.order_id = w2_OrderShipping.order_id
                    )
                    LEFT JOIN w2_OrderCoupon ON
                    (
                      w2_Order.order_id = w2_OrderCoupon.order_id
                    )
                    LEFT JOIN w2_Payment ON
                    (
                      w2_Order.shop_id = w2_Payment.shop_id
                      AND
                      w2_Order.order_payment_kbn = w2_Payment.payment_id
                    )
                    LEFT JOIN w2_ShopShipping ON
                    (
                      w2_Order.shop_id = w2_ShopShipping.shop_id
                      AND
                      w2_Order.shipping_id = w2_ShopShipping.shipping_id
                    )
                    INNER JOIN w2_User ON
                    (
                      w2_Order.user_id = w2_User.user_id
                    )
                    LEFT JOIN w2_FixedPurchase ON
                    (
                      w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                    )
         ]]>
        </Sql>
      </ExportSql>

      <!-- DB更新用SQLクエリ
      ・ExecTimeOut 実行タイムアウト時間 デフォルト60
      ・ExecUnit 1回での更新実行単位 デフォルト10件
      ・HistoryType 更新履歴の追加 未設定の場合は履歴の追加なし
          order:注文情報 ※ <Field UpdateSqlKey="order_id">タグを必須で追加してください。
          fixedPurchase:定期台帳 ※ <Field UpdateSqlKey="fixed_purchase_id">タグを必須で追加してください。
          user:ユーザ情報  ※ <Field UpdateSqlKey="user_id">タグを必須で追加してください。
      ・内容 更新用SQL ※ @@ UpdateSqlKey @@は<Field UpdateSqlKey>タグのUpdateSqlKeyに設定したキーを対象に置換されます。
      -->
      <!--
      <UpdateSql ExecTimeOut="120" ExecUnit="10">
        <HistoryType>order</HistoryType>
        <Sql>
          <![CDATA[
            UPDATE  w2_Order
               SET  extend_status1 = '0',
                    date_changed = GETDATE(),
                    last_changed = 'batch'
             WHERE  order_id = '@@ order_ida @@';
          ]]>
        </Sql>
      </UpdateSql>
      -->

      <!-- 出力カラム -->
      <Fields>
        <!-- UpdateSqlタグ更新キー用フィールド
        ・UpdateSqlKey:UpdateSqlタグ内置換キー
        ・ExportFlg:連携ファイルに出力するか デフォルトtrue
        ・内容 取得用SQL
        -->
        <Field UpdateSqlKey="order_id" ExportFlg="false">
          <Value>
            <![CDATA[
              w2_Order.order_id
              ]]>
          </Value>
        </Field>

        <!-- 例：空項目を出力します -->
        <Field HeaderName="空項目">
          <Value>
            <![CDATA[
             ''
              ]]>
          </Value>
        </Field>

        <!-- 例：固定文字列（”サンプル固定値出力”）を出力します -->
        <Field HeaderName="サンプル固定値出力">
          <Value>
            <![CDATA[
            'サンプル固定値出力'
            ]]>
          </Value>
        </Field>

        <!-- 例：マスタ項目（注文ID）の値を出力します -->
        <Field HeaderName="注文ID">
          <Value>
            <![CDATA[
              w2_Order.order_id
              ]]>
          </Value>
        </Field>

        <!-- 例：金額出力 後ろから4文字削除 .000 を削除 -->
        <Field HeaderName="金額">
          <Value>
            <![CDATA[
              LEFT(CAST(order_price_subtotal AS nvarchar), LEN(CAST(order_price_subtotal AS nvarchar)) - 4)
              ]]>
          </Value>
        </Field>

        <!--例： 金額出力 後ろから4文字削除 .000 を削除 それから円を追加 -->
        <Field HeaderName="金額(円あり)">
          <Value>
            <![CDATA[
              LEFT(CAST(order_price_subtotal AS nvarchar), LEN(CAST(order_price_subtotal AS nvarchar)) - 4) + '円'
              ]]>
          </Value>
        </Field>

        <!-- 例：フォーマットを指定して現在の時間を出力します -->
        <Field HeaderName="現在時刻">
          <Value>
            <![CDATA[
             CONVERT(nvarchar(30), DATEADD(DAY, -1, GETDATE()), 121)
              ]]>
          </Value>
        </Field>

        <!-- 例：フォーマットを指定してマスタ項目（注文日時）の値を出力します -->
        <Field HeaderName="注文日時">
          <Value>
            <![CDATA[
             CONVERT(nvarchar(30), w2_Order.order_date, 121)
              ]]>
          </Value>
        </Field>

        <!-- 例：SQLで対応していないフォーマット"yyyy年mm月dd日 hh:mi:ss"でマスタ項目（注文日時）の値を出力します -->
        <Field HeaderName="自由設定日付フォーマット">
          <Value>
            <![CDATA[
              CONVERT(nvarchar(4), DATEPART(YEAR, w2_Order.order_date)) +
              '年' +
              CONVERT(nvarchar(2), DATEPART(MONTH, w2_Order.order_date)) +
              '月'+
              CONVERT(nvarchar(2), DATEPART(DAY, w2_Order.order_date)) +
              '日 ' +
              CONVERT(nvarchar(8), w2_Order.order_date, 108)
              ]]>
          </Value>
        </Field>

        <!-- 例：固定値"01"、マスタ項目（注文ID）、固定値"03"を結合した値を出力します -->
        <Field HeaderName="固定文字連結">
          <Value>
            <![CDATA[
              '10' + w2_Order.order_id + '03'
              ]]>
          </Value>
        </Field>

        <!-- 例：6文字目から3文字を出力します（"1234567890"→"678"を出力） -->
        <Field HeaderName="6文字目から3文字">
          <Value>
            <![CDATA[
            SUBSTRING('1234567890', 6, 3)
              ]]>
          </Value>
        </Field>

        <!-- 例：左側から3文字を出力します（"1234567890"→"123"を出力） -->
        <Field HeaderName="左側から3文字">
          <Value>
            <![CDATA[
            LEFT('1234567890', 3)
              ]]>
          </Value>
        </Field>

        <!-- 例：右側から3文字を出力します（"1234567890"→"890"を出力） -->
        <Field HeaderName="右側から3文字">
          <Value>
            <![CDATA[
            RIGHT('1234567890', 3)
              ]]>
          </Value>
        </Field>

        <!-- 例：マスタ項目（配送先の住所１～４）の値を結合して、21文字目～40文字目を取得して出力します -->
        <Field HeaderName="配送先の住所 21文字目～40文字目">
          <Value>
            <![CDATA[
            SUBSTRING(w2_OrderShipping.shipping_addr1 + w2_OrderShipping.shipping_addr2 + w2_OrderShipping.shipping_addr3 + w2_OrderShipping.shipping_addr4, 21, 20)
              ]]>
          </Value>
        </Field>

        <!-- 例：分岐で決済区分によって出力値を切り替えて出力します -->
        <!-- 
          決済区分は'K10'の場合、固定値"クレジット"を出力します
          決済区分は'K20'の場合、固定値"代金引換"を出力します
          それ以外は固定値"その他"
          -->
        <Field HeaderName="決済区分で出し分け">
          <Value>
            <![CDATA[
            CASE
              WHEN w2_Order.order_payment_kbn = 'K10' THEN 'クレジット'
              WHEN w2_Order.order_payment_kbn = 'K20' THEN '代引き'
              ELSE 'その他'
            END
              ]]>
          </Value>
        </Field>

        <!-- 例：マスタ項目（注文のメモ）にある改行コードを半角スペースに置換したものを出力します -->
        <Field HeaderName="置換例１">
          <Value>
            <![CDATA[
            REPLACE(REPLACE(w2_Order.memo, CHAR(13) + CHAR(10), ' '), CHAR(13), ' ')
              ]]>
          </Value>
        </Field>

        <!-- 例：マスタ項目（注文者の電話番号）にあるハイフンを空に置換したものを出力します -->
        <Field HeaderName="置換例２">
          <Value>
            <![CDATA[
            REPLACE(w2_OrderOwner.owner_tel1, '-', '')
              ]]>
          </Value>
        </Field>

        <!-- 例：文字列の部分文字列をバイト長で指定した範囲で出力します（"1234567890あいうえおかきくけこ" → "かきくけ"） -->
        <Field HeaderName="バイト長切り出し" StartBytePosition="21" ByteLength="9">
          <Value>
            <![CDATA[
            '1234567890あいうえおかきくけこ'
              ]]>
          </Value>
        </Field>

        <!-- 例：文字の種類を変換して出力します（"12345あいうえお" → "１２３４５あいうえお"） -->
        <!-- ConvertString属性の設定可能値：
         ・全角への変換: ToZenkaku
         ・全角カタカナへ変換： ToZenkakuKatakana
         ・全角ひらがなへ変換： ToZenkakuHiragana
         ・半角へ変換： ToHankaku
         ・半角カタカナへ変換： ToHankakuKatakana
         -->
        <Field HeaderName="文字列変換" ConvertString="ToZenkaku">
          <Value>
            <![CDATA[
            '12345あいうえお'
              ]]>
          </Value>
        </Field>
      </Fields>
    </SearchSetting>
  </ExportSetting>

  <!-- ☆サンプル:在庫情報 -->
  <ExportSetting CommandKey="stockNow" ExecModeType="debug">
    <FtpSetting Use="false" IsActiveMode="true" EnableSsl="false">
      <Host><![CDATA[]]></Host>
      <Id><![CDATA[]]></Id>
      <Password><![CDATA[]]></Password>
      <ExportDir><![CDATA[\dir]]></ExportDir>
    </FtpSetting>

    <FileSetting>
      <ExportDir><![CDATA[]]></ExportDir>
      <FileName>
        <Value Type="string">stockNow_</Value>
        <Value Type="dateString" Format="yyyyMMddHHmmss">now</Value>
      </FileName>
      <Extension>csv</Extension>
      <Separator Type="input"><![CDATA[,]]></Separator>
      <HeaderExport>true</HeaderExport>
      <QuotationMark><![CDATA["]]></QuotationMark>
      <Encoding>shift_jis</Encoding>
    </FileSetting>

    <SearchSetting>
      <ExportSql ExecTimeOut="120">
        <Sql>
          <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  product_id,
                variation_id
          INTO  #FreeExportTempTable
          FROM  w2_ProductStock
      ORDER BY  date_created DESC
      
        SELECT  @@ fields @@
          FROM  #FreeExportTempTable
                INNER JOIN w2_ProductStock ON
                (
                  w2_ProductStock.product_id = #FreeExportTempTable.product_id
                  AND
                  w2_ProductStock.variation_id = #FreeExportTempTable.variation_id
                )
        ]]>
        </Sql>
      </ExportSql>
      <Fields>
        <Field HeaderName="商品ID">
          <Value>
            <![CDATA[
            w2_ProductStock.product_id
              ]]>
          </Value>
        </Field>
        <Field HeaderName="商品バリエーションID">
          <Value>
            <![CDATA[
            w2_ProductStock.variation_id
              ]]>
          </Value>
        </Field>
        <Field HeaderName="在庫数">
          <Value>
            <![CDATA[
            w2_ProductStock.stock
              ]]>
          </Value>
        </Field>
      </Fields>
    </SearchSetting>
  </ExportSetting>

  <!-- ☆サンプル:在庫増減 -->
  <ExportSetting CommandKey="stockFrom" ExecModeType="debug">
    <FtpSetting Use="false" IsActiveMode="true" EnableSsl="false">
      <Host><![CDATA[]]></Host>
      <Id><![CDATA[]]></Id>
      <Password><![CDATA[]]></Password>
      <ExportDir><![CDATA[\dir]]></ExportDir>
    </FtpSetting>

    <FileSetting>
      <ExportDir><![CDATA[]]></ExportDir>
      <FileName>
        <Value Type="string">stockFrom_</Value>
        <Value Type="dateString" Format="yyyyMMddHHmmss">now</Value>
      </FileName>
      <Extension>csv</Extension>
      <Separator Type="input"><![CDATA[,]]></Separator>
      <HeaderExport>true</HeaderExport>
      <QuotationMark><![CDATA["]]></QuotationMark>
      <Encoding>shift_jis</Encoding>
      <UploadType>append</UploadType>
    </FileSetting>

    <SearchSetting>
      <ExportSql ExecTimeOut="120">
        <Sql>
          <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  history_no,
                product_id,
                variation_id
          INTO  #FreeExportTempTable
          FROM  w2_ProductStockHistory
         WHERE  date_created <= DATEADD(MINUTE, 1, GETDATE())
           AND  date_created >= DATEADD(DAY, -1, GETDATE())
      ORDER BY  date_created DESC
      
        SELECT  @@ fields @@
          FROM  #FreeExportTempTable
                INNER JOIN w2_ProductStockHistory ON
                (
                  w2_ProductStockHistory.history_no = #FreeExportTempTable.history_no
                  AND
                  w2_ProductStockHistory.product_id = #FreeExportTempTable.product_id
                  AND
                  w2_ProductStockHistory.variation_id = #FreeExportTempTable.variation_id
                ) 
        ]]>
        </Sql>
      </ExportSql>

      <Fields>
        <Field HeaderName="在庫履歴ID">
          <Value>
            <![CDATA[
            w2_ProductStockHistory.history_no
              ]]>
          </Value>
        </Field>
        <Field HeaderName="商品ID">
          <Value>
            <![CDATA[
            w2_ProductStockHistory.product_id
              ]]>
          </Value>
        </Field>
        <Field HeaderName="商品バリエーションID">
          <Value>
            <![CDATA[
            w2_ProductStockHistory.variation_id
              ]]>
          </Value>
        </Field>
        <Field HeaderName="アクションステータス">
          <Value>
            <![CDATA[
            w2_ProductStockHistory.action_status
              ]]>
          </Value>
        </Field>
        <Field HeaderName="在庫変更数">
          <Value>
            <![CDATA[
            w2_ProductStockHistory.add_stock
              ]]>
          </Value>
        </Field>
      </Fields>
    </SearchSetting>
  </ExportSetting>

  <!-- ☆サンプル:対象のユーザ拡張ステータスを更新 -->
  <ExportSetting CommandKey="user" ExecModeType="debug">
    <FtpSetting Use="false" IsActiveMode="true" EnableSsl="false">
      <Host><![CDATA[]]></Host>
      <Id><![CDATA[]]></Id>
      <Password><![CDATA[]]></Password>
      <ExportDir><![CDATA[\dir]]></ExportDir>
    </FtpSetting>

    <FileSetting>
      <ExportDir><![CDATA[]]></ExportDir>
      <FileName>
        <Value Type="string">user_</Value>
        <Value Type="dateString" Format="yyyyMMddHHmmss">now</Value>
      </FileName>
      <Extension>csv</Extension>
      <Separator Type="input"><![CDATA[,]]></Separator>
      <HeaderExport>true</HeaderExport>
      <QuotationMark><![CDATA["]]></QuotationMark>
      <Encoding>shift_jis</Encoding>
      <UploadType>append</UploadType>
    </FileSetting>

    <SearchSetting>
      <ExportSql ExecTimeOut="120">
        <Sql>
          <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  user_id
          INTO  #FreeExportTempTable
          FROM  w2_User
         WHERE  user_id = '【対象ユーザ】'
      
        SELECT  @@ fields @@
          FROM  #FreeExportTempTable
                INNER JOIN w2_User ON
                (
                  w2_User.user_id = #FreeExportTempTable.user_id
                )
        ]]>
        </Sql>
      </ExportSql>

      <!--
      <UpdateSql ExecTimeOut="120" ExecUnit="10">
        <HistoryType>user</HistoryType>
        <Sql>
          <![CDATA[
          UPDATE  w2_UserExtend
             SET  usrex_age = '4',
                  date_changed = GETDATE(),
                  last_changed = 'batch'
           WHERE  user_id = '@@ user_id @@';
          ]]>
        </Sql>
      </UpdateSql>
      -->

      <Fields>
        <Field UpdateSqlKey="user_id" ExportFlg="false">
          <Value>
            <![CDATA[
            w2_User.user_id
              ]]>
          </Value>
        </Field>

        <Field HeaderName="ユーザID">
          <Value>
            <![CDATA[
            w2_User.user_id
              ]]>
          </Value>
        </Field>
      </Fields>
    </SearchSetting>
  </ExportSetting>

  <!-- ☆サンプル:対象の拡張ステータスを更新 -->
  <ExportSetting CommandKey="fixedPurchase" ExecModeType="debug">
    <FtpSetting Use="false" IsActiveMode="true" EnableSsl="false">
      <Host><![CDATA[]]></Host>
      <Id><![CDATA[]]></Id>
      <Password><![CDATA[]]></Password>
      <ExportDir><![CDATA[\dir]]></ExportDir>
    </FtpSetting>

    <FileSetting>
      <ExportDir><![CDATA[]]></ExportDir>
      <FileName>
        <Value Type="string">fixedPurchase_</Value>
        <Value Type="dateString" Format="yyyyMMddHHmmss">now</Value>
      </FileName>
      <Extension>csv</Extension>
      <Separator Type="input"><![CDATA[,]]></Separator>
      <HeaderExport>true</HeaderExport>
      <QuotationMark><![CDATA["]]></QuotationMark>
      <Encoding>shift_jis</Encoding>
      <UploadType>append</UploadType>
    </FileSetting>

    <SearchSetting>
      <ExportSql ExecTimeOut="120">
        <Sql>
          <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  fixed_purchase_id
          INTO  #FreeExportTempTable
          FROM  w2_FixedPurchase
         WHERE  fixed_purchase_id = '【定期ID】'
      
        SELECT  @@ fields @@
          FROM  #FreeExportTempTable
                INNER JOIN w2_FixedPurchase ON
                (
                  w2_FixedPurchase.fixed_purchase_id = #FreeExportTempTable.fixed_purchase_id
                )
        ]]>
        </Sql>
      </ExportSql>

      <!--
      <UpdateSql ExecTimeOut="120" ExecUnit="10">
        <HistoryType>fixedPurchase</HistoryType>
        <Sql>
          <![CDATA[
          UPDATE  w2_FixedPurchase
             SET  extend_status1 = '1',
                  date_changed = GETDATE(),
                  last_changed = 'batch'
           WHERE  fixed_purchase_id = '@@ fixed_purchase_id @@';
          ]]>
        </Sql>
      </UpdateSql>
      -->

      <Fields>
        <Field UpdateSqlKey="fixed_purchase_id" ExportFlg="false">
          <Value>
            <![CDATA[
            w2_FixedPurchase.fixed_purchase_id
              ]]>
          </Value>
        </Field>

        <Field HeaderName="定期台帳ID">
          <Value>
            <![CDATA[
            w2_FixedPurchase.fixed_purchase_id
              ]]>
          </Value>
        </Field>
      </Fields>
    </SearchSetting>
  </ExportSetting>

</Root>
