<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 店舗配送種別マスタ系SQLステートメントXML (ShopShipping.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2015 All Rights Reserved.
=========================================================================================================
-->
<ShopShipping>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShipping
         WHERE  shop_id = @shop_id
           AND  shipping_id = @shipping_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </Get>

  <!-- 取得（全て） -->
  <GetAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShipping
         WHERE  w2_ShopShipping.shop_id = @shop_id
      ORDER BY  w2_ShopShipping.shop_id ASC, w2_ShopShipping.shipping_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetAll>

  <!-- 配送料マスタ取得（全て） -->
  <GetShippingDeliveryPostageAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShippingDeliveryPostage
         WHERE  shop_id = @shop_id
           AND  shipping_id = @shipping_id
        ORDER BY shop_id ASC, shipping_id ASC, delivery_company_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetShippingDeliveryPostageAll>

  <!-- 地帯取得（全て） -->
  <GetZoneAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShippingZone
         WHERE  shop_id = @shop_id
           AND  shipping_id = @shipping_id
        ORDER BY shop_id ASC, shipping_id ASC, delivery_company_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetZoneAll>

  <!-- 配送会社取得（全て） -->
  <GetCompanyAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShippingCompany
         WHERE  shipping_id = @shipping_id
      ORDER BY  shipping_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetCompanyAll>

  <!--初期配送会社取得 -->
  <GetDefaultCompany>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShippingCompany
         WHERE  shipping_id = @shipping_id
           AND  shipping_kbn = @shipping_kbn
           AND  default_delivery_company = '1'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </GetDefaultCompany>

    <!-- 郵便番号から配送種別情報取得 -->
  <GetFromZipcode>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  w2_ShippingDeliveryPostage.shipping_price_kbn,
                  w2_ShippingDeliveryPostage.shipping_free_price_flg,
                  w2_ShippingDeliveryPostage.shipping_free_price,
                  w2_ShippingDeliveryPostage.announce_free_shipping_flg,
                  w2_ShippingDeliveryPostage.calculation_plural_kbn,
                  w2_ShippingDeliveryPostage.plural_shipping_price,
                  w2_ShippingDeliveryPostage.storepickup_free_price_flg,
                  w2_ShippingDeliveryPostage.free_shipping_fee,
                  w2_ShopShippingZone.delivery_company_id,
                  w2_ShopShippingZone.shipping_zone_no,
                  w2_ShopShippingZone.size_xxs_shipping_price,
                  w2_ShopShippingZone.size_xs_shipping_price,
                  w2_ShopShippingZone.size_s_shipping_price,
                  w2_ShopShippingZone.size_m_shipping_price,
                  w2_ShopShippingZone.size_l_shipping_price,
                  w2_ShopShippingZone.size_xl_shipping_price,
                  w2_ShopShippingZone.size_xxl_shipping_price,
                  w2_ShopShippingZone.size_mail_shipping_price,
                  w2_ShopShippingZone.conditional_shipping_price_threshold,
                  w2_ShopShippingZone.conditional_shipping_price,
                  w2_ShopShipping.*
            FROM  w2_ShopShipping
                  LEFT JOIN w2_ShippingDeliveryPostage ON
                  (
                    w2_ShopShipping.shop_id = w2_ShippingDeliveryPostage.shop_id
                    AND
                    w2_ShopShipping.shipping_id = w2_ShippingDeliveryPostage.shipping_id
                    AND
                    w2_ShippingDeliveryPostage.delivery_company_id = @delivery_company_id
                  )
                  LEFT JOIN w2_ShopShippingZone ON
                  (
                    w2_ShopShipping.shop_id = w2_ShopShippingZone.shop_id
                    AND
                    w2_ShopShipping.shipping_id = w2_ShopShippingZone.shipping_id
                    AND
                    w2_ShopShippingZone.delivery_company_id = @delivery_company_id
                  )
           WHERE  w2_ShopShipping.shop_id = @shop_id
             AND  w2_ShopShipping.shipping_id = @shipping_id
             AND  (
                    w2_ShopShippingZone.shipping_zone_no = @shipping_zone_no
                    OR
                    (
                      @zip <> ''
                      AND
                      w2_ShopShippingZone.zip like '%' + @zip + '%'
                      AND
                      w2_ShopShippingZone.shipping_zone_no > @min_shipping_zone_no
                    )
                  )
          ORDER BY w2_ShopShippingZone.shipping_zone_no DESC
        ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="40" />
      <Input Name="shipping_id" Type="nvarchar" Size="40" />
      <Input Name="shipping_zone_no" Type="int" />
      <Input Name="zip" Type="nvarchar" Size="8" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="min_shipping_zone_no" Type="int" />
    </Parameter>
  </GetFromZipcode>

  <!--  shop_idに紐づくドロップダウンリストに必要な情報のみを取得 -->
  <GetShippingInfoByShopId>
    <Statement>
      <![CDATA[
        SELECT  w2_ShopShipping.shipping_id,
                w2_ShopShipping.shop_shipping_name
          FROM  w2_ShopShipping
         WHERE  w2_ShopShipping.shop_id = @shop_id
      ORDER BY  w2_ShopShipping.shop_id ASC, w2_ShopShipping.shipping_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetShippingInfoByShopId>

  <!-- 配送情報から配送不可郵便番号取得 -->
  <GetUnavailableShippingZipFromShippingDelivery>
    <Statement>
      <![CDATA[
          SELECT  zip
            FROM  w2_ShopShippingZone
           WHERE  shipping_id = @shipping_id
             AND  delivery_company_id = @delivery_company_id
             AND  unavailable_shipping_area_flg = '1'
        ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetUnavailableShippingZipFromShippingDelivery>

  <!-- 配送会社削除 -->
  <DeleteDeliveryCompany>
    <Statement>
      <![CDATA[
        DELETE FROM w2_ShopShippingCompany
        WHERE  shipping_id = @shipping_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </DeleteDeliveryCompany>

  <!-- 配送種別配送会社登録 -->
  <InsertCompany>
    <Statement>
      <![CDATA[
        INSERT INTO w2_ShopShippingCompany
        (
            shipping_id,
            shipping_kbn,
            delivery_company_id,
            default_delivery_company,
            date_created,
            date_changed,
            last_changed
        )
        VALUES
        (
            @shipping_id,
            @shipping_kbn,
            @delivery_company_id,
            @default_delivery_company,
            GETDATE(),
            GETDATE(),
            @last_changed
        )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_kbn" Type="nvarchar" Size="10" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="default_delivery_company" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertCompany>

  <!--  delivery_company_idに紐づくすべての配送種別配送会社情報を取得 -->
  <GetShippingCompanyByDeliveryCompanyId>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_ShopShippingCompany
         WHERE  w2_ShopShippingCompany.delivery_company_id = @delivery_company_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetShippingCompanyByDeliveryCompanyId>

  <!-- 店舗配送料地帯情報を登録する -->
  <InsertShopShippingZone>
    <Statement>
      <![CDATA[
        INSERT  w2_ShopShippingZone
                (
                  shop_id
                  ,shipping_id
                  ,shipping_zone_no
                  ,shipping_zone_name
                  ,zip
                  ,size_xxs_shipping_price
                  ,size_xs_shipping_price
                  ,size_s_shipping_price
                  ,size_m_shipping_price
                  ,size_l_shipping_price
                  ,size_xl_shipping_price
                  ,size_xxl_shipping_price
                  ,date_created
                  ,date_changed
                  ,last_changed
                  ,size_mail_shipping_price
                  ,delivery_company_id
                  ,conditional_shipping_price_threshold
                  ,conditional_shipping_price
                  ,unavailable_shipping_area_flg
                )
        VALUES  (
                  @shop_id
                  ,@shipping_id
                  ,@shipping_zone_no
                  ,@shipping_zone_name
                  ,@zip
                  ,@size_xxs_shipping_price
                  ,@size_xs_shipping_price
                  ,@size_s_shipping_price
                  ,@size_m_shipping_price
                  ,@size_l_shipping_price
                  ,@size_xl_shipping_price
                  ,@size_xxl_shipping_price
                  ,getdate()
                  ,getdate()
                  ,@last_changed
                  ,@size_mail_shipping_price
                  ,@delivery_company_id
                  ,@conditional_shipping_price_threshold
                  ,@conditional_shipping_price
                  ,@unavailable_shipping_area_flg
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_zone_no" Type="int" />
      <Input Name="shipping_zone_name" Type="nvarchar" Size="30" />
      <Input Name="zip" Type="ntext" />
      <Input Name="size_xxs_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_xs_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_s_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_m_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_l_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_xl_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="size_xxl_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="size_mail_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="conditional_shipping_price_threshold" Type="decimal" Size="18,3" />
      <Input Name="conditional_shipping_price" Type="decimal" Size="18,3" />
      <Input Name="unavailable_shipping_area_flg" Type="nvarchar" Size="1" />
    </Parameter>
  </InsertShopShippingZone>

  <!-- 配送種別IDに紐づくすべての店舗配送料地帯情報を削除する -->
  <DeleteShopShippingZoneByShippingId>
    <Statement>
      <![CDATA[
        DELETE  w2_ShopShippingZone
         WHERE  w2_ShopShippingZone.shop_id = @shop_id
           AND  w2_ShopShippingZone.shipping_id = @shipping_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </DeleteShopShippingZoneByShippingId>

  <!-- 配送種別IDと地帯に紐づくすべての店舗配送料地帯情報を削除する -->
  <DeleteShopShippingZoneByShippingIdAndZone>
    <Statement>
      <![CDATA[
        DELETE  w2_ShopShippingZone
         WHERE  w2_ShopShippingZone.shop_id = @shop_id
           AND  w2_ShopShippingZone.shipping_id = @shipping_id
           AND  w2_ShopShippingZone.shipping_zone_no = @shipping_zone_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_zone_no" Type="int" />
    </Parameter>
  </DeleteShopShippingZoneByShippingIdAndZone>

  <!-- Get shipping names by shipping ids -->
  <GetShippingNamesByShippingIds>
    <Statement>
      <![CDATA[
        SELECT  shop_shipping_name
          FROM  w2_ShopShipping
         WHERE  shop_id = @shop_id
           AND  shop_shipping_name <> ''
           AND  shipping_id IN (@@ shipping_ids @@)
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetShippingNamesByShippingIds>

  <!-- 更新日と最終更新者を更新 -->
  <UpdateShopShippingDateChangedAndLastChanged>
    <Statement>
      <![CDATA[
        UPDATE  w2_ShopShipping
           SET  w2_ShopShipping.date_changed = getdate(),
                w2_ShopShipping.last_changed = @last_changed
         WHERE  w2_ShopShipping.shop_id = @shop_id
           AND  w2_ShopShipping.shipping_id = @shipping_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
    </Parameter>
  </UpdateShopShippingDateChangedAndLastChanged>

</ShopShipping>