<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : ポイントマスタ系SQLサブステートメントXML (Point_Sub.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2015 All Rights Reserved.
=========================================================================================================
-->
<Point_Sub>

  <!-- ユーザーポイント情報一覧取得用WHERE文 -->
  <USERPOINT_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  (
            @srch_key = 0 AND w2_User.user_id like @srch_word_like_escaped + '%'  ESCAPE '#'  -- ユーザーID
            OR
            @srch_key = 1 AND w2_User.name like '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 氏名
            OR
            @srch_key = 2 AND w2_User.name_kana like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- フリガナ
            OR
            @srch_key = 3
            AND
            (
              w2_User.tel1 LIKE @srch_word_like_escaped + '%' ESCAPE '#'
              OR
              w2_User.tel1_1 + w2_User.tel1_2 + w2_User.tel1_3 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 電話番号
              OR
              w2_User.tel2 LIKE @srch_word_like_escaped + '%' ESCAPE '#'
              OR
              w2_User.tel2_1 + w2_User.tel2_2 + w2_User.tel2_3 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- tel2 number
            )
            OR
            @srch_key = 4 AND w2_User.mail_addr like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- メールアドレス
            OR
            @srch_key = 4 AND w2_User.mail_addr2 like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- モバイルメールアドレス
            OR
            @srch_key = 5
            AND
            (
              w2_User.zip LIKE @srch_word_like_escaped + '%' ESCAPE '#'
              OR
              w2_User.zip1 + w2_User.zip2 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 郵便番号
            )
            OR
            @srch_key = 6 AND w2_User.addr like '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 住所
            OR
            @srch_key = 7 AND w2_User.company_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 企業名
            OR
            @srch_key = 8 AND w2_User.company_post_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 部署名
            OR
            @srch_key = 99 AND  @srch_word_like_escaped = ''                                      -- 条件なし
            )     
            AND w2_User.user_kbn IN ('PC_USER','MB_USER','SP_USER','OFF_USER')
            -- ユーザー退会フラグ
            <@@hasval:del_flg@@>
              AND
              w2_User.del_flg = @del_flg
            </@@hasval:del_flg@@>
      ]]>
    </Statement>
  </USERPOINT_SEARCH_WHERE>

  <!-- ユーザーポイント情報一覧取得用WHERE文 -->
  <USERPOINTDETAIL_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  (
                  @srch_key = 0 AND w2_User.user_id like @srch_word_like_escaped + '%'  ESCAPE '#'  -- ユーザーID
                  OR
                  @srch_key = 1 AND w2_User.name like '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 氏名
                  OR
                  @srch_key = 2 AND w2_User.name_kana like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- フリガナ
                  OR
                  @srch_key = 3
                  AND
                  (
                    w2_User.tel1 LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                    OR
                    w2_User.tel1_1 + w2_User.tel1_2 + w2_User.tel1_3 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 電話番号
                  )
                  OR
                  @srch_key = 4 AND w2_User.mail_addr like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- メールアドレス
                  OR
                  @srch_key = 4 AND w2_User.mail_addr2 like '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- モバイルメールアドレス
                  OR
                  @srch_key = 5
                  AND
                  (
                    w2_User.zip LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                    OR
                    w2_User.zip1 + w2_User.zip2 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 郵便番号
                  )
                  OR
                  @srch_key = 6 AND w2_User.addr like '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 住所
                  OR
                  @srch_key = 7 AND w2_User.company_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 企業名
                  OR
                  @srch_key = 8 AND w2_User.company_post_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 部署名
                  OR
                  @srch_key = 99 AND  @srch_word_like_escaped = ''                                      -- 条件なし
                )
           AND  w2_User.user_kbn IN ('PC_USER','MB_USER','SP_USER','OFF_USER')
      ]]>
    </Statement>
  </USERPOINTDETAIL_SEARCH_WHERE>

  <!-- ユーザーポイント情報一覧取得用ORDER_BY -->
  <USERPOINT_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN point_info.point
            ELSE '1'
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  2 THEN ISNULL(point_info.point_exp,DATEADD(YEAR,1,getdate()))
            ELSE NULL
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  8 THEN point_info.user_id
            ELSE '1'
          END
          ASC,
          CASE @sort_kbn
            WHEN  1 THEN point_info.point
            ELSE '1'
          END 
          DESC, 
          CASE @sort_kbn
            WHEN  3 THEN ISNULL(point_info.point_exp,DATEADD(YEAR,1,getdate()))
            ELSE NULL
          END 
          DESC,
          CASE @sort_kbn
            WHEN  9 THEN point_info.user_id
            ELSE '1'
          END
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          point_info.user_id ASC
      ]]>
    </Statement>
  </USERPOINT_SEARCH_ORDER_BY>

  <!-- ユーザーポイント詳細情報一覧出力用ORDER_BY -->
  <USERPOINTDETAIL_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN point
            ELSE '1'
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  2 THEN point_exp
            ELSE NULL
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  8 THEN w2_User.user_id
            ELSE '1'
          END
          ASC,
          CASE @sort_kbn
            WHEN  1 THEN point
            ELSE '1'
          END 
          DESC, 
          CASE @sort_kbn
            WHEN  3 THEN point_exp
            ELSE NULL
          END 
          DESC,
          CASE @sort_kbn
            WHEN  9 THEN w2_User.user_id
            ELSE '1'
          END
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_User.user_id ASC
      ]]>
    </Statement>
  </USERPOINTDETAIL_SEARCH_ORDER_BY>

  <!-- ユーザーポイント情報一覧出力用ORDER_BY -->
  <USERPOINT_EXPORT_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN point
            ELSE '1'
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  2 THEN point_exp
            ELSE NULL
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  8 THEN w2_User.user_id
            ELSE '1'
          END
          ASC,
          CASE @sort_kbn
            WHEN  1 THEN point
            ELSE '1'
          END 
          DESC, 
          CASE @sort_kbn
            WHEN  3 THEN point_exp
            ELSE NULL
          END 
          DESC,
          CASE @sort_kbn
            WHEN  9 THEN w2_User.user_id
            ELSE '1'
          END
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_User.user_id ASC
      ]]>
    </Statement>
  </USERPOINT_EXPORT_ORDER_BY>

  <!-- ユーザーポイント履歴情報一覧取得用WHERE文 -->
  <USERPOINTHISTORY_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  w2_UserPointHistory.user_id = @user_id 
           AND  (
                  @point_kbn = 'ALL'
                  OR
                  w2_UserPointHistory.point_kbn = @point_kbn
                )
      ]]>
    </Statement>
  </USERPOINTHISTORY_SEARCH_WHERE>

  <!-- ユーザーポイント履歴情報一覧取得用ORDER_BY -->
  <USERPOINTHISTORY_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          w2_UserPointHistory.history_no ASC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_UserPointHistory.user_id ASC, w2_UserPointHistory.history_no ASC
      ]]>
    </Statement>
  </USERPOINTHISTORY_SEARCH_ORDER_BY>

  <!-- ポイント基本ルール情報一覧取得用WHERE文 -->
  <POINTRULE_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  w2_PointRule.dept_id = @dept_id 
           AND  w2_PointRule.point_rule_kbn = @point_rule_kbn
           AND  (
                  @srch_key = 0 AND w2_PointRule.point_inc_kbn = @srch_word  -- ポイント加算区分
                  OR 
                  @srch_key = 99 AND @srch_word = ''                -- 条件なし
                )
      ]]>
    </Statement>
  </POINTRULE_SEARCH_WHERE>

  <!-- ポイント基本ルール情報一覧取得用ORDER_BY -->
  <POINTRULE_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN w2_PointRule.priority
            ELSE '1'
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  1 THEN w2_PointRule.priority
            ELSE NULL
          END 
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_PointRule.dept_id ASC, w2_PointRule.point_rule_id ASC
      ]]>
    </Statement>
  </POINTRULE_SEARCH_ORDER_BY>

  <!-- ポイントルールスケジュール情報一覧取得用WHERE文 -->
  <POINTRULESCHEDULE_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  (@point_rule_schedule_id = '' OR w2_PointRuleSchedule.point_rule_schedule_id LIKE @point_rule_schedule_id + '%'  ESCAPE '#')
           AND  (@point_rule_schedule_name = '' OR w2_PointRuleSchedule.point_rule_schedule_name LIKE '%' + @point_rule_schedule_name + '%'  ESCAPE '#')
      ]]>
    </Statement>
  </POINTRULESCHEDULE_SEARCH_WHERE>

  <!-- ポイントルールスケジュール情報一覧取得用ORDER_BY -->
  <POINTRULESCHEDULE_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_PointRuleSchedule.point_rule_schedule_id ASC
      ]]>
    </Statement>
  </POINTRULESCHEDULE_SEARCH_ORDER_BY>

</Point_Sub>
