<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : ページデザイン ページ管理系SQLステートメントXML (PageDesign.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2019 All Rights Reserved.
=========================================================================================================
-->
<PageDesign>

  <!-- 検索ヒット件数取得 -->
  <GetSearchHitCount>
    <Statement>
      <![CDATA[
        SELECT  COUNT(distinct(w2_PageDesign.page_id))
          FROM  w2_PageDesign
                [[ PAGE_DESIGN_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetSearchHitCount>

  <!-- 検索 -->
  <Search>
    <Statement>
      <![CDATA[
        SELECT  w2_PageDesign.*
          FROM  w2_PageDesign
                [[ PAGE_DESIGN_SEARCH_WHERE ]]
                [[ PAGE_DESIGN_SEARCH_ORDER_BY ]]
      ]]>
    </Statement>
    <Parameter>
    </Parameter>
  </Search>

  <!-- グループ取得 -->
  <GetGroup>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesignGroup
         WHERE  group_id = @group_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="group_id" Type="bigint" />
    </Parameter>
  </GetGroup>

  <!-- グループ全取得 -->
  <GetAllGroup>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesignGroup
        ORDER BY group_sort_number ASC
      ]]>
    </Statement>
  </GetAllGroup>

  <!-- グループ登録 (登録後、ID取得)-->
  <InsertGroup>
    <Statement>
      <![CDATA[
        INSERT  w2_PageDesignGroup
                (
                  group_name
                  ,group_sort_number
                  ,date_created
                  ,date_changed
                  ,last_changed
                )
        VALUES  (
                  @group_name
                  ,@group_sort_number
                  ,GETDATE()
                  ,GETDATE()
                  ,@last_changed
                )
                
        SELECT  SCOPE_IDENTITY()
      ]]>
    </Statement>
    <Parameter>
      <Input Name="group_name" Type="nvarchar" Size="60" />
      <Input Name="group_sort_number" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertGroup>

  <!-- グループ更新 -->
  <UpdateGroup>
    <Statement>
      <![CDATA[
        UPDATE  w2_PageDesignGroup
           SET  group_name = @group_name
                ,group_sort_number = @group_sort_number
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
         WHERE  group_id = @group_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="group_id" Type="bigint" />
      <Input Name="group_name" Type="nvarchar" Size="60" />
      <Input Name="group_sort_number" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateGroup>

  <!-- グループ削除 -->
  <DeleteGroup>
    <Statement>
      <![CDATA[
        DELETE  w2_PageDesignGroup
         WHERE  group_id = @group_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="group_id" Type="bigint" />
    </Parameter>
  </DeleteGroup>

  <!-- ページ取得 -->
  <GetPage>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesign
         WHERE  page_id = @page_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="page_id" Type="bigint" />
    </Parameter>
  </GetPage>

  <!-- ページ取得 -->
  <GetPageByFileName>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesign
         WHERE  file_name = @file_name
      ]]>
    </Statement>
    <Parameter>
      <Input Name="file_name" Type="nvarchar" Size="60" />
    </Parameter>
  </GetPageByFileName>

  <!-- ページ全取得 -->
  <GetAllPage>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesign
      ]]>
    </Statement>
  </GetAllPage>

  <!-- ページ登録 (登録後、ID取得)-->
  <InsertPage>
    <Statement>
      <![CDATA[
        INSERT  w2_PageDesign
                (
                  management_title
                  ,page_type
                  ,file_name
                  ,pc_file_dir_path
                  ,group_id
                  ,page_sort_number
                  ,use_type
                  ,publish
                  ,condition_publish_date_from
                  ,condition_publish_date_to
                  ,condition_member_only_type
                  ,condition_member_rank_id
                  ,condition_target_list_type
                  ,condition_target_list_ids
                  ,date_created
                  ,date_changed
                  ,last_changed
                  ,metadata_desc
                )
        VALUES  (
                  @management_title
                  ,@page_type
                  ,@file_name
                  ,@pc_file_dir_path
                  ,@group_id
                  ,@page_sort_number
                  ,@use_type
                  ,@publish
                  ,@condition_publish_date_from
                  ,@condition_publish_date_to
                  ,@condition_member_only_type
                  ,@condition_member_rank_id
                  ,@condition_target_list_type
                  ,@condition_target_list_ids
                  ,GETDATE()
                  ,GETDATE()
                  ,@last_changed
                  ,@metadata_desc
                )
                
        SELECT  SCOPE_IDENTITY()
      ]]>
    </Statement>
    <Parameter>
      <Input Name="management_title" Type="nvarchar" Size="100" />
      <Input Name="page_type" Type="nvarchar" Size="20" />
      <Input Name="file_name" Type="nvarchar" Size="60" />
      <Input Name="pc_file_dir_path" Type="nvarchar" Size="300" />
      <Input Name="group_id" Type="bigint" />
      <Input Name="page_sort_number" Type="int" />
      <Input Name="use_type" Type="nvarchar" Size="20" />
      <Input Name="publish" Type="nvarchar" Size="20" />
      <Input Name="condition_publish_date_from" Type="datetime" />
      <Input Name="condition_publish_date_to" Type="datetime" />
      <Input Name="condition_member_only_type" Type="nvarchar" Size="20" />
      <Input Name="condition_member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="condition_target_list_type" Type="nvarchar" Size="20" />
      <Input Name="condition_target_list_ids" Type="nvarchar" Size="MAX" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="metadata_desc" Type="nvarchar" Size="200" />
    </Parameter>
  </InsertPage>

  <!-- カスタムページ更新 -->
  <UpdateCustomPage>
    <Statement>
      <![CDATA[
        UPDATE  w2_PageDesign
           SET  management_title = @management_title
                ,page_type = @page_type
                ,file_name = @file_name
                ,group_id = @group_id
                ,use_type = @use_type
                ,publish = @publish
                ,condition_publish_date_from = @condition_publish_date_from
                ,condition_publish_date_to = @condition_publish_date_to
                ,condition_member_only_type = @condition_member_only_type
                ,condition_member_rank_id = @condition_member_rank_id
                ,condition_target_list_type = @condition_target_list_type
                ,condition_target_list_ids = @condition_target_list_ids
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
                ,metadata_desc = @metadata_desc
         WHERE  page_id = @page_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="page_id" Type="bigint" />
      <Input Name="management_title" Type="nvarchar" Size="100" />
      <Input Name="page_type" Type="nvarchar" Size="20" />
      <Input Name="file_name" Type="nvarchar" Size="60" />
      <Input Name="group_id" Type="bigint" />
      <Input Name="use_type" Type="nvarchar" Size="20" />
      <Input Name="publish" Type="nvarchar" Size="20" />
      <Input Name="condition_publish_date_from" Type="datetime" />
      <Input Name="condition_publish_date_to" Type="datetime" />
      <Input Name="condition_member_only_type" Type="nvarchar" Size="20" />
      <Input Name="condition_member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="condition_target_list_type" Type="nvarchar" Size="20" />
      <Input Name="condition_target_list_ids" Type="nvarchar" Size="MAX" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="metadata_desc" Type="nvarchar" Size="200" />
    </Parameter>
  </UpdateCustomPage>

  <!-- 標準ページ更新 -->
  <UpdateNormalPage>
    <Statement>
      <![CDATA[
        UPDATE  w2_PageDesign
           SET  group_id = @group_id
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
         WHERE  page_id = @page_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="page_id" Type="bigint" />
      <Input Name="group_id" Type="bigint" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateNormalPage>

  <!-- ページ順序 更新 -->
  <UpdatePageGroupSort>
    <Statement>
      <![CDATA[
        UPDATE  w2_PageDesign
           SET  group_id = @group_id
                ,page_sort_number = @page_sort_number
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
         WHERE  page_id = @page_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="page_id" Type="bigint" />
      <Input Name="group_id" Type="bigint" />
      <Input Name="page_sort_number" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdatePageGroupSort>

  <!-- ページ削除 -->
  <DeletePage>
    <Statement>
      <![CDATA[
        DELETE  w2_PageDesign
         WHERE  page_id = @page_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="page_id" Type="bigint" />
    </Parameter>
  </DeletePage>

  <!-- CMS管理のページをすべて取得 -->
  <GetAllManagedPagesForSitemap>
    <Statement>
      <![CDATA[
        -- ページ管理
        SELECT  management_title AS management_title
                ,pc_file_dir_path AS pc_file_dir_path
                ,file_name AS file_name
                ,'Page' AS page_type
          FROM  w2_PageDesign
        UNION ALL
        -- 特集ページ情報
        SELECT  management_title AS management_title
                ,file_dir_path AS file_dir_path
                ,file_name AS file_name
                ,'FeaturePage' AS page_type
          FROM  w2_FeaturePage
        UNION ALL
        -- ランディングページ
        SELECT  page_title AS management_title
                ,'Landing\formlp\'
                ,page_file_name + '.aspx' AS file_name
                ,'LandingPage' AS page_type
          FROM  w2_LandingPageDesign
      ]]>
    </Statement>
  </GetAllManagedPagesForSitemap>

  <!-- ページをその他グループに移動 -->
  <UpdatePageMoveOtherGroup>
    <Statement>
      <![CDATA[
        UPDATE  w2_PageDesign
           SET  group_id = 0
                ,page_sort_number = 0
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
         WHERE  group_id = @group_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="group_id" Type="bigint" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdatePageMoveOtherGroup>

  <!-- 存在しないグループと紐づいているページのグループIDを抽出 -->
  <NotExistGroupIds>
    <Statement>
      <![CDATA[
        SELECT  page_design_group_id.group_id
          FROM  (
                  SELECT  w2_PageDesign.group_id
                    FROM  w2_PageDesign
                   WHERE  w2_PageDesign.group_id <> 0
                ) AS page_design_group_id
                LEFT JOIN w2_PageDesignGroup ON
                (
                  w2_PageDesignGroup.group_id = page_design_group_id.group_id
                )
         WHERE  w2_PageDesignGroup.group_id IS NULL
      ]]>
    </Statement>
    <Parameter>
    </Parameter>
  </NotExistGroupIds>

  <!-- ページ管理で使用されているか -->
  <CheckTargetListUsed>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_PageDesign
         WHERE  condition_target_list_ids LIKE '%' + @target_id + '%'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="target_id" Type="nvarchar" Size="max" />
    </Parameter>
  </CheckTargetListUsed>
</PageDesign>