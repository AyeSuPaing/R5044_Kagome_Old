<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 税率毎の注文金額情報系SQLステートメントXML (OrderPriceByTaxRate.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2019 All Rights Reserved.
=========================================================================================================
-->
<OrderPriceByTaxRate>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderPriceByTaxRate
         WHERE  order_id = @order_id
           AND  key_tax_rate = @key_tax_rate
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="key_tax_rate" Type="decimal" Size="5,2" />
    </Parameter>
  </Get>

  <!-- 返品用金額補正取得 -->
  <GetReturnPriceCorrections>
    <Statement>
      <![CDATA[
        SELECT  return_price_correction_by_rate
          FROM  w2_OrderPriceByTaxRate
         WHERE  order_id LIKE @order_id + '%'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetReturnPriceCorrections>

    <!-- 税率毎価格情報削除（全て） -->
  <DeleteAllByOrderId>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderPriceByTaxRate
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteAllByOrderId>

  <!-- 登録 -->
  <Insert>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderPriceByTaxRate
                (
                  order_id
                  ,key_tax_rate
                  ,price_subtotal_by_rate
                  ,price_shipping_by_rate
                  ,price_payment_by_rate
                  ,return_price_correction_by_rate
                  ,price_total_by_rate
                  ,tax_price_by_rate
                  ,date_created
                  ,date_changed
                )
        VALUES  (
                  @order_id
                  ,@key_tax_rate
                  ,@price_subtotal_by_rate
                  ,@price_shipping_by_rate
                  ,@price_payment_by_rate
                  ,@return_price_correction_by_rate
                  ,@price_total_by_rate
                  ,@tax_price_by_rate
                  ,@date_created
                  ,@date_changed
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="key_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="price_subtotal_by_rate" Type="decimal" />
      <Input Name="price_shipping_by_rate" Type="decimal" />
      <Input Name="price_payment_by_rate" Type="decimal" />
      <Input Name="return_price_correction_by_rate" Type="decimal" />
      <Input Name="price_total_by_rate" Type="decimal" />
      <Input Name="tax_price_by_rate" Type="decimal" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
    </Parameter>
  </Insert>
  
  <!-- 関連する税率毎価格情報を取得 -->
  <GetRelatedSummaryOrderPriceByTaxRate>
    <Statement>
      <![CDATA[
        SELECT  @order_id AS order_id,
                w2_OrderPriceByTaxRate.key_tax_rate,
                SUM(w2_OrderPriceByTaxRate.price_subtotal_by_rate) AS price_subtotal_by_rate,
                SUM(w2_OrderPriceByTaxRate.price_shipping_by_rate) AS price_shipping_by_rate,
                SUM(w2_OrderPriceByTaxRate.price_payment_by_rate) AS price_payment_by_rate,
                SUM(w2_OrderPriceByTaxRate.price_total_by_rate) AS price_total_by_rate,
                SUM(w2_OrderPriceByTaxRate.tax_price_by_rate) AS tax_price_by_rate,
                SUM(w2_OrderPriceByTaxRate.return_price_correction_by_rate) AS return_price_correction_by_rate
          FROM  (
                  SELECT  w2_Order.order_id
                    FROM  w2_Order
                   WHERE  w2_Order.order_id = @order_id
                      OR  w2_Order.order_id_org = @order_id
                ) AS OrderIds
                INNER JOIN w2_OrderPriceByTaxRate ON
                (
                  OrderIds.order_id = w2_OrderPriceByTaxRate.order_id
                )
        GROUP BY w2_OrderPriceByTaxRate.key_tax_rate
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetRelatedSummaryOrderPriceByTaxRate>

</OrderPriceByTaxRate>
