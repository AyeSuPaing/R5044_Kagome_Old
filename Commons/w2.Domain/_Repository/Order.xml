<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 注文情報系SQLステートメントXML (Order.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2015 All Rights Reserved.
=========================================================================================================
-->
<Order>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </Get>

  <!-- 注文情報の件数取得 -->
  <Count>
    <Statement>
      <![CDATA[
        SELECT  COUNT(*)
          FROM  w2_Order
         WHERE  order_id = @order_id
    ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </Count>

  <GetOrderDataBinding>
    <Statement>
      <![CDATA[ 
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        /* 会員ランク価格や特別価格などを考慮する商品価格を取得する一時テーブル作成 */
        SELECT  w2_FixedPurchase.fixed_purchase_id,
                w2_FixedPurchaseItem.shop_id,
                w2_FixedPurchaseItem.product_id,
                w2_FixedPurchaseItem.variation_id,
                (
                  SELECT  ISNULL
                          (
                            (
                              SELECT TOP 1 member_rank_price
                                FROM  w2_ProductPrice 
                                      LEFT JOIN w2_MemberRank ON
                                      (
                                        w2_ProductPrice.member_rank_id = w2_MemberRank.member_rank_id
                                      )
                               WHERE  w2_ProductPrice.shop_id = w2_FixedPurchaseItem.shop_id
                                 AND  w2_ProductPrice.product_id = w2_FixedPurchaseItem.product_id
                                 AND  (w2_ProductPrice.variation_id = w2_FixedPurchaseItem.variation_id OR (w2_ProductView.use_variation_flg = '0' AND w2_ProductPrice.variation_id = ''))
                                 AND  w2_User.member_rank_id <> ''
                                 AND  w2_MemberRank.member_rank_order >= (SELECT member_rank_order FROM w2_MemberRank where member_rank_id = w2_User.member_rank_id AND valid_flg = 'ON')
                                 AND  w2_MemberRank.valid_flg = 'ON'
                              ORDER BY  w2_MemberRank.member_rank_order
                            ),
                            ISNULL(w2_ProductView.special_price, w2_ProductView.price)
                          )
                ) AS price
          INTO  #ItemPrice
          FROM  w2_FixedPurchase
                INNER JOIN w2_User ON
                (
                  w2_FixedPurchase.user_id = w2_User.user_id
                )
                INNER JOIN w2_FixedPurchaseItem ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseItem.fixed_purchase_id
                )
                LEFT JOIN w2_ProductView ON
                (
                  w2_FixedPurchaseItem.shop_id = w2_ProductView.shop_id
                  AND
                  w2_FixedPurchaseItem.product_id = w2_ProductView.product_id
                  AND
                  w2_FixedPurchaseItem.variation_id = w2_ProductView.variation_id
                )

        SELECT  @@ fields @@
          FROM  w2_Order
                INNER JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                LEFT JOIN w2_ProductTag ON
                (
                  w2_OrderItem.product_id = w2_ProductTag.product_id
                )
                LEFT JOIN w2_ProductExtend ON
                (
                  w2_OrderItem.shop_id = w2_ProductExtend.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductExtend.product_id
                )
                LEFT JOIN w2_ProductStock ON
                (
                  w2_OrderItem.shop_id = w2_ProductStock.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductStock.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductStock.variation_id
                )
                LEFT JOIN w2_ProductCategory ON
                (
                  w2_Product.shop_id = w2_ProductCategory.shop_id
                  AND
                  w2_ProductStock.product_id IN (w2_Product.category_id1, w2_Product.category_id2, w2_Product.category_id3, w2_Product.category_id4, w2_Product.category_id5)
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_UserBusinessOwnerGMO ON
                (
                  w2_User.user_id = w2_UserBusinessOwnerGMO.user_id
                )
                LEFT JOIN w2_UserAttribute ON
                (
                  w2_User.user_id = w2_UserAttribute.user_id
                )
                LEFT JOIN w2_UserExtend ON
                (
                  w2_Order.user_id = w2_UserExtend.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_FixedPurchaseShipping ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseShipping.fixed_purchase_id
                )
                LEFT JOIN w2_TwFixedPurchaseInvoice ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_TwFixedPurchaseInvoice.fixed_purchase_id
                )
                LEFT JOIN w2_FixedPurchaseItem ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseItem.fixed_purchase_id
                )
                LEFT JOIN #ItemPrice ON
                (
                  w2_Order.fixed_purchase_id = #ItemPrice.fixed_purchase_id
                  AND
                  w2_FixedPurchaseItem.product_id = #ItemPrice.product_id
                  AND
                  w2_FixedPurchaseItem.variation_id = #ItemPrice.variation_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                  GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                [[ ORDER_SEARCH_WHERE ]]
                ORDER BY w2_Order.order_id ASC
      ]]>
    </Statement>
  </GetOrderDataBinding>

  <GetOrderDataBindingWorkflowMaster>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        /* 会員ランク価格や特別価格などを考慮する商品価格を取得するため */
        SELECT  w2_FixedPurchase.fixed_purchase_id,
                w2_FixedPurchaseItem.shop_id,
                w2_FixedPurchaseItem.product_id,
                w2_FixedPurchaseItem.variation_id,
                (
                  SELECT  ISNULL(
                             (SELECT TOP 1 member_rank_price
                                FROM  w2_ProductPrice 
                                      LEFT JOIN w2_MemberRank ON
                                      (
                                        w2_ProductPrice.member_rank_id = w2_MemberRank.member_rank_id
                                      )
                               WHERE  w2_ProductPrice.shop_id = w2_FixedPurchaseItem.shop_id
                                 AND  w2_ProductPrice.product_id = w2_FixedPurchaseItem.product_id
                                 AND  (w2_ProductPrice.variation_id = w2_FixedPurchaseItem.variation_id OR (w2_ProductView.use_variation_flg = '0' AND w2_ProductPrice.variation_id = ''))
                                 AND  w2_User.member_rank_id <> ''
                                 AND  w2_MemberRank.member_rank_order >= (SELECT ISNULL(MAX(member_rank_order), 999) FROM w2_MemberRank where member_rank_id = w2_User.member_rank_id AND valid_flg = 'ON')
                                 AND  w2_MemberRank.valid_flg = 'ON'
                            ORDER BY  w2_MemberRank.member_rank_order),
                              ISNULL(w2_ProductView.special_price, w2_ProductView.price))
                    FROM  w2_ProductView
                   WHERE  w2_ProductView.shop_id = w2_FixedPurchaseItem.shop_id
                     AND  w2_ProductView.product_id = w2_FixedPurchaseItem.product_id
                     AND  w2_ProductView.variation_id = w2_FixedPurchaseItem.variation_id
                ) AS price
          INTO  #ItemPrice
          FROM  w2_FixedPurchase
                INNER JOIN w2_User ON
                (
                  w2_FixedPurchase.user_id = w2_User.user_id
                )
                INNER JOIN w2_FixedPurchaseItem ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseItem.fixed_purchase_id
                )

        SELECT  @@ fields @@
          FROM  w2_Order
                INNER JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                LEFT JOIN w2_ProductTag ON
                (
                  w2_OrderItem.product_id = w2_ProductTag.product_id
                )
                LEFT JOIN w2_ProductExtend ON
                (
                  w2_OrderItem.shop_id = w2_ProductExtend.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductExtend.product_id
                )
                LEFT JOIN w2_ProductStock ON
                (
                  w2_OrderItem.shop_id = w2_ProductStock.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductStock.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductStock.variation_id
                )
                LEFT JOIN w2_ProductCategory ON
                (
                  w2_Product.shop_id = w2_ProductCategory.shop_id
                  AND
                  w2_ProductStock.product_id IN (w2_Product.category_id1, w2_Product.category_id2, w2_Product.category_id3, w2_Product.category_id4, w2_Product.category_id5)
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_UserBusinessOwnerGMO ON
                (
                  w2_User.user_id = w2_UserBusinessOwnerGMO.user_id
                )
                LEFT JOIN w2_UserAttribute ON
                (
                  w2_User.user_id = w2_UserAttribute.user_id
                )
                LEFT JOIN w2_UserExtend ON
                (
                  w2_Order.user_id = w2_UserExtend.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_FixedPurchaseShipping ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseShipping.fixed_purchase_id
                )
                LEFT JOIN w2_TwFixedPurchaseInvoice ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_TwFixedPurchaseInvoice.fixed_purchase_id
                )
                LEFT JOIN w2_FixedPurchaseItem ON
                (
                  w2_FixedPurchase.fixed_purchase_id = w2_FixedPurchaseItem.fixed_purchase_id
                )
                LEFT JOIN #ItemPrice ON
                (
                  w2_Order.fixed_purchase_id = #ItemPrice.fixed_purchase_id
                  AND
                  w2_FixedPurchaseItem.product_id = #ItemPrice.product_id
                  AND
                  w2_FixedPurchaseItem.variation_id = #ItemPrice.variation_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                  GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
                ORDER BY w2_Order.order_id ASC
      ]]>
    </Statement>
  </GetOrderDataBindingWorkflowMaster>

  <!-- 注文マスタ情報取得(CSV出力用) -->
  <GetOrderMaster>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderMaster>

  <!-- 注文商品マスタ情報取得(CSV出力用) -->
  <GetOrderItemMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                [[ ORDER_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_OrderItem.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemMaster>

  <!-- 注文セットプロモーション情報取得（マスタ出力用） -->
  <GetOrderSetPromotionMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderSetPromotionMaster>

  <!-- 注文マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMaster>

  <!-- 注文商品マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderItemWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )                
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_OrderItem.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemWorkflowMaster>

  <!-- 注文セットプロモーションマスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderSetPromotionWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderSetPromotionWorkflowMaster>

  <!-- 注文マスタフィールドチェック -->
  <CheckOrderFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_Order
                  INNER JOIN w2_OrderOwner ON
                  (
                    w2_Order.order_id = w2_OrderOwner.order_id
                  )
                  INNER JOIN w2_OrderShipping ON
                  (
                    w2_Order.order_id = w2_OrderShipping.order_id 
                  )
                  LEFT JOIN w2_OrderCoupon ON
                  (
                    w2_Order.order_id = w2_OrderCoupon.order_id
                  )
                  LEFT JOIN w2_Payment ON
                  (
                    w2_Order.shop_id = w2_Payment.shop_id
                    AND
                    w2_Order.order_payment_kbn = w2_Payment.payment_id
                  )
                  LEFT JOIN w2_ShopShipping ON
                  (
                    w2_Order.shop_id = w2_ShopShipping.shop_id
                    AND
                    w2_Order.shipping_id = w2_ShopShipping.shipping_id
                  )
                  LEFT JOIN w2_FixedPurchase ON
                  (
                    w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  )
                  LEFT JOIN w2_User ON
                  (
                    w2_Order.user_id = w2_User.user_id
                  )
                  LEFT JOIN w2_TwOrderInvoice ON
                  (
                    w2_Order.order_id = w2_TwOrderInvoice.order_id
                  )
                  INNER JOIN
                  (
                    SELECT  order_id,
                            SUM(return_price_correction_by_rate) as correction_price_total
                      FROM  w2_OrderPriceByTaxRate
                  GROUP BY  order_id
                  ) AS CorrectionPriceInfo
                  ON
                  (
                    w2_Order.order_id = CorrectionPriceInfo.order_id
                  )
                  WHERE  w2_Order.shop_id = @shop_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </CheckOrderFields>

  <!-- データ結合フィールドチェック -->
  <CheckOrderDataBindingFields>
    <Statement>
      <![CDATA[
      /* 明細金額（小計）項目の該当的をチェックするため */
          CREATE TABLE #ItemPrice (product_id nvarchar(30), price decimal(18, 3))
        SELECT  TOP 1
                @@ fields @@
          FROM  w2_Order
                LEFT JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                  AND
                  w2_Order.shop_id = w2_OrderItem.shop_id
                )
                LEFT JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                  AND
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                )
                LEFT JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                  AND
                  w2_Order.shop_id = w2_OrderItem.shop_id
                )
                LEFT JOIN w2_UserBusinessOwnerGMO ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                  AND
                  w2_Order.shop_id = w2_OrderItem.shop_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                LEFT JOIN w2_ProductTag ON
                (
                  w2_orderItem.product_id = w2_ProductTag.product_id
                )
                LEFT JOIN w2_ProductExtend ON
                (
                  w2_OrderItem.shop_id = w2_ProductExtend.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductExtend.product_id
                )
                LEFT JOIN w2_ProductStock ON
                (
                  w2_ProductStock.shop_id = w2_ProductStock.shop_id
                  AND
                  w2_OrderItem.product_id = w2_ProductStock.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductStock.variation_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_UserExtend ON
                (
                  w2_Order.user_id = w2_UserExtend.user_id
                )
                LEFT JOIN w2_UserAttribute ON
                (
                  w2_Order.user_id = w2_UserAttribute.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  AND
                  w2_Order.shop_id = w2_FixedPurchase.shop_id
                )
                LEFT JOIN w2_FixedPurchaseItem ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  AND
                  w2_Order.shop_id = w2_FixedPurchaseItem.shop_id
                )
                LEFT JOIN #ItemPrice ON
                  (
                    w2_FixedPurchaseItem.product_id = #ItemPrice.product_id
                  )
                LEFT JOIN w2_FixedPurchaseShipping ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchaseShipping.fixed_purchase_id
                )
                LEFT JOIN w2_TwFixedPurchaseInvoice ON
                (
                  w2_Order.fixed_purchase_id = w2_TwFixedPurchaseInvoice.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                  GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                WHERE  w2_Order.shop_id = @shop_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </CheckOrderDataBindingFields>

  <!-- 注文商品マスタフィールドチェック -->
  <CheckOrderItemFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_Order
                  INNER JOIN w2_OrderOwner ON
                  (
                    w2_Order.order_id = w2_OrderOwner.order_id
                  )
                  INNER JOIN w2_OrderShipping ON
                  (
                    w2_Order.order_id = w2_OrderShipping.order_id
                  )
                  INNER JOIN w2_OrderItem ON
                  (
                    w2_Order.order_id = w2_OrderItem.order_id
                  )
                  LEFT JOIN w2_OrderCoupon ON
                  (
                    w2_Order.order_id = w2_OrderCoupon.order_id
                  )
                  LEFT JOIN w2_Payment ON
                  (
                    w2_Order.order_payment_kbn = w2_Payment.payment_id
                  )
                  LEFT JOIN w2_ShopShipping ON
                  (
                    w2_Order.shipping_id = w2_ShopShipping.shipping_id
                  )
                  LEFT JOIN w2_FixedPurchase ON
                  (
                    w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  )
                  LEFT JOIN w2_OrderSetPromotion ON
                  (
                    w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                    AND
                    w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                  )
                  LEFT JOIN w2_User ON
                  (
                    w2_Order.user_id = w2_User.user_id
                  )
                  LEFT JOIN w2_TwOrderInvoice ON
                  (
                    w2_OrderItem.order_id = w2_TwOrderInvoice.order_id
                  )
                  INNER JOIN
                  (
                    SELECT  order_id,
                            SUM(return_price_correction_by_rate) as correction_price_total
                      FROM  w2_OrderPriceByTaxRate
                  GROUP BY  order_id
                  ) AS CorrectionPriceInfo
                  ON
                  (
                    w2_Order.order_id = CorrectionPriceInfo.order_id
                  )
            WHERE  w2_Order.shop_id = @shop_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </CheckOrderItemFields>

  <!-- 注文セットプロモーションマスタフィールドチェック -->
  <CheckOrderSetPromotionFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_Order
                  INNER JOIN w2_OrderOwner ON
                  (
                    w2_Order.order_id = w2_OrderOwner.order_id
                  )
                  LEFT JOIN w2_OrderSetPromotion ON
                  (
                    w2_Order.order_id = w2_OrderSetPromotion.order_id
                  )
           WHERE  w2_Order.shop_id = @shop_id 
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </CheckOrderSetPromotionFields>

  <!-- 注文情報を取得 -->
  <GetOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id AS item_supplier_id,
                w2_OrderItem.subscription_box_course_id AS item_subscription_box_course_id,
                w2_OrderItem.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(w2_OrderItem.variation_id, LEN(w2_OrderItem.variation_id) - LEN(w2_OrderItem.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name,
                w2_Product.fixed_purchase_flg AS fixed_purchase_flg_product
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrder>

  <!-- 注文同梱情報取得 -->
  <GetCombinedOrders>
    <Statement>
      <![CDATA[
        SELECT  order_id,
                fixed_purchase_id,
                combined_org_order_ids
          FROM  w2_Order WITH (NOLOCK)
         WHERE  order_id IN (@@ order_id @@)
      ]]>
    </Statement>
  </GetCombinedOrders>

  <!-- 配送先情報を取得 -->
  <GetOrderShipping>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.*
          FROM  w2_OrderShipping
         WHERE  w2_OrderShipping.order_id = @order_id
        ORDER BY w2_OrderShipping.order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderShipping>

  <!-- 注文セットプロモーション情報を取得 -->
  <GetOrderSetPromotion>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderSetPromotion.*
          FROM  w2_OrderSetPromotion
         WHERE  w2_OrderSetPromotion.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderSetPromotion>

  <!-- 注文情報取得(※子注文の返品商品も抽出する) -->
  <GetOrderForOrderReturnExchange>
    <Statement>
      <![CDATA[
        /*
        結果セット内のOrderIdを注文商品のOrderIdにするため
        注文商品を最初にSELECTしている
        （注文商品には別注文IDの返品商品が含まれている)
        */
        SELECT  ReturnExchangeItems.*,
                ReturnExchangeItems.supplier_id AS item_supplier_id,
                ReturnExchangeItems.subscription_box_course_id AS item_subscription_box_course_id,
                ReturnExchangeItems.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_Order.*,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(ReturnExchangeItems.variation_id, LEN(ReturnExchangeItems.variation_id) - LEN(ReturnExchangeItems.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN
                (
                  SELECT *
                    FROM w2_OrderItem oiorg
                   WHERE oiorg.order_id = @order_id_org

                  UNION ALL

                  -- 子注文の返品商品
                  SELECT *
                    FROM w2_OrderItem oich
                   WHERE oich.order_id IN
                                      (
                                        SELECT order_id
                                          FROM w2_Order
                                         WHERE order_id_org = @order_id_org
                                       )
                     AND oich.item_return_exchange_kbn = '01'
                ) ReturnExchangeItems ON
                (
                  w2_Order.order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderSetPromotion.order_id = @order_id_org
                  AND
                  ReturnExchangeItems.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_Order.order_id = @order_id_org
           AND  w2_OrderShipping.order_shipping_no = ReturnExchangeItems.order_shipping_no
      ORDER BY  ReturnExchangeItems.date_created ASC -- 注文商品の作成日昇順
			]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="60" />
    </Parameter>
  </GetOrderForOrderReturnExchange>

  <!-- 交換済み注文情報取得(※親注文IDが等しい注文の返品商品も抽出する) -->
  <GetExchangedOrder>
    <Statement>
      <![CDATA[
        /*
        注文商品を最初にSELECTしている
        結果セット内のOrderIdを注文商品のOrderIdにするため
        （注文商品には別注文IDの返品商品が含まれている)
        */
        SELECT  ReturnExchangeItems.*,
                ReturnExchangeItems.supplier_id as item_supplier_id,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_Order.*,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(ReturnExchangeItems.variation_id, LEN(ReturnExchangeItems.variation_id) - LEN(ReturnExchangeItems.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN
                (
                  SELECT *
                    FROM w2_OrderItem oiorg
                   WHERE oiorg.order_id = @order_id
                   
                  UNION ALL
                  
                  -- 親注文IDが等しい注文の返品商品
                  SELECT *
                    FROM w2_OrderItem oich
                   WHERE oich.order_id IN
                                      (
                                        SELECT order_id
                                          FROM w2_Order 
                                         WHERE order_id_org = @order_id_org
                                           AND order_id != @order_id
                                           AND order_id > @order_id -- 対象の交換済み注文IDより連番が大きい注文IDが対象
                                       )
                     AND oich.item_return_exchange_kbn = '01'
                ) ReturnExchangeItems ON
                (
                  w2_order.order_id = ReturnExchangeItems.order_id
                  OR
                  ReturnExchangeItems.order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderSetPromotion.order_id = @order_id_org
                  AND
                  ReturnExchangeItems.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_Order.order_id = @order_id 
      ORDER BY  ReturnExchangeItems.date_created ASC -- 注文商品の作成日昇順
			]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="60" />
    </Parameter>
  </GetExchangedOrder>

  <!-- 最大注文ID(枝番付き)取得 -->
  <GetOrderIdForOrderReturnExchange>
    <Statement>
      <![CDATA[
        -- current_noはデフォルト0
        DECLARE @current_no int
        SET @current_no = 0

        -- 一番新しい関連注文取得
        DECLARE @order_id_child_max nvarchar(30)
        SELECT  @order_id_child_max = MAX(order_id)
          FROM  w2_Order
         WHERE  w2_Order.order_id like @order_id_org + '%'
           AND  w2_Order.order_id_org = @order_id_org

        -- 関連注文がある場合はcurrent_noを取得
        IF @order_id_child_max IS NOT NULL
        BEGIN
          SET @current_no = ISNULL(MAX(CONVERT(int, SUBSTRING(@order_id_child_max, LEN(@order_id_org) + 2, LEN(@order_id_child_max) - LEN(@order_id_org) + 1))), 0)
        END

        -- current_no を +1 して新しい注文ID取得
        SELECT  @order_id_org + '-' + RIGHT('000' + CONVERT(nvarchar, @current_no + 1), 3) AS order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderIdForOrderReturnExchange>

  <!-- 交換注文の注文ID群を取得 -->
  <GetExchangedOrderIds>
    <Statement>
      <![CDATA[
        -- 元注文＋関連注文の注文ID群
        SELECT  w2_Order.order_id
          FROM  w2_Order
         WHERE  (
                  (
                    w2_Order.order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                    AND
                    w2_Order.order_id_org = @order_id_org
                  )
                  AND
                  w2_Order.return_exchange_kbn = '10' -- 交換のみ
                  AND
                  w2_Order.order_status != 'ODR_CNSL' -- 注文ステータスがキャンセル以外
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="60" />
    </Parameter>
  </GetExchangedOrderIds>

  <!-- Get order by payment order id -->
  <GetOrderByPaymentOrderId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
         WHERE  w2_Order.payment_order_id = @payment_order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
    </Parameter>
  </GetOrderByPaymentOrderId>

  <!-- 返品交換含む注文情報取得（全ての注文情報を含む） -->
  <GetRelatedOrders>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderPriceByTaxRate.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id AS item_supplier_id,
                w2_OrderItem.date_created AS item_date_created,
                w2_OrderItem.date_changed AS item_date_changed,
                w2_OrderItem.subscription_box_course_id AS item_subscription_box_course_id,
                w2_OrderItem.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderCoupon.*,
                w2_OrderSetPromotion.*,
                w2_OrderSetPromotion.order_setpromotion_no AS promotion_order_setpromotion_no
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderPriceByTaxRate ON
                (
                  w2_Order.order_id = w2_OrderPriceByTaxRate.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  (
                  (w2_Order.order_id = @order_id_org)
                  OR
                  (w2_Order.order_id_org = @order_id_org)
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </GetRelatedOrders>

  <!-- 注文一覧を取得(ワークフロー) -->
  <GetOrderWorkflowList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        ;WITH RowIndex AS
		(
            SELECT  w2_Order.order_id,
                    ROW_NUMBER()
                    OVER
                    (
                    @@ orderby @@
                    ) AS row_num,
					COUNT(w2_Order.order_id) OVER () AS row_count
              FROM  w2_Order
                    INNER JOIN w2_OrderOwner ON
                    (
                    w2_Order.order_id = w2_OrderOwner.order_id
                    )
                    INNER JOIN w2_User ON
                    (
                    w2_Order.user_id = w2_User.user_id
                    )
                    [[ ORDERWORKFLOW_SEARCH_WHERE ]]
		)
		
        -- 該当情報取得
        SELECT  w2_Order.shop_id,
                w2_Order.order_id,
                w2_Order.mall_id,
                w2_Order.user_id,
                CONVERT(nvarchar(10),w2_Order.bundle_order_bak) AS bundle_order_bak,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_Order.order_payment_kbn,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.order_return_exchange_status,
                order_return_exchange_receipt_date,
                w2_Order.order_repayment_status,
                w2_Order.return_exchange_kbn,
                w2_Order.order_kbn,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_Order.order_stockreserved_status,
                w2_Order.order_shipped_status,
                w2_Order.card_tran_id,
                w2_Order.card_instruments,
                w2_Order.payment_order_id,
                w2_Order.extend_status1,
                w2_Order.extend_status2,
                w2_Order.extend_status3,
                w2_Order.extend_status4,
                w2_Order.extend_status5,
                w2_Order.extend_status6,
                w2_Order.extend_status7,
                w2_Order.extend_status8,
                w2_Order.extend_status9,
                w2_Order.extend_status10,
                w2_Order.extend_status11,
                w2_Order.extend_status12,
                w2_Order.extend_status13,
                w2_Order.extend_status14,
                w2_Order.extend_status15,
                w2_Order.extend_status16,
                w2_Order.extend_status17,
                w2_Order.extend_status18,
                w2_Order.extend_status19,
                w2_Order.extend_status20,
                w2_Order.extend_status21,
                w2_Order.extend_status22,
                w2_Order.extend_status23,
                w2_Order.extend_status24,
                w2_Order.extend_status25,
                w2_Order.extend_status26,
                w2_Order.extend_status27,
                w2_Order.extend_status28,
                w2_Order.extend_status29,
                w2_Order.extend_status30,
                w2_Order.extend_status31,
                w2_Order.extend_status32,
                w2_Order.extend_status33,
                w2_Order.extend_status34,
                w2_Order.extend_status35,
                w2_Order.extend_status36,
                w2_Order.extend_status37,
                w2_Order.extend_status38,
                w2_Order.extend_status39,
                w2_Order.extend_status40,
                w2_Order.memo,
                w2_Order.management_memo,
                w2_Order.shipping_memo,
                w2_Order.order_price_shipping,
                w2_Order.order_price_exchange,
                w2_Order.order_price_regulation,
                w2_Order.order_price_repayment,
                w2_Order.order_price_total,
                w2_Order.order_point_use,
                w2_Order.order_point_use_yen,
                w2_Order.order_point_add,
                w2_Order.order_coupon_use,
                w2_Order.date_created,
                w2_Order.gift_flg,
                w2_Order.digital_contents_flg,
                w2_OrderCoupon.dept_id,
                w2_OrderCoupon.coupon_id,
                w2_OrderCoupon.coupon_no,
                w2_OrderCoupon.coupon_code,
                w2_OrderCoupon.coupon_type,
                w2_DeliveryCompany.delivery_company_id,
                w2_DeliveryCompany.shipping_time_id1,
                w2_DeliveryCompany.shipping_time_message1,
                w2_DeliveryCompany.shipping_time_id2,
                w2_DeliveryCompany.shipping_time_message2,
                w2_DeliveryCompany.shipping_time_id3,
                w2_DeliveryCompany.shipping_time_message3,
                w2_DeliveryCompany.shipping_time_id4,
                w2_DeliveryCompany.shipping_time_message4,
                w2_DeliveryCompany.shipping_time_id5,
                w2_DeliveryCompany.shipping_time_message5,
                w2_DeliveryCompany.shipping_time_id6,
                w2_DeliveryCompany.shipping_time_message6,
                w2_DeliveryCompany.shipping_time_id7,
                w2_DeliveryCompany.shipping_time_message7,
                w2_DeliveryCompany.shipping_time_id8,
                w2_DeliveryCompany.shipping_time_message8,
                w2_DeliveryCompany.shipping_time_id9,
                w2_DeliveryCompany.shipping_time_message9,
                w2_DeliveryCompany.shipping_time_id10,
                w2_DeliveryCompany.shipping_time_message10,
                w2_ShopShipping.wrapping_paper_flg,
                w2_ShopShipping.wrapping_bag_flg,
                w2_MallCooperationSetting.mall_name,
                w2_User.user_management_level_id,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_tel1,
                RowIndex.row_count,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.delivery_company_id,
                w2_Order.fixed_purchase_order_count,
                w2_Order.fixed_purchase_shipped_count,
                w2_Order.order_count_order,
                w2_Order.demand_status,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name
          FROM  RowIndex
                INNER JOIN w2_Order ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = '1'
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetOrderWorkflowList>

  <GetOrderWorkflowListCount>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        ;WITH RowIndex AS
        (
            SELECT  w2_Order.order_id,
                    ROW_NUMBER() OVER (ORDER BY w2_Order.order_id ASC) AS row_num,
                    COUNT(w2_Order.order_id) OVER () AS row_count
              FROM  w2_Order
                    INNER JOIN w2_OrderOwner ON (w2_Order.order_id = w2_OrderOwner.order_id)
                    INNER JOIN w2_User ON (w2_Order.user_id = w2_User.user_id)
                    [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        )

        -- 該当情報取得
        SELECT  RowIndex.row_count
          FROM  RowIndex
                INNER JOIN w2_Order ON (RowIndex.order_id = w2_Order.order_id)
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
        ORDER BY RowIndex.row_num ASC
    ]]>
    </Statement>
    <Parameter>
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetOrderWorkflowListCount>

  <!-- 返品交換含む注文ID取得 -->
  <GetRelatedOrderIds>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.order_id
          FROM  w2_Order
         WHERE  (
                  w2_Order.order_id = @order_id_org
                  OR
                  w2_Order.order_id_org = @order_id_org
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </GetRelatedOrderIds>

  <!-- 与信期限切れ注文ID取得 -->
  <GetAuthExpiredOrderIds>
    <Statement>
      <![CDATA[
       -- ダーティリードを許可して共有ロックを掛けなくする
       SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  order_id
          FROM  w2_Order
         WHERE
           mall_id = 'OWN_SITE' --自社サイトの注文
           AND
           (
            order_status IN ('ODR', 'ODR_RECG', 'STK_RSVD', 'SHP_ARGD')
            OR
            (order_status = '' AND return_exchange_kbn <> '00') --返品・交換注文
            OR
            (order_status = 'ODR_CNSL' AND return_exchange_kbn = '10') --交換注文キャンセル
           )
           AND
           (
                  (
                    -- クレジットカードは与信済みのみ
                    order_payment_kbn = 'K10'
                    AND
                    external_payment_auth_date < @card_expire_date
                    AND
                    external_payment_status IN ('AUTH_COMP')
                  )
                  OR
                  (
                    -- GMO Invoice
                    (
                      order_payment_kbn = 'K38'
                      OR
                      order_payment_kbn = 'K39'
                    )
                    AND
                    external_payment_auth_date < @gmo_post_expire_date
                    AND
                    online_payment_status <> '01'
                    AND
                    external_payment_status = 'OK'
                  )
                  OR
                  (
                    -- 後払いは与信済みのみ
                    (
                      order_payment_kbn = 'K32'
                      OR
                      order_payment_kbn = 'K37'
                    )
                    AND
                    external_payment_auth_date < @cvs_def_expire_date
                    AND
                    external_payment_status IN ('AUTH_COMP')
                  )
                  OR
                  (
                    -- Amazon Payは与信済み
                    (order_payment_kbn = 'K80'
                    OR
                    order_payment_kbn = 'K81')
                    AND
                    -- 未連携のみ（売上確定済＆キャンセル済は対象外）
                    online_payment_status = ''
                    AND
                    external_payment_auth_date < @amazon_pay_expire_date
                    AND
                    external_payment_status IN ('AUTH_COMP')
                )
                  OR
                  (
                    -- Paidy Payは与信済み
                    w2_Order.order_payment_kbn = 'K33'
                    AND
                    w2_Order.external_payment_auth_date < @paidy_pay_expire_date
                    AND
                    w2_Order.external_payment_status IN ('AUTH_COMP')
                  )
                  OR
                  (
                    -- LINEPayは与信済み
                    order_payment_kbn = 'G16'
                    AND
                    online_payment_status = ''
                    AND
                    external_payment_auth_date < @line_pay_expire_date
                    AND
                    external_payment_status IN ('AUTH_COMP')
                )
                  OR
                  (
                    -- NP後払い は与信済み
                    w2_Order.order_payment_kbn = 'K36'
                    AND
                    w2_Order.external_payment_auth_date < @npafter_pay_expire_date
                    AND
                    w2_Order.external_payment_status IN ('AUTH_COMP')
                )
                OR
                (
                    -- Rakuten card  external_payment_status
                    w2_Order.order_payment_kbn = 'M91'
                    AND
                    w2_Order.external_payment_auth_date < @rakuten_pay_expire_date
                    AND
                    w2_Order.external_payment_status IN ('AUTH_COMP')
              )
           )
           AND last_auth_flg = '1'  --最新与信の注文
      ]]>
    </Statement>
    <Parameter>
      <Input Name="card_expire_date" Type="datetime" />
      <Input Name="cvs_def_expire_date" Type="datetime" />
      <Input Name="amazon_pay_expire_date" Type="datetime" />
      <Input Name="paidy_pay_expire_date" Type="datetime" />
      <Input Name="line_pay_expire_date" Type="datetime" />
      <Input Name="npafter_pay_expire_date" Type="datetime" />
      <Input Name="rakuten_pay_expire_date" Type="datetime" />
      <Input Name="gmo_post_expire_date" Type="datetime" />
    </Parameter>
  </GetAuthExpiredOrderIds>

  <!-- 与信期限切れ注文ID取得(たまご→RPのシステム移行時用) -->
  <GetOrderIdsForAuth>
    <Statement>
      <![CDATA[
       -- ダーティリードを許可して共有ロックを掛けなくする
       SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  order_id
          FROM  w2_Order
         WHERE
           mall_id = 'OWN_SITE' --自社サイトの注文
           AND order_price_total > 0 --総額1円以上の注文のみ
           <@@hasval:extend_status_number@@>
           AND
           (
             @@ extend_status_condition @@
           )
           </@@hasval:extend_status_number@@>
      ]]>
    </Statement>
    <Parameter>
      <Input Name="extend_status_number" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderIdsForAuth>

  <!-- 返品用の受注取得 -->
  <GetForOrderReturn>
    <Statement>
      <![CDATA[
        SELECT  COUNT(*)
          FROM  w2_Order
         WHERE  w2_Order.order_id_org = @order_id
           AND  w2_Order.return_exchange_kbn = @return_exchange_kbn
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="return_exchange_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </GetForOrderReturn>

  <!-- Get Orders By External Deliverty Status And Update Date -->
  <GetOrdersByExternalDelivertyStatusAndUpdateDate>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.*,
                w2_Order.*
          FROM  w2_OrderShipping
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  shipping_external_deliverty_status = @shipping_external_deliverty_status
           AND  shipping_status_update_date > @deadline_date
      ]]>
    </Statement>
    <Parameter>
      <Input Name="deadline_date" Type="datetime" />
      <Input Name="shipping_external_deliverty_status" Type="nvarchar" Size="5" />
    </Parameter>
  </GetOrdersByExternalDelivertyStatusAndUpdateDate>

  <!-- Get Order Latest -->
  <GetOrderLatest>
    <Statement>
      <![CDATA[
        SELECT  TOP 1
                *
          FROM  w2_Order
         WHERE  user_id = @user_id
           AND  order_status NOT IN ('ODR_CNSL', 'TMP_CNSL', '')
        ORDER BY order_date DESC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderLatest>

  <!-- 初回購入注文を取得 -->
  <GetFirstOrder>
    <Statement>
      <![CDATA[
        SELECT  TOP 1
                *
          FROM  w2_Order
         WHERE  user_id = @user_id
           AND  order_status NOT IN ('ODR_CNSL', 'TMP_CNSL', '')
        ORDER BY order_date ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetFirstOrder>

  <!-- 更新ロック取得 -->
  <GetUpdLock>
    <Statement>
      <![CDATA[
        SELECT  order_id
          FROM  w2_Order WITH(UPDLOCK)
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetUpdLock>

  <!-- 更新ロック取得 -->
  <!-- ※テーブルロックをするため、トランザクションのコミット/ロールバック必須 -->
  <GetAllUpdateLock>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order WITH(UPDLOCK)
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetAllUpdateLock>

	<!-- 注文情報登録 -->
  <InsertOrder>
    <Statement>
      <![CDATA[
      INSERT  w2_Order
          (
            w2_Order.order_id,
            w2_Order.user_id,
            w2_Order.shop_id,
            w2_Order.order_kbn,
            w2_Order.mall_id,
            w2_Order.order_payment_kbn,
            w2_Order.order_status,
            w2_Order.order_date,
            w2_Order.order_stockreserved_status,
            w2_Order.order_shipped_status,
            w2_Order.order_item_count,
            w2_Order.order_product_count,
            w2_Order.order_price_subtotal,
            w2_Order.order_price_shipping,
            w2_Order.order_price_exchange,
            w2_Order.order_price_regulation,
            w2_Order.order_price_total,
            w2_Order.order_discount_set_price,
            w2_Order.order_point_use,
            w2_Order.order_point_use_yen,
            w2_Order.order_point_add,
            w2_Order.order_coupon_use,
            w2_Order.card_kbn,
            w2_Order.card_tran_id,
            w2_Order.card_instruments,
            w2_Order.card_installments_code,
            w2_Order.advcode_first,
            w2_Order.advcode_new,
            w2_Order.career_id,
            w2_Order.remote_addr,
            w2_Order.relation_memo,
            w2_Order.regulation_memo,
            w2_Order.shipping_id,
            w2_Order.fixed_purchase_id,
            w2_Order.memo,
            w2_Order.management_memo,
            w2_Order.date_created,
            w2_Order.date_changed,
            w2_Order.last_changed,
            w2_Order.member_rank_discount_price,
            w2_Order.member_rank_id,
            w2_Order.gift_flg,
            w2_Order.digital_contents_flg,
            w2_Order.shipping_price_separate_estimates_flg,
            w2_Order.order_tax_included_flg,
            w2_Order.order_tax_rate,
            w2_Order.order_tax_round_type,
            w2_Order.setpromotion_product_discount_amount,
            w2_Order.setpromotion_shipping_charge_discount_amount,
            w2_Order.setpromotion_payment_charge_discount_amount,
            w2_Order.payment_order_id,
            w2_Order.fixed_purchase_discount_price,
            w2_Order.fixed_purchase_member_discount_amount,
            w2_Order.last_billed_amount,
            w2_Order.external_order_id,
            w2_Order.external_import_status,
            w2_Order.external_payment_auth_date,
            w2_Order.last_auth_flg,
            w2_Order.order_id_org,
            w2_Order.order_recognition_date,
            w2_Order.order_stockreserved_date,
            w2_Order.order_shipping_date,
            w2_Order.order_shipped_date,
            w2_Order.order_delivering_date,
            w2_Order.order_cancel_date,
            w2_Order.order_payment_status,
            w2_Order.order_payment_date,
            w2_Order.demand_status,
            w2_Order.demand_date,
            w2_Order.order_return_exchange_status,
            w2_Order.order_return_exchange_receipt_date,
            w2_Order.order_return_exchange_arrival_date,
            w2_Order.order_return_exchange_complete_date,
            w2_Order.order_repayment_status,
            w2_Order.order_repayment_date,
            w2_Order.order_price_repayment,
            w2_Order.shipped_changed_kbn,
            w2_Order.return_exchange_kbn,
            w2_Order.return_exchange_reason_kbn,
            w2_Order.extend_status1,
            w2_Order.extend_status_date1,
            w2_Order.extend_status2,
            w2_Order.extend_status_date2,
            w2_Order.extend_status3,
            w2_Order.extend_status_date3,
            w2_Order.extend_status4,
            w2_Order.extend_status_date4,
            w2_Order.extend_status5,
            w2_Order.extend_status_date5,
            w2_Order.extend_status6,
            w2_Order.extend_status_date6,
            w2_Order.extend_status7,
            w2_Order.extend_status_date7,
            w2_Order.extend_status8,
            w2_Order.extend_status_date8,
            w2_Order.extend_status9,
            w2_Order.extend_status_date9,
            w2_Order.extend_status10,
            w2_Order.extend_status_date10,
            w2_Order.mobile_uid,
            w2_Order.payment_memo,
            w2_Order.return_exchange_reason_memo,
            w2_Order.repayment_memo,
            w2_Order.affiliate_session_name1,
            w2_Order.affiliate_session_value1,
            w2_Order.affiliate_session_name2,
            w2_Order.affiliate_session_value2,
            w2_Order.user_agent,
            w2_Order.extend_status11,
            w2_Order.extend_status_date11,
            w2_Order.extend_status12,
            w2_Order.extend_status_date12,
            w2_Order.extend_status13,
            w2_Order.extend_status_date13,
            w2_Order.extend_status14,
            w2_Order.extend_status_date14,
            w2_Order.extend_status15,
            w2_Order.extend_status_date15,
            w2_Order.extend_status16,
            w2_Order.extend_status_date16,
            w2_Order.extend_status17,
            w2_Order.extend_status_date17,
            w2_Order.extend_status18,
            w2_Order.extend_status_date18,
            w2_Order.extend_status19,
            w2_Order.extend_status_date19,
            w2_Order.extend_status20,
            w2_Order.extend_status_date20,
            w2_Order.extend_status21,
            w2_Order.extend_status_date21,
            w2_Order.extend_status22,
            w2_Order.extend_status_date22,
            w2_Order.extend_status23,
            w2_Order.extend_status_date23,
            w2_Order.extend_status24,
            w2_Order.extend_status_date24,
            w2_Order.extend_status25,
            w2_Order.extend_status_date25,
            w2_Order.extend_status26,
            w2_Order.extend_status_date26,
            w2_Order.extend_status27,
            w2_Order.extend_status_date27,
            w2_Order.extend_status28,
            w2_Order.extend_status_date28,
            w2_Order.extend_status29,
            w2_Order.extend_status_date29,
            w2_Order.extend_status30,
            w2_Order.extend_status_date30,
            w2_Order.fixed_purchase_order_count,
            w2_Order.fixed_purchase_shipped_count,
            w2_Order.extend_status31,
            w2_Order.extend_status_date31,
            w2_Order.extend_status32,
            w2_Order.extend_status_date32,
            w2_Order.extend_status33,
            w2_Order.extend_status_date33,
            w2_Order.extend_status34,
            w2_Order.extend_status_date34,
            w2_Order.extend_status35,
            w2_Order.extend_status_date35,
            w2_Order.extend_status36,
            w2_Order.extend_status_date36,
            w2_Order.extend_status37,
            w2_Order.extend_status_date37,
            w2_Order.extend_status38,
            w2_Order.extend_status_date38,
            w2_Order.extend_status39,
            w2_Order.extend_status_date39,
            w2_Order.extend_status40,
            w2_Order.extend_status_date40,
            w2_Order.last_order_point_use,
            w2_Order.last_order_point_use_yen,
            w2_Order.mall_link_status,
            w2_Order.order_price_tax,
            w2_Order.order_price_subtotal_tax,            
            w2_Order.settlement_currency,
            w2_Order.settlement_rate,
            w2_Order.settlement_amount,
            w2_Order.shipping_memo,
            w2_Order.shipping_tax_rate,
            w2_Order.payment_tax_rate,
            w2_Order.order_count_order,
            w2_Order.invoice_bundle_flg,
            w2_Order.inflow_contents_id,
            w2_Order.inflow_contents_type,
            w2_Order.receipt_flg,
            w2_Order.receipt_address,
            w2_Order.receipt_proviso,
            w2_Order.delivery_tran_id,
            w2_Order.online_delivery_status,
            w2_Order.external_payment_type,
            w2_Order.credit_branch_no,
            w2_Order.attribute1,
            w2_Order.attribute2,
            w2_Order.attribute3,
            w2_Order.attribute4,
            w2_Order.attribute5,
            w2_Order.attribute6,
            w2_Order.attribute7,
            w2_Order.attribute8,
            w2_Order.attribute9,
            w2_Order.attribute10,
            w2_Order.subscription_box_course_id,
            w2_Order.subscription_box_fixed_amount,
            w2_Order.order_subscription_box_order_count,
            w2_Order.storepickup_status,
            w2_Order.storepickup_store_arrived_date,
            w2_Order.storepickup_delivered_complete_date,
            w2_Order.storepickup_return_date
          )
      VALUES  (
            @order_id,
            @user_id,
            @shop_id,
            @order_kbn,
            @mall_id,
            @order_payment_kbn,
            @order_status,
            @order_date,
            '01',   -- 在庫未引当
            '01',   -- 未出荷
            @order_item_count,
            @order_product_count,
            @order_price_subtotal,
            @order_price_shipping,
            @order_price_exchange,
            @order_price_regulation,
            @order_price_total, -- 小計 ＋ 配送料 ＋ 決済手数料 - 利用ポイント
            @order_discount_set_price, -- セット値引き金額
            @order_point_use,
            @order_point_use_yen,
            @order_point_add,
            @order_coupon_use,
            @card_kbn,
            @card_tran_id,
            @card_instruments,
            @card_installments_code,
            @advcode_first,
            @advcode_new,
            @career_id,
            @remote_addr,
            @relation_memo,
            @regulation_memo,
            @shipping_id,
            @fixed_purchase_id,
            @memo,
            @management_memo,
            @date_created,
            @date_changed,
            @last_changed,
            @member_rank_discount_price,
            @member_rank_id,
            @gift_flg,
            @digital_contents_flg,
            @shipping_price_separate_estimates_flg,
            @order_tax_included_flg,
            @order_tax_rate,
            @order_tax_round_type,
            @setpromotion_product_discount_amount,
            @setpromotion_shipping_charge_discount_amount,
            @setpromotion_payment_charge_discount_amount,
            @payment_order_id,
            @fixed_purchase_discount_price,
            @fixed_purchase_member_discount_amount,
            @last_billed_amount,
            @external_order_id,
            @external_import_status,
            @external_payment_auth_date,
            @last_auth_flg,
            @order_id_org,
            @order_recognition_date,
            @order_stockreserved_date,
            @order_shipping_date,
            @order_shipped_date,
            @order_delivering_date,
            @order_cancel_date,
            @order_payment_status,
            @order_payment_date,
            @demand_status,
            @demand_date,
            @order_return_exchange_status,
            @order_return_exchange_receipt_date,
            @order_return_exchange_arrival_date,
            @order_return_exchange_complete_date,
            @order_repayment_status,
            @order_repayment_date,
            @order_price_repayment,
            @shipped_changed_kbn,
            @return_exchange_kbn,
            @return_exchange_reason_kbn,
            @extend_status1,
            @extend_status_date1,
            @extend_status2,
            @extend_status_date2,
            @extend_status3,
            @extend_status_date3,
            @extend_status4,
            @extend_status_date4,
            @extend_status5,
            @extend_status_date5,
            @extend_status6,
            @extend_status_date6,
            @extend_status7,
            @extend_status_date7,
            @extend_status8,
            @extend_status_date8,
            @extend_status9,
            @extend_status_date9,
            @extend_status10,
            @extend_status_date10,
            @mobile_uid,
            @payment_memo,
            @return_exchange_reason_memo,
            @repayment_memo,
            @affiliate_session_name1,
            @affiliate_session_value1,
            @affiliate_session_name2,
            @affiliate_session_value2,
            @user_agent,
            @extend_status11,
            @extend_status_date11,
            @extend_status12,
            @extend_status_date12,
            @extend_status13,
            @extend_status_date13,
            @extend_status14,
            @extend_status_date14,
            @extend_status15,
            @extend_status_date15,
            @extend_status16,
            @extend_status_date16,
            @extend_status17,
            @extend_status_date17,
            @extend_status18,
            @extend_status_date18,
            @extend_status19,
            @extend_status_date19,
            @extend_status20,
            @extend_status_date20,
            @extend_status21,
            @extend_status_date21,
            @extend_status22,
            @extend_status_date22,
            @extend_status23,
            @extend_status_date23,
            @extend_status24,
            @extend_status_date24,
            @extend_status25,
            @extend_status_date25,
            @extend_status26,
            @extend_status_date26,
            @extend_status27,
            @extend_status_date27,
            @extend_status28,
            @extend_status_date28,
            @extend_status29,
            @extend_status_date29,
            @extend_status30,
            @extend_status_date30,
            @fixed_purchase_order_count,
            @fixed_purchase_shipped_count,
            @extend_status31,
            @extend_status_date31,
            @extend_status32,
            @extend_status_date32,
            @extend_status33,
            @extend_status_date33,
            @extend_status34,
            @extend_status_date34,
            @extend_status35,
            @extend_status_date35,
            @extend_status36,
            @extend_status_date36,
            @extend_status37,
            @extend_status_date37,
            @extend_status38,
            @extend_status_date38,
            @extend_status39,
            @extend_status_date39,
            @extend_status40,
            @extend_status_date40,
            @last_order_point_use,
            @last_order_point_use_yen,
            @mall_link_status,
            @order_price_tax,
            @order_price_subtotal_tax,
            @settlement_currency,
            @settlement_rate,
            @settlement_amount,
            @shipping_memo,
            @shipping_tax_rate,
            @payment_tax_rate,
            @order_count_order,
            @invoice_bundle_flg,
            @inflow_contents_id,
            @inflow_contents_type,
            @receipt_flg,
            @receipt_address,
            @receipt_proviso,
            @delivery_tran_id,
            @online_delivery_status,
            @external_payment_type,
            @credit_branch_no,
            @attribute1,
            @attribute2,
            @attribute3,
            @attribute4,
            @attribute5,
            @attribute6,
            @attribute7,
            @attribute8,
            @attribute9,
            @attribute10,
            @subscription_box_course_id,
            @subscription_box_fixed_amount,
            @order_subscription_box_order_count,
            @storepickup_status,
            @storepickup_store_arrived_date,
            @storepickup_delivered_complete_date,
            @storepickup_return_date
          )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="order_date" Type="datetime" />
      <Input Name="order_item_count" Type="int" />
      <Input Name="order_product_count" Type="int" />
      <Input Name="order_price_subtotal" Type="decimal" Size="18,3" />
      <Input Name="order_price_shipping" Type="decimal" Size="18,3" />
      <Input Name="order_price_exchange" Type="decimal" Size="18,3" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="order_discount_set_price" Type="decimal" Size="18,3" />
      <Input Name="order_point_use" Type="decimal" />
      <Input Name="order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="order_point_add" Type="decimal" />
      <Input Name="order_coupon_use" Type="decimal" Size="18,3" />
      <Input Name="card_kbn" Type="nvarchar" Size="30" />
      <Input Name="card_tran_id" Type="nvarchar" Size="100" />
      <Input Name="card_instruments" Type="nvarchar" Size="30" />
      <Input Name="card_installments_code" Type="nvarchar" Size="10" />
      <Input Name="advcode_first" Type="nvarchar" Size="30" />
      <Input Name="advcode_new" Type="nvarchar" Size="30" />
      <Input Name="career_id" Type="nvarchar" Size="10" />
      <Input Name="remote_addr" Type="nvarchar" Size="30" />
      <Input Name="relation_memo" Type="ntext" />
      <Input Name="regulation_memo" Type="ntext" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="management_memo" Type="nvarchar" Size="MAX" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="member_rank_discount_price" Type="decimal" Size="18,3" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="gift_flg" Type="nvarchar" Size="2" />
      <Input Name="digital_contents_flg" Type="nvarchar" Size="2" />
      <Input Name="shipping_price_separate_estimates_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_rate" Type="decimal" />
      <Input Name="order_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="setpromotion_product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_payment_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
      <Input Name="fixed_purchase_discount_price" Type="decimal" Size="18,3" />
      <Input Name="fixed_purchase_member_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="external_order_id" Type="nvarchar" Size="50" />
      <Input Name="external_import_status" Type="nvarchar" Size="10" />
      <Input Name="external_payment_auth_date" Type="datetime" />
      <Input Name="last_auth_flg" Type="nvarchar" Size="1" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_recognition_date" Type="datetime" />
      <Input Name="order_stockreserved_date" Type="datetime" />
      <Input Name="order_shipping_date" Type="datetime" />
      <Input Name="order_shipped_date" Type="datetime" />
      <Input Name="order_delivering_date" Type="datetime" />
      <Input Name="order_cancel_date" Type="datetime" />
      <Input Name="order_payment_status" Type="nvarchar" Size="1" />
      <Input Name="order_payment_date" Type="datetime" />
      <Input Name="demand_status" Type="nvarchar" Size="1" />
      <Input Name="demand_date" Type="datetime" />
      <Input Name="order_return_exchange_status" Type="nvarchar" Size="10" />
      <Input Name="order_return_exchange_receipt_date" Type="datetime" />
      <Input Name="order_return_exchange_arrival_date" Type="datetime" />
      <Input Name="order_return_exchange_complete_date" Type="datetime" />
      <Input Name="order_repayment_status" Type="nvarchar" Size="10" />
      <Input Name="order_repayment_date" Type="datetime" />
      <Input Name="order_price_repayment" Type="decimal" />
      <Input Name="shipped_changed_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_reason_kbn" Type="nvarchar" Size="10" />
      <Input Name="extend_status1" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date1" Type="datetime" />
      <Input Name="extend_status2" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date2" Type="datetime" />
      <Input Name="extend_status3" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date3" Type="datetime" />
      <Input Name="extend_status4" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date4" Type="datetime" />
      <Input Name="extend_status5" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date5" Type="datetime" />
      <Input Name="extend_status6" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date6" Type="datetime" />
      <Input Name="extend_status7" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date7" Type="datetime" />
      <Input Name="extend_status8" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date8" Type="datetime" />
      <Input Name="extend_status9" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date9" Type="datetime" />
      <Input Name="extend_status10" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date10" Type="datetime" />
      <Input Name="mobile_uid" Type="nvarchar" Size="50" />
      <Input Name="payment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="return_exchange_reason_memo" Type="ntext" />
      <Input Name="repayment_memo" Type="ntext" />
      <Input Name="affiliate_session_name1" Type="nvarchar" Size="50" />
      <Input Name="affiliate_session_value1" Type="nvarchar" Size="100" />
      <Input Name="affiliate_session_name2" Type="nvarchar" Size="50" />
      <Input Name="affiliate_session_value2" Type="nvarchar" Size="100" />
      <Input Name="user_agent" Type="nvarchar" Size="512" /> />
      <Input Name="extend_status11" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date11" Type="datetime" />
      <Input Name="extend_status12" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date12" Type="datetime" />
      <Input Name="extend_status13" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date13" Type="datetime" />
      <Input Name="extend_status14" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date14" Type="datetime" />
      <Input Name="extend_status15" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date15" Type="datetime" />
      <Input Name="extend_status16" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date16" Type="datetime" />
      <Input Name="extend_status17" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date17" Type="datetime" />
      <Input Name="extend_status18" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date18" Type="datetime" />
      <Input Name="extend_status19" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date19" Type="datetime" />
      <Input Name="extend_status20" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date20" Type="datetime" />
      <Input Name="extend_status21" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date21" Type="datetime" />
      <Input Name="extend_status22" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date22" Type="datetime" />
      <Input Name="extend_status23" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date23" Type="datetime" />
      <Input Name="extend_status24" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date24" Type="datetime" />
      <Input Name="extend_status25" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date25" Type="datetime" />
      <Input Name="extend_status26" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date26" Type="datetime" />
      <Input Name="extend_status27" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date27" Type="datetime" />
      <Input Name="extend_status28" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date28" Type="datetime" />
      <Input Name="extend_status29" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date29" Type="datetime" />
      <Input Name="extend_status30" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date30" Type="datetime" />
      <Input Name="fixed_purchase_order_count" Type="int" />
      <Input Name="fixed_purchase_shipped_count" Type="int" />
      <Input Name="extend_status31" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date31" Type="datetime" />
      <Input Name="extend_status32" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date32" Type="datetime" />
      <Input Name="extend_status33" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date33" Type="datetime" />
      <Input Name="extend_status34" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date34" Type="datetime" />
      <Input Name="extend_status35" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date35" Type="datetime" />
      <Input Name="extend_status36" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date36" Type="datetime" />
      <Input Name="extend_status37" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date37" Type="datetime" />
      <Input Name="extend_status38" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date38" Type="datetime" />
      <Input Name="extend_status39" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date39" Type="datetime" />
      <Input Name="extend_status40" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date40" Type="datetime" />
      <Input Name="last_order_point_use" Type="decimal" />
      <Input Name="last_order_point_use_yen" Type="decimal" />
      <Input Name="mall_link_status" Type="nvarchar" Size="20" />
      <Input Name="order_price_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_subtotal_tax" Type="decimal" Size="18,3" />
      <Input Name="settlement_currency" Type="nvarchar" Size="3" />
      <Input Name="settlement_rate" Type="decimal" Size="24,12" />
      <Input Name="settlement_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_memo" Type="nvarchar" Size="MAX" />
      <Input Name="shipping_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="payment_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="order_count_order" Type="int" />
      <Input Name="invoice_bundle_flg" Type="nvarchar" Size="1" />
      <Input Name="inflow_contents_id" Type="nvarchar" Size="30" />
      <Input Name="inflow_contents_type" Type="nvarchar" Size="20" />
      <Input Name="receipt_flg" Type="nvarchar" Size="1" />
      <Input Name="receipt_address" Type="nvarchar" Size="100" />
      <Input Name="receipt_proviso" Type="nvarchar" Size="100" />
      <Input Name="delivery_tran_id" Type="nvarchar" Size="100" />
      <Input Name="online_delivery_status" Type="nvarchar" Size="2" />
      <Input Name="external_payment_type" Type="nvarchar" Size="20" />
      <Input Name="credit_branch_no" Type="int" />
      <Input Name="attribute1" Type="nvarchar" Size="100" />
      <Input Name="attribute2" Type="nvarchar" Size="100" />
      <Input Name="attribute3" Type="nvarchar" Size="100" />
      <Input Name="attribute4" Type="nvarchar" Size="100" />
      <Input Name="attribute5" Type="nvarchar" Size="100" />
      <Input Name="attribute6" Type="nvarchar" Size="100" />
      <Input Name="attribute7" Type="nvarchar" Size="100" />
      <Input Name="attribute8" Type="nvarchar" Size="100" />
      <Input Name="attribute9" Type="nvarchar" Size="100" />
      <Input Name="attribute10" Type="nvarchar" Size="100" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
      <Input Name="order_subscription_box_order_count" Type="int" />
      <Input Name="storepickup_status" Type="nvarchar" Size="30" />
      <Input Name="storepickup_store_arrived_date" Type="datetime" />
      <Input Name="storepickup_delivered_complete_date" Type="datetime" />
      <Input Name="storepickup_return_date" Type="datetime" />
    </Parameter>
  </InsertOrder>

  <!-- 注文者情報登録 -->
  <InsertOwner>
    <Statement>
      <![CDATA[
      INSERT  w2_OrderOwner
              (
                w2_OrderOwner.order_id,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_sex,
                w2_OrderOwner.owner_birth,
                w2_OrderOwner.date_created,
                w2_OrderOwner.date_changed,
                w2_OrderOwner.access_country_iso_code,
                w2_OrderOwner.disp_language_code,
                w2_OrderOwner.disp_language_locale_id,
                w2_OrderOwner.disp_currency_code,
                w2_OrderOwner.disp_currency_locale_id,
                w2_OrderOwner.owner_addr_country_iso_code,
                w2_OrderOwner.owner_addr_country_name,
                w2_OrderOwner.owner_addr5
              )
      VALUES  (
                @order_id,
                @owner_kbn,
                @owner_name,
                @owner_name1,
                @owner_name2,
                @owner_name_kana,
                @owner_name_kana1,
                @owner_name_kana2,
                @owner_mail_addr,
                @owner_mail_addr2,
                @owner_zip,
                @owner_addr1,
                @owner_addr2,
                @owner_addr3,
                @owner_addr4,
                @owner_company_name,
                @owner_company_post_name,
                @owner_tel1,
                CASE WHEN @owner_sex <> ''
                  THEN @owner_sex
                  ELSE 'UNKNOWN'
                  END,
                @owner_birth,
                @date_created,
                @date_changed,
                @access_country_iso_code,
                @disp_language_code,
                @disp_language_locale_id,
                @disp_currency_code,
                @disp_currency_locale_id,
                @owner_addr_country_iso_code,
                @owner_addr_country_name,
                @owner_addr5
              )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_name_kana" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana1" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana2" Type="nvarchar" Size="60" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_mail_addr2" Type="nvarchar" Size="256" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_company_name" Type="nvarchar" Size="50" />
      <Input Name="owner_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
      <Input Name="owner_sex" Type="nvarchar" Size="10" />
      <Input Name="owner_birth" Type="datetime" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="access_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="disp_language_code" Type="nvarchar" Size="4" />
      <Input Name="disp_language_locale_id" Type="nvarchar" Size="7" />
      <Input Name="disp_currency_code" Type="nvarchar" Size="4" />
      <Input Name="disp_currency_locale_id" Type="nvarchar" Size="7" />
      <Input Name="owner_addr_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="owner_addr_country_name" Type="nvarchar" Size="100" />
      <Input Name="owner_addr5" Type="nvarchar" Size="50" />
    </Parameter>
  </InsertOwner>

  <!-- 返品交換向け注文登録 -->
  <InsertOrderForOrderReturnExchange>
    <Statement>
      <![CDATA[
        INSERT  w2_Order
                (
                  order_id,
                  order_id_org,
                  user_id,
                  shop_id,
                  order_kbn,
                  mall_id,
                  order_payment_kbn,
                  order_status,
                  order_payment_status,
                  demand_status,
                  order_date,
                  order_item_count,
                  order_product_count,order_price_subtotal,
                  order_price_total,shipping_id,
                  shipped_changed_kbn,
                  return_exchange_kbn,
                  return_exchange_reason_kbn,
                  return_exchange_reason_memo,
                  order_price_repayment,
                  repayment_memo,
                  order_return_exchange_status,
                  order_return_exchange_receipt_date,
                  order_repayment_status,
                  order_price_regulation,
                  regulation_memo,
                  last_changed,
                  gift_flg,
                  order_tax_included_flg,
                  order_tax_rate,
                  order_tax_round_type,
                  member_rank_id,
                  fixed_purchase_order_count,
                  fixed_purchase_shipped_count,
                  card_tran_id,
                  payment_order_id,
                  credit_branch_no,
                  card_instruments,
                  card_installments_code,
                  last_billed_amount,
                  external_payment_status,
                  external_payment_auth_date,
                  online_payment_status,
                  payment_memo,
                  order_point_use,
                  order_point_use_yen,
                  last_order_point_use,
                  last_order_point_use_yen,
                  last_auth_flg,
                  order_price_tax,
                  order_price_subtotal_tax,
                  settlement_currency,
                  settlement_rate,
                  settlement_amount,
                  shipping_tax_rate,
                  payment_tax_rate,
                  invoice_bundle_flg,
                  external_payment_type,
                  fixed_purchase_id,
                  subscription_box_course_id,
                  subscription_box_fixed_amount,
                  order_subscription_box_order_count
                )
        VALUES  (
                  @order_id,
                  @order_id_org,
                  @user_id,
                  @shop_id,
                  @order_kbn,
                  @mall_id,
                  @order_payment_kbn,
                  '', -- 指定無し（返品、交換注文の場合）
                  9, -- 指定無し（返品、交換注文の場合）
                  9,  -- 指定無し（返品、交換注文の場合）
                  GETDATE(),
                  @order_item_count,
                  @order_product_count,
                  @order_price_subtotal,
                  @order_price_total, -- 小計＋調整金額
                  @shipping_id,
                  '00', -- 指定無し
                  @return_exchange_kbn,
                  @return_exchange_reason_kbn,
                  @return_exchange_reason_memo,
                  @order_price_repayment,
                  @repayment_memo,
                  @order_return_exchange_status,
                  @order_return_exchange_receipt_date,
                  @order_repayment_status,
                  @order_price_regulation,
                  @regulation_memo,
                  @last_changed,
                  @gift_flg,
                  @order_tax_included_flg,
                  @order_tax_rate,
                  @order_tax_round_type,
                  @member_rank_id,
                  @fixed_purchase_order_count,
                  @fixed_purchase_shipped_count,
                  @card_tran_id,
                  @payment_order_id,
                  @credit_branch_no,
                  @card_instruments,@card_installments_code,
                  @last_billed_amount,
                  @external_payment_status,
                  @external_payment_auth_date,
                  @online_payment_status,
                  @payment_memo,
                  @order_point_use,
                  @order_point_use_yen,
                  @last_order_point_use,
                  @last_order_point_use_yen,
                  @last_auth_flg,
                  @order_price_tax,
                  @order_price_subtotal_tax,
                  @settlement_currency,
                  @settlement_rate,
                  @settlement_amount,
                  @shipping_tax_rate,
                  @payment_tax_rate,
                  @invoice_bundle_flg,
                  @external_payment_type,
                  @fixed_purchase_id,
                  @subscription_box_course_id,
                  @subscription_box_fixed_amount,
                  @order_subscription_box_order_count
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="order_date" Type="datetime" />
      <Input Name="order_item_count" Type="int" />
      <Input Name="order_product_count" Type="int" />
      <Input Name="order_price_subtotal" Type="decimal" Size="18,3" />
      <Input Name="order_price_shipping" Type="decimal" Size="18,3" />
      <Input Name="order_price_exchange" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="order_point_use" Type="decimal" />
      <Input Name="order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="order_point_add" Type="decimal" />
      <Input Name="card_kbn" Type="nvarchar" Size="30" />
      <Input Name="card_instruments" Type="nvarchar" Size="100" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_reason_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_reason_memo" Type="nvarchar" Size="MAX" />
      <Input Name="order_price_repayment" Type="decimal" Size="18,3" />
      <Input Name="repayment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="order_return_exchange_status" Type="nvarchar" Size="10" />
      <Input Name="order_return_exchange_receipt_date" Type="datetime" />
      <Input Name="order_repayment_status" Type="nvarchar" Size="10" />
      <Input Name="order_repayment_date" Type="datetime" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="regulation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="payment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="management_memo" Type="nvarchar" Size="MAX" />
      <Input Name="relation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="gift_flg" Type="nvarchar" Size="2" />
      <Input Name="order_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_rate" Type="decimal" />
      <Input Name="order_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="fixed_purchase_order_count" Type="int" />
      <Input Name="fixed_purchase_shipped_count" Type="int" />
      <Input Name="card_tran_id" Type="nvarchar" Size="100" />
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
      <Input Name="credit_branch_no" Type="int" />
      <Input Name="card_installments_code" Type="nvarchar" Size="10" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="external_payment_status" Type="nvarchar" Size="30" />
      <Input Name="external_payment_auth_date" Type="datetime" />
      <Input Name="online_payment_status" Type="nvarchar" Size="2" />
      <Input Name="order_point_use" Type="decimal" />
      <Input Name="order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="last_order_point_use" Type="decimal" />
      <Input Name="last_order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="last_auth_flg" Type="nvarchar" Size="1" />
      <Input Name="order_price_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_subtotal_tax" Type="decimal" Size="18,3" />
      <Input Name="settlement_currency" Type="nvarchar" Size="3" />
      <Input Name="settlement_rate" Type="decimal" Size="24,12" />
      <Input Name="settlement_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="payment_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="invoice_bundle_flg" Type="nvarchar" Size="1" />
      <Input Name="external_payment_type" Type="nvarchar" Size="20" />
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
      <Input Name="order_subscription_box_order_count" Type="int" />
    </Parameter>
  </InsertOrderForOrderReturnExchange>

  <!-- 返品交換向け注文者情報登録 -->
  <InsertOrderOwnerForOrderReturnExchange>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderOwner
                (
                  order_id,
                  owner_kbn,
                  owner_name,
                  owner_name1,
                  owner_name2,
                  owner_name_kana,
                  owner_name_kana1,
                  owner_name_kana2,
                  owner_mail_addr,
                  owner_mail_addr2,
                  owner_zip,
                  owner_addr1,
                  owner_addr2,
                  owner_addr3,
                  owner_addr4,
                  owner_company_name,
                  owner_company_post_name,
                  owner_tel1,
                  owner_sex,
                  owner_birth,
                  access_country_iso_code,
                  disp_language_code,
                  disp_language_locale_id,
                  disp_currency_code,
                  disp_currency_locale_id,
                  owner_addr_country_iso_code,
                  owner_addr_country_name,
                  owner_addr5
                )
        SELECT  @order_id,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_sex,
                w2_OrderOwner.owner_birth,
                w2_OrderOwner.access_country_iso_code,
                w2_OrderOwner.disp_language_code,
                w2_OrderOwner.disp_language_locale_id,
                w2_OrderOwner.disp_currency_code,
                w2_OrderOwner.disp_currency_locale_id,
                w2_OrderOwner.owner_addr_country_iso_code,
                w2_OrderOwner.owner_addr_country_name,
                w2_OrderOwner.owner_addr5
         FROM   w2_OrderOwner
        WHERE   w2_OrderOwner.order_id = @order_id_org  -- 元注文ID
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </InsertOrderOwnerForOrderReturnExchange>

  <!-- 注文配送先情報追加処理 -->
  <InsertOrderShippingForOrderReturnExchange>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderShipping
                (
                  order_id,
                  order_shipping_no,
                  shipping_name,
                  shipping_name1,
                  shipping_name2,
                  shipping_name_kana,
                  shipping_name_kana1,
                  shipping_name_kana2,
                  shipping_zip,
                  shipping_addr1,
                  shipping_addr2,
                  shipping_addr3,
                  shipping_addr4,
                  shipping_company_name,
                  shipping_company_post_name,
                  shipping_tel1,
                  sender_name,
                  sender_name1,
                  sender_name2,
                  sender_name_kana,
                  sender_name_kana1,
                  sender_name_kana2,
                  sender_zip,
                  sender_addr1,
                  sender_addr2,
                  sender_addr3,
                  sender_addr4,
                  sender_company_name,
                  sender_company_post_name,
                  sender_tel1,
                  shipping_date,
                  shipping_time,
                  wrapping_paper_type,
                  wrapping_paper_name,
                  wrapping_bag_type,
                  shipping_method,
                  delivery_company_id,
                  shipping_country_iso_code,
                  shipping_country_name,
                  shipping_addr5,
                  sender_country_iso_code,
                  sender_country_name,
                  sender_addr5,
                  shipping_receiving_store_flg,
                  shipping_receiving_store_id,
                  shipping_external_deliverty_status,
                  shipping_status,
                  shipping_status_update_date,
                  shipping_receiving_mail_date,
                  shipping_receiving_store_type,
                  storepickup_real_shop_id
                )
        SELECT  @order_id,
                @order_shipping_no,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_name1,
                w2_OrderShipping.shipping_name2,
                w2_OrderShipping.shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.sender_name,
                w2_OrderShipping.sender_name1,
                w2_OrderShipping.sender_name2,
                w2_OrderShipping.sender_name_kana,
                w2_OrderShipping.sender_name_kana1,
                w2_OrderShipping.sender_name_kana2,
                w2_OrderShipping.sender_zip,
                w2_OrderShipping.sender_addr1,
                w2_OrderShipping.sender_addr2,
                w2_OrderShipping.sender_addr3,
                w2_OrderShipping.sender_addr4,
                w2_OrderShipping.sender_company_name,
                w2_OrderShipping.sender_company_post_name,
                w2_OrderShipping.sender_tel1,
                @shipping_date,
                @shipping_time,
                w2_OrderShipping.wrapping_paper_type,
                w2_OrderShipping.wrapping_paper_name,
                w2_OrderShipping.wrapping_bag_type,
                w2_OrderShipping.shipping_method,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_country_iso_code,
                w2_OrderShipping.shipping_country_name,
                w2_OrderShipping.shipping_addr5,
                w2_OrderShipping.sender_country_iso_code,
                w2_OrderShipping.sender_country_name,
                w2_OrderShipping.sender_addr5,
                @shipping_receiving_store_flg,
                @shipping_receiving_store_id,
                @shipping_external_deliverty_status,
                @shipping_status,
                @shipping_status_update_date,
                @shipping_receiving_mail_date,
                w2_OrderShipping.shipping_receiving_store_type,
                @storepickup_real_shop_id
          FROM  w2_OrderShipping
         WHERE  w2_OrderShipping.order_id = @order_id_org  -- 元注文ID
         AND    w2_OrderShipping.order_shipping_no = @order_shipping_no_org
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no_org" Type="nvarchar" Size="30" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="shipping_receiving_store_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_receiving_store_id" Type="nvarchar" Size="20" />
      <Input Name="shipping_external_deliverty_status" Type="nvarchar" Size="5" />
      <Input Name="shipping_status" Type="nvarchar" Size="10" />
      <Input Name="shipping_status_update_date" Type="datetime" />
      <Input Name="shipping_receiving_mail_date" Type="datetime" />
      <Input Name="storepickup_real_shop_id" Type="nvarchar" Size="30" />
    </Parameter>
  </InsertOrderShippingForOrderReturnExchange>

  <!-- 注文商品情報追加処理(返品用：非入力項目は元注文商品から参照) -->
  <InsertOrderItemForOrderReturnExchange>
    <Statement>
      <![CDATA[
        -- 入力項目以外は、商品マスタから取得
        DECLARE @brand_id nvarchar(30)
        DECLARE @download_url nvarchar(MAX)
        DECLARE @cooperation_id1 nvarchar(30)
        DECLARE @cooperation_id2 nvarchar(30)
        DECLARE @cooperation_id3 nvarchar(30)
        DECLARE @cooperation_id4 nvarchar(30)
        DECLARE @cooperation_id5 nvarchar(30)
        DECLARE @cooperation_id6 nvarchar(50)
        DECLARE @cooperation_id7 nvarchar(50)
        DECLARE @cooperation_id8 nvarchar(50)
        DECLARE @cooperation_id9 nvarchar(50)
        DECLARE @cooperation_id10 nvarchar(50)
        DECLARE @bundle_item_display_type nvarchar(10)
        DECLARE @shipping_size_kbn nvarchar(4)
        
        SELECT  @brand_id = w2_Product.brand_id1,
                @download_url = w2_ProductVariationView.variation_download_url,
                @cooperation_id1 = w2_ProductVariationView.variation_cooperation_id1,
                @cooperation_id2 = w2_ProductVariationView.variation_cooperation_id2,
                @cooperation_id3 = w2_ProductVariationView.variation_cooperation_id3,
                @cooperation_id4 = w2_ProductVariationView.variation_cooperation_id4,
                @cooperation_id5 = w2_ProductVariationView.variation_cooperation_id5,
                @cooperation_id6 = w2_ProductVariationView.variation_cooperation_id6,
                @cooperation_id7 = w2_ProductVariationView.variation_cooperation_id7,
                @cooperation_id8 = w2_ProductVariationView.variation_cooperation_id8,
                @cooperation_id9 = w2_ProductVariationView.variation_cooperation_id9,
                @cooperation_id10 = w2_ProductVariationView.variation_cooperation_id10,
                @bundle_item_display_type = w2_Product.bundle_item_display_type,
                @shipping_size_kbn = w2_Product.shipping_size_kbn
          FROM  w2_Product
                INNER JOIN w2_ProductVariationView ON
                (
                  w2_Product.shop_id = w2_ProductVariationView.shop_id
                  AND
                  w2_Product.product_id = w2_ProductVariationView.product_id
                )
         WHERE  w2_Product.shop_id = @shop_id
           AND  w2_Product.product_id = @product_id
           AND  w2_ProductVariationView.variation_id = @variation_id

        INSERT  w2_OrderItem
                (
                  w2_OrderItem.order_id,
                  w2_OrderItem.order_item_no,
                  w2_OrderItem.order_shipping_no,
                  w2_OrderItem.shop_id,
                  w2_OrderItem.product_id,
                  w2_OrderItem.variation_id,
                  w2_OrderItem.supplier_id,
                  w2_OrderItem.product_name,
                  w2_OrderItem.product_name_kana,
                  w2_OrderItem.product_price,
                  w2_OrderItem.product_tax_included_flg,
                  w2_OrderItem.product_tax_rate,
                  w2_OrderItem.product_tax_round_type,
                  w2_OrderItem.product_price_pretax,
                  w2_OrderItem.item_quantity,
                  w2_OrderItem.item_quantity_single,
                  w2_OrderItem.item_price,
                  w2_OrderItem.item_price_tax,
                  w2_OrderItem.item_price_single,
                  w2_OrderItem.item_return_exchange_kbn,
                  w2_OrderItem.product_option_texts,
                  w2_OrderItem.brand_id,
                  w2_OrderItem.productsale_id,
                  w2_OrderItem.download_url,
                  w2_OrderItem.cooperation_id1,
                  w2_OrderItem.cooperation_id2,
                  w2_OrderItem.cooperation_id3,
                  w2_OrderItem.cooperation_id4,
                  w2_OrderItem.cooperation_id5,
                  w2_OrderItem.cooperation_id6,
                  w2_OrderItem.cooperation_id7,
                  w2_OrderItem.cooperation_id8,
                  w2_OrderItem.cooperation_id9,
                  w2_OrderItem.cooperation_id10,
                  w2_OrderItem.order_setpromotion_no,
                  w2_OrderItem.order_setpromotion_item_no,
                  w2_OrderItem.novelty_id,
                  w2_OrderItem.recommend_id,
                  w2_OrderItem.fixed_purchase_product_flg,
                  w2_OrderItem.product_bundle_id,
                  w2_OrderItem.bundle_item_display_type,
                  w2_OrderItem.item_discounted_price,
                  w2_OrderItem.shipping_size_kbn,
                  w2_OrderItem.subscription_box_course_id,
                  w2_OrderItem.subscription_box_fixed_amount
                )
        VALUES  (
                  @order_id,
                  @order_item_no,
                  @order_shipping_no,
                  @shop_id,
                  @product_id,
                  @variation_id,
                  @supplier_id,
                  @product_name,
                  @product_name_kana,
                  @product_price,
                  @product_tax_included_flg,
                  @product_tax_rate,
                  @product_tax_round_type,
                  @product_price_pretax,
                  @item_quantity,
                  @item_quantity,
                  @item_price,
                  @item_price_tax,
                  @item_price,
                  @item_return_exchange_kbn,
                  @product_option_texts,
                  @brand_id,
                  @productsale_id,
                  @download_url,
                  @cooperation_id1,
                  @cooperation_id2,
                  @cooperation_id3,
                  @cooperation_id4,
                  @cooperation_id5,
                  @cooperation_id6,
                  @cooperation_id7,
                  @cooperation_id8,
                  @cooperation_id9,
                  @cooperation_id10,
                  @order_setpromotion_no,
                  @order_setpromotion_item_no,
                  @novelty_id,
                  @recommend_id,
                  @fixed_purchase_product_flg,
                  @product_bundle_id,
                  @bundle_item_display_type,
                  @item_discounted_price,
                  @shipping_size_kbn,
                  @subscription_box_course_id,
                  @subscription_box_fixed_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="supplier_id" Type="nvarchar" Size="20" />
      <Input Name="product_name" Type="nvarchar" Size="200" />
      <Input Name="product_name_kana" Type="nvarchar" Size="200" />
      <Input Name="product_price" Type="decimal" Size="18,3" />
      <Input Name="product_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="product_tax_rate" Type="decimal" />
      <Input Name="product_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="product_price_pretax" Type="decimal" Size="18,3" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="item_price" Type="decimal" Size="18,3" />
      <Input Name="item_price_tax" Type="decimal" Size="18,3" />
      <Input Name="item_return_exchange_kbn" Type="nvarchar" Size="10" />
      <Input Name="product_option_texts" Type="nvarchar" Size="max" />
      <Input Name="productsale_id" Type="nvarchar" Size="10" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="order_setpromotion_item_no" Type="int" />
      <Input Name="novelty_id" Type="nvarchar" Size="30" />
      <Input Name="recommend_id" Type="nvarchar" Size="30" />
      <Input Name="fixed_purchase_product_flg" Type="nvarchar" Size="1" />
      <Input Name="product_bundle_id" Type="nvarchar" Size="30" />
      <Input Name="item_discounted_price" Type="decimal" Size="18,3" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertOrderItemForOrderReturnExchange>

  <!-- 注文セットプロモーション情報追加処理 -->
  <InsertOrderSetPromotion>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderSetPromotion
                (
                  order_id,
                  order_setpromotion_no,
                  setpromotion_id,
                  setpromotion_name,
                  setpromotion_disp_name,
                  undiscounted_product_subtotal,
                  product_discount_flg,
                  product_discount_amount,
                  shipping_charge_free_flg,
                  shipping_charge_discount_amount,
                  payment_charge_free_flg,
                  payment_charge_discount_amount
                )
        VALUES  (
                  @order_id,
                  @order_setpromotion_no,
                  @setpromotion_id,
                  @setpromotion_name,
                  @setpromotion_disp_name,
                  @undiscounted_product_subtotal,
                  @product_discount_flg,
                  @product_discount_amount,
                  @shipping_charge_free_flg,
                  @shipping_charge_discount_amount,
                  @payment_charge_free_flg,
                  @payment_charge_discount_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="setpromotion_id" Type="nvarchar" Size="10" />
      <Input Name="setpromotion_name" Type="nvarchar" Size="30" />
      <Input Name="setpromotion_disp_name" Type="nvarchar" Size="30" />
      <Input Name="undiscounted_product_subtotal" Type="decimal" Size="18,3" />
      <Input Name="product_discount_flg" Type="nvarchar" Size="1" />
      <Input Name="product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="payment_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="payment_charge_discount_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertOrderSetPromotion>

  <!-- 税率毎価格情報追加処理 -->
  <InsertOrderPriceInfoByTaxRate>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderPriceByTaxRate
                (
                  order_id
                  ,key_tax_rate
                  ,price_subtotal_by_rate
                  ,price_shipping_by_rate
                  ,price_payment_by_rate
                  ,return_price_correction_by_rate
                  ,price_total_by_rate
                  ,tax_price_by_rate
                )
        VALUES  (
                  @order_id
                  ,@key_tax_rate
                  ,@price_subtotal_by_rate
                  ,@price_shipping_by_rate
                  ,@price_payment_by_rate
                  ,@return_price_correction_by_rate
                  ,@price_total_by_rate
                  ,@tax_price_by_rate
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="key_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="price_subtotal_by_rate" Type="decimal" />
      <Input Name="price_shipping_by_rate" Type="decimal" />
      <Input Name="price_payment_by_rate" Type="decimal" />
      <Input Name="return_price_correction_by_rate" Type="decimal" />
      <Input Name="price_total_by_rate" Type="decimal" />
      <Input Name="tax_price_by_rate" Type="decimal" />
    </Parameter>
  </InsertOrderPriceInfoByTaxRate>

  <!-- 更新 -->
  <Update>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  order_id_org = @order_id_org
                ,order_group_id = @order_group_id
                ,order_no = @order_no
                ,bundle_child_order_ids = @bundle_child_order_ids
                ,bundle_parent_order_id = @bundle_parent_order_id
                ,bundle_order_bak = @bundle_order_bak
                ,user_id = @user_id
                ,shop_id = @shop_id
                ,supplier_id = @supplier_id
                ,order_kbn = @order_kbn
                ,mall_id = @mall_id
                ,order_payment_kbn = @order_payment_kbn
                ,order_status = @order_status
                ,order_date = @order_date
                ,order_recognition_date = @order_recognition_date
                ,order_stockreserved_status = @order_stockreserved_status
                ,order_stockreserved_date = @order_stockreserved_date
                ,order_shipping_date = @order_shipping_date
                ,order_shipped_status = @order_shipped_status
                ,order_shipped_date = @order_shipped_date
                ,order_delivering_date = @order_delivering_date
                ,order_cancel_date = @order_cancel_date
                ,order_return_date = @order_return_date
                ,order_payment_status = @order_payment_status
                ,order_payment_date = @order_payment_date
                ,demand_status = @demand_status
                ,demand_date = @demand_date
                ,order_return_exchange_status = @order_return_exchange_status
                ,order_return_exchange_receipt_date = @order_return_exchange_receipt_date
                ,order_return_exchange_arrival_date = @order_return_exchange_arrival_date
                ,order_return_exchange_complete_date = @order_return_exchange_complete_date
                ,order_repayment_status = @order_repayment_status
                ,order_repayment_date = @order_repayment_date
                ,order_item_count = @order_item_count
                ,order_product_count = @order_product_count
                ,order_price_subtotal = @order_price_subtotal
                ,order_price_pack = @order_price_pack
                ,order_price_tax = @order_price_tax
                ,order_price_subtotal_tax = @order_price_subtotal_tax
                ,order_price_shipping = @order_price_shipping
                ,order_price_exchange = @order_price_exchange
                ,order_price_regulation = @order_price_regulation
                ,order_price_repayment = @order_price_repayment
                ,order_price_total = @order_price_total
                ,order_discount_set_price = @order_discount_set_price
                ,order_point_use = @order_point_use
                ,order_point_use_yen = @order_point_use_yen
                ,order_point_add = @order_point_add
                ,order_point_rate = @order_point_rate
                ,order_coupon_use = @order_coupon_use
                ,card_kbn = @card_kbn
                ,card_instruments = @card_instruments
                ,card_tran_id = @card_tran_id
                ,shipping_id = @shipping_id
                ,fixed_purchase_id = @fixed_purchase_id
                ,advcode_first = @advcode_first
                ,advcode_new = @advcode_new
                ,shipped_changed_kbn = @shipped_changed_kbn
                ,return_exchange_kbn = @return_exchange_kbn
                ,return_exchange_reason_kbn = @return_exchange_reason_kbn
                ,attribute1 = @attribute1
                ,attribute2 = @attribute2
                ,attribute3 = @attribute3
                ,attribute4 = @attribute4
                ,attribute5 = @attribute5
                ,attribute6 = @attribute6
                ,attribute7 = @attribute7
                ,attribute8 = @attribute8
                ,attribute9 = @attribute9
                ,attribute10 = @attribute10
                ,extend_status1 = @extend_status1
                ,extend_status_date1 = @extend_status_date1
                ,extend_status2 = @extend_status2
                ,extend_status_date2 = @extend_status_date2
                ,extend_status3 = @extend_status3
                ,extend_status_date3 = @extend_status_date3
                ,extend_status4 = @extend_status4
                ,extend_status_date4 = @extend_status_date4
                ,extend_status5 = @extend_status5
                ,extend_status_date5 = @extend_status_date5
                ,extend_status6 = @extend_status6
                ,extend_status_date6 = @extend_status_date6
                ,extend_status7 = @extend_status7
                ,extend_status_date7 = @extend_status_date7
                ,extend_status8 = @extend_status8
                ,extend_status_date8 = @extend_status_date8
                ,extend_status9 = @extend_status9
                ,extend_status_date9 = @extend_status_date9
                ,extend_status10 = @extend_status10
                ,extend_status_date10 = @extend_status_date10
                ,career_id = @career_id
                ,mobile_uid = @mobile_uid
                ,remote_addr = @remote_addr
                ,memo = @memo
                ,wrapping_memo = @wrapping_memo
                ,payment_memo = @payment_memo
                ,management_memo = @management_memo
                ,shipping_memo = @shipping_memo
                ,relation_memo = @relation_memo
                ,return_exchange_reason_memo = @return_exchange_reason_memo
                ,regulation_memo = @regulation_memo
                ,repayment_memo = @repayment_memo
                ,del_flg = @del_flg
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
                ,member_rank_discount_price = @member_rank_discount_price
                ,member_rank_id = @member_rank_id
                ,credit_branch_no = @credit_branch_no
                ,affiliate_session_name1 = @affiliate_session_name1
                ,affiliate_session_value1 = @affiliate_session_value1
                ,affiliate_session_name2 = @affiliate_session_name2
                ,affiliate_session_value2 = @affiliate_session_value2
                ,user_agent = @user_agent
                ,gift_flg = @gift_flg
                ,digital_contents_flg = @digital_contents_flg
                ,card_3dsecure_tran_id = @card_3dsecure_tran_id
                ,card_3dsecure_auth_url = @card_3dsecure_auth_url
                ,card_3dsecure_auth_key = @card_3dsecure_auth_key
                ,shipping_price_separate_estimates_flg = @shipping_price_separate_estimates_flg
                ,order_tax_included_flg = @order_tax_included_flg
                ,order_tax_rate = @order_tax_rate
                ,order_tax_round_type = @order_tax_round_type
                ,extend_status11 = @extend_status11
                ,extend_status_date11 = @extend_status_date11
                ,extend_status12 = @extend_status12
                ,extend_status_date12 = @extend_status_date12
                ,extend_status13 = @extend_status13
                ,extend_status_date13 = @extend_status_date13
                ,extend_status14 = @extend_status14
                ,extend_status_date14 = @extend_status_date14
                ,extend_status15 = @extend_status15
                ,extend_status_date15 = @extend_status_date15
                ,extend_status16 = @extend_status16
                ,extend_status_date16 = @extend_status_date16
                ,extend_status17 = @extend_status17
                ,extend_status_date17 = @extend_status_date17
                ,extend_status18 = @extend_status18
                ,extend_status_date18 = @extend_status_date18
                ,extend_status19 = @extend_status19
                ,extend_status_date19 = @extend_status_date19
                ,extend_status20 = @extend_status20
                ,extend_status_date20 = @extend_status_date20
                ,extend_status21 = @extend_status21
                ,extend_status_date21 = @extend_status_date21
                ,extend_status22 = @extend_status22
                ,extend_status_date22 = @extend_status_date22
                ,extend_status23 = @extend_status23
                ,extend_status_date23 = @extend_status_date23
                ,extend_status24 = @extend_status24
                ,extend_status_date24 = @extend_status_date24
                ,extend_status25 = @extend_status25
                ,extend_status_date25 = @extend_status_date25
                ,extend_status26 = @extend_status26
                ,extend_status_date26 = @extend_status_date26
                ,extend_status27 = @extend_status27
                ,extend_status_date27 = @extend_status_date27
                ,extend_status28 = @extend_status28
                ,extend_status_date28 = @extend_status_date28
                ,extend_status29 = @extend_status29
                ,extend_status_date29 = @extend_status_date29
                ,extend_status30 = @extend_status30
                ,extend_status_date30 = @extend_status_date30
                ,extend_status31 = @extend_status31
                ,extend_status_date31 = @extend_status_date31
                ,extend_status32 = @extend_status32
                ,extend_status_date32 = @extend_status_date32
                ,extend_status33 = @extend_status33
                ,extend_status_date33 = @extend_status_date33
                ,extend_status34 = @extend_status34
                ,extend_status_date34 = @extend_status_date34
                ,extend_status35 = @extend_status35
                ,extend_status_date35 = @extend_status_date35
                ,extend_status36 = @extend_status36
                ,extend_status_date36 = @extend_status_date36
                ,extend_status37 = @extend_status37
                ,extend_status_date37 = @extend_status_date37
                ,extend_status38 = @extend_status38
                ,extend_status_date38 = @extend_status_date38
                ,extend_status39 = @extend_status39
                ,extend_status_date39 = @extend_status_date39
                ,extend_status40 = @extend_status40
                ,extend_status_date40 = @extend_status_date40
                ,card_installments_code = @card_installments_code
                ,setpromotion_product_discount_amount = @setpromotion_product_discount_amount
                ,setpromotion_shipping_charge_discount_amount = @setpromotion_shipping_charge_discount_amount
                ,setpromotion_payment_charge_discount_amount = @setpromotion_payment_charge_discount_amount
                ,online_payment_status = @online_payment_status
                ,fixed_purchase_order_count = @fixed_purchase_order_count
                ,fixed_purchase_shipped_count = @fixed_purchase_shipped_count
                ,fixed_purchase_discount_price = @fixed_purchase_discount_price
                ,payment_order_id = @payment_order_id
                ,fixed_purchase_member_discount_amount = @fixed_purchase_member_discount_amount
                ,external_payment_status = @external_payment_status
                ,external_payment_auth_date = @external_payment_auth_date
                ,external_payment_error_message = @external_payment_error_message
                ,last_billed_amount = @last_billed_amount
                ,last_order_point_use = @last_order_point_use
                ,last_order_point_use_yen = @last_order_point_use_yen
                ,external_order_id = @external_order_id
                ,external_import_status = @external_import_status
                ,combined_org_order_ids = @combined_org_order_ids
                ,last_auth_flg = @last_auth_flg
                ,mall_link_status = @mall_link_status
                ,settlement_currency = @settlement_currency
                ,settlement_rate = @settlement_rate
                ,settlement_amount = @settlement_amount
                ,shipping_tax_rate = @shipping_tax_rate
                ,payment_tax_rate = @payment_tax_rate
                ,invoice_bundle_flg = @invoice_bundle_flg
                ,inflow_contents_id = @inflow_contents_id
                ,inflow_contents_type =@inflow_contents_type
                ,receipt_flg = @receipt_flg
                ,receipt_output_flg = @receipt_output_flg
                ,receipt_address = @receipt_address
                ,receipt_proviso = @receipt_proviso
                ,delivery_tran_id = @delivery_tran_id
                ,online_delivery_status = @online_delivery_status
                ,w2_Order.external_payment_type = @external_payment_type
                ,logi_cooperation_status = @logi_cooperation_status
                ,extend_status41 = @extend_status41
                ,extend_status_date41 = @extend_status_date41
                ,extend_status42 = @extend_status42
                ,extend_status_date42 = @extend_status_date42
                ,extend_status43 = @extend_status43
                ,extend_status_date43 = @extend_status_date43
                ,extend_status44 = @extend_status44
                ,extend_status_date44 = @extend_status_date44
                ,extend_status45 = @extend_status45
                ,extend_status_date45 = @extend_status_date45
                ,extend_status46 = @extend_status46
                ,extend_status_date46 = @extend_status_date46
                ,extend_status47 = @extend_status47
                ,extend_status_date47 = @extend_status_date47
                ,extend_status48 = @extend_status48
                ,extend_status_date48 = @extend_status_date48
                ,extend_status49 = @extend_status49
                ,extend_status_date49 = @extend_status_date49
                ,extend_status50 = @extend_status50
                ,extend_status_date50 = @extend_status_date50
                ,card_tran_pass = @card_tran_pass
                ,storepickup_status = @storepickup_status
                <@@hasval:storepickup_store_arrived_date@@>
                ,storepickup_store_arrived_date = @storepickup_store_arrived_date
                </@@hasval:storepickup_store_arrived_date@@>
                <@@hasval:storepickup_delivered_complete_date@@>
                ,storepickup_delivered_complete_date = @storepickup_delivered_complete_date
                </@@hasval:storepickup_delivered_complete_date@@>
                <@@hasval:storepickup_return_date@@>
                ,storepickup_return_date = @storepickup_return_date
                </@@hasval:storepickup_return_date@@>
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_group_id" Type="nvarchar" Size="30" />
      <Input Name="order_no" Type="nvarchar" Size="30" />
      <Input Name="bundle_child_order_ids" Type="ntext" />
      <Input Name="bundle_parent_order_id" Type="nvarchar" Size="30" />
      <Input Name="bundle_order_bak" Type="ntext" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="supplier_id" Type="nvarchar" Size="20" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="order_date" Type="datetime" />
      <Input Name="order_recognition_date" Type="datetime" />
      <Input Name="order_stockreserved_status" Type="nvarchar" Size="10" />
      <Input Name="order_stockreserved_date" Type="datetime" />
      <Input Name="order_shipping_date" Type="datetime" />
      <Input Name="order_shipped_status" Type="nvarchar" Size="10" />
      <Input Name="order_shipped_date" Type="datetime" />
      <Input Name="order_delivering_date" Type="datetime" />
      <Input Name="order_cancel_date" Type="datetime" />
      <Input Name="order_return_date" Type="datetime" />
      <Input Name="order_payment_status" Type="nvarchar" Size="1" />
      <Input Name="order_payment_date" Type="datetime" />
      <Input Name="demand_status" Type="nvarchar" Size="1" />
      <Input Name="demand_date" Type="datetime" />
      <Input Name="order_return_exchange_status" Type="nvarchar" Size="10" />
      <Input Name="order_return_exchange_receipt_date" Type="datetime" />
      <Input Name="order_return_exchange_arrival_date" Type="datetime" />
      <Input Name="order_return_exchange_complete_date" Type="datetime" />
      <Input Name="order_repayment_status" Type="nvarchar" Size="10" />
      <Input Name="order_repayment_date" Type="datetime" />
      <Input Name="order_item_count" Type="int" />
      <Input Name="order_product_count" Type="int" />
      <Input Name="order_price_subtotal" Type="decimal" Size="18,3" />
      <Input Name="order_price_subtotal_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_pack" Type="decimal" />
      <Input Name="order_price_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_shipping" Type="decimal" Size="18,3" />
      <Input Name="order_price_exchange" Type="decimal" Size="18,3" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="order_price_repayment" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="order_discount_set_price" Type="decimal" Size="18,3" />
      <Input Name="order_point_use" Type="decimal" />
      <Input Name="order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="order_point_add" Type="decimal" />
      <Input Name="order_point_rate" Type="decimal" />
      <Input Name="order_coupon_use" Type="decimal" Size="18,3" />
      <Input Name="card_kbn" Type="nvarchar" Size="30" />
      <Input Name="card_instruments" Type="nvarchar" Size="30" />
      <Input Name="card_tran_id" Type="nvarchar" Size="100" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
      <Input Name="advcode_first" Type="nvarchar" Size="30" />
      <Input Name="advcode_new" Type="nvarchar" Size="30" />
      <Input Name="shipped_changed_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_kbn" Type="nvarchar" Size="10" />
      <Input Name="return_exchange_reason_kbn" Type="nvarchar" Size="10" />
      <Input Name="attribute1" Type="nvarchar" Size="100" />
      <Input Name="attribute2" Type="nvarchar" Size="100" />
      <Input Name="attribute3" Type="nvarchar" Size="100" />
      <Input Name="attribute4" Type="nvarchar" Size="100" />
      <Input Name="attribute5" Type="nvarchar" Size="100" />
      <Input Name="attribute6" Type="nvarchar" Size="100" />
      <Input Name="attribute7" Type="nvarchar" Size="100" />
      <Input Name="attribute8" Type="nvarchar" Size="100" />
      <Input Name="attribute9" Type="nvarchar" Size="100" />
      <Input Name="attribute10" Type="nvarchar" Size="100" />
      <Input Name="extend_status1" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date1" Type="datetime" />
      <Input Name="extend_status2" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date2" Type="datetime" />
      <Input Name="extend_status3" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date3" Type="datetime" />
      <Input Name="extend_status4" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date4" Type="datetime" />
      <Input Name="extend_status5" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date5" Type="datetime" />
      <Input Name="extend_status6" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date6" Type="datetime" />
      <Input Name="extend_status7" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date7" Type="datetime" />
      <Input Name="extend_status8" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date8" Type="datetime" />
      <Input Name="extend_status9" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date9" Type="datetime" />
      <Input Name="extend_status10" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date10" Type="datetime" />
      <Input Name="career_id" Type="nvarchar" Size="10" />
      <Input Name="mobile_uid" Type="nvarchar" Size="50" />
      <Input Name="remote_addr" Type="nvarchar" Size="30" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="wrapping_memo" Type="nvarchar" Size="MAX" />
      <Input Name="payment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="management_memo" Type="nvarchar" Size="MAX" />
      <Input Name="shipping_memo" Type="nvarchar" Size="MAX" />
      <Input Name="relation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="return_exchange_reason_memo" Type="nvarchar" Size="MAX" />
      <Input Name="regulation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="repayment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="del_flg" Type="nvarchar" Size="1" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="member_rank_discount_price" Type="decimal" Size="18,3" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="credit_branch_no" Type="int" />
      <Input Name="affiliate_session_name1" Type="nvarchar" Size="50" />
      <Input Name="affiliate_session_value1" Type="nvarchar" Size="100" />
      <Input Name="affiliate_session_name2" Type="nvarchar" Size="50" />
      <Input Name="affiliate_session_value2" Type="nvarchar" Size="100" />
      <Input Name="user_agent" Type="nvarchar" Size="512" />
      <Input Name="gift_flg" Type="nvarchar" Size="2" />
      <Input Name="digital_contents_flg" Type="nvarchar" Size="2" />
      <Input Name="card_3dsecure_tran_id" Type="nvarchar" Size="100" />
      <Input Name="card_3dsecure_auth_url" Type="nvarchar" Size="MAX" />
      <Input Name="card_3dsecure_auth_key" Type="nvarchar" Size="1000" />
      <Input Name="shipping_price_separate_estimates_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="order_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="extend_status11" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date11" Type="datetime" />
      <Input Name="extend_status12" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date12" Type="datetime" />
      <Input Name="extend_status13" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date13" Type="datetime" />
      <Input Name="extend_status14" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date14" Type="datetime" />
      <Input Name="extend_status15" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date15" Type="datetime" />
      <Input Name="extend_status16" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date16" Type="datetime" />
      <Input Name="extend_status17" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date17" Type="datetime" />
      <Input Name="extend_status18" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date18" Type="datetime" />
      <Input Name="extend_status19" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date19" Type="datetime" />
      <Input Name="extend_status20" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date20" Type="datetime" />
      <Input Name="extend_status21" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date21" Type="datetime" />
      <Input Name="extend_status22" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date22" Type="datetime" />
      <Input Name="extend_status23" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date23" Type="datetime" />
      <Input Name="extend_status24" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date24" Type="datetime" />
      <Input Name="extend_status25" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date25" Type="datetime" />
      <Input Name="extend_status26" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date26" Type="datetime" />
      <Input Name="extend_status27" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date27" Type="datetime" />
      <Input Name="extend_status28" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date28" Type="datetime" />
      <Input Name="extend_status29" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date29" Type="datetime" />
      <Input Name="extend_status30" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date30" Type="datetime" />
      <Input Name="extend_status31" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date31" Type="datetime" />
      <Input Name="extend_status32" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date32" Type="datetime" />
      <Input Name="extend_status33" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date33" Type="datetime" />
      <Input Name="extend_status34" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date34" Type="datetime" />
      <Input Name="extend_status35" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date35" Type="datetime" />
      <Input Name="extend_status36" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date36" Type="datetime" />
      <Input Name="extend_status37" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date37" Type="datetime" />
      <Input Name="extend_status38" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date38" Type="datetime" />
      <Input Name="extend_status39" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date39" Type="datetime" />
      <Input Name="extend_status40" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date40" Type="datetime" />
      <Input Name="card_installments_code" Type="nvarchar" Size="10" />
      <Input Name="setpromotion_product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_payment_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="online_payment_status" Type="nvarchar" Size="2" />
      <Input Name="fixed_purchase_order_count" Type="int" />
      <Input Name="fixed_purchase_shipped_count" Type="int" />
      <Input Name="fixed_purchase_discount_price" Type="decimal" Size="18,3" />
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
      <Input Name="fixed_purchase_member_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="external_payment_status" Type="nvarchar" Size="30" />
      <Input Name="external_payment_error_message" Type="nvarchar" Size="MAX" />
      <Input Name="external_payment_auth_date" Type="datetime" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="external_order_id" Type="nvarchar" Size="50" />
      <Input Name="external_import_status" Type="nvarchar" Size="10" />
      <Input Name="last_order_point_use" Type="decimal" />
      <Input Name="last_order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="combined_org_order_ids" Type="nvarchar" Size="MAX" />
      <Input Name="last_auth_flg" Type="nvarchar" Size="1" />
      <Input Name="mall_link_status" Type="nvarchar" Size="20" />
      <Input Name="settlement_currency" Type="nvarchar" Size="3" />
      <Input Name="settlement_rate" Type="decimal" Size="24,12" />
      <Input Name="settlement_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="payment_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="invoice_bundle_flg" Type="nvarchar" Size="1" />
      <Input Name="inflow_contents_id" Type="nvarchar" Size="30" />
      <Input Name="inflow_contents_type" Type="nvarchar" Size="20" />
      <Input Name="receipt_flg" Type="nvarchar" Size="1" />
      <Input Name="receipt_output_flg" Type="nvarchar" Size="1" />
      <Input Name="receipt_address" Type="nvarchar" Size="100" />
      <Input Name="receipt_proviso" Type="nvarchar" Size="100" />
      <Input Name="delivery_tran_id" Type="nvarchar" Size="100" />
      <Input Name="online_delivery_status" Type="nvarchar" Size="2" />
      <Input Name="external_payment_type" Type="nvarchar" Size="20" />
      <Input Name="logi_cooperation_status" Type="nvarchar" Size="10" />
      <Input Name="extend_status41" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date41" Type="datetime" />
      <Input Name="extend_status42" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date42" Type="datetime" />
      <Input Name="extend_status43" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date43" Type="datetime" />
      <Input Name="extend_status44" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date44" Type="datetime" />
      <Input Name="extend_status45" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date45" Type="datetime" />
      <Input Name="extend_status46" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date46" Type="datetime" />
      <Input Name="extend_status47" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date47" Type="datetime" />
      <Input Name="extend_status48" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date48" Type="datetime" />
      <Input Name="extend_status49" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date49" Type="datetime" />
      <Input Name="extend_status50" Type="nvarchar" Size="10" />
      <Input Name="extend_status_date50" Type="datetime" />
      <Input Name="card_tran_pass" Type="nvarchar" Size="100" />
      <Input Name="storepickup_status" Type="nvarchar" Size="30" />
      <Input Name="storepickup_store_arrived_date" Type="datetime" />
      <Input Name="storepickup_delivered_complete_date" Type="datetime" />
      <Input Name="storepickup_return_date" Type="datetime" />
    </Parameter>
  </Update>

  <!-- 出荷後変更区分更新(元注文情報) -->
  <UpdateShippedChangedKbn>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.shipped_changed_kbn = '02', -- 出荷後変更有り
                w2_Order.date_changed = getdate(),
                w2_Order.last_changed = @last_changed
         WHERE  w2_Order.order_id = @order_id_org
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateShippedChangedKbn>

  <!-- ヤマト後払い/ヤマトクレジットカード出荷報告完了更新対象の返品注文情報取得 -->
  <GetUpdateShipmentCompleteTargeReturnOrder>
    <Statement>
      <![CDATA[
        -- ダーティリードを許可して共有ロックを掛けなくする
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
      
        SELECT  *
          FROM  w2_Order
         WHERE  w2_Order.mall_id = 'OWN_SITE' --自社サイトの注文
           AND  w2_Order.order_payment_kbn = @order_payment_kbn -- ヤマト後払い／ヤマトクレジットカード
           AND  w2_Order.last_auth_flg = '1'  -- 最終与信の注文
           AND w2_Order.external_payment_status = 'AUTH_COMP' -- 与信済み
           AND
           (
              (
                w2_Order.return_exchange_kbn = '01' -- 返品
                AND
                w2_Order.order_status NOT IN ('ODR_CNSL','TMP_CNSL')
              )
              OR
              (
                w2_Order.return_exchange_kbn = '10' -- 交換
                AND
                w2_Order.order_status = 'ODR_CNSL'
              )
           )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </GetUpdateShipmentCompleteTargeReturnOrder>

  <!-- ユーザーIDから注文情報取得 -->
  <GetOrdersByUserId>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order WITH (NOLOCK)
         WHERE  user_id = @user_id
        ORDER BY order_date
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrdersByUserId>

  <!-- キャンセル済み注文以外を取得 -->
  <GetUncancelledOrders>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  order_id,
                order_status,
                order_payment_kbn
          FROM  w2_Order
         WHERE  user_id = @user_id
           AND  order_status NOT IN ('ODR_CNSL', 'TMP_CNSL', '')  -- 仮注文、キャンセル、返品済は初回購入対象外
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetUncancelledOrders>

  <!-- ユーザーIDから注文情報取得（全ての注文情報を含む） -->
  <GetOrderInfosByUserId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderPriceByTaxRate.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id AS item_supplier_id,
                w2_OrderItem.date_created AS item_date_created,
                w2_OrderItem.date_changed AS item_date_changed,
                w2_OrderItem.subscription_box_course_id AS item_subscription_box_course_id,
                w2_OrderItem.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderCoupon.*,
                w2_OrderSetPromotion.*,
                w2_OrderSetPromotion.order_setpromotion_no AS promotion_order_setpromotion_no
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderPriceByTaxRate ON
                (
                  w2_Order.order_id = w2_OrderPriceByTaxRate.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  user_id = @user_id
        ORDER BY order_date
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderInfosByUserId>

  <!-- 注文IDから注文情報取得（全ての注文情報を含む） -->
  <GetOrderInfoByOrderId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderPriceByTaxRate.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id AS item_supplier_id,
                w2_OrderItem.date_created AS item_date_created,
                w2_OrderItem.date_changed AS item_date_changed,
                w2_OrderItem.subscription_box_course_id AS item_subscription_box_course_id,
                w2_OrderItem.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderCoupon.*,
                w2_OrderSetPromotion.*,
                w2_OrderSetPromotion.order_setpromotion_no AS promotion_order_setpromotion_no,
                w2_DeliveryCompany.delivery_company_name,
                w2_Payment.payment_name
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderPriceByTaxRate ON
                (
                  w2_Order.order_id = w2_OrderPriceByTaxRate.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                    w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
                LEFT JOIN w2_Payment ON
                (
                    w2_Order.shop_id = w2_Payment.shop_id
                    AND
                    w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderInfoByOrderId>

  <!-- 注文履歴一覧を取得する -->
  <GetOrderHistoryList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  w2_Order.order_id,
                w2_Order.order_payment_kbn,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_shipping_date,
                w2_Order.order_shipped_date,
                w2_Order.order_delivering_date,
                w2_Order.order_cancel_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.order_price_total,
                w2_Order.memo,
                w2_Order.card_instruments,
                w2_Order.return_exchange_kbn,
                w2_Order.order_kbn,
                w2_Payment.payment_name,
                w2_Order.order_id_org,
                (SELECT SUM(item_quantity) FROM w2_OrderItem WHERE w2_Order.order_id = w2_OrderItem.order_id) AS total_item_quantity
          FROM  w2_Order
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
         WHERE  w2_Order.user_id = @user_id
           AND  w2_Order.del_flg = '0'
         ORDER BY
                w2_Order.order_date DESC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderHistoryList>

  <!-- 注文詳細を取得する -->
  <GetOrderHistoryDetail>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.subscription_box_course_id AS item_subscription_box_course_id,
                w2_OrderItem.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_DeliveryCompany.*,
                w2_ShopShipping.*,
                w2_TwOrderInvoice.*,
                CASE w2_OrderShipping.shipping_time
                  WHEN w2_DeliveryCompany.shipping_time_id1 THEN w2_DeliveryCompany.shipping_time_message1
                  WHEN w2_DeliveryCompany.shipping_time_id2 THEN w2_DeliveryCompany.shipping_time_message2
                  WHEN w2_DeliveryCompany.shipping_time_id3 THEN w2_DeliveryCompany.shipping_time_message3
                  WHEN w2_DeliveryCompany.shipping_time_id4 THEN w2_DeliveryCompany.shipping_time_message4
                  WHEN w2_DeliveryCompany.shipping_time_id5 THEN w2_DeliveryCompany.shipping_time_message5
                  WHEN w2_DeliveryCompany.shipping_time_id6 THEN w2_DeliveryCompany.shipping_time_message6
                  WHEN w2_DeliveryCompany.shipping_time_id7 THEN w2_DeliveryCompany.shipping_time_message7
                  WHEN w2_DeliveryCompany.shipping_time_id8 THEN w2_DeliveryCompany.shipping_time_message8
                  WHEN w2_DeliveryCompany.shipping_time_id9 THEN w2_DeliveryCompany.shipping_time_message9
                  WHEN w2_DeliveryCompany.shipping_time_id10 THEN w2_DeliveryCompany.shipping_time_message10
                  ELSE ''
                END AS shipping_time_message,
                w2_Payment.payment_name AS order_payment_kbn_name,
                w2_FixedPurchase.*,
                w2_OrderSetPromotion.*,
                w2_Product.recommend_product_id,
                w2_Product.use_variation_flg,
                -- 注文したの商品IDの現情報を取得する（表示可能なproduct_idの件数を取得）
                ( SELECT  COUNT(w2_ProductView.product_id)
                   FROM w2_ProductView
                  WHERE 
                    (
                        w2_ProductView.shop_id = w2_OrderItem.shop_id
                        AND w2_ProductView.product_id = w2_OrderItem.product_id
                        AND w2_ProductView.display_from <= getdate()    -- 表示期間内
                        AND ((w2_ProductView.display_to IS NULL) OR (w2_ProductView.display_to >= getdate()))
                        AND w2_ProductView.display_kbn IN ('0','1')    -- 商品一覧○、商品詳細○ OR 商品一覧×、商品詳細○
                        AND w2_ProductView.mobile_disp_flg IN ('0','1') -- PC&モバイル OR PCのみ
                        AND w2_ProductView.valid_flg = '1'              -- 有効
                        AND w2_OrderItem.order_history_display_type = 'VALID' -- 明細表示有効
                        -- 会員ランクによる表示可否条件も加える
                        [[ MEMBER_RANK_SEARCH_WHERE ]]
                    )
                ) AS newest_product_count
          FROM  w2_Order
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_TwOrderInvoice.order_id = w2_OrderShipping.order_id
                  AND
                  w2_TwOrderInvoice.order_shipping_no = w2_OrderShipping.order_shipping_no
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                INNER JOIN w2_ShopShipping ON
                (
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                INNER JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_Order.order_id = @order_id
           AND  w2_Order.user_id = @user_id
           AND  (
                  w2_Order.order_status NOT IN ('TMP','TMP_CNSL')	-- 仮注文、仮注文キャンセル以外
                  <@@hasval:include_temp_paidy_paygent_order@@>
                  OR
                  w2_Order.order_payment_kbn = 'K33'
                  </@@hasval:include_temp_paidy_paygent_order@@>
                )
           AND  w2_OrderItem.order_history_display_type = 'VALID' -- 明細表示有効
        ORDER BY w2_Order.order_id, w2_OrderItem.order_shipping_no, w2_OrderItem.order_setpromotion_no, w2_OrderItem.order_setpromotion_item_no, w2_OrderItem.order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderHistoryDetail>

  <!-- 注文履歴一覧（注文単位）を取得する -->
  <GetOrderHistoryListByOrders>
    <Statement>
      <![CDATA[
        -- 全件数取得
        DECLARE @row_count int
        SELECT  @row_count = ISNULL(COUNT(w2_Order.order_id), 0)
          FROM  w2_Order
                [[ ORDERHISTORY_SEARCH_WHERE ]]

        -- 該当情報取得
        SELECT  w2_Order.*,
                @row_count AS row_count
          FROM  (
                  SELECT  w2_Order.order_id,
                          ROW_NUMBER()
                          OVER
                          (
                            [[ ORDERHISTORY_SEARCH_ORDER_BY ]]
                          ) AS row_num
                    FROM  w2_Order
                          [[ ORDERHISTORY_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_Order ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetOrderHistoryListByOrders>

  <!-- 注文履歴一覧（商品単位）を取得する -->
  <GetOrderHistoryListByProducts>
    <Statement>
      <![CDATA[
        -- 購入済みの商品情報一覧を作成します
        -- OrderItem単位で抽出したリストです
        -- あとでソートする時に必要になる項目（ここのタイミングでのみ集計できるもの）を書き出しておきます
        DECLARE @order_item_table TABLE(
                [shop_id] [nvarchar](10) NOT NULL DEFAULT (''),
                [brand_id1] [nvarchar](30) NOT NULL DEFAULT (''),
                [product_id] [nvarchar](30) NOT NULL DEFAULT (''),
                [variation_id] [nvarchar](60)  NOT NULL DEFAULT (''),
                [orderitem_variation_name] [nvarchar](200) NOT NULL DEFAULT (''),
                [orderitem_product_id_count] [int] NOT NULL DEFAULT (0),
                [orderitem_variation_id_count] [int] NOT NULL DEFAULT (0),
                [order_date] [datetime]  NOT NULL DEFAULT (''),
                [order_id] [nvarchar](30) NOT NULL DEFAULT ('')
        )
        
    INSERT
      INTO	@order_item_table
        (
            shop_id,
            brand_id1,
            product_id,
            variation_id,
            orderitem_variation_name,
            orderitem_product_id_count,
            orderitem_variation_id_count,
            order_date,
            order_id
        )
        SELECT
                w2_OrderItem.shop_id,
                ISNULL(w2_ProductView.brand_id1, ''),
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id,
                MIN(w2_OrderItem.product_name) AS orderitem_variation_name, -- w2_OrderItemのproduct_name 最短のものを１つ取得しておく
                COUNT (w2_OrderItem.product_id) AS orderitem_product_id_count, -- w2_OrderItemのproduct_id単位でのカウント
                COUNT (w2_OrderItem.variation_id) AS orderitem_variation_id_count, -- w2_OrderItemのvariation_id単位でのカウント
                MAX (w2_Order.order_date) AS order_date, -- 最後に購入した日
                MAX (w2_Order.order_id) AS order_id -- 最後に購入した注文ID（恐らく）
          FROM  
                w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                -- 最終的に表示できない(表示しない)商品はこの時点で予め削っておき、カウント数と表示件数を合わせる
                INNER JOIN w2_ProductView ON 
                (
                  w2_ProductView.shop_id = w2_OrderItem.shop_id
                  AND
                  w2_ProductView.product_id = w2_OrderItem.product_id
                  AND 
                  w2_ProductView.variation_id = w2_OrderItem.variation_id
                )
         WHERE
                w2_Order.user_id = @user_id
                AND  w2_Order.order_status NOT IN ('TMP','TMP_CNSL')	-- 仮注文、仮注文キャンセル以外
                AND  w2_Order.del_flg = '0'
                AND  w2_Order.return_exchange_kbn = '00' -- 元注文のみ
                AND  w2_OrderItem.product_bundle_id = '' -- 同梱商品以外
                AND  w2_OrderItem.novelty_id = ''  -- ノベルティ商品以外
      GROUP BY
                w2_OrderItem.shop_id,
                w2_ProductView.brand_id1,
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id
               
      -- ここから実際に表示するリストの抽出を実施します（タイムセール価格、会員価格も取得）
      -- 全件数取得
       DECLARE  @row_count int
        SELECT  @row_count = ISNULL(COUNT(variation_id), 0)
          FROM  @order_item_table

        [[ USER_MEMBER_RANK_ORDER ]]

        SELECT 
                row_num,
                ISNULL(tmpProductCountingTable.product_count, 0) AS newest_product_count, -- 表示可能なproduct_idの件数を取得
                tmp_order_item_table.*,
                w2_ProductView.*,
                @row_count AS row_count,
                [[ MEMBER_RANK_PRICE_PRODUCTVARIATION ]]
                ,
                [[ PRODUCT_SOLD_OUT_SELECT ]]
        
          FROM  
                (
                  SELECT  tmp_order_item_table.variation_id,
                          ROW_NUMBER()
                          OVER
                          (
                            ORDER BY tmp_order_item_table.order_date DESC -- 最後のORDER BY と合わせる
                          ) AS row_num
                    FROM  @order_item_table AS tmp_order_item_table
                ) AS RowIndex
                INNER JOIN @order_item_table AS tmp_order_item_table ON
                (
                  RowIndex.variation_id = tmp_order_item_table.variation_id
                )
                INNER JOIN w2_ProductView ON
                (
                      w2_ProductView.shop_id = tmp_order_item_table.shop_id
                  AND w2_ProductView.brand_id1 = tmp_order_item_table.brand_id1
                  AND w2_ProductView.product_id = tmp_order_item_table.product_id
                  AND w2_ProductView.variation_id = tmp_order_item_table.variation_id
                )
                INNER JOIN w2_Product ON -- ProductのSub PRODUCT_SOLD_OUT_SELECT を流用するためのJOIN
                (
                      w2_Product.shop_id = tmp_order_item_table.shop_id
                  AND w2_Product.brand_id1 = tmp_order_item_table.brand_id1
                  AND w2_Product.product_id = tmp_order_item_table.product_id
                )
                LEFT JOIN 
                  (
                        -- 過去の注文商品IDに紐づく商品IDで、今も存在している商品の数をSELECT時に算出する
                        SELECT 
                                  w2_ProductView.shop_id,
                                  w2_ProductView.brand_id1,
                                  w2_ProductView.product_id,
                                  COUNT(product_id) AS product_count
                          FROM w2_ProductView
                         WHERE 
                              (
                                      w2_ProductView.display_from <= getdate()    -- 表示期間内
                                  AND ((w2_ProductView.display_to IS NULL) OR (w2_ProductView.display_to >= getdate()))
                                  AND w2_ProductView.display_kbn IN ('0','1')      -- 詳細表示ＯＫ？
                                  AND w2_ProductView.mobile_disp_flg IN ('0','1') -- PC&モバイル OR PCのみ
                                  AND w2_ProductView.valid_flg = '1'              -- 有効
                                  -- 会員ランクによる表示可否条件も考慮する
                                  [[ MEMBER_RANK_SEARCH_WHERE ]]
                              )
                        GROUP BY
                                  w2_ProductView.shop_id,
                                  w2_ProductView.brand_id1,
                                  w2_ProductView.product_id 
                  ) AS tmpProductCountingTable ON 
                    (
                            tmpProductCountingTable.shop_id = tmp_order_item_table.shop_id
                        AND tmpProductCountingTable.brand_id1 = tmp_order_item_table.brand_id1
                        AND tmpProductCountingTable.product_id = tmp_order_item_table.product_id
                    )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
       ORDER BY tmp_order_item_table.order_date DESC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetOrderHistoryListByProducts>

  <!-- 注文ID一覧から注文商品取得 -->
  <GetItemByOrderIds>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  w2_OrderItem.order_id,
                w2_OrderItem.order_item_no,
                w2_OrderItem.order_shipping_no,
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id,
                w2_OrderItem.product_name,
                w2_OrderItem.item_quantity,
                w2_OrderItem.product_set_id,
                w2_Product.fixed_purchase_flg AS fixed_purchase_flg
          FROM  w2_OrderItem
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_OrderItem.order_id IN (@order_id)
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="ntext"/>
    </Parameter>
  </GetItemByOrderIds>

  <!-- 注文者取得 -->
  <GetOwner>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderOwner
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOwner>

  <!-- 注文者更新 -->
  <UpdateOwner>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderOwner
           SET  owner_kbn = @owner_kbn
                ,owner_name = @owner_name
                ,owner_name_kana = @owner_name_kana
                ,owner_mail_addr = @owner_mail_addr
                ,owner_zip = @owner_zip
                ,owner_addr1 = @owner_addr1
                ,owner_addr2 = @owner_addr2
                ,owner_addr3 = @owner_addr3
                ,owner_addr4 = @owner_addr4
                ,owner_tel1 = @owner_tel1
                ,owner_tel2 = @owner_tel2
                ,owner_tel3 = @owner_tel3
                ,owner_fax = @owner_fax
                ,owner_sex = @owner_sex
                ,owner_birth = @owner_birth
                ,owner_company_name = @owner_company_name
                ,owner_company_post_name = @owner_company_post_name
                ,owner_company_exective_name = @owner_company_exective_name
                ,del_flg = @del_flg
                ,date_changed = GETDATE()
                ,owner_name1 = @owner_name1
                ,owner_name2 = @owner_name2
                ,owner_name_kana1 = @owner_name_kana1
                ,owner_name_kana2 = @owner_name_kana2
                ,owner_mail_addr2 = @owner_mail_addr2
                ,access_country_iso_code = @access_country_iso_code
                ,disp_language_code = @disp_language_code
                ,disp_language_locale_id = @disp_language_locale_id
                ,disp_currency_code = @disp_currency_code
                ,disp_currency_locale_id = @disp_currency_locale_id
                ,owner_addr_country_iso_code = @owner_addr_country_iso_code
                ,owner_addr_country_name = @owner_addr_country_name
                ,owner_addr5 = @owner_addr5
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name_kana" Type="nvarchar" Size="60" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
      <Input Name="owner_tel2" Type="nvarchar" Size="16" />
      <Input Name="owner_tel3" Type="nvarchar" Size="16" />
      <Input Name="owner_fax" Type="nvarchar" Size="16" />
      <Input Name="owner_sex" Type="nvarchar" Size="10" />
      <Input Name="owner_birth" Type="datetime" />
      <Input Name="owner_company_name" Type="nvarchar" Size="50" />
      <Input Name="owner_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="owner_company_exective_name" Type="nvarchar" Size="50" />
      <Input Name="del_flg" Type="nvarchar" Size="1" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="owner_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="owner_mail_addr2" Type="nvarchar" Size="256" />
      <Input Name="access_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="disp_language_code" Type="nvarchar" Size="4" />
      <Input Name="disp_language_locale_id" Type="nvarchar" Size="7" />
      <Input Name="disp_currency_code" Type="nvarchar" Size="4" />
      <Input Name="disp_currency_locale_id" Type="nvarchar" Size="7" />
      <Input Name="owner_addr_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="owner_addr_country_name" Type="nvarchar" Size="100" />
      <Input Name="owner_addr5" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdateOwner>

  <!-- 注文ステータス更新(注文済み) -->
  <UpdateOrderStatusComp>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order. order_status = 'ODR',  -- 注文済み
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusComp>

  <!-- 注文ステータス更新(注文承認) -->
  <UpdateOrderStatusConfirm>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR_RECG',  -- 受注承認
                w2_Order.order_recognition_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusConfirm>

  <!-- 注文ステータス更新(在庫引当済み) -->
  <UpdateOrderStatusReservedStock>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'STK_RSVD',  -- 在庫引当済み
                w2_Order.order_stockreserved_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusReservedStock>

  <!-- 注文ステータス更新(出荷手配済み) -->
  <UpdateOrderStatusShipping>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'SHP_ARGD',  -- 出荷手配済み
                w2_Order.order_shipping_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusShipping>

  <!-- 注文ステータス更新(出荷完了) -->
  <UpdateOrderStatusForwardComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'SHP_COMP',  -- 出荷完了
                w2_Order.order_shipped_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusForwardComplete>

  <!-- 注文ステータス更新(配送完了) -->
  <UpdateOrderStatusDelivering>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'DLV_COMP',  -- 配送完了
                w2_Order.order_delivering_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusDelivering>

  <!-- 注文ステータス更新(キャンセル) -->
  <UpdateOrderStatusCancel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR_CNSL',  -- キャンセル
                w2_Order.order_cancel_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
           AND  w2_Order.order_status <> 'ODR_CNSL'  -- キャンセルは対象外（二重キャンセル防止）
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusCancel>

  <!-- 注文ステータス更新(仮注文キャンセル) -->
  <UpdateOrderStatusTempOrderCancel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'TMP_CNSL',  -- 仮注文キャンセル
                w2_Order.order_cancel_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
           AND  w2_Order.order_status <> 'TMP_CNSL'  -- 仮注文キャンセルは対象外（二重キャンセル防止）
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusTempOrderCancel>

  <!-- 入金ステータス更新(入金確認待ち) -->
  <UpdateOrderPaymentStatusConfirm>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 0,  -- 入金確認待ち
                w2_Order.order_payment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusConfirm>

  <!-- 入金ステータス更新(入金済み) -->
  <UpdateOrderPaymentStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 1,  -- 入金済み
                w2_Order.order_payment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusComplete>

  <!-- 入金ステータス更新(一部入金) -->
  <UpdateOrderPaymentStatusShortage>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 2,  -- 一部入金
                w2_Order.order_payment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusShortage>

  <!-- 督促ステータス更新(督促なし) -->
  <UpdateOrderDemandStatusUnKnown>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.demand_status = '0',        -- 督促ステータス
                w2_Order.demand_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderDemandStatusUnKnown>

  <!-- 督促ステータス更新(督促レベル1～) -->
  <UpdateOrderDemandStatusLevel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.demand_status = @demand_status,  -- 督促ステータス
                w2_Order.demand_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="demand_status" Type="nvarchar" Size="1" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderDemandStatusLevel>

  <!-- 返品交換ステータス更新(返品交換受付) -->
  <UpdateOrderReturnExchangeStatusReceipt>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '01',  -- 返品交換受付
                w2_Order.order_return_exchange_receipt_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusReceipt>

  <!-- 返品交換ステータス更新(返品交換商品到着) -->
  <UpdateOrderReturnExchangeStatusArrival>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '02',  -- 返品交換商品到着
                w2_Order.order_return_exchange_arrival_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusArrival>

  <!-- 返品ステータス更新(返品交換完了) -->
  <UpdateOrderReturnExchangeStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '03',  -- 返品交換完了
                w2_Order.order_return_exchange_complete_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
        WHERE   w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusComplete>

  <!-- 返金ステータス更新(返金無し) -->
  <UpdateOrderRepaymentStatusNoRepayment>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '01',  -- 返金無し
                w2_Order.order_repayment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusNoRepayment>

  <!-- 返金ステータス更新(未返金) -->
  <UpdateOrderRepaymentStatusConfrim>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '02',  -- 未返金
                w2_Order.order_repayment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusConfrim>

  <!-- ペイジェント注文完了時更新 -->
  <UpdatePaygentOrder>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.card_3dsecure_tran_id = @card_3dsecure_tran_id, --3DSecure利用時のみ渡される
                w2_Order.card_tran_id = @card_tran_id, --Paygent側返却値のpayment_idを格納
                w2_Order.last_changed = 'user',
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="card_3dsecure_tran_id" Type="nvarchar" Size="100" />
      <Input Name="card_tran_id" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdatePaygentOrder>

  <!-- 返金ステータス更新(返金済み) -->
  <UpdateOrderRepaymentStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '03',  -- 返金済み
                w2_Order.order_repayment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusComplete>

  <!-- 交換注文→通常注文に更新 -->
  <!-- ・注文ステータスを「指定無し」→「注文済み」
       ・注文日時を「更新日時」★更新日指定の日時ではない！
       ・入金ステータスを「指定無し」→「入金確認待ち」
       ・督促ステータスを「指定無し」→「督促なし」-->
  <UpdateOrderExchange>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR',  -- 注文済み
                w2_Order.order_payment_status = '0', -- 入金確認待ち
                w2_Order.demand_status = '0', -- 督促なし
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderExchange>

  <!-- 注文商品情報の実在庫を引当済実在庫数更新 -->
  <UpdateItemRealStockReserved>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.item_realstock_reserved = w2_OrderItem.item_realstock_reserved + @item_realstock_reserved,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="item_realstock_reserved" Type="int" />
    </Parameter>
  </UpdateItemRealStockReserved>

  <!-- 在庫引当ステータス更新 -->
  <UpdateOrderStockReservedStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_stockreserved_status = @order_stockreserved_status,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_stockreserved_status" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStockReservedStatus>

  <!-- 注文商品情報の実在庫を出荷済実在庫数更新 -->
  <UpdateItemRealStockShipped>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.item_realstock_shipped = w2_OrderItem.item_realstock_shipped + @item_realstock_shipped,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="item_realstock_shipped" Type="int" />
    </Parameter>
  </UpdateItemRealStockShipped>

  <!-- 在庫戻し済みフラグ更新 -->
  <UpdateItemStockReturnedFlag>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.stock_returned_flg = @stock_returned_flg,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="stock_returned_flg" Type="nvarchar" Size="1" />
    </Parameter>
  </UpdateItemStockReturnedFlag>

  <!-- 出荷ステータス更新 -->
  <UpdateOrderShippedStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_shipped_status = @order_shipped_status,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipped_status" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderShippedStatus>

  <!-- 配送伝票番号更新 -->
  <UpdateOrderShippingCheckNo>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderShipping
           SET  shipping_check_no = @shipping_check_no
         WHERE  order_id = @order_id
           AND  order_shipping_no = @order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shipping_check_no" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdateOrderShippingCheckNo>

  <!-- 返品交換ステータス更新(返品交換受付) -->
  <UpdateOrderReturnExchangeStatusReceipt>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '01',  -- 返品交換受付
                w2_Order.order_return_exchange_receipt_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusReceipt>

  <!-- 返金ステータス更新(未返金) -->
  <UpdateOrderRepaymentStatusConfrim>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '02',  -- 未返金
                w2_Order.order_repayment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusConfrim>

  <!-- 領収書出力フラグ更新 -->
  <UpdateOrderReceiptOutputFlg>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.receipt_output_flg = @receipt_output_flg,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="receipt_output_flg" Type="nvarchar" Size="1" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReceiptOutputFlg>

  <!-- 最終更新日時更新(注文ID) -->
  <UpdateOrderDateChangedByOrderId>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.date_changed = GETDATE()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </UpdateOrderDateChangedByOrderId>

  <!-- 最終更新日時更新(ユーザID) -->
  <UpdateOrderDateChangedByUserId>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.date_changed = GETDATE()
         WHERE  w2_Order.user_id = @user_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </UpdateOrderDateChangedByUserId>

  <!-- 最終更新日時更新(統合) -->
  <UpdateOrderDateChangedForIntegration>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.date_changed = GETDATE()
          FROM  w2_Order
         INNER JOIN w2_OrderCoupon
            ON  w2_Order.order_id = w2_OrderCoupon.order_id
         WHERE  w2_Order.user_id = @user_id
           AND  w2_OrderCoupon.coupon_id = @coupon_id
           AND  w2_OrderCoupon.coupon_no = @coupon_no_old
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_no_old" Type="int" />
    </Parameter>
  </UpdateOrderDateChangedForIntegration>

  <!-- 配送先取得 -->
  <GetShipping>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderShipping
         WHERE  order_id = @order_id
           AND  order_shipping_no = @order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
    </Parameter>
  </GetShipping>

  <!-- 配送先取得（全て） -->
  <GetShippingAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderShipping
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetShippingAll>

  <!-- 配送先登録 -->
  <InsertShipping>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderShipping
                (
                  order_id
                  ,order_shipping_no
                  ,shipping_name
                  ,shipping_name_kana
                  ,shipping_zip
                  ,shipping_addr1
                  ,shipping_addr2
                  ,shipping_addr3
                  ,shipping_addr4
                  ,shipping_tel1
                  ,shipping_tel2
                  ,shipping_tel3
                  ,shipping_fax
                  ,shipping_company
                  ,shipping_date
                  ,shipping_time
                  ,shipping_check_no
                  ,del_flg
                  ,date_created
                  ,date_changed
                  ,shipping_name1
                  ,shipping_name2
                  ,shipping_name_kana1
                  ,shipping_name_kana2
                  ,sender_name
                  ,sender_name1
                  ,sender_name2
                  ,sender_name_kana
                  ,sender_name_kana1
                  ,sender_name_kana2
                  ,sender_zip
                  ,sender_addr1
                  ,sender_addr2
                  ,sender_addr3
                  ,sender_addr4
                  ,sender_tel1
                  ,wrapping_paper_type
                  ,wrapping_paper_name
                  ,wrapping_bag_type
                  ,shipping_company_name
                  ,shipping_company_post_name
                  ,sender_company_name
                  ,sender_company_post_name
                  ,another_shipping_flg
                  ,shipping_method
                  ,delivery_company_id
                  ,shipping_country_iso_code
                  ,shipping_country_name
                  ,shipping_addr5
                  ,sender_country_iso_code
                  ,sender_country_name
                  ,sender_addr5
                  ,scheduled_shipping_date
                  ,shipping_receiving_store_flg
                  ,shipping_receiving_store_id
                  ,shipping_external_deliverty_status
                  ,shipping_status
                  ,shipping_status_update_date
                  ,shipping_receiving_mail_date
                  ,shipping_receiving_store_type
                  ,shipping_status_code
                  ,shipping_office_name
                  ,shipping_handy_time
                  ,shipping_current_status
                  ,shipping_status_detail
                  ,storepickup_real_shop_id
                )
        VALUES  (
                  @order_id
                  ,@order_shipping_no
                  ,@shipping_name
                  ,@shipping_name_kana
                  ,@shipping_zip
                  ,@shipping_addr1
                  ,@shipping_addr2
                  ,@shipping_addr3
                  ,@shipping_addr4
                  ,@shipping_tel1
                  ,@shipping_tel2
                  ,@shipping_tel3
                  ,@shipping_fax
                  ,@shipping_company
                  ,@shipping_date
                  ,@shipping_time
                  ,@shipping_check_no
                  ,@del_flg
                  ,GETDATE()
                  ,GETDATE()
                  ,@shipping_name1
                  ,@shipping_name2
                  ,@shipping_name_kana1
                  ,@shipping_name_kana2
                  ,@sender_name
                  ,@sender_name1
                  ,@sender_name2
                  ,@sender_name_kana
                  ,@sender_name_kana1
                  ,@sender_name_kana2
                  ,@sender_zip
                  ,@sender_addr1
                  ,@sender_addr2
                  ,@sender_addr3
                  ,@sender_addr4
                  ,@sender_tel1
                  ,@wrapping_paper_type
                  ,@wrapping_paper_name
                  ,@wrapping_bag_type
                  ,@shipping_company_name
                  ,@shipping_company_post_name
                  ,@sender_company_name
                  ,@sender_company_post_name
                  ,@another_shipping_flg
                  ,@shipping_method
                  ,@delivery_company_id
                  ,@shipping_country_iso_code
                  ,@shipping_country_name
                  ,@shipping_addr5
                  ,@sender_country_iso_code
                  ,@sender_country_name
                  ,@sender_addr5
                  ,@scheduled_shipping_date
                  ,@shipping_receiving_store_flg
                  ,@shipping_receiving_store_id
                  ,@shipping_external_deliverty_status
                  ,@shipping_status
                  ,@shipping_status_update_date
                  ,@shipping_receiving_mail_date
                  ,@shipping_receiving_store_type
                  ,@shipping_status_code
                  ,@shipping_office_name
                  ,@shipping_handy_time
                  ,@shipping_current_status
                  ,@shipping_status_detail
                  ,@storepickup_real_shop_id
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name_kana" Type="nvarchar" Size="60" />
      <Input Name="shipping_zip" Type="nvarchar" Size="30" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="shipping_tel2" Type="nvarchar" Size="16" />
      <Input Name="shipping_tel3" Type="nvarchar" Size="16" />
      <Input Name="shipping_fax" Type="nvarchar" Size="16" />
      <Input Name="shipping_company" Type="nvarchar" Size="30" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="shipping_check_no" Type="nvarchar" Size="50" />
      <Input Name="del_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="shipping_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="sender_name" Type="nvarchar" Size="40" />
      <Input Name="sender_name1" Type="nvarchar" Size="20" />
      <Input Name="sender_name2" Type="nvarchar" Size="20" />
      <Input Name="sender_name_kana" Type="nvarchar" Size="60" />
      <Input Name="sender_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="sender_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="sender_zip" Type="nvarchar" Size="8" />
      <Input Name="sender_addr1" Type="nvarchar" Size="50" />
      <Input Name="sender_addr2" Type="nvarchar" Size="50" />
      <Input Name="sender_addr3" Type="nvarchar" Size="50" />
      <Input Name="sender_addr4" Type="nvarchar" Size="50" />
      <Input Name="sender_tel1" Type="nvarchar" Size="16" />
      <Input Name="wrapping_paper_type" Type="nvarchar" Size="50" />
      <Input Name="wrapping_paper_name" Type="nvarchar" Size="200" />
      <Input Name="wrapping_bag_type" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_name" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="sender_company_name" Type="nvarchar" Size="50" />
      <Input Name="sender_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_method" Type="nvarchar" Size="10" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="shipping_country_name" Type="nvarchar" Size="100" />
      <Input Name="shipping_addr5" Type="nvarchar" Size="50" />
      <Input Name="sender_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="sender_country_name" Type="nvarchar" Size="100" />
      <Input Name="sender_addr5" Type="nvarchar" Size="50" />
      <Input Name="scheduled_shipping_date" Type="datetime" />
      <Input Name="shipping_receiving_store_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_receiving_store_id" Type="nvarchar" Size="20" />
      <Input Name="shipping_external_deliverty_status" Type="nvarchar" Size="5" />
      <Input Name="shipping_status" Type="nvarchar" Size="10" />
      <Input Name="shipping_status_update_date" Type="datetime" />
      <Input Name="shipping_receiving_mail_date" Type="datetime" />
      <Input Name="shipping_receiving_store_type" Type="nvarchar" Size="5" />
      <Input Name="shipping_status_code" Type="nvarchar" Size="5" />
      <Input Name="shipping_office_name" Type="nvarchar" Size="15" />
      <Input Name="shipping_handy_time" Type="nvarchar" Size="20" />
      <Input Name="shipping_current_status" Type="nvarchar" Size="30" />
      <Input Name="shipping_status_detail" Type="nvarchar" Size="50" />
      <Input Name="storepickup_real_shop_id" Type="nvarchar" Size="30" />
    </Parameter>
  </InsertShipping>

  <!-- 税率毎価格情報登録 -->
  <InsertOrderPriceByTaxRate>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderPriceByTaxRate
                (
                  order_id
                  ,key_tax_rate
                  ,price_subtotal_by_rate
                  ,price_shipping_by_rate
                  ,price_payment_by_rate
                  ,return_price_correction_by_rate
                  ,price_total_by_rate
                  ,tax_price_by_rate
                  ,date_created
                  ,date_changed
                )
        VALUES  (
                  @order_id
                  ,@key_tax_rate
                  ,@price_subtotal_by_rate
                  ,@price_shipping_by_rate
                  ,@price_payment_by_rate
                  ,@return_price_correction_by_rate
                  ,@price_total_by_rate
                  ,@tax_price_by_rate
                  ,GETDATE()
                  ,GETDATE()
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="key_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="price_subtotal_by_rate" Type="decimal" />
      <Input Name="price_shipping_by_rate" Type="decimal" />
      <Input Name="price_payment_by_rate" Type="decimal" />
      <Input Name="return_price_correction_by_rate" Type="decimal" />
      <Input Name="price_total_by_rate" Type="decimal" />
      <Input Name="tax_price_by_rate" Type="decimal" />
    </Parameter>
  </InsertOrderPriceByTaxRate>

  <!-- 配送先更新 -->
  <UpdateShipping>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderShipping
           SET  shipping_name = @shipping_name
                ,shipping_name_kana = @shipping_name_kana
                ,shipping_zip = @shipping_zip
                ,shipping_addr1 = @shipping_addr1
                ,shipping_addr2 = @shipping_addr2
                ,shipping_addr3 = @shipping_addr3
                ,shipping_addr4 = @shipping_addr4
                ,shipping_tel1 = @shipping_tel1
                ,shipping_tel2 = @shipping_tel2
                ,shipping_tel3 = @shipping_tel3
                ,shipping_fax = @shipping_fax
                ,shipping_company = @shipping_company
                ,shipping_date = @shipping_date
                ,shipping_time = @shipping_time
                ,shipping_check_no = @shipping_check_no
                ,del_flg = @del_flg
                ,date_changed = GETDATE()
                ,shipping_name1 = @shipping_name1
                ,shipping_name2 = @shipping_name2
                ,shipping_name_kana1 = @shipping_name_kana1
                ,shipping_name_kana2 = @shipping_name_kana2
                ,sender_name = @sender_name
                ,sender_name1 = @sender_name1
                ,sender_name2 = @sender_name2
                ,sender_name_kana = @sender_name_kana
                ,sender_name_kana1 = @sender_name_kana1
                ,sender_name_kana2 = @sender_name_kana2
                ,sender_zip = @sender_zip
                ,sender_addr1 = @sender_addr1
                ,sender_addr2 = @sender_addr2
                ,sender_addr3 = @sender_addr3
                ,sender_addr4 = @sender_addr4
                ,sender_tel1 = @sender_tel1
                ,wrapping_paper_type = @wrapping_paper_type
                ,wrapping_paper_name = @wrapping_paper_name
                ,wrapping_bag_type = @wrapping_bag_type
                ,shipping_company_name = @shipping_company_name
                ,shipping_company_post_name = @shipping_company_post_name
                ,sender_company_name = @sender_company_name
                ,sender_company_post_name = @sender_company_post_name
                ,another_shipping_flg = @another_shipping_flg
                ,shipping_method = @shipping_method
                ,delivery_company_id = @delivery_company_id
                ,shipping_receiving_store_flg = @shipping_receiving_store_flg
                ,shipping_receiving_store_id = @shipping_receiving_store_id
                ,shipping_external_deliverty_status = @shipping_external_deliverty_status
                ,shipping_status = @shipping_status
                ,shipping_status_update_date = @shipping_status_update_date
                ,shipping_receiving_mail_date = @shipping_receiving_mail_date
                ,shipping_receiving_store_type = @shipping_receiving_store_type
                ,shipping_status_code = @shipping_status_code
                ,shipping_office_name = @shipping_office_name
                ,shipping_handy_time = @shipping_handy_time
                ,shipping_current_status = @shipping_current_status
                ,shipping_status_detail = @shipping_status_detail
         WHERE  order_id = @order_id
           AND  order_shipping_no = @order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name_kana" Type="nvarchar" Size="60" />
      <Input Name="shipping_zip" Type="nvarchar" Size="8" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="shipping_tel2" Type="nvarchar" Size="16" />
      <Input Name="shipping_tel3" Type="nvarchar" Size="16" />
      <Input Name="shipping_fax" Type="nvarchar" Size="16" />
      <Input Name="shipping_company" Type="nvarchar" Size="30" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="shipping_check_no" Type="nvarchar" Size="50" />
      <Input Name="del_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="shipping_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="sender_name" Type="nvarchar" Size="40" />
      <Input Name="sender_name1" Type="nvarchar" Size="20" />
      <Input Name="sender_name2" Type="nvarchar" Size="20" />
      <Input Name="sender_name_kana" Type="nvarchar" Size="60" />
      <Input Name="sender_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="sender_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="sender_zip" Type="nvarchar" Size="8" />
      <Input Name="sender_addr1" Type="nvarchar" Size="50" />
      <Input Name="sender_addr2" Type="nvarchar" Size="50" />
      <Input Name="sender_addr3" Type="nvarchar" Size="50" />
      <Input Name="sender_addr4" Type="nvarchar" Size="50" />
      <Input Name="sender_tel1" Type="nvarchar" Size="16" />
      <Input Name="wrapping_paper_type" Type="nvarchar" Size="50" />
      <Input Name="wrapping_paper_name" Type="nvarchar" Size="200" />
      <Input Name="wrapping_bag_type" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_name" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="sender_company_name" Type="nvarchar" Size="50" />
      <Input Name="sender_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_method" Type="nvarchar" Size="10" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_receiving_store_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_receiving_store_id" Type="nvarchar" Size="20" />
      <Input Name="shipping_external_deliverty_status" Type="nvarchar" Size="5" />
      <Input Name="shipping_status" Type="nvarchar" Size="10" />
      <Input Name="shipping_status_update_date" Type="datetime" />
      <Input Name="shipping_receiving_mail_date" Type="datetime" />
      <Input Name="shipping_receiving_store_type" Type="nvarchar" Size="5" />
      <Input Name="shipping_status_code" Type="nvarchar" Size="5" />
      <Input Name="shipping_office_name" Type="nvarchar" Size="15" />
      <Input Name="shipping_handy_time" Type="nvarchar" Size="20" />
      <Input Name="shipping_current_status" Type="nvarchar" Size="30" />
      <Input Name="shipping_status_detail" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdateShipping>

  <!-- 配送先削除（全て） -->
  <DeleteShippingAll>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderShipping
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteShippingAll>

  <!-- 税率毎価格情報削除（全て） -->
  <DeleteOrderPriceByTaxRateAll>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderPriceByTaxRate
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderPriceByTaxRateAll>

  <!-- 商品取得（全て） -->
  <GetItemAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderItem
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetItemAll>

  <!-- 商品登録 -->
  <InsertItem>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderItem
                (
                  order_id
                  ,order_item_no
                  ,order_shipping_no
                  ,shop_id
                  ,product_id
                  ,variation_id
                  ,supplier_id
                  ,product_name
                  ,product_name_kana
                  ,product_price
                  ,product_price_org
                  ,product_point
                  ,product_tax_included_flg
                  ,product_tax_rate
                  ,product_tax_round_type
                  ,product_price_pretax
                  ,product_price_ship
                  ,product_price_cost
                  ,product_point_kbn
                  ,item_realstock_reserved
                  ,item_realstock_shipped
                  ,item_quantity
                  ,item_quantity_single
                  ,item_price
                  ,item_price_tax
                  ,item_price_single
                  ,product_set_id
                  ,product_set_no
                  ,product_set_count
                  ,item_return_exchange_kbn
                  ,item_memo
                  ,item_point
                  ,item_cancel_flg
                  ,item_cancel_date
                  ,item_return_flg
                  ,item_return_date
                  ,del_flg
                  ,date_created
                  ,date_changed
                  ,product_option_texts
                  ,brand_id
                  ,download_url
                  ,productsale_id
                  ,cooperation_id1
                  ,cooperation_id2
                  ,cooperation_id3
                  ,cooperation_id4
                  ,cooperation_id5
                  ,order_setpromotion_no
                  ,order_setpromotion_item_no
                  ,stock_returned_flg
                  ,novelty_id
                  ,recommend_id
                  ,fixed_purchase_product_flg
                  ,product_bundle_id
                  ,bundle_item_display_type
                  ,shipping_size_kbn
                  ,limited_payment_ids
                  ,plural_shipping_price_free_flg
                  ,column_for_mall_order
                  ,cooperation_id6
                  ,cooperation_id7
                  ,cooperation_id8
                  ,cooperation_id9
                  ,cooperation_id10
                  ,gift_wrapping_id
                  ,gift_message
                  ,fixed_purchase_discount_value
                  ,fixed_purchase_discount_type
                  ,fixed_purchase_item_order_count
                  ,fixed_purchase_item_shipped_count
                  ,item_discounted_price
                  ,subscription_box_course_id
                  ,subscription_box_fixed_amount
                )
        VALUES  (
                  @order_id
                  ,@order_item_no
                  ,@order_shipping_no
                  ,@shop_id
                  ,@product_id
                  ,@variation_id
                  ,@supplier_id
                  ,@product_name
                  ,@product_name_kana
                  ,@product_price
                  ,@product_price_org
                  ,@product_point
                  ,@product_tax_included_flg
                  ,@product_tax_rate
                  ,@product_tax_round_type
                  ,@product_price_pretax
                  ,@product_price_ship
                  ,@product_price_cost
                  ,@product_point_kbn
                  ,@item_realstock_reserved
                  ,@item_realstock_shipped
                  ,@item_quantity
                  ,@item_quantity_single
                  ,@item_price
                  ,@item_price_tax
                  ,@item_price_single
                  ,@product_set_id
                  ,@product_set_no
                  ,@product_set_count
                  ,@item_return_exchange_kbn
                  ,@item_memo
                  ,@item_point
                  ,@item_cancel_flg
                  ,@item_cancel_date
                  ,@item_return_flg
                  ,@item_return_date
                  ,@del_flg
                  ,GETDATE()
                  ,GETDATE()
                  ,@product_option_texts
                  ,@brand_id
                  ,@download_url
                  ,@productsale_id
                  ,@cooperation_id1
                  ,@cooperation_id2
                  ,@cooperation_id3
                  ,@cooperation_id4
                  ,@cooperation_id5
                  ,@order_setpromotion_no
                  ,@order_setpromotion_item_no
                  ,@stock_returned_flg
                  ,@novelty_id
                  ,@recommend_id
                  ,@fixed_purchase_product_flg
                  ,@product_bundle_id
                  ,@bundle_item_display_type
                  ,@shipping_size_kbn
                  ,@limited_payment_ids
                  ,@plural_shipping_price_free_flg
                  ,@column_for_mall_order
                  ,@cooperation_id6
                  ,@cooperation_id7
                  ,@cooperation_id8
                  ,@cooperation_id9
                  ,@cooperation_id10
                  ,@gift_wrapping_id
                  ,@gift_message
                  ,@fixed_purchase_discount_value
                  ,@fixed_purchase_discount_type
                  ,@fixed_purchase_item_order_count
                  ,@fixed_purchase_item_shipped_count
                  ,@item_discounted_price
                  ,@subscription_box_course_id
                  ,@subscription_box_fixed_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="supplier_id" Type="nvarchar" Size="20" />
      <Input Name="product_name" Type="nvarchar" Size="200" />
      <Input Name="product_name_kana" Type="nvarchar" Size="200" />
      <Input Name="product_price" Type="decimal" Size="18,3" />
      <Input Name="product_price_org" Type="decimal" Size="18,3" />
      <Input Name="product_point" Type="float" />
      <Input Name="product_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="product_tax_rate" Type="decimal"  />
      <Input Name="product_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="product_price_pretax" Type="decimal" Size="18,3" />
      <Input Name="product_price_ship" Type="decimal" />
      <Input Name="product_price_cost" Type="decimal" />
      <Input Name="product_point_kbn" Type="nvarchar" Size="1" />
      <Input Name="item_realstock_reserved" Type="int" />
      <Input Name="item_realstock_shipped" Type="int" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="item_quantity_single" Type="int" />
      <Input Name="item_price" Type="decimal" Size="18,3" />
      <Input Name="item_price_tax" Type="decimal" Size="18,3" />
      <Input Name="item_price_single" Type="decimal" Size="18,3" />
      <Input Name="product_set_id" Type="nvarchar" Size="30" />
      <Input Name="product_set_no" Type="int" />
      <Input Name="product_set_count" Type="int" />
      <Input Name="item_return_exchange_kbn" Type="nvarchar" Size="10" />
      <Input Name="item_memo" Type="nvarchar" Size="100" />
      <Input Name="item_point" Type="float" />
      <Input Name="item_cancel_flg" Type="nvarchar" Size="1" />
      <Input Name="item_cancel_date" Type="datetime" />
      <Input Name="item_return_flg" Type="nvarchar" Size="1" />
      <Input Name="item_return_date" Type="datetime" />
      <Input Name="del_flg" Type="nvarchar" Size="1" />
      <Input Name="product_option_texts" Type="nvarchar" Size="MAX" />
      <Input Name="brand_id" Type="nvarchar" Size="30" />
      <Input Name="download_url" Type="nvarchar" Size="MAX" />
      <Input Name="productsale_id" Type="nvarchar" Size="10" />
      <Input Name="cooperation_id1" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id2" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id3" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id4" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id5" Type="nvarchar" Size="30" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="order_setpromotion_item_no" Type="int" />
      <Input Name="stock_returned_flg" Type="nvarchar" Size="1" />
      <Input Name="novelty_id" Type="nvarchar" Size="30" />
      <Input Name="recommend_id" Type="nvarchar" Size="30" />
      <Input Name="fixed_purchase_product_flg" Type="nvarchar" Size="1" />
      <Input Name="product_bundle_id" Type="nvarchar" Size="30" />
      <Input Name="bundle_item_display_type" Type="nvarchar" Size="10" />
      <Input Name="shipping_size_kbn" Type="nvarchar" Size="4" />
      <Input Name="limited_payment_ids" Type="nvarchar" Size="250" />
      <Input Name="plural_shipping_price_free_flg" Type="nvarchar" Size="1" />
      <Input Name="column_for_mall_order" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id6" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id7" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id8" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id9" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id10" Type="nvarchar" Size="50" />
      <Input Name="gift_wrapping_id" Type="nvarchar" Size="50" />
      <Input Name="gift_message" Type="nvarchar" Size="max" />
      <Input Name="fixed_purchase_discount_value" Type="decimal" />
      <Input Name="fixed_purchase_discount_type" Type="nvarchar" Size="10" />
      <Input Name="fixed_purchase_item_order_count" Type="int" />
      <Input Name="fixed_purchase_item_shipped_count" Type="int" />
      <Input Name="item_discounted_price" Type="decimal" Size="18,3" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertItem>

  <!-- 商品削除（全て） -->
  <DeleteItemAll>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderItem
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteItemAll>

  <!-- クーポン取得 -->
  <GetCoupon>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderCoupon.*,
                w2_Coupon.*,
                w2_Coupon.exceptional_icon & 2 AS exceptional_icon1,  -- 論理積(AND)で各アイコン設定値取得
                w2_Coupon.exceptional_icon & 4 AS exceptional_icon2,
                w2_Coupon.exceptional_icon & 8 AS exceptional_icon3,
                w2_Coupon.exceptional_icon & 16 AS exceptional_icon4,
                w2_Coupon.exceptional_icon & 32 AS exceptional_icon5,
                w2_Coupon.exceptional_icon & 64 AS exceptional_icon6,
                w2_Coupon.exceptional_icon & 128 AS exceptional_icon7,
                w2_Coupon.exceptional_icon & 256 AS exceptional_icon8,
                w2_Coupon.exceptional_icon & 512 AS exceptional_icon9,
                w2_Coupon.exceptional_icon & 1024 AS exceptional_icon10,
                w2_UserCoupon.*
          FROM  w2_OrderCoupon
                LEFT JOIN w2_Coupon ON
                (
                  w2_OrderCoupon.coupon_id = w2_Coupon.coupon_id
                )
                LEFT JOIN w2_UserCoupon ON
                (
                  w2_OrderCoupon.coupon_id = w2_UserCoupon.coupon_id
                )
         WHERE  w2_OrderCoupon.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetCoupon>

  <!-- クーポン取得（全て） -->
  <GetAllCoupons>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderCoupon
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetAllCoupons>

  <!-- クーポン登録 -->
  <InsertCoupon>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        INSERT  w2_OrderCoupon
                (
                  order_id
                  ,order_coupon_no
                  ,dept_id
                  ,coupon_id
                  ,coupon_no
                  ,coupon_code
                  ,coupon_name
                  ,coupon_disp_name
                  ,coupon_type
                  ,coupon_discount_price
                  ,coupon_discount_rate
                  ,date_created
                  ,date_changed
                  ,last_changed
                )
        VALUES  (
                  @order_id
                  ,@order_coupon_no
                  ,@dept_id
                  ,@coupon_id
                  ,@coupon_no
                  ,@coupon_code
                  ,@coupon_name
                  ,@coupon_disp_name
                  ,@coupon_type
                  ,@coupon_discount_price
                  ,@coupon_discount_rate
                  ,GETDATE()
                  ,GETDATE()
                  ,@last_changed
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_coupon_no" Type="int" />
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_no" Type="int" />
      <Input Name="coupon_code" Type="nvarchar" Size="30" />
      <Input Name="coupon_name" Type="nvarchar" Size="30" />
      <Input Name="coupon_disp_name" Type="nvarchar" Size="30" />
      <Input Name="coupon_type" Type="nvarchar" Size="10" />
      <Input Name="coupon_discount_price" Type="decimal" Size="18,3" />
      <Input Name="coupon_discount_rate" Type="decimal" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertCoupon>

  <!-- クーポン更新 -->
  <UpdateCoupon>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderCoupon
           SET  dept_id = @dept_id
                ,coupon_id = @coupon_id
                ,coupon_no = @coupon_no
                ,coupon_code = @coupon_code
                ,coupon_name = @coupon_name
                ,coupon_disp_name = @coupon_disp_name
                ,coupon_type = @coupon_type
                ,coupon_discount_price = @coupon_discount_price
                ,coupon_discount_rate = @coupon_discount_rate
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
         WHERE  order_id = @order_id
           AND  order_coupon_no = @order_coupon_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_coupon_no" Type="int" />
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_no" Type="int" />
      <Input Name="coupon_code" Type="nvarchar" Size="30" />
      <Input Name="coupon_name" Type="nvarchar" Size="30" />
      <Input Name="coupon_disp_name" Type="nvarchar" Size="30" />
      <Input Name="coupon_type" Type="nvarchar" Size="10" />
      <Input Name="coupon_discount_price" Type="decimal" Size="18,3" />
      <Input Name="coupon_discount_rate" Type="decimal" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateCoupon>

  <!-- クーポン更新(ユーザー統合) -->
  <UpdateCouponForIntegration>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderCoupon
           SET  coupon_no = @coupon_no
                ,date_changed = GETDATE()
                ,last_changed = @last_changed
          FROM  w2_OrderCoupon
                INNER JOIN w2_Order ON
                (
                  w2_OrderCoupon.order_id = w2_Order.order_id
                )
         WHERE  w2_Order.user_id = @user_id
           AND  w2_OrderCoupon.coupon_id = @coupon_id
           AND  w2_OrderCoupon.coupon_no = @coupon_no_old
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_no" Type="int" />
      <Input Name="coupon_no_old" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateCouponForIntegration>

  <!-- クーポン情報削除 -->
  <DeleteOrderCoupon>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderCoupon
         WHERE  w2_OrderCoupon.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderCoupon>

  <!-- クーポン情報削除 （注文ID＆注文クーポン枝番指定）-->
  <DeleteCouponByCouponNo>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderCoupon
         WHERE  w2_OrderCoupon.order_id = @order_id
           AND  w2_OrderCoupon.order_coupon_no = @order_coupon_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_coupon_no" Type="int" />
    </Parameter>
  </DeleteCouponByCouponNo>

  <!-- 注文セットプロモーション取得（全て） -->
  <GetSetPromotionAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderSetPromotion
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetSetPromotionAll>

  <!-- 注文セットプロモーション登録 -->
  <InsertSetPromotion>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderSetPromotion
                (
                  order_id
                  ,order_setpromotion_no
                  ,setpromotion_id
                  ,setpromotion_name
                  ,setpromotion_disp_name
                  ,undiscounted_product_subtotal
                  ,product_discount_flg
                  ,product_discount_amount
                  ,shipping_charge_free_flg
                  ,shipping_charge_discount_amount
                  ,payment_charge_free_flg
                  ,payment_charge_discount_amount
                )
        VALUES  (
                  @order_id
                  ,@order_setpromotion_no
                  ,@setpromotion_id
                  ,@setpromotion_name
                  ,@setpromotion_disp_name
                  ,@undiscounted_product_subtotal
                  ,@product_discount_flg
                  ,@product_discount_amount
                  ,@shipping_charge_free_flg
                  ,@shipping_charge_discount_amount
                  ,@payment_charge_free_flg
                  ,@payment_charge_discount_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="setpromotion_id" Type="nvarchar" Size="10" />
      <Input Name="setpromotion_name" Type="nvarchar" Size="30" />
      <Input Name="setpromotion_disp_name" Type="nvarchar" Size="30" />
      <Input Name="undiscounted_product_subtotal" Type="decimal" Size="18,3" />
      <Input Name="product_discount_flg" Type="nvarchar" Size="1" />
      <Input Name="product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="payment_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="payment_charge_discount_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertSetPromotion>

  <!-- 注文セットプロモーション削除 -->
  <DeleteSetPromotionAll>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderSetPromotion
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteSetPromotionAll>

  <!-- 取得 -->
  <GetOrderPriceByTaxRateAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderPriceByTaxRate
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderPriceByTaxRateAll>

  <!-- 追加ポイント調整 -->
  <AdjustAddPoint>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  order_point_add = @order_point_add,
                last_changed = @last_changed
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_point_add" Type="decimal" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </AdjustAddPoint>

  <!-- 注文情報を取得（ステータス更新メール用） -->
  <GetForOrderMail>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderSetPromotion.*,
                w2_OrderCoupon.*,
                w2_ShopShipping.*,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_FixedPurchase.*,
                w2_User.*,
                w2_DeliveryCompany.*
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_DeliveryCompany.delivery_company_id = w2_OrderShipping.delivery_company_id
                )
                LEFT JOIN w2_SubscriptionBox ON
                (
                  w2_Order.subscription_box_course_id = w2_SubscriptionBox.subscription_box_course_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetForOrderMail>

  <!-- 注文情報を取得（ステータス更新メール用） -->
  <GetAllForOrderMail>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderSetPromotion.*,
                w2_OrderCoupon.*,
                w2_ShopShipping.*,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_FixedPurchase.*,
                w2_User.*,
                w2_DeliveryCompany.*,
                w2_DeliveryLeadTime.*
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_DeliveryCompany.delivery_company_id = w2_OrderShipping.delivery_company_id
                )
                LEFT JOIN w2_SubscriptionBox ON
                (
                  w2_Order.subscription_box_course_id = w2_SubscriptionBox.subscription_box_course_id
                )
                LEFT JOIN w2_DeliveryLeadTime ON
                (
                  w2_OrderShipping.shipping_addr1 = w2_DeliveryLeadTime.lead_time_zone_name
                  AND
                  w2_OrderShipping.delivery_company_id = w2_DeliveryLeadTime.delivery_company_id
                )
      ]]>
    </Statement>
    <Parameter>
    </Parameter>
  </GetAllForOrderMail>

  <!-- 注文情報に紐づくシリアルキーを取得（ステータス更新メール用） -->
  <GetOrderSerialKeyForOrderMail>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderItem.*,
                w2_SerialKey.*
          FROM  w2_Order
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                INNER JOIN w2_SerialKey ON
                (
                  w2_OrderItem.order_id = w2_SerialKey.order_id
                  AND
                  w2_OrderItem.order_item_no = w2_SerialKey.order_item_no
                )
         WHERE  w2_Order.order_id = @order_id
           AND  w2_SerialKey.status = 'DELIVERED'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderSerialKeyForOrderMail>

  <!-- 注文IDとクーポン利用ユーザー(メールアドレスorユーザーID)から注文情報を取得 -->
  <GetOrderByOrderIdAndCouponUseUser>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
         WHERE  w2_Order.order_id = @order_id
                AND
                @coupon_use_user =
                  CASE @used_user_judge_type
                    WHEN 'MailAddress' THEN w2_User.mail_addr
                    WHEN 'UserId' THEN w2_User.user_id
                  END
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="coupon_use_user" Type="nvarchar" Size="256" />
      <Input Name="used_user_judge_type" Type="nvarchar" Size="15" />
    </Parameter>
  </GetOrderByOrderIdAndCouponUseUser>

  <!-- 外部連携受注IDから注文情報を取得 -->
  <GetOrderByExternalOrderId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
         WHERE  w2_Order.external_order_id = @external_order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="external_order_id" Type="nvarchar" Size="50" />
    </Parameter>
  </GetOrderByExternalOrderId>

  <!-- 注文同梱可能な注文情報取得 -->
  <GetCombinableOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_User
                INNER JOIN w2_Order ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_User.user_id = @user_id
           AND  w2_Order.mall_id = 'OWN_SITE'
           AND  w2_Order.order_date >= @order_date_deadline
           AND  w2_Order.shipping_id = @shipping_id
           <@@hasval:shipping_date_deadline@@>
           AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
           </@@hasval:shipping_date_deadline@@>
           AND  w2_Order.order_status in (@@ order_status @@)
           AND  w2_Order.order_payment_kbn in (@@ order_payment_kbn @@)
           AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
           AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
           AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
           @@ fixed_purchase_condition @@
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shipping_id" Type="nvarchar" Size="30" />
      <Input Name="order_date_deadline" Type="datetime" />
      <Input Name="shipping_date_deadline" Type="datetime" />
    </Parameter>
  </GetCombinableOrder>

  <!-- 注文同梱可能な注文数取得 -->
  <GetCombinableOrderCount>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  COUNT(*)
          FROM  w2_User
                INNER JOIN w2_Order ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_User.user_id = @user_id
           AND  w2_Order.mall_id = 'OWN_SITE'
           AND  w2_Order.order_date >= @order_date_deadline
           AND  w2_Order.shipping_id = @shipping_id
           <@@hasval:shipping_date_deadline@@>
           AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
           </@@hasval:shipping_date_deadline@@>
           AND  w2_Order.order_status in (@@ order_status @@)
           AND  w2_Order.order_payment_kbn in (@@ order_payment_kbn @@)
           AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
           AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
           AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
           @@ fixed_purchase_condition @@
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shipping_id" Type="nvarchar" Size="30" />
      <Input Name="order_date_deadline" Type="datetime" />
      <Input Name="shipping_date_deadline" Type="datetime" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetCombinableOrderCount>

  <!-- 3Dセキュア情報更新 -->
  <Update3dsecureInfo>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.card_3dsecure_tran_id = @card_3dsecure_tran_id,
                w2_Order.card_3dsecure_auth_url = @card_3dsecure_auth_url,
                w2_Order.card_3dsecure_auth_key = @card_3dsecure_auth_key,
                w2_Order.last_changed = @last_changed
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="card_3dsecure_tran_id" Type="nvarchar" Size="100" />
      <Input Name="card_3dsecure_auth_url" Type="nvarchar" Size="MAX" />
      <Input Name="card_3dsecure_auth_key" Type="nvarchar" Size="1000" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </Update3dsecureInfo>

  <!-- Amazon出荷通知対象取得 -->
  <GetForAmazonOrderFulfilment>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.order_id,
                w2_Order.order_shipped_date,
                w2_Order.order_delivering_date,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_method,
                w2_OrderShipping.shipping_check_no,
                w2_DeliveryCompany.delivery_company_name
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_OrderShipping.order_id = w2_Order.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = 1
                )
                INNER JOIN w2_DeliveryCompany ON
                (
                  w2_DeliveryCompany.delivery_company_id = w2_OrderShipping.delivery_company_id
                )
         WHERE  w2_Order.order_status IN ('SHP_COMP', 'DLV_COMP')
           AND  w2_Order.mall_link_status = 'UNSHIP_ODR'
           AND  w2_Order.external_import_status = 'COMP'
           AND  w2_Order.mall_id = @mall_id
           AND  w2_Order.return_exchange_kbn = '00'   -- 元注文のみ対象
      ]]>
    </Statement>
    <Parameter>
      <Input Name="mall_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetForAmazonOrderFulfilment>

  <!-- 類似配送先注文ID取得(定期商品) -->
  <GetOrderIdForFixedProductOrderLimitCheck>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.order_id,
                w2_OrderItem.product_id
          FROM  (
                   SELECT  shop_id,
                           product_id,
                           variation_id,
                           variation_fixed_purchase_firsttime_price,
                           fixed_purchase_product_order_limit_flg
                     FROM  w2_ProductVariationView
                ) AS ProductVariationView
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderItem.shop_id = ProductVariationView.shop_id
                  AND
                  w2_OrderItem.product_id = ProductVariationView.product_id
                  AND
                  w2_OrderItem.variation_id = ProductVariationView.variation_id
                )
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_OrderShipping.order_id = w2_Order.order_id
                )
                <@@val:table_name:w2_OrderOwner@@>
                INNER JOIN w2_OrderOwner ON
                (
                  w2_OrderOwner.order_id = w2_OrderShipping.order_id
                )
                </@@val:table_name:w2_OrderOwner@@>
         WHERE  w2_OrderItem.shop_id = @shop_id
           AND  w2_OrderItem.product_id IN (@@ productIds @@)
           AND  w2_OrderItem.fixed_purchase_product_flg = '1'
           AND  w2_Order.order_status <> 'ODR_CNSL'
           AND  w2_Order.order_status <> 'TMP_CNSL'
           AND  ProductVariationView.fixed_purchase_product_order_limit_flg = '1'
           AND  ProductVariationView.variation_fixed_purchase_firsttime_price is not null
           AND  (@@ condition @@)
           <@@hasval:not_include_order@@>
           AND  NOT EXISTS
                (
                  SELECT  order_id
                    FROM  w2_Order o
                   WHERE  o.order_id = w2_Order.order_id
                     AND  o.order_id IN (@@ notExistsOrderIds @@)
                )
           </@@hasval:not_include_order@@>
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetOrderIdForFixedProductOrderLimitCheck>

  <!-- 類似配送先注文ID取得(通常商品) -->
  <GetOrderIdForProductOrderLimitCheck>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.order_id,
                w2_OrderItem.product_id
          FROM  (
                   SELECT  shop_id,
                           product_id,
                           variation_id,
                           product_order_limit_flg_fp
                     FROM  w2_ProductVariationView
                ) AS ProductVariationView
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderItem.shop_id = ProductVariationView.shop_id
                  AND
                  w2_OrderItem.product_id = ProductVariationView.product_id
                  AND
                  w2_OrderItem.variation_id = ProductVariationView.variation_id
                )
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_OrderShipping.order_id = w2_Order.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_OrderOwner.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_OrderItem.shop_id = @shop_id
           AND  w2_OrderItem.product_id IN (@@ productIds @@)
           AND  w2_OrderItem.fixed_purchase_product_flg = '0'
           AND  w2_Order.order_status <> 'ODR_CNSL'
           AND  w2_Order.order_status <> 'TMP_CNSL'
           AND  ProductVariationView.product_order_limit_flg_fp = '1'
           AND  (@@ condition @@)
           AND  NOT EXISTS
                (
                  SELECT  order_id
                    FROM  w2_Order o
                   WHERE  o.order_id = w2_Order.order_id
                     AND  o.order_id IN (@@ notExistsOrderIds @@)
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetOrderIdForProductOrderLimitCheck>

  <!-- Lohaco予約注文の取得 -->
  <GetLohacoReserveOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
         WHERE  w2_Order.shop_id = @shop_id
           AND  w2_Order.mall_id = @mall_id
           AND  w2_Order.@@extend_status_name@@ = @extend_status_value
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="extend_status_value" Type="nvarchar" Size="10" />
    </Parameter>
  </GetLohacoReserveOrder>

  <!-- 最新の定期注文の取得 -->
  <GetLastFixedPurchaseOrder>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  TOP 1 w2_Order.*
          FROM  w2_Order
                INNER JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
         WHERE  w2_FixedPurchase.fixed_purchase_id = @fixed_purchase_id
        ORDER BY w2_order.order_date desc
      ]]>
    </Statement>
    <Parameter>
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetLastFixedPurchaseOrder>

  <!-- 返品交換注文商品情報を取得 -->
  <GetReturnExchangeOrderItems>
    <Statement>
      <![CDATA[
         SELECT  w2_OrderItem.*
           FROM  w2_OrderItem
                 LEFT JOIN w2_Order ON
                 (
                   w2_Order.order_id = w2_OrderItem.order_id
                 )
          WHERE  w2_Order.order_id_org = @order_id_org
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </GetReturnExchangeOrderItems>

  <!-- 注文同梱可能な注文数取得 -->
  <GetCombinableParentOrderWithConditionCount>
    <Statement>
      <![CDATA[
        SELECT  COUNT(*)
          FROM  (
                  SELECT  w2_Order.order_payment_kbn,
                          w2_Order.user_id,
                          w2_Order.shipping_id,
                          w2_Order.order_id,
                          w2_Order.fixed_purchase_id
                    FROM  w2_User
                          INNER JOIN w2_Order ON
                          (
                            w2_Order.user_id = w2_User.user_id
                          )
                          INNER JOIN w2_OrderShipping ON
                          (
                            w2_Order.order_id = w2_OrderShipping.order_id
                          )
                   WHERE  w2_Order.mall_id = 'OWN_SITE'
                     AND  w2_Order.order_date >= @order_date_deadline
                     <@@hasval:shipping_date_deadline@@>
                     AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
                     </@@hasval:shipping_date_deadline@@>
                     AND  w2_Order.order_status in (@@ order_status @@)
                     AND  w2_Order.order_payment_kbn in (@@ order_payment_kbn @@)
                     AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
                     AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
                     AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
                     @@ user_id_condition @@
                     @@ user_name_condition @@
                ) AS ParentOrder
                -- 注文同梱できる注文が存在することが条件
         WHERE  Exists
                (
                  SELECT  1
                    FROM  (
                            SELECT  w2_Order.user_id,
                                    w2_Order.shipping_id,
                                    w2_Order.order_id
                              FROM  w2_Order
                                    INNER JOIN w2_OrderShipping ON
                                    (
                                      w2_Order.order_id = w2_OrderShipping.order_id
                                    )
                              WHERE  w2_Order.mall_id = 'OWN_SITE'
                                AND  w2_Order.order_date >= @order_date_deadline
                                <@@hasval:shipping_date_deadline@@>
                                AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
                                </@@hasval:shipping_date_deadline@@>
                                AND  w2_Order.order_status in (@@ order_status @@)
                                AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
                                AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
                                AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
                                AND  NOT Exists
                                     (
                                       SELECT  1
                                         FROM  w2_OrderItem
                                               INNER JOIN w2_Product ON
                                               (
                                                w2_OrderItem.shop_id = w2_Product.shop_id
                                                AND
                                                w2_OrderItem.product_id = w2_Product.product_id
                                               )
                                        WHERE  w2_OrderItem.order_id = w2_Order.order_id
                                          AND  w2_Product.limited_payment_ids like '%' + ParentOrder.order_payment_kbn + '%'
                                     )
                                @@ fixed_purchase_condition @@
                          ) AS CombinableChildOrder
                   WHERE  ParentOrder.user_id = CombinableChildOrder.user_id
                     AND  ParentOrder.shipping_id = CombinableChildOrder.shipping_id
                     AND  ParentOrder.order_id <> CombinableChildOrder.order_id
                     AND  ParentOrder.order_payment_kbn <> 'K70'
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_date_deadline" Type="datetime" />
      <Input Name="shipping_date_deadline" Type="datetime" />
    </Parameter>
  </GetCombinableParentOrderWithConditionCount>

  <!-- 注文同梱可能な子注文情報取得 -->
  <GetCombinableChildOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_User
                INNER JOIN w2_Order ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_User.user_id = @user_id
           AND  w2_Order.mall_id = 'OWN_SITE'
           AND  w2_Order.order_date >= @order_date_deadline
           AND  w2_Order.shipping_id = @shipping_id
           <@@hasval:shipping_date_deadline@@>
           AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
           </@@hasval:shipping_date_deadline@@>
           AND  w2_Order.order_status in (@@ order_status @@)
           AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
           AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
           AND  w2_Order.order_id <> @order_id
           @@ fixed_purchase_condition @@
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shipping_id" Type="nvarchar" Size="30" />
      <Input Name="order_date_deadline" Type="datetime" />
      <Input Name="shipping_date_deadline" Type="datetime" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </GetCombinableChildOrder>

  <!-- 注文同梱可能な注文情報取得 -->
  <GetCombinableParentOrderWithCondition>
    <Statement>
      <![CDATA[
        SELECT  OrderWithRowNum.*
          FROM  (
                  SELECT  *,
                          ROW_NUMBER() OVER(ORDER BY ParentOrder.shipping_date) as row_num
                    FROM  (
                            SELECT  w2_Order.*,
                                    w2_OrderShipping.shipping_date
                              FROM  w2_User
                                    INNER JOIN w2_Order ON
                                    (
                                      w2_Order.user_id = w2_User.user_id
                                    )
                                    INNER JOIN w2_OrderShipping ON
                                    (
                                      w2_Order.order_id = w2_OrderShipping.order_id
                                    )
                             WHERE  w2_Order.mall_id = 'OWN_SITE'
                               AND  w2_Order.order_date >= @order_date_deadline
                               <@@hasval:shipping_date_deadline@@>
                               AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
                               </@@hasval:shipping_date_deadline@@>
                               AND  w2_Order.order_status in (@@ order_status @@)
                               AND  w2_Order.order_payment_kbn in (@@ order_payment_kbn @@)
                               AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
                               AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
                               AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
                               @@ user_id_condition @@
                               @@ user_name_condition @@
                          ) AS ParentOrder
                   WHERE  Exists
                          (
                            SELECT  1
                              FROM  (
                                      SELECT  w2_Order.*
                                        FROM  w2_Order
                                              INNER JOIN w2_OrderShipping ON
                                              (
                                                w2_Order.order_id = w2_OrderShipping.order_id
                                              )
                                        WHERE  w2_Order.mall_id = 'OWN_SITE'
                                          AND  w2_Order.order_date >= @order_date_deadline
                                          <@@hasval:shipping_date_deadline@@>
                                          AND  w2_OrderShipping.shipping_date >= @shipping_date_deadline
                                          </@@hasval:shipping_date_deadline@@>
                                          AND  w2_Order.order_status in (@@ order_status @@)
                                          AND  w2_Order.order_payment_status in (@@ order_payment_status @@)
                                          AND  w2_Order.shipping_id not in (@@ deny_shipping_id @@)
                                          AND  w2_OrderShipping.shipping_method not in (@@ deny_shipping_method @@)
                                          AND  NOT Exists
                                               (
                                                 SELECT  1
                                                   FROM  w2_OrderItem
                                                         INNER JOIN w2_Product ON
                                                         (
                                                           w2_OrderItem.product_id = w2_Product.product_id
                                                         )
                                                  WHERE  w2_OrderItem.order_id = w2_Order.order_id
                                                    AND  w2_Product.limited_payment_ids like '%' + ParentOrder.order_payment_kbn + '%'
                                               )
                                          @@ fixed_purchase_condition @@
                                    ) AS CombinableChildOrder
                             WHERE  ParentOrder.user_id = CombinableChildOrder.user_id
                               AND  ParentOrder.shipping_id = CombinableChildOrder.shipping_id
                               AND  ParentOrder.order_id <> CombinableChildOrder.order_id
                          )
                 ) AS OrderWithRowNum
         WHERE  OrderWithRowNum.row_num >= @start_row_num
           AND  OrderWithRowNum.row_num <= @end_row_num
         ORDER BY OrderWithRowNum.row_num
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_date_deadline" Type="datetime" />
      <Input Name="shipping_date_deadline" Type="datetime" />
      <Input Name="start_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetCombinableParentOrderWithCondition>

  <!-- 注文キャンセル用注文情報を取得(注文同梱時キャンセル用) -->
  <GetOrderForOrderCancel>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id as item_supplier_id,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(w2_OrderItem.variation_id, LEN(w2_OrderItem.variation_id) - LEN(w2_OrderItem.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name,
                w2_Product.fixed_purchase_flg AS fixed_purchase_flg_product
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderForOrderCancel>

  <!-- 注文情報の最終値(最終請求金額など)更新 -->
  <UpdateOrderLastAmount>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  last_billed_amount = @last_billed_amount
                ,last_order_point_use = @last_order_point_use
                ,last_order_point_use_yen = @last_order_point_use_yen
                ,last_changed = @last_changed
                ,date_changed = GETDATE()
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="last_order_point_use" Type="decimal" />
      <Input Name="last_order_point_use_yen" Type="decimal" Size="18,3" />
    </Parameter>
  </UpdateOrderLastAmount>

  <!--外部決済連携ログを更新-->
  <AppendExternalPaymentCooperationLog>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.external_payment_cooperation_log = w2_Order.external_payment_cooperation_log + @external_payment_cooperation_log,
                last_changed = @last_changed
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="external_payment_cooperation_log" Type="nvarchar" Size="MAX" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </AppendExternalPaymentCooperationLog>

  <!--商品同梱：過去注文回数取得-->
  <GetOrderedCountForProductBundle>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderItem.product_bundle_id,
                COUNT(w2_Order.order_id) AS ordered_count
          FROM  w2_Order WITH (NOLOCK)
               LEFT JOIN w2_Order AS OrderReturn WITH (NOLOCK) ON
               (
                 OrderReturn.order_id_org = w2_Order.order_id
               )
               INNER JOIN w2_OrderItem WITH (NOLOCK) ON
               (
                 w2_OrderItem.order_id = w2_Order.order_id
               )
         WHERE  w2_Order.user_id = @user_id
           AND  (
                  (
                    OrderReturn.order_id IS NULL
                    AND
                    w2_Order.order_status NOT IN ('ODR_CNSL','TMP_CNSL')
                    AND
                    w2_Order.order_id NOT IN (@@ excludeOrderIds @@)
                  )
                  OR
                  (
                    OrderReturn.order_id IS NOT NULL
                    AND
                    (
                      OrderReturn.return_exchange_kbn <> '01' -- 返品時を除く
                      OR
                      OrderReturn.order_return_exchange_status <> '03' -- 返品交換完了時を除く
                    )
                  )
                )
           AND  w2_OrderItem.product_bundle_id in (@@ productBundleIds @@)
        GROUP BY w2_OrderItem.product_bundle_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderedCountForProductBundle>

  <!-- 受注情報の累計購入回数更新 -->
  <UpdateOrderCountByUserId>
    <Statement>
      <![CDATA[
        create table #tmp_table
        (
        order_id nvarchar(30),
        t_user_id nvarchar(30),
        order_date datetime,
        user_order_count int
        )
        
        INSERT INTO #tmp_table(order_id,t_user_id,order_date,user_order_count)
        SELECT order_id,w2_Order.user_id,order_date,order_count_old
        FROM w2_Order
        LEFT JOIN w2_User ON w2_Order.user_id = w2_User.user_id
        WHERE w2_Order.user_id = @user_id
        ORDER BY order_date
        
        DECLARE @order_id nvarchar(30)
        DECLARE @t_user_id nvarchar(30)
        DECLARE @order_date datetime
        DECLARE @user_order_count int
        DECLARE test CURSOR LOCAL FOR SELECT order_id, t_user_id, order_date, user_order_count FROM #tmp_table
        DECLARE @order_count int = 0
        OPEN test
        FETCH NEXT FROM test INTO @order_id,@t_user_id,@order_date,@user_order_count
        
        WHILE @@FETCH_STATUS = 0
        BEGIN
        
        SET @order_count =
          (
            SELECT COUNT(*) FROM w2_Order
             WHERE order_date <= @order_date
               AND user_id = @user_id
               AND order_status <> 'ODR_CNSL'
               AND order_status <> 'TMP_CNSL'
               AND return_exchange_kbn = '00'
          )
        
        UPDATE  w2_Order
           SET  order_count_order = 
                (CASE
                  WHEN order_status IN ('ODR_CNSL', 'TMP_CNSL') AND @order_count = @order_count_old
                    THEN (@order_count_old + 1)
                  WHEN return_exchange_kbn = '00'
                    THEN @order_count + @order_count_old
                  ELSE
                    null
                END)
         WHERE  order_id = @order_id
        
        FETCH NEXT FROM test
        INTO @order_id,@t_user_id,@order_date,@user_order_count
        END
        
        IF OBJECT_ID(N'tempdb..#tmp_table', N'U') IS NOT NULL
        DROP TABLE #tmp_table;
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="order_count_old" Type="int" />
    </Parameter>
  </UpdateOrderCountByUserId>

  <!-- 税率毎価格情報取得(全て) -->
  <GetPriceInfoByTaxRateAll>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_OrderPriceByTaxRate
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetPriceInfoByTaxRateAll>

  <GetTaxRateIncludeReturnExchange>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderPriceByTaxRate.key_tax_rate
                ,SUM(w2_OrderPriceByTaxRate.price_subtotal_by_rate) as price_subtotal_by_rate
                ,SUM(w2_OrderPriceByTaxRate.price_total_by_rate) as price_total_by_rate
                ,SUM(w2_OrderPriceByTaxRate.tax_price_by_rate) as tax_price_by_rate
          FROM  w2_OrderPriceByTaxRate
          WHERE w2_OrderPriceByTaxRate.order_id LIKE @order_id + '%'
          GROUP BY w2_OrderPriceByTaxRate.key_tax_rate
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetTaxRateIncludeReturnExchange>

  <!-- 請求書同梱フラグ更新 -->
  <UpdateInvoiceBundleFlg>
    <Statement>
      <![CDATA[
         UPDATE  w2_Order
            SET  invoice_bundle_flg = @invoice_bundle_flg,
                 last_changed = @last_changed,
                 date_changed = GETDATE()
          WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="invoice_bundle_flg" Type="nvarchar" Size="1" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateInvoiceBundleFlg>

  <!-- Get All TwOrderInvoice By Order Id -->
  <GetInvoiceAll>
    <Statement>
      <![CDATA[
        SELECT  w2_TwOrderInvoice.*
          FROM  w2_TwOrderInvoice
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetInvoiceAll>

  <!-- Get Orders Return Exchange By Order Id -->
  <GetOrdersReturnExchangeByOrderId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id as item_supplier_id,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(w2_OrderItem.variation_id, LEN(w2_OrderItem.variation_id) - LEN(w2_OrderItem.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name,
                w2_Product.fixed_purchase_flg AS fixed_purchase_flg_product
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_Order.order_id_org = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrdersReturnExchangeByOrderId>

  <!-- Get Related Order Items -->
  <GetRelatedOrderItems>
    <Statement>
      <![CDATA[
         SELECT  w2_OrderItem.*
           FROM  w2_OrderItem
                 LEFT JOIN w2_Order ON
                 (
                   w2_Order.order_id = w2_OrderItem.order_id
                 )
          WHERE  w2_Order.order_id = @order_id_org
             OR  w2_Order.order_id_org = @order_id_org
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
    </Parameter>
  </GetRelatedOrderItems>

  <!-- Get Last Order -->
  <GetLastOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
         WHERE  w2_Order.user_id = @user_id
           AND  w2_Order.order_payment_kbn NOT IN (@@ payment_ids @@)
           AND  w2_Order.order_date IS NOT NULL
        ORDER BY w2_Order.order_date DESC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetLastOrder>

  <!-- Get Orders Without Return Exchange And Rejection -->
  <GetOrdersWithoutReturnExchangeAndRejection>
    <Statement>
      <![CDATA[
        SELECT  order1.*
          FROM  w2_Order order1
         WHERE  order1.user_id = @user_id
           AND  order1.order_payment_kbn NOT IN (@@ payment_ids @@)
           AND  order1.extend_status6 = 0 -- 拒否
           AND  order1.order_id_org = ''
           AND  NOT EXISTS
                (
                  SELECT  order2.order_id
                    FROM  w2_Order order2
                   WHERE  order1.order_id = order2.order_id_org
                )
           AND  order1.order_status NOT IN (@@ order_status @@)
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrdersWithoutReturnExchangeAndRejection>

  <!-- Get Orders Last Three Month Without Return Exchange -->
  <GetOrdersLastThreeMonthWithoutReturnExchange>
    <Statement>
      <![CDATA[
        SELECT  order1.*
          FROM  w2_Order order1
         WHERE  order1.user_id = @user_id
           AND  order1.order_payment_kbn NOT IN (@@ payment_ids @@)
           AND  order1.order_date <= GETDATE()
           AND  order1.order_date >= @start_date
           AND  order1.order_id_org = ''
           AND  NOT EXISTS
                (
                  SELECT  order2.order_id
                    FROM  w2_Order order2
                   WHERE  order1.order_id = order2.order_id_org
                )
           AND  order1.order_status NOT IN (@@ order_status @@)
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="start_date" Type="datetime" />
    </Parameter>
  </GetOrdersLastThreeMonthWithoutReturnExchange>

  <!-- Get First Fixed Purchase Order -->
  <GetFirstFixedPurchaseOrder>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  TOP 1 w2_Order.*
          FROM  w2_Order
                INNER JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
         WHERE  w2_FixedPurchase.fixed_purchase_id = @fixed_purchase_id
        ORDER BY w2_order.order_date ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetFirstFixedPurchaseOrder>

  <!-- Get Order By Card Tran Id -->
  <GetOrderByCardTranId>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  TOP 1 *
          FROM  w2_Order
         WHERE  card_tran_id = @card_tran_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="card_tran_id" Type="nvarchar" Size="100" />
    </Parameter>
  </GetOrderByCardTranId>

  <!-- Get All Order Relate Fixed Purchase -->
  <GetAllOrderRelateFixedPurchase>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

         SELECT  w2_Order.*
           FROM  w2_Order
                 INNER  JOIN  w2_FixedPurchase ON
                 (
                   w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                 )
          WHERE  w2_Order.fixed_purchase_id = @fixed_purchase_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetAllOrderRelateFixedPurchase>

  <!-- 連携メモの更新 -->
  <AppendRelationMemo>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.relation_memo = relation_memo + @relation_memo,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="relation_memo" Type="ntext" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </AppendRelationMemo>

  <!-- Get Orders For Line -->
  <GetOrdersForLine>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  TOP(@limit) *
          FROM  (
                  SELECT  *
                    FROM  w2_Order
                   WHERE  (
                            user_id = @user_id
                            OR
                            fixed_purchase_id = @fixed_purchase_id
                          )
                     AND  order_status NOT IN ('ODR_CNSL', 'TMP_CNSL', '')
                     AND  date_changed >= @date_changed
                  ORDER BY order_date DESC
                           OFFSET @offset ROWS
                ) AS TEMP
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
      <Input Name="limit" Type="int" />
      <Input Name="offset" Type="int" />
      <Input Name="date_changed" Type="DateTime" />
    </Parameter>
  </GetOrdersForLine>

  <!-- Get orders by order status -->
  <GetOrdersByOrderStatus>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*
          FROM  w2_Order
         WHERE  w2_Order.order_status = @order_status
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_status" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrdersByOrderStatus>

  <!-- 決済種別と複数の注文IDから注文情報取得 -->
  <GetMulitpleOrdersByOrderIdsAndPaymentKbn>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
         WHERE  order_id IN (@@ orderIds @@)
           AND  order_payment_kbn = @order_payment_kbn;
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </GetMulitpleOrdersByOrderIdsAndPaymentKbn>

  <!-- Get orders for elogit wms cooperation -->
  <GetOrdersForElogitWmsCooperation>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.order_price_shipping,
                w2_Order.order_price_shipping_tax,
                w2_Order.order_price_exchange,
                w2_Order.order_price_exchange_tax,
                w2_Order.last_billed_amount,
                w2_Order.shipping_memo,
                w2_Order.order_id,
                w2_Order.user_id,
                w2_Order.member_rank_discount_price,
                w2_Order.order_payment_kbn,
                w2_Order.setpromotion_product_discount_amount,
                w2_Order.setpromotion_shipping_charge_discount_amount,
                w2_Order.setpromotion_payment_charge_discount_amount,
                w2_Order.order_point_use_yen,
                w2_Order.order_coupon_use,
                w2_Order.order_point_use,
                w2_Order.order_price_subtotal,
                w2_Order.order_price_total,
                w2_Order.order_price_regulation,
                w2_Order.order_discount_set_price,
                w2_Order.fixed_purchase_member_discount_amount,
                w2_Order.fixed_purchase_discount_price,
                w2_Order.order_point_add,
                (
                  SELECT  w2_UserPoint.point
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.user_id = w2_Order.user_id
                     AND  w2_UserPoint.point_type = '01'
                     AND  w2_UserPoint.point_kbn = '01'
                ) AS point,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderItem.variation_id,
                w2_OrderItem.product_name,
                w2_OrderItem.item_quantity,
                w2_OrderItem.product_price,
                w2_OrderItem.product_tax_rate,
                w2_OrderItem.item_price_tax,
                ISNULL((
                  SELECT  SUM(w2_OrderItem.product_price * w2_OrderItem.item_quantity)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                     AND  w2_OrderItem.product_tax_rate = '8.00'
                ), 0) AS price_total_item_8,
                ISNULL((
                  SELECT  SUM(w2_OrderItem.product_price * w2_OrderItem.item_quantity)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                     AND  w2_OrderItem.product_tax_rate = '10.00'
                ), 0) AS price_total_item_10,
                ISNULL((
                  SELECT  w2_OrderPriceByTaxRate.price_subtotal_by_rate
                    FROM  w2_OrderPriceByTaxRate
                   WHERE  w2_OrderPriceByTaxRate.order_id = w2_Order.order_id
                     AND  w2_OrderPriceByTaxRate.key_tax_rate = '8.00'
                ), 0) AS price_subtotal_by_rate_8,
                ISNULL((
                  SELECT  w2_OrderPriceByTaxRate.price_subtotal_by_rate
                    FROM  w2_OrderPriceByTaxRate
                   WHERE  w2_OrderPriceByTaxRate.order_id = w2_Order.order_id
                     AND  w2_OrderPriceByTaxRate.key_tax_rate = '10.00'
                ), 0) AS price_subtotal_by_rate_10,
                ISNULL((
                  SELECT  w2_OrderPriceByTaxRate.tax_price_by_rate
                    FROM  w2_OrderPriceByTaxRate
                   WHERE  w2_OrderPriceByTaxRate.order_id = w2_Order.order_id
                     AND  w2_OrderPriceByTaxRate.key_tax_rate = '8.00'
                ), 0) AS tax_price_by_rate_8,
                ISNULL((
                  SELECT  w2_OrderPriceByTaxRate.tax_price_by_rate
                    FROM  w2_OrderPriceByTaxRate
                   WHERE  w2_OrderPriceByTaxRate.order_id = w2_Order.order_id
                     AND  w2_OrderPriceByTaxRate.key_tax_rate = '10.00'
                ), 0) AS tax_price_by_rate_10,
                (
                  SELECT  SUM(w2_OrderPriceByTaxRate.tax_price_by_rate)
                    FROM  w2_OrderPriceByTaxRate
                   WHERE  w2_OrderPriceByTaxRate.order_id = w2_Order.order_id
                  GROUP BY w2_OrderPriceByTaxRate.order_id
                ) AS consumption_tax,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_mail_addr,
                w2_Order.fixed_purchase_order_count,
                w2_Order.card_tran_id,
                w2_Order.invoice_bundle_flg,
                w2_Payment.payment_name
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_Payment ON
                (
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
         WHERE  w2_Order.extend_status41 = '1'
           AND  w2_Order.extend_status42 = '0'
           AND  w2_Order.order_status IN ('ODR', 'ODR_RECG', 'STK_RSVD')
      ]]>
    </Statement>
  </GetOrdersForElogitWmsCooperation>

  <!-- Get order count by order workflow setting -->
  <GetOrderCountByOrderWorkflowSetting>
    <Statement>
      <![CDATA[
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  ISNULL(COUNT(w2_Order.order_id), 0)
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetOrderCountByOrderWorkflowSetting>

  <!-- 交換済み注文情報取得(※親注文IDが等しい注文の返品商品も抽出する) -->
  <GetExchangedOrders>
    <Statement>
      <![CDATA[
        /*
        注文商品を最初にSELECTしている
        結果セット内のOrderIdを注文商品のOrderIdにするため
        （注文商品には別注文IDの返品商品が含まれている)
        */
        SELECT  ReturnExchangeItems.*,
                ReturnExchangeItems.supplier_id AS item_supplier_id,
                ReturnExchangeItems.subscription_box_course_id AS item_subscription_box_course_id,
                ReturnExchangeItems.subscription_box_fixed_amount AS item_subscription_box_fixed_amount,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_Order.*,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(ReturnExchangeItems.variation_id, LEN(ReturnExchangeItems.variation_id) - LEN(ReturnExchangeItems.product_id)) AS v_id,
                w2_Payment.payment_name, 
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN
                (
                  SELECT *
                    FROM w2_OrderItem oiorg
                   WHERE oiorg.order_id = @order_id
                   
                  UNION ALL
                  
                  -- 親注文IDが等しい注文の返品商品
                  SELECT *
                    FROM w2_OrderItem oich
                   WHERE oich.order_id IN
                                      (
                                        SELECT order_id
                                          FROM w2_Order 
                                         WHERE order_id_org = @order_id_org
                                           AND order_id != @order_id
                                           AND order_id > @order_id -- 対象の交換済み注文IDより連番が大きい注文IDが対象
                                       )
                     AND oich.item_return_exchange_kbn = '01'
                ) ReturnExchangeItems ON
                (
                  w2_order.order_id = ReturnExchangeItems.order_id
                  OR
                  ReturnExchangeItems.order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                )                
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )                
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderSetPromotion.order_id = @order_id_org
                  AND
                  ReturnExchangeItems.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_Order.order_id = @order_id 
      ORDER BY  ReturnExchangeItems.date_created ASC -- 注文商品の作成日昇順
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="60" />
    </Parameter>
  </GetExchangedOrders>

  <!-- 交換注文の注文ID群を取得 -->
  <GetExchangedOrderIds>
    <Statement>
      <![CDATA[
        -- 元注文＋関連注文の注文ID群
        SELECT  w2_Order.order_id
          FROM  w2_Order
         WHERE  (
                  (
                    w2_Order.order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                    AND
                    w2_Order.order_id_org = @order_id_org
                  )
                  AND
                  w2_Order.return_exchange_kbn = '10' -- 交換のみ
                  AND
                  w2_Order.order_status != 'ODR_CNSL' -- 注文ステータスがキャンセル以外
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="60" />
    </Parameter>
  </GetExchangedOrderIds>

  <!-- 注文ID、商品IDから注文商品を取得 -->
  <GetItemByOrderIdAndProductId>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderItem.*
          FROM  w2_OrderItem
         WHERE  order_id = @order_id
           AND  product_id = @product_id
           AND  variation_id = @variation_id
           AND  product_bundle_id = ''
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
    </Parameter>
  </GetItemByOrderIdAndProductId>

  <!-- コンビニ後払いで与信結果がHOLDの注文を取得 -->
  <GetCvsDeferredAuthResultHold>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
         WHERE  order_payment_kbn = 'K32' -- コンビニ後払い
           AND  order_status = 'ODR'
           AND  external_payment_status = 'AUTH_MIDST'
      ]]>
    </Statement>
  </GetCvsDeferredAuthResultHold>

  <!-- GMOアトカラで与信結果が審査中の注文を取得 -->
  <GetOrderForGmoAtokaraAuthResult>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
         WHERE  order_payment_kbn = 'K40' -- GMOアトカラ
           AND  order_status = 'ODR'
           AND  external_payment_status = 'AUTH_MIDST'
      ]]>
    </Statement>
  </GetOrderForGmoAtokaraAuthResult>

  <!-- Get order workflow list no pagination -->
  <GetOrderWorkflowListNoPagination>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        ;WITH RowIndex AS
		(
            SELECT  w2_Order.order_id,
                    ROW_NUMBER()
                    OVER
                    (
                    @@ orderby @@
                    ) AS row_num,
					COUNT(w2_Order.order_id) OVER () AS row_count
              FROM  w2_Order
                    INNER JOIN w2_OrderOwner ON
                    (
                    w2_Order.order_id = w2_OrderOwner.order_id
                    )
                    INNER JOIN w2_User ON
                    (
                    w2_Order.user_id = w2_User.user_id
                    )
                    [[ ORDERWORKFLOW_SEARCH_WHERE ]]
		)
		
        -- 該当情報取得
        SELECT  w2_Order.order_id,
                RowIndex.row_count
          FROM  RowIndex
                INNER JOIN w2_Order ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = '1'
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
      ]]>
    </Statement>
  </GetOrderWorkflowListNoPagination>

  <!-- Get Delivery Tran Id List Order Work Flow -->
  <GetDeliveryTranIdListOrderWorkFlow>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.delivery_tran_id
          FROM  w2_Order
                INNER JOIN w2_OrderShipping WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDeliveryTranIdListOrderWorkFlow>

  <!-- Get order payment ids for atobaraicom get authorize status -->
  <GetOrderPaymentIdsForAtobaraicomGetAuthorizeStatus>
    <Statement>
      <![CDATA[
        SELECT  payment_order_id
          FROM  w2_Order
         WHERE  order_payment_kbn = 'K32'
           AND  order_status = 'ODR'
           AND  external_payment_status = 'AUTH_MIDST'
      ]]>
    </Statement>
  </GetOrderPaymentIdsForAtobaraicomGetAuthorizeStatus>

  <!-- 取得 -->
  <GetPointGrantOrder>
    <Statement>
      <![CDATA[
        -- 現在日付取得
        DECLARE @current_date datetime
        SET @current_date = getdate()

        SELECT  *
          FROM  w2_Order
         WHERE  EXISTS
                (
                  SELECT  w2_UserPoint.user_id
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.point_type = '00'
                     AND  w2_UserPoint.user_id = w2_Order.user_id
                     AND  w2_UserPoint.kbn1 = w2_Order.order_id
                     -- 出荷完了 または 配送完了
                     AND  w2_Order.order_status IN ('SHP_COMP', 'DLV_COMP')
                     -- 出荷日からX日以上経ったもの
                     AND  @current_date >= DATEADD(dd, @point_temp_to_comp_days, w2_Order.order_shipped_date)
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="point_temp_to_comp_days" Type="int" />
    </Parameter>
  </GetPointGrantOrder>

  <GetOnlinePaymentStatusByOrderId>
    <Statement>
      <![CDATA[
        SELECT  online_payment_status
          FROM  w2_Order
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOnlinePaymentStatusByOrderId>
  
  <!--Get InReview Gmo Order-->
  <GetInReviewGmoOrder>
    <Statement>
      <![CDATA[
        SET NOCOUNT ON;
            
        SELECT  w2_Order.order_id,
                w2_Order.card_tran_id,
                w2_Order.last_changed
          FROM  w2_Order WITH (NOLOCK)
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_User.user_management_level_id = 'normal'
           AND  (
                  w2_Order.external_payment_status = 'INREVIEW'
                  OR
                  w2_Order.external_payment_status = 'DEPOSITWAITING'
                )
           AND  (
                  w2_Order.order_payment_kbn = 'K38'
                  OR
                  w2_Order.order_payment_kbn = 'K39'
                )
           AND  w2_Order.card_tran_id <> ''
           AND  w2_Order.order_status <> 'ODR_CNSL'
        ]]>
    </Statement>
  </GetInReviewGmoOrder>

  <!-- 注文履歴一覧（注文単位）を取得する -->
	<GetOrderHistoryListByFixedPurchaseId>
    <Statement>
      <![CDATA[
        -- 全件数取得(定期ID指定)
        DECLARE @row_count int
        SELECT  @row_count = ISNULL(COUNT(w2_Order.order_id), 0)
          FROM  w2_Order
                [[ ORDERHISTORY_SEARCH_WHERE ]]
                AND  fixed_purchase_id = @fixed_purchase_id

        -- 該当情報取得
        SELECT  w2_Order.*,
                @row_count AS row_count
          FROM  (
                  SELECT  w2_Order.order_id,
                          ROW_NUMBER()
                          OVER
                          (
                            [[ ORDERHISTORY_SEARCH_ORDER_BY ]]
                          ) AS row_num
                    FROM  w2_Order
                          [[ ORDERHISTORY_SEARCH_WHERE ]]
                          AND  fixed_purchase_id = @fixed_purchase_id
                ) AS RowIndex
                INNER JOIN w2_Order ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
      <Input Name="fixed_purchase_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderHistoryListByFixedPurchaseId>

  <!-- YAHOOモール注文取り込みを行う注文を取得 -->
  <GetOrderIdsForYahooOrderImport>
    <Statement>
      <![CDATA[
        SELECT  order_id,
                user_id
          FROM  w2_Order WITH (NOLOCK)
         WHERE  mall_id = @mall_id
           AND  order_status = 'TMP' -- 仮注文
      ]]>
    </Statement>
    <Parameter>
      <Input Name="mall_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderIdsForYahooOrderImport>

  <!-- YAHOOモール注文取り込みした注文情報を更新-->
  <AddYahooMallOrderDetail>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  user_id = @user_id,
                order_status = @order_status,
                relation_memo = relation_memo + @relation_memo,
                order_payment_kbn = @order_payment_kbn,
                order_payment_status = @order_payment_status,
                <@@hasval:is_paid_with_paypay@@>
                  regulation_memo = regulation_memo + @regulation_memo,
                  order_price_regulation = @order_price_regulation,
                  order_price_total = @order_price_total,
                  last_billed_amount = @last_billed_amount,
                  settlement_amount = @settlement_amount,
                </@@hasval:is_paid_with_paypay@@>
                memo = @memo,
                card_instruments = @card_instruments,
                date_changed = GETDATE(),
                last_changed = 'batch'
         WHERE  shop_id = @shop_id
                AND
                order_id = @order_id
                AND
                order_status = 'TMP'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="20" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="regulation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="relation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_payment_status" Type="nvarchar" Size="1" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="settlement_amount" Type="decimal" Size="18,3" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="card_instruments" Type="nvarchar" Size="30" />
      <Input Name="is_paid_with_paypay" Type="nvarchar" Size="1" />
    </Parameter>
  </AddYahooMallOrderDetail>

  <!-- YAHOOモール注文取り込みした注文者情報を更新 -->
  <AddYahooMallOrderOwnerDetail>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderOwner
           SET  w2_OrderOwner.owner_kbn = @owner_kbn,
                w2_OrderOwner.owner_name = @owner_name,
                w2_OrderOwner.owner_name1 = @owner_name1,
                w2_OrderOwner.owner_name2 = @owner_name2,
                w2_OrderOwner.owner_mail_addr = @owner_mail_addr,
                w2_OrderOwner.owner_addr1 = @owner_addr1,
                w2_OrderOwner.owner_addr2 = @owner_addr2,
                w2_OrderOwner.owner_addr3 = @owner_addr3,
                w2_OrderOwner.owner_addr4 = @owner_addr4,
                w2_OrderOwner.owner_zip = @owner_zip,
                w2_OrderOwner.owner_tel1 = @owner_tel1,
                w2_OrderOwner.date_changed = GETDATE()
         WHERE  w2_OrderOwner.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
    </Parameter>
  </AddYahooMallOrderOwnerDetail>

  <!-- YAHOOモール注文取り込みした注文配送情報を更新 -->
  <AddYahooMallOrderShippingDetail>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderShipping
           SET  w2_OrderShipping.shipping_name = @shipping_name,
                w2_OrderShipping.shipping_name1 = @shipping_name1,
                w2_OrderShipping.shipping_name2 = @shipping_name2,
                w2_OrderShipping.shipping_zip = @shipping_zip,
                w2_OrderShipping.shipping_addr1 = @shipping_addr1,
                w2_OrderShipping.shipping_addr2 = @shipping_addr2,
                w2_OrderShipping.shipping_addr3 = @shipping_addr3,
                w2_OrderShipping.shipping_addr4 = @shipping_addr4,
                w2_OrderShipping.shipping_tel1 = @shipping_tel1,
                w2_OrderShipping.shipping_date = @shipping_date,
                w2_OrderShipping.shipping_time = @shipping_time,
                w2_OrderShipping.date_changed = GETDATE(),
                w2_OrderShipping.another_shipping_flg = @another_shipping_flg
         WHERE  w2_OrderShipping.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_zip" Type="nvarchar" Size="8" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
    </Parameter>
  </AddYahooMallOrderShippingDetail>

  <!-- 店舗受取ステータス更新 -->
  <UpdateStorePickupStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.storepickup_status = @storepickup_status,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = GETDATE()
                <@@hasval:storepickup_store_arrived_date@@>
                ,w2_Order.storepickup_store_arrived_date = @storepickup_store_arrived_date
                </@@hasval:storepickup_store_arrived_date@@>
                <@@hasval:storepickup_delivered_complete_date@@>
                ,w2_Order.storepickup_delivered_complete_date = @storepickup_delivered_complete_date
                </@@hasval:storepickup_delivered_complete_date@@>
                <@@hasval:storepickup_return_date@@>
                ,w2_Order.storepickup_return_date = @storepickup_return_date
                </@@hasval:storepickup_return_date@@>
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="storepickup_status" Type="nvarchar" Size="30" />
      <Input Name="storepickup_store_arrived_date" Type="datetime" />
      <Input Name="storepickup_delivered_complete_date" Type="datetime" />
      <Input Name="storepickup_return_date" Type="datetime" />
    </Parameter>
  </UpdateStorePickupStatus>

  <!-- Get order store pick up count -->
  <GetOrderStorePickUpCount>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        -- 全件数取得
        SELECT  ISNULL(COUNT(DISTINCT w2_Order.order_id), 0) AS order_count
          FROM  w2_Order WITH (NOLOCK)
                INNER JOIN w2_OrderShipping WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_RealShop WITH (NOLOCK) ON
                (
                  w2_OrderShipping.storepickup_real_shop_id = w2_RealShop.real_shop_id
                )
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_tel1_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_tel1_like_escaped@@>
                [[ ORDER_STORE_PICK_UP_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetOrderStorePickUpCount>

  <!-- Get orders for Letro -->
  <GetOrdersForLetro>
    <Statement>
      <![CDATA[
      SELECT  *
        FROM  w2_Order
       WHERE  1 = 1
              <@@hasval:order_from@@>
                AND w2_Order.order_date >= @order_from
              </@@hasval:order_from@@>
              <@@hasval:order_to@@>
                AND w2_Order.order_date < @order_to
              </@@hasval:order_to@@>
              <@@hasval:order_shipped_from@@>
                AND w2_Order.order_shipped_date >= @order_shipped_from
              </@@hasval:order_shipped_from@@>
              <@@hasval:order_shipped_to@@>
                AND w2_Order.order_shipped_date < @order_shipped_to
              </@@hasval:order_shipped_to@@>
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_from" Type="datetime" />
      <Input Name="order_to" Type="datetime" />
      <Input Name="order_shipped_from" Type="datetime" />
      <Input Name="order_shipped_to" Type="datetime" />
    </Parameter>
  </GetOrdersForLetro>

  <!-- 指定期間の出荷注文情報を取得 -->
  <GetShippingOrderForDate>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_OrderShipping.scheduled_shipping_date BETWEEN @min_time AND @max_time
           AND  w2_Order.order_status NOT IN ('ODR_CNSL','TMP','TMP_CNSL')
      ]]>
    </Statement>
    <Parameter>
      <Input Name="min_time" Type="datetime" />
      <Input Name="max_time" Type="datetime" />
    </Parameter>
  </GetShippingOrderForDate>

  <!-- 指定決済が利用不可決済になる商品を持つ注文の件数取得 -->
  <GetCountOrderWithLimitedPaymentIds>
    <Statement>
      <![CDATA[
        SELECT  COUNT(*)
          FROM  w2_OrderItem
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_Product.limited_payment_ids like '%' + @payment_id_like_escaped + '%'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="payment_id_like_escaped" Type="nvarchar" Size="10" />
    </Parameter>
  </GetCountOrderWithLimitedPaymentIds>
</Order>
