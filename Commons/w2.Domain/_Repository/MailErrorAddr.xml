<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : メールエラーアドレスマスタ系SQLステートメントXML (MailErrorAddr.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2018 All Rights Reserved.
=========================================================================================================
-->
<MailErrorAddr>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_MailErrorAddr
         WHERE  mail_addr = @mail_addr
      ]]>
    </Statement>
    <Parameter>
      <Input Name="mail_addr" Type="nvarchar" Size="256" />
    </Parameter>
  </Get>

  <!-- エラーポイント登録（更新） -->
  <Upsert>
    <Statement>
      <![CDATA[
        -- 登録/更新判断用
        DECLARE @counts int
        SELECT  @counts = COUNT(*)
          FROM  w2_MailErrorAddr
         WHERE  mail_addr = @mail_addr
        
        IF @counts = 0
        BEGIN
          -- 登録
          INSERT  w2_MailErrorAddr
                  (
                    mail_addr,
                    error_point,
                    last_changed
                  )
          VALUES  (
                    @mail_addr,
                    @error_point,
                    'batch'
                  )
        END
        ELSE
        BEGIN
          --更新
          UPDATE  w2_MailErrorAddr
             SET  error_point = error_point + @error_point
           WHERE  mail_addr = @mail_addr
        END
        ]]>
    </Statement>
    <Parameter>
      <Input Name="mail_addr" Type="nvarchar" Size="256" />
      <Input Name="error_point" Type="bigint" />
    </Parameter>
  </Upsert>

</MailErrorAddr>
