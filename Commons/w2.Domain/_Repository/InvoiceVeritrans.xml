<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : ベリトランス後払い請求書系SQLステートメントXML (InvoiceVeritrans.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2023 All Rights Reserved.
=========================================================================================================
-->
<InvoiceVeritrans>
  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_InvoiceVeritrans
                INNER JOIN w2_InvoiceVeritransDetail WITH(NOLOCK) ON
                (
                  w2_InvoiceVeritrans.order_id = w2_InvoiceVeritransDetail.order_id
                )
         WHERE  w2_InvoiceVeritrans.order_id = @order_id
         ORDER  BY w2_InvoiceVeritransDetail.detail_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </Get>

  <!-- 登録 -->
  <InsertUpdate>
    <Statement>
      <![CDATA[
        MERGE  w2_InvoiceVeritrans AS target
        USING  (
                  SELECT  @order_id AS order_id
               ) AS source
               ON
               (
                  target.order_id = source.order_id
               )
        WHEN MATCHED THEN
          UPDATE
             SET  service_type = @service_type,
                  m_status = @m_status,
                  v_result_code = @v_result_code,
                  m_err_msg = @m_err_msg,
                  m_arch_txn = @m_arch_txn,
                  payment_order_id = @payment_order_id,
                  cust_txn = @cust_txn,
                  txn_version = @txn_version,
                  invoice_bar_code = @invoice_bar_code,
                  invoice_code = @invoice_code,
                  invoice_kbn = @invoice_kbn,
                  history_seq = @history_seq,
                  reminded_kbn = @reminded_kbn,
                  company_name = @company_name,
                  department = @department,
                  customer_name = @customer_name,
                  customer_zip = @customer_zip,
                  customer_address1 = @customer_address1,
                  customer_address2 = @customer_address2,
                  customer_address3 = @customer_address3,
                  shop_zip = @shop_zip,
                  shop_address1 = @shop_address1,
                  shop_address2 = @shop_address2,
                  shop_address3 = @shop_address3,
                  shop_tel = @shop_tel,
                  shop_fax = @shop_fax,
                  billed_amount = @billed_amount,
                  tax = @tax,
                  time_of_receipts = @time_of_receipts,
                  invoice_start_date = @invoice_start_date,
                  invoice_title = @invoice_title,
                  nissen_message1 = @nissen_message1,
                  nissen_message2 = @nissen_message2,
                  nissen_message3 = @nissen_message3,
                  nissen_message4 = @nissen_message4,
                  invoice_shopsite_name = @invoice_shopsite_name,
                  shop_email = @shop_email,
                  nissen_name = @nissen_name,
                  nissen_qa_url = @nissen_qa_url,
                  shop_order_date = @shop_order_date,
                  shop_code = @shop_code,
                  nissen_transaction_id = @nissen_transaction_id,
                  shop_transaction_id1 = @shop_transaction_id1,
                  shop_transaction_id2 = @shop_transaction_id2,
                  shop_message1 = @shop_message1,
                  shop_message2 = @shop_message2,
                  shop_message3 = @shop_message3,
                  shop_message4 = @shop_message4,
                  shop_message5 = @shop_message5,
                  invoice_form = @invoice_form,
                  postal_account_number = @postal_account_number,
                  postal_account_holder_name = @postal_account_holder_name,
                  postal_font_top_row = @postal_font_top_row,
                  postal_font_bottom_row = @postal_font_bottom_row,
                  remittance_address = @remittance_address,
                  x_symbol = @x_symbol,
                  reserve1 = @reserve1,
                  reserve2 = @reserve2,
                  reserve3 = @reserve3,
                  date_changed = GETDATE(),
                  last_changed = @last_changed
        WHEN NOT MATCHED THEN
          INSERT  (
                    order_id,
                    service_type,
                    m_status,
                    v_result_code,
                    m_err_msg,
                    m_arch_txn,
                    payment_order_id,
                    cust_txn,
                    txn_version,
                    invoice_bar_code,
                    invoice_code,
                    invoice_kbn,
                    history_seq,
                    reminded_kbn,
                    company_name,
                    department,
                    customer_name,
                    customer_zip,
                    customer_address1,
                    customer_address2,
                    customer_address3,
                    shop_zip,
                    shop_address1,
                    shop_address2,
                    shop_address3,
                    shop_tel,
                    shop_fax,
                    billed_amount,
                    tax,
                    time_of_receipts,
                    invoice_start_date,
                    invoice_title,
                    nissen_message1,
                    nissen_message2,
                    nissen_message3,
                    nissen_message4,
                    invoice_shopsite_name,
                    shop_email,
                    nissen_name,
                    nissen_qa_url,
                    shop_order_date,
                    shop_code,
                    nissen_transaction_id,
                    shop_transaction_id1,
                    shop_transaction_id2,
                    shop_message1,
                    shop_message2,
                    shop_message3,
                    shop_message4,
                    shop_message5,
                    invoice_form,
                    postal_account_number,
                    postal_account_holder_name,
                    postal_font_top_row,
                    postal_font_bottom_row,
                    remittance_address,
                    x_symbol,
                    reserve1,
                    reserve2,
                    reserve3,
                    date_created,
                    date_changed,
                    last_changed
                  )
          VALUES  (
                    @order_id,
                    @service_type,
                    @m_status,
                    @v_result_code,
                    @m_err_msg,
                    @m_arch_txn,
                    @payment_order_id,
                    @cust_txn,
                    @txn_version,
                    @invoice_bar_code,
                    @invoice_code,
                    @invoice_kbn,
                    @history_seq,
                    @reminded_kbn,
                    @company_name,
                    @department,
                    @customer_name,
                    @customer_zip,
                    @customer_address1,
                    @customer_address2,
                    @customer_address3,
                    @shop_zip,
                    @shop_address1,
                    @shop_address2,
                    @shop_address3,
                    @shop_tel,
                    @shop_fax,
                    @billed_amount,
                    @tax,
                    @time_of_receipts,
                    @invoice_start_date,
                    @invoice_title,
                    @nissen_message1,
                    @nissen_message2,
                    @nissen_message3,
                    @nissen_message4,
                    @invoice_shopsite_name,
                    @shop_email,
                    @nissen_name,
                    @nissen_qa_url,
                    @shop_order_date,
                    @shop_code,
                    @nissen_transaction_id,
                    @shop_transaction_id1,
                    @shop_transaction_id2,
                    @shop_message1,
                    @shop_message2,
                    @shop_message3,
                    @shop_message4,
                    @shop_message5,
                    @invoice_form,
                    @postal_account_number,
                    @postal_account_holder_name,
                    @postal_font_top_row,
                    @postal_font_bottom_row,
                    @remittance_address,
                    @x_symbol,
                    @reserve1,
                    @reserve2,
                    @reserve3,
                    GETDATE(),
                    GETDATE(),
                    @last_changed
                  );
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="service_type" Type="nvarchar" Size="10" />
      <Input Name="m_status" Type="nvarchar" Size="32" />
      <Input Name="v_result_code" Type="nvarchar" Size="16" />
      <Input Name="m_err_msg" Type="nvarchar" Size="max" />
      <Input Name="m_arch_txn" Type="nvarchar" Size="100" />
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
      <Input Name="cust_txn" Type="nvarchar" Size="100" />
      <Input Name="txn_version" Type="nvarchar" Size="5" />
      <Input Name="invoice_bar_code" Type="nvarchar" Size="44" />
      <Input Name="invoice_code" Type="nvarchar" Size="16" />
      <Input Name="invoice_kbn" Type="nvarchar" Size="1" />
      <Input Name="history_seq" Type="nvarchar" Size="1" />
      <Input Name="reminded_kbn" Type="nvarchar" Size="2" />
      <Input Name="company_name" Type="nvarchar" Size="35" />
      <Input Name="department" Type="nvarchar" Size="35" />
      <Input Name="customer_name" Type="nvarchar" Size="25" />
      <Input Name="customer_zip" Type="nvarchar" Size="7" />
      <Input Name="customer_address1" Type="nvarchar" Size="4" />
      <Input Name="customer_address2" Type="nvarchar" Size="31" />
      <Input Name="customer_address3" Type="nvarchar" Size="35" />
      <Input Name="shop_zip" Type="nvarchar" Size="7" />
      <Input Name="shop_address1" Type="nvarchar" Size="4" />
      <Input Name="shop_address2" Type="nvarchar" Size="31" />
      <Input Name="shop_address3" Type="nvarchar" Size="35" />
      <Input Name="shop_tel" Type="nvarchar" Size="17"/>
      <Input Name="shop_fax" Type="nvarchar" Size="17"/>
      <Input Name="billed_amount" Type="nvarchar" Size="6" />
      <Input Name="tax" Type="nvarchar" Size="6" />
      <Input Name="time_of_receipts" Type="datetime" />
      <Input Name="invoice_start_date" Type="datetime" />
      <Input Name="invoice_title" Type="nvarchar" Size="3" />
      <Input Name="nissen_message1" Type="nvarchar" Size="30" />
      <Input Name="nissen_message2" Type="nvarchar" Size="30" />
      <Input Name="nissen_message3" Type="nvarchar" Size="30" />
      <Input Name="nissen_message4" Type="nvarchar" Size="30" />
      <Input Name="invoice_shopsite_name" Type="nvarchar" Size="75" />
      <Input Name="shop_email" Type="nvarchar" Size="100" />
      <Input Name="nissen_name" Type="nvarchar" Size="50" />
      <Input Name="nissen_qa_url" Type="nvarchar" Size="50" />
      <Input Name="shop_order_date" Type="datetime" />
      <Input Name="shop_code" Type="nvarchar" Size="9" />
      <Input Name="nissen_transaction_id" Type="nvarchar" Size="11" />
      <Input Name="shop_transaction_id1" Type="nvarchar" Size="20" />
      <Input Name="shop_transaction_id2" Type="nvarchar" Size="20" />
      <Input Name="shop_message1" Type="nvarchar" Size="60" />
      <Input Name="shop_message2" Type="nvarchar" Size="60" />
      <Input Name="shop_message3" Type="nvarchar" Size="60" />
      <Input Name="shop_message4" Type="nvarchar" Size="60" />
      <Input Name="shop_message5" Type="nvarchar" Size="60" />
      <Input Name="invoice_form" Type="nvarchar" Size="1" />
      <Input Name="postal_account_number" Type="nvarchar" Size="100" />
      <Input Name="postal_account_holder_name" Type="nvarchar" Size="100" />
      <Input Name="postal_font_top_row" Type="nvarchar" Size="39" />
      <Input Name="postal_font_bottom_row" Type="nvarchar" Size="44" />
      <Input Name="remittance_address" Type="nvarchar" Size="100" />
      <Input Name="x_symbol" Type="nvarchar" Size="100" />
      <Input Name="reserve1" Type="nvarchar" Size="100" />
      <Input Name="reserve2" Type="nvarchar" Size="100" />
      <Input Name="reserve3" Type="nvarchar" Size="100" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertUpdate>

  <!-- 請求書明細登録 -->
  <InsertUpdateDetail>
    <Statement>
      <![CDATA[
        MERGE  w2_InvoiceVeritransDetail AS target
        USING  (
                  SELECT  @order_id AS order_id,
                          @detail_no AS detail_no
               ) AS source
               ON
               (
                  target.order_id = source.order_id
                  AND
                  target.detail_no = source.detail_no
               )
        WHEN MATCHED THEN
          UPDATE
             SET  target.goods_name = @goods_name,
                  target.goods_price = @goods_price,
                  target.goods_num = @goods_num
        WHEN NOT MATCHED THEN
          INSERT  (
                    order_id,
                    detail_no,
                    goods_name,
                    goods_price,
                    goods_num,
                    date_created
                  )
          VALUES  (
                    @order_id,
                    @detail_no,
                    @goods_name,
                    @goods_price,
                    @goods_num,
                    GETDATE()
                  );
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="detail_no" Type="int" />
      <Input Name="goods_name" Type="nvarchar" Size="150" />
      <Input Name="goods_price" Type="nvarchar" Size="6" />
      <Input Name="goods_num" Type="nvarchar" Size="4" />
    </Parameter>
  </InsertUpdateDetail>
</InvoiceVeritrans>
