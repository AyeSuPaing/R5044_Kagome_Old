<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : メール送信ログ系SQLステートメントXML (MailSendLog.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2016 All Rights Reserved.
=========================================================================================================
-->
<MailSendLog>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_MailSendLog
         WHERE  log_no = @log_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="log_no" Type="bigint" />
    </Parameter>
  </Get>

  <!-- ユーザーIDからメール送信ログ取得 -->
  <GetMailSendLogByUserId>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_MailSendLog
         WHERE  user_id = @user_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetMailSendLogByUserId>

  <!-- 最も古い送信日時取得 -->
  <GetDateSendMailOldest>
    <Statement>
      <![CDATA[
        SELECT  TOP 1 MIN(date_send_mail) AS date_send_mail
          FROM  w2_MailSendLog
      ]]>
    </Statement>
  </GetDateSendMailOldest>

  <!-- 登録 -->
  <Insert>
    <Statement>
      <![CDATA[
        INSERT  w2_MailSendLog
                (
                  user_id
                  ,dept_id
                  ,mailtext_id
                  ,mailtext_name
                  ,maildist_id
                  ,maildist_name
                  ,shop_id
                  ,mail_id
                  ,mail_name
                  ,mail_from_name
                  ,mail_from
                  ,mail_to
                  ,mail_cc
                  ,mail_bcc
                  ,mail_subject
                  ,mail_body
                  ,mail_body_html
                  ,error_message
                  ,date_send_mail
                  ,date_created
                  ,read_flg
                  ,date_read_mail
                  ,text_history_no
                  ,mail_addr_kbn
                )
        VALUES  (
                  @user_id
                  ,@dept_id
                  ,@mailtext_id
                  ,@mailtext_name
                  ,@maildist_id
                  ,@maildist_name
                  ,@shop_id
                  ,@mail_id
                  ,@mail_name
                  ,@mail_from_name
                  ,@mail_from
                  ,@mail_to
                  ,@mail_cc
                  ,@mail_bcc
                  ,@mail_subject
                  ,@mail_body
                  ,@mail_body_html
                  ,@error_message
                  ,@date_send_mail
                  ,GETDATE()
                  ,@read_flg
                  ,NULL
                  ,@text_history_no
                  ,@mail_addr_kbn
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="log_no" Type="bigint" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="mailtext_id" Type="nvarchar" Size="30" />
      <Input Name="mailtext_name" Type="nvarchar" Size="30" />
      <Input Name="maildist_id" Type="nvarchar" Size="30" />
      <Input Name="maildist_name" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="mail_id" Type="nvarchar" Size="10" />
      <Input Name="mail_from_name" Type="nvarchar" Size="50" />
      <Input Name="mail_name" Type="nvarchar" Size="50" />
      <Input Name="mail_from" Type="nvarchar" Size="256" />
      <Input Name="mail_to" Type="nvarchar" Size="1000" />
      <Input Name="mail_cc" Type="nvarchar" Size="1000" />
      <Input Name="mail_bcc" Type="nvarchar" Size="1000" />
      <Input Name="mail_subject" Type="nvarchar" Size="500" />
      <Input Name="mail_body" Type="ntext" />
      <Input Name="mail_body_html" Type="ntext" />
      <Input Name="error_message" Type="nvarchar" Size="max" />
      <Input Name="date_send_mail" Type="datetime" />
      <Input Name="read_flg" Type="nvarchar" Size="2" />
      <Input Name="text_history_no" Type="bigint" />
      <Input Name="mail_addr_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </Insert>

  <!-- 更新 -->
  <Update>
    <Statement>
      <![CDATA[
        UPDATE  w2_MailSendLog
           SET  user_id = @user_id
                ,dept_id = @dept_id
                ,mailtext_id = @mailtext_id
                ,mailtext_name = @mailtext_name
                ,maildist_id = @maildist_id
                ,maildist_name = @maildist_name
                ,shop_id = @shop_id
                ,mail_id = @mail_id
                ,mail_name = @mail_name
                ,mail_from_name = @mail_from_name
                ,mail_from = @mail_from
                ,mail_to = @mail_to
                ,mail_cc = @mail_cc
                ,mail_bcc = @mail_bcc
                ,mail_subject = @mail_subject
                ,mail_body = @mail_body
                ,mail_body_html = @mail_body_html
                ,error_message = @error_message
                ,date_send_mail = @date_send_mail
                ,read_flg = @read_flg
                ,date_read_mail = @date_read_mail
                ,text_history_no = @text_history_no
                ,mail_addr_kbn = @mail_addr_kbn
         WHERE  log_no = @log_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="log_no" Type="bigint" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="mailtext_id" Type="nvarchar" Size="30" />
      <Input Name="mailtext_name" Type="nvarchar" Size="30" />
      <Input Name="maildist_id" Type="nvarchar" Size="30" />
      <Input Name="maildist_name" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="mail_id" Type="nvarchar" Size="10" />
      <Input Name="mail_name" Type="nvarchar" Size="50" />
      <Input Name="mail_from_name" Type="nvarchar" Size="50" />
      <Input Name="mail_from" Type="nvarchar" Size="256" />
      <Input Name="mail_to" Type="nvarchar" Size="1000" />
      <Input Name="mail_cc" Type="nvarchar" Size="1000" />
      <Input Name="mail_bcc" Type="nvarchar" Size="1000" />
      <Input Name="mail_subject" Type="nvarchar" Size="500" />
      <Input Name="mail_body" Type="ntext" />
      <Input Name="mail_body_html" Type="ntext" />
      <Input Name="error_message" Type="nvarchar" Size="MAX" />
      <Input Name="date_send_mail" Type="datetime" />
      <Input Name="read_flg" Type="nvarchar" Size="2" />
      <Input Name="date_read_mail" Type="datetime" />
      <Input Name="text_history_no" Type="bigint" />
      <Input Name="mail_addr_kbn" Type="nvarchar" Size="10" />
    </Parameter>
  </Update>

  <!-- 指定日時以前を削除 -->
  <DeleteByDateSendMail>
    <Statement>
      <![CDATA[
        DELETE  w2_MailSendLog
         WHERE  date_send_mail < @date_send_mail
      ]]>
    </Statement>
    <Parameter>
      <Input Name="date_send_mail" Type="datetime" />
    </Parameter>
  </DeleteByDateSendMail>

  <!-- 取得(画面表示用) -->
  <GetForDisplay>
    <Statement>
      <![CDATA[
        SELECT  w2_MailSendLog.log_no,
                w2_MailSendLog.user_id,
                w2_MailSendLog.dept_id,
                w2_MailSendLog.mailtext_id,
                w2_MailSendLog.mailtext_name,
                w2_MailSendLog.maildist_id,
                w2_MailSendLog.maildist_name,
                w2_MailSendLog.shop_id,
                w2_MailSendLog.mail_id,
                w2_MailSendLog.mail_name,
                w2_MailSendLog.mail_from_name,
                w2_MailSendLog.mail_from,
                w2_MailSendLog.mail_to,
                w2_MailSendLog.mail_cc,
                w2_MailSendLog.mail_bcc,
                w2_MailSendLog.mail_subject,
                CASE w2_MailSendLog.mail_addr_kbn
                    WHEN 'PC' THEN
                        ISNULL(w2_MailSendTextHistory.mail_body, w2_MailSendLog.mail_body)
                    WHEN 'MB' THEN
                        ISNULL(w2_MailSendTextHistory.mailtext_body_mobile, w2_MailSendLog.mail_body)
                    ELSE
                        w2_MailSendLog.mail_body
                END as mail_body,
                CASE w2_MailSendLog.mail_addr_kbn
                    WHEN 'PC' THEN
                        ISNULL(w2_MailSendTextHistory.mail_body_html, w2_MailSendLog.mail_body_html)
                    WHEN 'MB' THEN
                        ISNULL(w2_MailSendTextHistory.mailtext_decome, w2_MailSendLog.mail_body_html)
                    ELSE
                        w2_MailSendLog.mail_body_html
                END  as mail_body_html,
                w2_MailSendLog.error_message,
                w2_MailSendLog.date_send_mail,
                w2_MailSendLog.date_created,
                w2_MailSendLog.read_flg,
                w2_MailSendLog.date_read_mail,
                w2_MailSendLog.mail_addr_kbn,
                w2_MailSendTextHistory.mailtext_replace_tags
          FROM  w2_MailSendLog
                LEFT JOIN w2_MailSendTextHistory ON
                (
                  w2_MailSendTextHistory.text_history_no = w2_MailSendLog.text_history_no
                )
         WHERE  log_no = @log_no
           <@@hasval:user_id@@>
           AND  user_id = @user_id
           </@@hasval:user_id@@>
      ]]>
    </Statement>
    <Parameter>
      <Input Name="log_no" Type="bigint" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetForDisplay>

  <!-- メール配信時文章履歴登録(登録後、履歴NO取得) -->
  <InsertTextHistoryAndGetTextHistoryNo>
    <Statement>
      <![CDATA[
        INSERT  w2_MailSendTextHistory
                (
                  dept_id
                  ,mailtext_id
                  ,maildist_id
                  ,maildist_name
                  ,mail_body
                  ,mail_body_html
                  ,mailtext_body_mobile
                  ,mailtext_decome
                  ,date_created
                  ,mailtext_replace_tags
                )
        VALUES  (
                  @dept_id
                  ,@mailtext_id
                  ,@maildist_id
                  ,@maildist_name
                  ,@mail_body
                  ,@mail_body_html
                  ,@mailtext_body_mobile
                  ,@mailtext_decome
                  ,GETDATE()
                  ,@mailtext_replace_tags
                )
        
        SELECT SCOPE_IDENTITY()
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="mailtext_id" Type="nvarchar" Size="30" />
      <Input Name="maildist_id" Type="nvarchar" Size="30" />
      <Input Name="maildist_name" Type="nvarchar" Size="30" />
      <Input Name="mail_body" Type="nvarchar" Size="MAX" />
      <Input Name="mail_body_html" Type="nvarchar" Size="MAX" />
      <Input Name="mailtext_body_mobile" Type="nvarchar" Size="MAX" />
      <Input Name="mailtext_decome" Type="nvarchar" Size="MAX" />
      <Input Name="mailtext_replace_tags" Type="nvarchar" Size="MAX" />
    </Parameter>
  </InsertTextHistoryAndGetTextHistoryNo>
  
</MailSendLog>