<?xml version="1.0" encoding="utf-8" ?>
<Migration>
  <Up>
    <Statement>
      <![CDATA[

INSERT INTO w2_ConfigurationSetting VALUES('ProductBrand_Enabled','C000_AppCommon',N'FALSE','0',getdate(),getdate(),'w2kawano')

------------------------------------------------------
-- ブランドマスタ
------------------------------------------------------
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[w2_ProductBrand]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
drop table [dbo].[w2_ProductBrand]
GO

CREATE TABLE [dbo].[w2_ProductBrand] (
	[brand_id] [nvarchar] (30) NOT NULL,
	[brand_name] [nvarchar] (100) NOT NULL DEFAULT (N''),
	[brand_title] [nvarchar] (100) NOT NULL DEFAULT (N''),
	[additional_design_tag] [nvarchar] (max) NOT NULL DEFAULT (N''),
	[seo_keyword] [nvarchar] (200) NOT NULL DEFAULT (N''),
	[default_flg] [nvarchar] (10) NOT NULL DEFAULT (N'OFF'),
	[valid_flg] [nvarchar] (10) NOT NULL DEFAULT (N'ON'),
	[date_created] [datetime] NOT NULL DEFAULT (getdate()),
	[date_changed] [datetime] NOT NULL DEFAULT (getdate()),
	[last_changed] [nvarchar] (20) NOT NULL DEFAULT (N'')
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[w2_ProductBrand] WITH NOCHECK ADD
	CONSTRAINT [PK_w2_ProductBrand] PRIMARY KEY  CLUSTERED
	(
		[brand_id]
	) ON [PRIMARY]
GO

------------------------------------------------------
-- 商品
------------------------------------------------------
ALTER TABLE w2_Product
ADD [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')

ALTER TABLE w2_WorkProduct
ADD [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')

------------------------------------------------------
-- カテゴリ
------------------------------------------------------
ALTER TABLE w2_ProductCategory
ADD [permitted_brand_ids] [nvarchar] (300) NOT NULL DEFAULT (N'')

ALTER TABLE w2_WorkProductCategory
ADD [permitted_brand_ids] [nvarchar] (300) NOT NULL DEFAULT (N'')

------------------------------------------------------
-- 注文商品
------------------------------------------------------
ALTER TABLE w2_OrderItem
ADD [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')

------------------------------------------------------
-- モバイルページ
------------------------------------------------------
ALTER TABLE w2_MobilePage
ADD [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')

ALTER TABLE [w2_MobilePage] 
DROP CONSTRAINT PK_w2_MobileContents 

ALTER TABLE [dbo].[w2_MobilePage] WITH NOCHECK ADD
	CONSTRAINT [PK_w2_MobilePage] PRIMARY KEY  CLUSTERED
	(
		[dept_id],
		[page_id],
		[career_id],
		[mobile_group_id],
		[brand_id]
	) ON [PRIMARY]
GO

------------------------------------------------------
-- 商品ランキング
------------------------------------------------------
ALTER TABLE w2_ProductRanking
ADD [brand_kbn] [nvarchar] (1) NOT NULL DEFAULT (N'0'),
    [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')

------------------------------------------------------
-- 新着情報
------------------------------------------------------
ALTER TABLE w2_News
ADD [brand_id] [nvarchar] (30) NOT NULL DEFAULT (N'')


GO

------------------------------------------------------
-- 商品ビュー
------------------------------------------------------
ALTER VIEW [dbo].[w2_ProductView](
		[shop_id],
		[supplier_id],
		[product_id],
		[cooperation_id1],
		[cooperation_id2],
		[cooperation_id3],
		[cooperation_id4],
		[cooperation_id5],
		[mall_ex_product_id],
		[maker_id],
		[maker_name],
		[name],
		[name_kana],
		[name2],
		[name2_kana],
		[seo_keywords],
		[catchcopy],
		[catchcopy_mobile],
		[outline_kbn],
		[outline],
		[outline_kbn_mobile],
		[outline_mobile],
		[desc_detail_kbn1],
		[desc_detail1],
		[desc_detail_kbn2],
		[desc_detail2],
		[desc_detail_kbn3],
		[desc_detail3],
		[desc_detail_kbn4],
		[desc_detail4],
		[return_exchange_message],
		[desc_detail_kbn1_mobile],
		[desc_detail1_mobile],
		[desc_detail_kbn2_mobile],
		[desc_detail2_mobile],
		[return_exchange_message_mobile],
		[note],
		[display_price],
		[display_special_price],
		[tax_included_flg],
		[tax_rate],
		[tax_round_type],
		[price_pretax],
		[price_shipping],
		[shipping_type],
		[shipping_size_kbn],
		[price_cost],
		[point_kbn1],
		[point1],
		[point_kbn2],
		[point2],
		[point_kbn3],
		[point3],
		[campaign_from],
		[campaign_to],
		[campaign_point_kbn],
		[campaign_point],
		[display_from],
		[display_to],
		[sell_from],
		[sell_to],
		[before_sale_display_kbn],
		[after_sale_display_kbn],
		[max_sell_quantity],
		[stock_management_kbn],
		[stock_message_id],
		[stock_disp_kbn],
		[url],
		[inquire_email],
		[inquire_tel],
		[display_kbn],
		[category_id1],
		[category_id2],
		[category_id3],
		[category_id4],
		[category_id5],
		[related_product_id_cs1],
		[related_product_id_cs2],
		[related_product_id_cs3],
		[related_product_id_cs4],
		[related_product_id_cs5],
		[related_product_id_us1],
		[related_product_id_us2],
		[related_product_id_us3],
		[related_product_id_us4],
		[related_product_id_us5],
		[image_head],
		[image_mobile],
		[icon_flg1],
		[icon_term_end1],
		[icon_flg2],
		[icon_term_end2],
		[icon_flg3],
		[icon_term_end3],
		[icon_flg4],
		[icon_term_end4],
		[icon_flg5],
		[icon_term_end5],
		[mobile_disp_flg],
		[use_variation_flg],
		[reservation_flg],
		[fixed_purchase_flg],
		[valid_flg],
		[variation_id],
		[variation_cooperation_id1],
		[variation_cooperation_id2],
		[variation_cooperation_id3],
		[variation_cooperation_id4],
		[variation_cooperation_id5],
		[mall_variation_id1],
		[mall_variation_id2],
		[mall_variation_type],
		[variation_name1],
		[variation_name2],
		[variation_name3],
		[price],
		[special_price],
		[variation_image_head],
		[variation_image_mobile],
		[display_order],
		[productsale_id],
		[sale_price],
		[validity],
		[stock],
		[realstock],
		[realstock_b],
		[realstock_c],
		[realstock_reserved],
		[stock_alert],
		[stock_message_name],
		[stock_message_def],
		[stock_datum1],
		[stock_message1],
		[stock_datum2],
		[stock_message2],
		[stock_datum3],
		[stock_message3],
		[stock_datum4],
		[stock_message4],
		[stock_datum5],
		[stock_message5],
		[stock_datum6],
		[stock_message6],
		[stock_datum7],
		[stock_message7],
		[del_flg],
		[date_created],
		[date_changed],
		[last_changed],
		[shipping_id],
		[search_keyword],
		[member_rank_discount_flg],
		[display_member_rank],
		[buyable_member_rank],
		[google_shopping_flg],
		[product_option_settings],
		[arrival_mail_valid_flg],
		[release_mail_valid_flg],
		[resale_mail_valid_flg],
		[select_variation_kbn],
		[select_variation_kbn_mobile],
		[brand_id]
		) AS
SELECT	[dbo].[w2_Product].[shop_id],
		[dbo].[w2_Product].[supplier_id],
		[dbo].[w2_Product].[product_id],
		[dbo].[w2_Product].[cooperation_id1],
		[dbo].[w2_Product].[cooperation_id2],
		[dbo].[w2_Product].[cooperation_id3],
		[dbo].[w2_Product].[cooperation_id4],
		[dbo].[w2_Product].[cooperation_id5],
		[dbo].[w2_Product].[mall_ex_product_id],
		[dbo].[w2_Product].[maker_id],
		[dbo].[w2_Product].[maker_name],
		[dbo].[w2_Product].[name],
		[dbo].[w2_Product].[name_kana],
		[dbo].[w2_Product].[name2],
		[dbo].[w2_Product].[name2_kana],
		[dbo].[w2_Product].[seo_keywords],
		[dbo].[w2_Product].[catchcopy],
		[dbo].[w2_Product].[catchcopy_mobile],
		[dbo].[w2_Product].[outline_kbn],
		[dbo].[w2_Product].[outline],
		[dbo].[w2_Product].[outline_kbn_mobile],
		[dbo].[w2_Product].[outline_mobile],
		[dbo].[w2_Product].[desc_detail_kbn1],
		[dbo].[w2_Product].[desc_detail1],
		[dbo].[w2_Product].[desc_detail_kbn2],
		[dbo].[w2_Product].[desc_detail2],
		[dbo].[w2_Product].[desc_detail_kbn3],
		[dbo].[w2_Product].[desc_detail3],
		[dbo].[w2_Product].[desc_detail_kbn4],
		[dbo].[w2_Product].[desc_detail4],
		[dbo].[w2_Product].[return_exchange_message],		
		[dbo].[w2_Product].[desc_detail_kbn1_mobile],
		[dbo].[w2_Product].[desc_detail1_mobile],
		[dbo].[w2_Product].[desc_detail_kbn2_mobile],
		[dbo].[w2_Product].[desc_detail2_mobile],
		[dbo].[w2_Product].[return_exchange_message_mobile],
		[dbo].[w2_Product].[note],
		[dbo].[w2_Product].[display_price],
		[dbo].[w2_Product].[display_special_price],
		[dbo].[w2_Product].[tax_included_flg],
		[dbo].[w2_Product].[tax_rate],
		[dbo].[w2_Product].[tax_round_type],
		[dbo].[w2_Product].[price_pretax],
		[dbo].[w2_Product].[price_shipping],
		[dbo].[w2_Product].[shipping_type],
		[dbo].[w2_Product].[shipping_size_kbn],
		[dbo].[w2_Product].[price_cost],
		[dbo].[w2_Product].[point_kbn1],
		[dbo].[w2_Product].[point1],
		[dbo].[w2_Product].[point_kbn2],
		[dbo].[w2_Product].[point2],
		[dbo].[w2_Product].[point_kbn3],
		[dbo].[w2_Product].[point3],
		[dbo].[w2_Product].[campaign_from],
		[dbo].[w2_Product].[campaign_to],
		[dbo].[w2_Product].[campaign_point_kbn],
		[dbo].[w2_Product].[campaign_point],
		[dbo].[w2_Product].[display_from],
		[dbo].[w2_Product].[display_to],
		[dbo].[w2_Product].[sell_from],
		[dbo].[w2_Product].[sell_to],
		[dbo].[w2_Product].[before_sale_display_kbn],
		[dbo].[w2_Product].[after_sale_display_kbn],
		[dbo].[w2_Product].[max_sell_quantity],
		[dbo].[w2_Product].[stock_management_kbn],
		[dbo].[w2_Product].[stock_message_id],
		[dbo].[w2_Product].[stock_disp_kbn],
		[dbo].[w2_Product].[url],
		[dbo].[w2_Product].[inquire_email],
		[dbo].[w2_Product].[inquire_tel],
		[dbo].[w2_Product].[display_kbn],
		[dbo].[w2_Product].[category_id1],
		[dbo].[w2_Product].[category_id2],
		[dbo].[w2_Product].[category_id3],
		[dbo].[w2_Product].[category_id4],
		[dbo].[w2_Product].[category_id5],
		[dbo].[w2_Product].[related_product_id_cs1],
		[dbo].[w2_Product].[related_product_id_cs2],
		[dbo].[w2_Product].[related_product_id_cs3],
		[dbo].[w2_Product].[related_product_id_cs4],
		[dbo].[w2_Product].[related_product_id_cs5],
		[dbo].[w2_Product].[related_product_id_us1],
		[dbo].[w2_Product].[related_product_id_us2],
		[dbo].[w2_Product].[related_product_id_us3],
		[dbo].[w2_Product].[related_product_id_us4],
		[dbo].[w2_Product].[related_product_id_us5],
		[dbo].[w2_Product].[image_head],
		[dbo].[w2_Product].[image_mobile],
		[dbo].[w2_Product].[icon_flg1],
		[dbo].[w2_Product].[icon_term_end1],
		[dbo].[w2_Product].[icon_flg2],
		[dbo].[w2_Product].[icon_term_end2],
		[dbo].[w2_Product].[icon_flg3],
		[dbo].[w2_Product].[icon_term_end3],
		[dbo].[w2_Product].[icon_flg4],
		[dbo].[w2_Product].[icon_term_end4],
		[dbo].[w2_Product].[icon_flg5],
		[dbo].[w2_Product].[icon_term_end5],
		[dbo].[w2_Product].[mobile_disp_flg],
		[dbo].[w2_Product].[use_variation_flg],
		[dbo].[w2_Product].[reservation_flg],
		[dbo].[w2_Product].[fixed_purchase_flg],
		[dbo].[w2_Product].[valid_flg],
		[dbo].[w2_ProductVariation].[variation_id],
		[dbo].[w2_ProductVariation].[variation_cooperation_id1],
		[dbo].[w2_ProductVariation].[variation_cooperation_id2],
		[dbo].[w2_ProductVariation].[variation_cooperation_id3],
		[dbo].[w2_ProductVariation].[variation_cooperation_id4],
		[dbo].[w2_ProductVariation].[variation_cooperation_id5],
		[dbo].[w2_ProductVariation].[mall_variation_id1],
		[dbo].[w2_ProductVariation].[mall_variation_id2],
		[dbo].[w2_ProductVariation].[mall_variation_type],
		[dbo].[w2_ProductVariation].[variation_name1],
		[dbo].[w2_ProductVariation].[variation_name2],
		[dbo].[w2_ProductVariation].[variation_name3],
		[dbo].[w2_ProductVariation].[price],
		[dbo].[w2_ProductVariation].[special_price],
		[dbo].[w2_ProductVariation].[variation_image_head],
		[dbo].[w2_ProductVariation].[variation_image_mobile],
		[dbo].[w2_ProductVariation].[display_order],
		[dbo].[w2_ProductSaleView].[productsale_id],
		[dbo].[w2_ProductSaleView].[sale_price],
		[dbo].[w2_ProductSaleView].[validity],
		[dbo].[w2_ProductStock].[stock],
		[dbo].[w2_ProductStock].[realstock],
		[dbo].[w2_ProductStock].[realstock_b],
		[dbo].[w2_ProductStock].[realstock_c],
		[dbo].[w2_ProductStock].[realstock_reserved],
		[dbo].[w2_ProductStock].[stock_alert],
		[dbo].[w2_ProductStockMessage].[stock_message_name],
		[dbo].[w2_ProductStockMessage].[stock_message_def],
		[dbo].[w2_ProductStockMessage].[stock_datum1],
		[dbo].[w2_ProductStockMessage].[stock_message1],
		[dbo].[w2_ProductStockMessage].[stock_datum2],
		[dbo].[w2_ProductStockMessage].[stock_message2],
		[dbo].[w2_ProductStockMessage].[stock_datum3],
		[dbo].[w2_ProductStockMessage].[stock_message3],
		[dbo].[w2_ProductStockMessage].[stock_datum4],
		[dbo].[w2_ProductStockMessage].[stock_message4],
		[dbo].[w2_ProductStockMessage].[stock_datum5],
		[dbo].[w2_ProductStockMessage].[stock_message5],
		[dbo].[w2_ProductStockMessage].[stock_datum6],
		[dbo].[w2_ProductStockMessage].[stock_message6],
		[dbo].[w2_ProductStockMessage].[stock_datum7],
		[dbo].[w2_ProductStockMessage].[stock_message7],
		[dbo].[w2_Product].[del_flg],
		[dbo].[w2_Product].[date_created],
		[dbo].[w2_Product].[date_changed],
		[dbo].[w2_Product].[last_changed],
		[dbo].[w2_ShopShipping].[shipping_id],
		[dbo].[w2_Product].[search_keyword],
		[dbo].[w2_Product].[member_rank_discount_flg],
		[dbo].[w2_Product].[display_member_rank],
		[dbo].[w2_Product].[buyable_member_rank],
		[dbo].[w2_Product].[google_shopping_flg],
		[dbo].[w2_Product].[product_option_settings],
		[dbo].[w2_Product].[arrival_mail_valid_flg],
		[dbo].[w2_Product].[release_mail_valid_flg],
		[dbo].[w2_Product].[resale_mail_valid_flg],
		[dbo].[w2_Product].[select_variation_kbn],
		[dbo].[w2_Product].[select_variation_kbn_mobile],
		[dbo].[w2_Product].[brand_id]
FROM	[dbo].[w2_Product] LEFT JOIN [dbo].[w2_ProductStockMessage] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ProductStockMessage].[shop_id]
			AND
			[dbo].[w2_Product].[stock_message_id] = [dbo].[w2_ProductStockMessage].[stock_message_id]
		)
		INNER JOIN [dbo].[w2_ProductVariation] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ProductVariation].[shop_id]
			AND
			[dbo].[w2_Product].[product_id] = [dbo].[w2_ProductVariation].[product_id]
			AND
			(
				(
					[dbo].[w2_Product].[use_variation_flg] = '1'
					AND
					[dbo].[w2_Product].[product_id] != [dbo].[w2_ProductVariation].[variation_id]
				)
				OR
				(
					[dbo].[w2_Product].[use_variation_flg] != '1'
					AND
					[dbo].[w2_Product].[product_id] = [dbo].[w2_ProductVariation].[variation_id]
				)
			)
		)
		LEFT JOIN [dbo].[w2_ProductSaleView] ON
		(
			[dbo].[w2_ProductVariation].[shop_id] = [dbo].[w2_ProductSaleView].[shop_id]
			AND
			[dbo].[w2_ProductSaleView].[productsale_kbn] = 'TS'
			AND
			[dbo].[w2_ProductVariation].[product_id] = [dbo].[w2_ProductSaleView].[product_id]
			AND
			[dbo].[w2_ProductVariation].[variation_id] = [dbo].[w2_ProductSaleView].[variation_id]
			AND
			[dbo].[w2_ProductSaleView].[validity] = '1'
		)
		LEFT JOIN [dbo].[w2_ProductStock] ON
		(
			[dbo].[w2_ProductVariation].[shop_id] = [dbo].[w2_ProductStock].[shop_id]
			AND
			[dbo].[w2_ProductVariation].[product_id] = [dbo].[w2_ProductStock].[product_id]
			AND
			[dbo].[w2_ProductVariation].[variation_id] = [dbo].[w2_ProductStock].[variation_id]
		)
		LEFT JOIN [dbo].[w2_ShopShipping] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ShopShipping].[shop_id]
			AND
			[dbo].[w2_Product].[shipping_type] = [dbo].[w2_ShopShipping].[shipping_id]
		)


			]]>
    </Statement>
  </Up>
</Migration>