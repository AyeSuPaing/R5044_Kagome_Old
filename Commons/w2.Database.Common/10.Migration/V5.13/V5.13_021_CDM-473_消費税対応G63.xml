<?xml version="1.0" encoding="utf-8" ?>
<Migration>
  <Up>
    <Statement>
      <![CDATA[

ALTER TABLE [w2_Order] ALTER COLUMN [order_price_tax] [decimal] (18,3) NOT NULL;
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_Order' AND COLUMN_NAME = 'order_price_tax_subtotal')
	ALTER TABLE [w2_Order] ADD [order_price_tax_subtotal] [decimal] (18,3) NOT NULL DEFAULT (0);
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_Order' AND COLUMN_NAME = 'order_price_tax_service')
	ALTER TABLE [w2_Order] ADD [order_price_tax_service] [decimal] (18,3) NOT NULL DEFAULT (0);
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_OrderItem' AND COLUMN_NAME = 'item_price_tax')
	ALTER TABLE [w2_OrderItem] ADD [item_price_tax] [decimal] (18,3) NOT NULL DEFAULT (0);
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_Product' AND COLUMN_NAME = 'tax_category_id')
	ALTER TABLE [w2_Product] ADD [tax_category_id] [nvarchar] (30) NOT NULL DEFAULT (N'default');
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_WorkProduct' AND COLUMN_NAME = 'tax_category_id')
	ALTER TABLE [w2_WorkProduct] ADD [tax_category_id] [nvarchar] (30) NOT NULL DEFAULT (N'default');
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'w2_DispSummaryAnalysis' AND COLUMN_NAME = 'price_tax')
	ALTER TABLE [w2_DispSummaryAnalysis] ADD [price_tax] [decimal] (23,3) NOT NULL DEFAULT (0);
GO

if not exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[w2_ProductTaxCategory]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
begin
/*
=========================================================================================================
  Module      : 商品税率カテゴリマスタ (w2_ProductTaxCategory.sql)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2018 All Rights Reserved.
=========================================================================================================
*/
CREATE TABLE [dbo].[w2_ProductTaxCategory] (
	[tax_category_id] [nvarchar] (30) NOT NULL DEFAULT (N''),
	[tax_category_name] [nvarchar] (40) NOT NULL DEFAULT (N''),
	[tax_rate] [decimal] (5,2) NOT NULL DEFAULT (0),
	[display_order] [int] NOT NULL DEFAULT (0),
	[date_created] [datetime] NOT NULL DEFAULT (getdate()),
	[date_changed] [datetime] NOT NULL DEFAULT (getdate()),
	[last_changed] [nvarchar] (20) NOT NULL DEFAULT (N'')
) ON [PRIMARY]

ALTER TABLE [dbo].[w2_ProductTaxCategory] WITH NOCHECK ADD
	CONSTRAINT [PK_w2_ProductTaxCategory] PRIMARY KEY  CLUSTERED
	(
		[tax_category_id]
	) ON [PRIMARY]

INSERT INTO [w2_ProductTaxCategory] (
	tax_category_id,
	tax_category_name,
	tax_rate,
	display_order
	)
VALUES (
	'default',
	'デフォルト税率',
	8,
	0
	)
end

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[w2_Product]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
UPDATE [w2_Product] SET [tax_category_id] = 'default'
GO

if exists (select * from sys.procedures where name = 'w2_CreateSummaryPdctSrchSp')
	drop PROCEDURE [dbo].[w2_CreateSummaryPdctSrchSp]
GO
CREATE PROCEDURE [dbo].[w2_CreateSummaryPdctSrchSp] (
					@TARGET_DATE varchar(10)) AS

	---------------------------------------
	-- 変数定義
	---------------------------------------
	DECLARE @DEPT_ID nvarchar(30)
	DECLARE @SUMMARY_KBN nvarchar(30)
	DECLARE @TGT_YEAR nvarchar(4)
	DECLARE @TGT_MONTH nvarchar(2)
	DECLARE @TGT_DAY nvarchar(2)

	---------------------------------------
	-- 日付分割
	---------------------------------------
	SET @TGT_YEAR = SUBSTRING(@TARGET_DATE, 0, 5)
	SET @TGT_MONTH = SUBSTRING(@TARGET_DATE, 6, 2)
	SET @TGT_DAY = SUBSTRING(@TARGET_DATE, 9, 2)


	---------------------------------------
	-- 検索ワードサマリ作成（全体）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_searchword'	-- 検索ワード

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved1
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			search_word,
			COUNT(*) AS TOTAL,
			AVG(hits) as AVERAGE
	  FROM	w2_ProductSearchWordHistory
	 WHERE	dept_id = @DEPT_ID
	   AND	date_created BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	GROUP BY search_word
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 検索ワードサマリ作成（PC）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_searchword_pc'	-- 検索ワード

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved1
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			search_word,
			COUNT(*) AS TOTAL,
			AVG(hits) as AVERAGE
	  FROM	w2_ProductSearchWordHistory
	 WHERE	dept_id = @DEPT_ID
	   AND	date_created BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	access_kbn = '0'	-- アクセス区分（PC'0' or モバイル'1' or スマートフォン'2'）
	GROUP BY search_word
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 検索ワードサマリ作成（モバイル）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_searchword_mob'	-- 検索ワード

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved1
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			search_word,
			COUNT(*) AS TOTAL,
			AVG(hits) as AVERAGE
	  FROM	w2_ProductSearchWordHistory
	 WHERE	dept_id = @DEPT_ID
	   AND	date_created BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	access_kbn = '1'	-- アクセス区分（PC'0' or モバイル'1' or スマートフォン'2'）
	GROUP BY search_word
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 検索ワードサマリ作成（スマートフォン）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_searchword_sp'	-- 検索ワード

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved1
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			search_word,
			COUNT(*) AS TOTAL,
			AVG(hits) as AVERAGE
	  FROM	w2_ProductSearchWordHistory
	 WHERE	dept_id = @DEPT_ID
	   AND	date_created BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	access_kbn = '2'	-- アクセス区分（PC'0' or モバイル'1' or スマートフォン'2'）
	GROUP BY search_word
	ORDER BY TOTAL DESC


	---------------------------------------
	-- 商品販売数サマリ作成（全体）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buycount'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity) AS TOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 商品販売数サマリ作成（PC）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buycount_pc'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity) AS TOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'PC'					-- 注文区分がPC
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 商品販売数サマリ作成（モバイル）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buycount_mob'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity) AS TOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'MB'					-- 注文区分がモバイル
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 商品販売数サマリ作成（スマートフォン）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buycount_sp'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity) AS TOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'SP'					-- 注文区分がスマートフォン
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC


	---------------------------------------
	-- 商品販売金額サマリ作成（全体）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buyprice'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			price_tax,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity * product_price)  AS TOTAL,
			SUM(w2_OrderItem.item_price_tax)  AS TAXTOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 商品販売金額サマリ作成（PC）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buyprice_pc'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			price_tax,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity * product_price)  AS TOTAL,
			SUM(w2_OrderItem.item_price_tax)  AS TAXTOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'PC'					-- 注文区分がPC
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC

	---------------------------------------
	-- 商品販売金額サマリ作成（モバイル）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buyprice_mob'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			price_tax,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity * product_price)  AS TOTAL,
			SUM(w2_OrderItem.item_price_tax)  AS TAXTOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'MB'					-- 注文区分がモバイル
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC
	
	---------------------------------------
	-- 商品販売金額サマリ作成（スマートフォン）
	---------------------------------------
	SET @DEPT_ID = '0'
	SET @SUMMARY_KBN = 'pct_buyprice_sp'	-- 商品販売数

	-- 削除
	DELETE
	  FROM	w2_DispSummaryAnalysis
	 WHERE	dept_id = @DEPT_ID
	   AND	summary_kbn = @SUMMARY_KBN
	   AND	tgt_year = @TGT_YEAR
	   AND	tgt_month = @TGT_MONTH
	   AND	tgt_day = @TGT_DAY

	-- 挿入
	INSERT
	  INTO	w2_DispSummaryAnalysis
			(
			dept_id,
			summary_kbn,
			tgt_year,
			tgt_month,
			tgt_day,
			value_name,
			counts,
			price_tax,
			reserved6,
			reserved7
			)
	SELECT	@DEPT_ID,
			@SUMMARY_KBN,
			@TGT_YEAR,
			@TGT_MONTH,
			@TGT_DAY,
			MAX(w2_OrderItem.product_name),
			SUM(w2_OrderItem.item_quantity * product_price)  AS TOTAL,
			SUM(w2_OrderItem.item_price_tax)  AS TAXTOTAL,
			w2_OrderItem.product_id,
			w2_OrderItem.variation_id
	  FROM	w2_Order
			LEFT JOIN w2_OrderItem ON w2_Order.order_id = w2_OrderItem.order_id
	 WHERE	order_date BETWEEN  @TARGET_DATE + ' 00:00:00' AND @TARGET_DATE + ' 23:59:59.997'
	   AND	order_status NOT IN ('TMP','ODR_CNSL','TMP_CNSL')	-- 仮注文、キャンセル、仮注文キャンセルは除外
	   AND	order_kbn = 'SP'					-- 注文区分がスマートフォン
	GROUP BY w2_OrderItem.product_id, w2_OrderItem.variation_id
	ORDER BY TOTAL DESC
	
GO

ALTER VIEW [dbo].[w2_ProductView](
		[shop_id],
		[supplier_id],
		[product_id],
		[cooperation_id1],
		[cooperation_id2],
		[cooperation_id3],
		[cooperation_id4],
		[cooperation_id5],
		[mall_ex_product_id],
		[maker_id],
		[maker_name],
		[name],
		[name_kana],
		[name2],
		[name2_kana],
		[seo_keywords],
		[catchcopy],
		[catchcopy_mobile],
		[outline_kbn],
		[outline],
		[outline_kbn_mobile],
		[outline_mobile],
		[desc_detail_kbn1],
		[desc_detail1],
		[desc_detail_kbn2],
		[desc_detail2],
		[desc_detail_kbn3],
		[desc_detail3],
		[desc_detail_kbn4],
		[desc_detail4],
		[return_exchange_message],
		[desc_detail_kbn1_mobile],
		[desc_detail1_mobile],
		[desc_detail_kbn2_mobile],
		[desc_detail2_mobile],
		[return_exchange_message_mobile],
		[note],
		[display_price],
		[display_special_price],
		[tax_included_flg],
		[tax_round_type],
		[price_pretax],
		[price_shipping],
		[shipping_type],
		[shipping_size_kbn],
		[price_cost],
		[point_kbn1],
		[point1],
		[point_kbn2],
		[point2],
		[point_kbn3],
		[point3],
		[campaign_from],
		[campaign_to],
		[campaign_point_kbn],
		[campaign_point],
		[display_from],
		[display_to],
		[sell_from],
		[sell_to],
		[before_sale_display_kbn],
		[after_sale_display_kbn],
		[max_sell_quantity],
		[stock_management_kbn],
		[stock_message_id],
		[stock_disp_kbn],
		[url],
		[inquire_email],
		[inquire_tel],
		[display_kbn],
		[category_id1],
		[category_id2],
		[category_id3],
		[category_id4],
		[category_id5],
		[related_product_id_cs1],
		[related_product_id_cs2],
		[related_product_id_cs3],
		[related_product_id_cs4],
		[related_product_id_cs5],
		[related_product_id_us1],
		[related_product_id_us2],
		[related_product_id_us3],
		[related_product_id_us4],
		[related_product_id_us5],
		[image_head],
		[image_mobile],
		[icon_flg1],
		[icon_term_end1],
		[icon_flg2],
		[icon_term_end2],
		[icon_flg3],
		[icon_term_end3],
		[icon_flg4],
		[icon_term_end4],
		[icon_flg5],
		[icon_term_end5],
		[icon_flg6],
		[icon_term_end6],
		[icon_flg7],
		[icon_term_end7],
		[icon_flg8],
		[icon_term_end8],
		[icon_flg9],
		[icon_term_end9],
		[icon_flg10],
		[icon_term_end10],
		[mobile_disp_flg],
		[use_variation_flg],
		[reservation_flg],
		[fixed_purchase_flg],
		[valid_flg],
		[variation_id],
		[variation_cooperation_id1],
		[variation_cooperation_id2],
		[variation_cooperation_id3],
		[variation_cooperation_id4],
		[variation_cooperation_id5],
		[mall_variation_id1],
		[mall_variation_id2],
		[mall_variation_type],
		[variation_name1],
		[variation_name2],
		[variation_name3],
		[price],
		[special_price],
		[variation_image_head],
		[variation_image_mobile],
		[display_order],
		[productsale_id],
		[sale_price],
		[validity],
		[stock],
		[realstock],
		[realstock_b],
		[realstock_c],
		[realstock_reserved],
		[stock_alert],
		[stock_message_name],
		[stock_message_def],
		[stock_datum1],
		[stock_message1],
		[stock_datum2],
		[stock_message2],
		[stock_datum3],
		[stock_message3],
		[stock_datum4],
		[stock_message4],
		[stock_datum5],
		[stock_message5],
		[stock_datum6],
		[stock_message6],
		[stock_datum7],
		[stock_message7],
		[stock_message_def_mobile],
		[stock_message_mobile1],
		[stock_message_mobile2],
		[stock_message_mobile3],
		[stock_message_mobile4],
		[stock_message_mobile5],
		[stock_message_mobile6],
		[stock_message_mobile7],
		[del_flg],
		[date_created],
		[date_changed],
		[last_changed],
		[shipping_id],
		[shipping_fixed_purchase_flg],
		[wrapping_paper_flg],
		[wrapping_paper_types],
		[wrapping_bag_flg],
		[wrapping_bag_types],
		[search_keyword],
		[member_rank_discount_flg],
		[display_member_rank],
		[buyable_member_rank],
		[google_shopping_flg],
		[product_option_settings],
		[arrival_mail_valid_flg],
		[release_mail_valid_flg],
		[resale_mail_valid_flg],
		[select_variation_kbn],
		[select_variation_kbn_mobile],
		[brand_id1],
		[brand_id2],
		[brand_id3],
		[brand_id4],
		[brand_id5],
		[plural_shipping_price_free_flg],
		[age_limit_flg],
		[gift_flg],
		[digital_contents_flg],
		[download_url],
		[variation_download_url],
		[display_sell_flg],
		[display_priority],
		[limited_payment_ids],
		[fixed_purchase_firsttime_price],
		[fixed_purchase_price],
		[variation_fixed_purchase_firsttime_price],
		[variation_fixed_purchase_price],
		[bundle_item_display_type],
		[product_type],
		[limited_fixed_purchase_kbn1_setting],
		[limited_fixed_purchase_kbn3_setting],
		[recommend_product_id],
		[check_fixed_purchase_firsttime_flg],
		[cooperation_id6],
		[cooperation_id7],
		[cooperation_id8],
		[cooperation_id9],
		[cooperation_id10],
		[variation_cooperation_id6],
		[variation_cooperation_id7],
		[variation_cooperation_id8],
		[variation_cooperation_id9],
		[variation_cooperation_id10],
		[andmall_reservation_flg],
		[variation_andmall_reservation_flg],
		[product_color_id],
		[variation_color_id],
		[tax_category_id],
		[tax_rate],
		[display_only_fixed_purchase_member_flg],
		[sell_only_fixed_purchase_member_flg],
		[product_weight_gram],
		[variation_weight_gram]
		) AS
SELECT	[dbo].[w2_Product].[shop_id],
		[dbo].[w2_Product].[supplier_id],
		[dbo].[w2_Product].[product_id],
		[dbo].[w2_Product].[cooperation_id1],
		[dbo].[w2_Product].[cooperation_id2],
		[dbo].[w2_Product].[cooperation_id3],
		[dbo].[w2_Product].[cooperation_id4],
		[dbo].[w2_Product].[cooperation_id5],
		[dbo].[w2_Product].[mall_ex_product_id],
		[dbo].[w2_Product].[maker_id],
		[dbo].[w2_Product].[maker_name],
		[dbo].[w2_Product].[name],
		[dbo].[w2_Product].[name_kana],
		[dbo].[w2_Product].[name2],
		[dbo].[w2_Product].[name2_kana],
		[dbo].[w2_Product].[seo_keywords],
		[dbo].[w2_Product].[catchcopy],
		[dbo].[w2_Product].[catchcopy_mobile],
		[dbo].[w2_Product].[outline_kbn],
		[dbo].[w2_Product].[outline],
		[dbo].[w2_Product].[outline_kbn_mobile],
		[dbo].[w2_Product].[outline_mobile],
		[dbo].[w2_Product].[desc_detail_kbn1],
		[dbo].[w2_Product].[desc_detail1],
		[dbo].[w2_Product].[desc_detail_kbn2],
		[dbo].[w2_Product].[desc_detail2],
		[dbo].[w2_Product].[desc_detail_kbn3],
		[dbo].[w2_Product].[desc_detail3],
		[dbo].[w2_Product].[desc_detail_kbn4],
		[dbo].[w2_Product].[desc_detail4],
		[dbo].[w2_Product].[return_exchange_message],		
		[dbo].[w2_Product].[desc_detail_kbn1_mobile],
		[dbo].[w2_Product].[desc_detail1_mobile],
		[dbo].[w2_Product].[desc_detail_kbn2_mobile],
		[dbo].[w2_Product].[desc_detail2_mobile],
		[dbo].[w2_Product].[return_exchange_message_mobile],
		[dbo].[w2_Product].[note],
		[dbo].[w2_Product].[display_price],
		[dbo].[w2_Product].[display_special_price],
		[dbo].[w2_Product].[tax_included_flg],
		[dbo].[w2_Product].[tax_round_type],
		[dbo].[w2_Product].[price_pretax],
		[dbo].[w2_Product].[price_shipping],
		[dbo].[w2_Product].[shipping_type],
		[dbo].[w2_Product].[shipping_size_kbn],
		[dbo].[w2_Product].[price_cost],
		[dbo].[w2_Product].[point_kbn1],
		[dbo].[w2_Product].[point1],
		[dbo].[w2_Product].[point_kbn2],
		[dbo].[w2_Product].[point2],
		[dbo].[w2_Product].[point_kbn3],
		[dbo].[w2_Product].[point3],
		[dbo].[w2_Product].[campaign_from],
		[dbo].[w2_Product].[campaign_to],
		[dbo].[w2_Product].[campaign_point_kbn],
		[dbo].[w2_Product].[campaign_point],
		[dbo].[w2_Product].[display_from],
		[dbo].[w2_Product].[display_to],
		[dbo].[w2_Product].[sell_from],
		[dbo].[w2_Product].[sell_to],
		[dbo].[w2_Product].[before_sale_display_kbn],
		[dbo].[w2_Product].[after_sale_display_kbn],
		[dbo].[w2_Product].[max_sell_quantity],
		[dbo].[w2_Product].[stock_management_kbn],
		[dbo].[w2_Product].[stock_message_id],
		[dbo].[w2_Product].[stock_disp_kbn],
		[dbo].[w2_Product].[url],
		[dbo].[w2_Product].[inquire_email],
		[dbo].[w2_Product].[inquire_tel],
		[dbo].[w2_Product].[display_kbn],
		[dbo].[w2_Product].[category_id1],
		[dbo].[w2_Product].[category_id2],
		[dbo].[w2_Product].[category_id3],
		[dbo].[w2_Product].[category_id4],
		[dbo].[w2_Product].[category_id5],
		[dbo].[w2_Product].[related_product_id_cs1],
		[dbo].[w2_Product].[related_product_id_cs2],
		[dbo].[w2_Product].[related_product_id_cs3],
		[dbo].[w2_Product].[related_product_id_cs4],
		[dbo].[w2_Product].[related_product_id_cs5],
		[dbo].[w2_Product].[related_product_id_us1],
		[dbo].[w2_Product].[related_product_id_us2],
		[dbo].[w2_Product].[related_product_id_us3],
		[dbo].[w2_Product].[related_product_id_us4],
		[dbo].[w2_Product].[related_product_id_us5],
		[dbo].[w2_Product].[image_head],
		[dbo].[w2_Product].[image_mobile],
		[dbo].[w2_Product].[icon_flg1],
		[dbo].[w2_Product].[icon_term_end1],
		[dbo].[w2_Product].[icon_flg2],
		[dbo].[w2_Product].[icon_term_end2],
		[dbo].[w2_Product].[icon_flg3],
		[dbo].[w2_Product].[icon_term_end3],
		[dbo].[w2_Product].[icon_flg4],
		[dbo].[w2_Product].[icon_term_end4],
		[dbo].[w2_Product].[icon_flg5],
		[dbo].[w2_Product].[icon_term_end5],
		[dbo].[w2_Product].[icon_flg6],
		[dbo].[w2_Product].[icon_term_end6],
		[dbo].[w2_Product].[icon_flg7],
		[dbo].[w2_Product].[icon_term_end7],
		[dbo].[w2_Product].[icon_flg8],
		[dbo].[w2_Product].[icon_term_end8],
		[dbo].[w2_Product].[icon_flg9],
		[dbo].[w2_Product].[icon_term_end9],
		[dbo].[w2_Product].[icon_flg10],
		[dbo].[w2_Product].[icon_term_end10],
		[dbo].[w2_Product].[mobile_disp_flg],
		[dbo].[w2_Product].[use_variation_flg],
		[dbo].[w2_Product].[reservation_flg],
		[dbo].[w2_Product].[fixed_purchase_flg],
		[dbo].[w2_Product].[valid_flg],
		[dbo].[w2_ProductVariationView].[variation_id],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id1],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id2],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id3],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id4],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id5],
		[dbo].[w2_ProductVariationView].[mall_variation_id1],
		[dbo].[w2_ProductVariationView].[mall_variation_id2],
		[dbo].[w2_ProductVariationView].[mall_variation_type],
		[dbo].[w2_ProductVariationView].[variation_name1],
		[dbo].[w2_ProductVariationView].[variation_name2],
		[dbo].[w2_ProductVariationView].[variation_name3],
		[dbo].[w2_ProductVariationView].[price],
		[dbo].[w2_ProductVariationView].[special_price],
		[dbo].[w2_ProductVariationView].[variation_image_head],
		[dbo].[w2_ProductVariationView].[variation_image_mobile],
		[dbo].[w2_ProductVariationView].[display_order],
		[dbo].[w2_ProductSaleView].[productsale_id],
		[dbo].[w2_ProductSaleView].[sale_price],
		[dbo].[w2_ProductSaleView].[validity],
		[dbo].[w2_ProductStock].[stock],
		[dbo].[w2_ProductStock].[realstock],
		[dbo].[w2_ProductStock].[realstock_b],
		[dbo].[w2_ProductStock].[realstock_c],
		[dbo].[w2_ProductStock].[realstock_reserved],
		[dbo].[w2_ProductStock].[stock_alert],
		[dbo].[w2_ProductStockMessage].[stock_message_name],
		[dbo].[w2_ProductStockMessage].[stock_message_def],
		[dbo].[w2_ProductStockMessage].[stock_datum1],
		[dbo].[w2_ProductStockMessage].[stock_message1],
		[dbo].[w2_ProductStockMessage].[stock_datum2],
		[dbo].[w2_ProductStockMessage].[stock_message2],
		[dbo].[w2_ProductStockMessage].[stock_datum3],
		[dbo].[w2_ProductStockMessage].[stock_message3],
		[dbo].[w2_ProductStockMessage].[stock_datum4],
		[dbo].[w2_ProductStockMessage].[stock_message4],
		[dbo].[w2_ProductStockMessage].[stock_datum5],
		[dbo].[w2_ProductStockMessage].[stock_message5],
		[dbo].[w2_ProductStockMessage].[stock_datum6],
		[dbo].[w2_ProductStockMessage].[stock_message6],
		[dbo].[w2_ProductStockMessage].[stock_datum7],
		[dbo].[w2_ProductStockMessage].[stock_message7],
		[dbo].[w2_ProductStockMessage].[stock_message_def_mobile],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile1],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile2],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile3],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile4],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile5],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile6],
		[dbo].[w2_ProductStockMessage].[stock_message_mobile7],
		[dbo].[w2_Product].[del_flg],
		[dbo].[w2_Product].[date_created],
		[dbo].[w2_Product].[date_changed],
		[dbo].[w2_Product].[last_changed],
		[dbo].[w2_ShopShipping].[shipping_id],
		[dbo].[w2_ShopShipping].[fixed_purchase_flg],
		[dbo].[w2_ShopShipping].[wrapping_paper_flg],
		[dbo].[w2_ShopShipping].[wrapping_paper_types],
		[dbo].[w2_ShopShipping].[wrapping_bag_flg],
		[dbo].[w2_ShopShipping].[wrapping_bag_types],
		[dbo].[w2_Product].[search_keyword],
		[dbo].[w2_Product].[member_rank_discount_flg],
		[dbo].[w2_Product].[display_member_rank],
		[dbo].[w2_Product].[buyable_member_rank],
		[dbo].[w2_Product].[google_shopping_flg],
		[dbo].[w2_Product].[product_option_settings],
		[dbo].[w2_Product].[arrival_mail_valid_flg],
		[dbo].[w2_Product].[release_mail_valid_flg],
		[dbo].[w2_Product].[resale_mail_valid_flg],
		[dbo].[w2_Product].[select_variation_kbn],
		[dbo].[w2_Product].[select_variation_kbn_mobile],
		[dbo].[w2_Product].[brand_id1],
		[dbo].[w2_Product].[brand_id2],
		[dbo].[w2_Product].[brand_id3],
		[dbo].[w2_Product].[brand_id4],
		[dbo].[w2_Product].[brand_id5],
    	[dbo].[w2_Product].[plural_shipping_price_free_flg],
		[dbo].[w2_Product].[age_limit_flg],
		[dbo].[w2_Product].[gift_flg],
		[dbo].[w2_Product].[digital_contents_flg],
		[dbo].[w2_Product].[download_url],
		[dbo].[w2_ProductVariationView].[variation_download_url],
		[dbo].[w2_Product].[display_sell_flg],
		[dbo].[w2_Product].[display_priority],
		[dbo].[w2_Product].[limited_payment_ids],
		[dbo].[w2_Product].[fixed_purchase_firsttime_price],
		[dbo].[w2_Product].[fixed_purchase_price],
		[dbo].[w2_ProductVariationView].[variation_fixed_purchase_firsttime_price],
		[dbo].[w2_ProductVariationView].[variation_fixed_purchase_price],
		[dbo].[w2_Product].[bundle_item_display_type],
		[dbo].[w2_Product].[product_type],
		[dbo].[w2_Product].[limited_fixed_purchase_kbn1_setting],
		[dbo].[w2_Product].[limited_fixed_purchase_kbn3_setting],
		[dbo].[w2_Product].[recommend_product_id],
		[dbo].[w2_Product].[check_fixed_purchase_firsttime_flg],
		[dbo].[w2_Product].[cooperation_id6],
		[dbo].[w2_Product].[cooperation_id7],
		[dbo].[w2_Product].[cooperation_id8],
		[dbo].[w2_Product].[cooperation_id9],
		[dbo].[w2_Product].[cooperation_id10],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id6],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id7],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id8],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id9],
		[dbo].[w2_ProductVariationView].[variation_cooperation_id10],
		[dbo].[w2_Product].[andmall_reservation_flg],
		[dbo].[w2_ProductVariationView].[variation_andmall_reservation_flg],
		[dbo].[w2_Product].[product_color_id],
		[dbo].[w2_ProductVariationView].[variation_color_id],
		[dbo].[w2_ProductTaxCategory].[tax_category_id],
		[dbo].[w2_ProductTaxCategory].[tax_rate],
		[dbo].[w2_Product].[display_only_fixed_purchase_member_flg],
		[dbo].[w2_Product].[sell_only_fixed_purchase_member_flg],
		[dbo].[w2_Product].[product_weight_gram],
		[dbo].[w2_ProductVariationView].[variation_weight_gram]
FROM	[dbo].[w2_Product] LEFT JOIN [dbo].[w2_ProductStockMessage] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ProductStockMessage].[shop_id]
			AND
			[dbo].[w2_Product].[stock_message_id] = [dbo].[w2_ProductStockMessage].[stock_message_id]
		)
		INNER JOIN [dbo].[w2_ProductVariationView] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ProductVariationView].[shop_id]
			AND
			[dbo].[w2_Product].[product_id] = [dbo].[w2_ProductVariationView].[product_id]
			AND
			(
				(
					[dbo].[w2_Product].[use_variation_flg] = '1'
					AND
					[dbo].[w2_Product].[product_id] != [dbo].[w2_ProductVariationView].[variation_id]
				)
				OR
				(
					[dbo].[w2_Product].[use_variation_flg] != '1'
					AND
					[dbo].[w2_Product].[product_id] = [dbo].[w2_ProductVariationView].[variation_id]
				)
			)
		)
		LEFT JOIN [dbo].[w2_ProductSaleView] ON
		(
			[dbo].[w2_ProductVariationView].[shop_id] = [dbo].[w2_ProductSaleView].[shop_id]
			AND
			[dbo].[w2_ProductSaleView].[productsale_kbn] = 'TS'
			AND
			[dbo].[w2_ProductVariationView].[product_id] = [dbo].[w2_ProductSaleView].[product_id]
			AND
			[dbo].[w2_ProductVariationView].[variation_id] = [dbo].[w2_ProductSaleView].[variation_id]
			AND
			[dbo].[w2_ProductSaleView].[validity] = '1'
		)
		LEFT JOIN [dbo].[w2_ProductStock] ON
		(
			[dbo].[w2_ProductVariationView].[shop_id] = [dbo].[w2_ProductStock].[shop_id]
			AND
			[dbo].[w2_ProductVariationView].[product_id] = [dbo].[w2_ProductStock].[product_id]
			AND
			[dbo].[w2_ProductVariationView].[variation_id] = [dbo].[w2_ProductStock].[variation_id]
		)
		LEFT JOIN [dbo].[w2_ShopShipping] ON
		(
			[dbo].[w2_Product].[shop_id] = [dbo].[w2_ShopShipping].[shop_id]
			AND
			[dbo].[w2_Product].[shipping_type] = [dbo].[w2_ShopShipping].[shipping_id]
		)
		LEFT JOIN [dbo].[w2_ProductTaxCategory] ON
		(
			[dbo].[w2_Product].[tax_category_id] = [dbo].[w2_ProductTaxCategory].[tax_category_id]
		)

GO

        ]]>
    </Statement>
  </Up>
</Migration>