<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 注文系SQLステートメントXML(Order.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<Order>  
  <!-- 注文一覧のIDのみ取得 -->
  <GetIDOnly>
    <Statement>
      <![CDATA[
        CREATE TABLE ##order_id
        (
          order_id nvarchar(30) NOT NULL
        )
        
        INSERT  ##order_id
        SELECT  w2_Order.order_id
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
       ]]>
    </Statement>
  </GetIDOnly>

  <!-- 注文一覧を取得 -->
  <GetOrderList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        -- 該当情報取得
        SELECT  w2_Order.shop_id,
                w2_Order.order_id,
                w2_Order.user_id,
                CONVERT(nvarchar(10), w2_Order.bundle_order_bak) AS bundle_order_bak,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_kbn,
                w2_Order.mall_id,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.order_return_exchange_status,
                w2_Order.order_return_exchange_receipt_date,
                w2_Order.order_repayment_status,
                w2_Order.return_exchange_kbn,
                w2_Order.order_kbn,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_Order.order_stockreserved_status,
                w2_Order.order_shipped_status,
                w2_Order.payment_order_id,
                w2_Order.card_tran_id,
                w2_Order.extend_status1,
                w2_Order.extend_status2,
                w2_Order.extend_status3,
                w2_Order.extend_status4,
                w2_Order.extend_status5,
                w2_Order.extend_status6,
                w2_Order.extend_status7,
                w2_Order.extend_status8,
                w2_Order.extend_status9,
                w2_Order.extend_status10,
                w2_Order.extend_status11,
                w2_Order.extend_status12,
                w2_Order.extend_status13,
                w2_Order.extend_status14,
                w2_Order.extend_status15,
                w2_Order.extend_status16,
                w2_Order.extend_status17,
                w2_Order.extend_status18,
                w2_Order.extend_status19,
                w2_Order.extend_status20,
                w2_Order.extend_status21,
                w2_Order.extend_status22,
                w2_Order.extend_status23,
                w2_Order.extend_status24,
                w2_Order.extend_status25,
                w2_Order.extend_status26,
                w2_Order.extend_status27,
                w2_Order.extend_status28,
                w2_Order.extend_status29,
                w2_Order.extend_status30,
                w2_Order.extend_status31,
                w2_Order.extend_status32,
                w2_Order.extend_status33,
                w2_Order.extend_status34,
                w2_Order.extend_status35,
                w2_Order.extend_status36,
                w2_Order.extend_status37,
                w2_Order.extend_status38,
                w2_Order.extend_status39,
                w2_Order.extend_status40,
                w2_Order.extend_status41,
                w2_Order.extend_status42,
                w2_Order.extend_status43,
                w2_Order.extend_status44,
                w2_Order.extend_status45,
                w2_Order.extend_status46,
                w2_Order.extend_status47,
                w2_Order.extend_status48,
                w2_Order.extend_status49,
                w2_Order.extend_status50,
                w2_Order.memo,
                w2_Order.management_memo,
                w2_Order.shipping_memo,
                w2_Order.payment_memo,
                w2_Order.relation_memo,
                w2_Order.shipping_memo,
                w2_Order.order_price_total,
                w2_MallCooperationSetting.mall_name,
                w2_Order.gift_flg,
                w2_Order.digital_contents_flg,
                w2_User.user_management_level_id,
                w2_User.user_memo,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.delivery_company_id,
                w2_Order.fixed_purchase_order_count,
                w2_Order.fixed_purchase_shipped_count,
                w2_Order.order_count_order,
                w2_Order.demand_status,
                w2_Order.storepickup_status
          FROM  (
                  SELECT  w2_Order.order_id,
                          ROW_NUMBER()
                          OVER
                          (
                            @@ orderby @@
                          ) AS row_num
                    FROM  w2_Order WITH (NOLOCK)
                          <@@hasval:storepickup_status@@>
                          INNER JOIN w2_OrderShipping WITH (NOLOCK) ON
                          (
                            w2_Order.order_id = w2_OrderShipping.order_id
                          )
                          INNER JOIN w2_RealShop WITH (NOLOCK) ON
                          (
                            w2_OrderShipping.storepickup_real_shop_id = w2_RealShop.real_shop_id
                          )
                          </@@hasval:storepickup_status@@>
                          <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped,product_option_texts_like_escaped@@>
                          INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                          (
                            w2_Order.order_id = w2_OrderOwner.order_id
                          )
                          </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped,product_option_texts_like_escaped@@>
                          <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                          INNER JOIN w2_User WITH (NOLOCK) ON
                          (
                            w2_Order.user_id = w2_User.user_id
                          )
                          </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                          <@@hasval:tw_invoice_no,tw_invoice_status@@>
                          LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                          (
                            w2_Order.order_id = w2_TwOrderInvoice.order_id
                          )
                          </@@hasval:tw_invoice_no,tw_invoice_status@@>
                          [[ ORDER_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_Order WITH (NOLOCK) ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_Payment WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN  w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting WITH (NOLOCK) ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                LEFT JOIN w2_OrderShipping WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = '1'
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
      <Input Name="product_bundle_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderList>

  <!-- 注文情報の行数を取得 -->
  <GetOrderCount>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        -- 全件数取得
        SELECT  ISNULL(COUNT(DISTINCT w2_Order.order_id), 0) AS order_count
          FROM  w2_Order WITH (NOLOCK)
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                <@@hasval:product_id_like_escaped,product_name_like_escaped,novelty_id_like_escaped,recommend_id_like_escaped,productsale_id_like_escaped,product_bundle_id_like_escaped,product_bundle_id_like_escaped,product_option_texts_like_escaped@@>
                INNER JOIN w2_OrderItem WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                </@@hasval:product_id_like_escaped,product_name_like_escaped,novelty_id_like_escaped,recommend_id_like_escaped,productsale_id_like_escaped,product_bundle_id_like_escaped,product_bundle_id_like_escaped,product_option_texts_like_escaped@@>
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetOrderCount>

  <!-- 注文商品情報を取得（ピッキングリスト用） -->
  <GetOrderItemListForPickingList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  @@ select @@
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                  AND
                  w2_OrderItem.item_quantity > 0
                ) 
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                LEFT JOIN w2_ProductStock ON
                (
                  w2_OrderItem.shop_id = w2_ProductStock.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductStock.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductStock.variation_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
                @@ groupby @@
                @@ having @@
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemListForPickingList>

  <!-- 注文マスタ件数取得(CSV出力用) -->
  <GetOrderMasterCount>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        ;WITH UserList AS
        (
          SELECT  DISTINCT @@ fields @@
            FROM  #TempTable
                  INNER JOIN w2_Order ON
                  (
                    w2_Order.order_id = #TempTable.order_id
                  )
                  INNER JOIN w2_OrderOwner ON
                  (
                    w2_Order.order_id = w2_OrderOwner.order_id
                  )
                  INNER JOIN w2_OrderShipping ON
                  (
                    w2_Order.order_id = w2_OrderShipping.order_id
                  )
                  LEFT JOIN w2_OrderCoupon ON
                  (
                    w2_Order.order_id = w2_OrderCoupon.order_id
                  )
                  LEFT JOIN w2_Payment ON
                  (
                    w2_Order.shop_id = w2_Payment.shop_id
                    AND
                    w2_Order.order_payment_kbn = w2_Payment.payment_id
                  )
                  LEFT JOIN w2_ShopShipping ON
                  (
                    w2_Order.shop_id = w2_ShopShipping.shop_id
                    AND
                    w2_Order.shipping_id = w2_ShopShipping.shipping_id
                  )
                  INNER JOIN w2_User ON
                  (
                    w2_Order.user_id = w2_User.user_id
                  )
                  LEFT JOIN w2_FixedPurchase ON
                  (
                    w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  )
        ),
        TempTL AS
        (
          SELECT  *
            FROM  UserList
           WHERE  UserList.del_flg = '0'
        ),
        TempTLAC AS
        (
          SELECT  COUNT(*) count
            FROM  TempTL
        ),
        TempTLMC AS
        (
          SELECT  COUNT(*) count
            FROM  TempTL
           WHERE  @mail_send_both_pc_and_mobile_enabled = 'True'
             AND  TempTL.mail_addr <> ''
             AND  TempTL.mail_addr2 <> ''
        )
        SELECT  TempTLAC.count + TempTLMC.count
          FROM  TempTLAC,
                TempTLMC
        ]]>
    </Statement>
    <Parameter>
      <Input Name="mail_send_both_pc_and_mobile_enabled" Type="nvarchar" Size="5" />
    </Parameter>
  </GetOrderMasterCount>

  <!-- 注文マスタ情報取得(CSV出力用) -->
  <GetOrderMaster>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderMaster>

  <!-- 注文Atodene請求書用マスタ情報取得(CSV出力用) -->
  <GetOrderMasterAtodeneInvoice>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
               INNER JOIN w2_InvoiceAtodene WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceAtodene.order_id AND w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_order.order_payment_kbn = 'K32'
                )
                INNER JOIN (
                             SELECT  order_id,
                                     MAX(CASE detail_no WHEN 1 THEN goods END) AS goods1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsAmount END) AS goodsAmount1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsPrice END) AS goodsPrice1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsSubtotal END) AS goodsSubtotal1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsExpand END) AS goodsExpand1,
                                     MAX(CASE detail_no WHEN 2 THEN goods END) AS goods2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsAmount END) AS goodsAmount2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsPrice END) AS goodsPrice2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsSubtotal END) AS goodsSubtotal2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsExpand END) AS goodsExpand2,
                                     MAX(CASE detail_no WHEN 3 THEN goods END) AS goods3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsAmount END) AS goodsAmount3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsPrice END) AS goodsPrice3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsSubtotal END) AS goodsSubtotal3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsExpand END) AS goodsExpand3,
                                     MAX(CASE detail_no WHEN 4 THEN goods END) AS goods4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsAmount END) AS goodsAmount4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsPrice END) AS goodsPrice4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsSubtotal END) AS goodsSubtotal4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsExpand END) AS goodsExpand4,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goods END), null) AS goods5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsAmount END), null) AS goodsAmount5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsPrice END), null) AS goodsPrice5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsSubtotal END), null) AS goodsSubtotal5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsExpand END), null) AS goodsExpand5,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goods END), null) AS goods6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsAmount END), null) AS goodsAmount6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsPrice END), null) AS goodsPrice6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsSubtotal END), null) AS goodsSubtotal6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsExpand END), null) AS goodsExpand6,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goods END), null) AS goods7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsAmount END), null) AS goodsAmount7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsPrice END), null) AS goodsPrice7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsSubtotal END), null) AS goodsSubtotal7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsExpand END), null) AS goodsExpand7,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goods END), null) AS goods8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsAmount END), null) AS goodsAmount8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsPrice END), null) AS goodsPrice8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsSubtotal END), null) AS goodsSubtotal8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsExpand END), null) AS goodsExpand8,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goods END), null) AS goods9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsAmount END), null) AS goodsAmount9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsPrice END), null) AS goodsPrice9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsSubtotal END), null) AS goodsSubtotal9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsExpand END), null) AS goodsExpand9,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goods END), null) AS goods10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsAmount END), null) AS goodsAmount10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsPrice END), null) AS goodsPrice10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsSubtotal END), null) AS goodsSubtotal10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsExpand END), null) AS goodsExpand10,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goods END), null) AS goods11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsAmount END), null) AS goodsAmount11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsPrice END), null) AS goodsPrice11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsSubtotal END), null) AS goodsSubtotal11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsExpand END), null) AS goodsExpand11,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goods END), null) AS goods12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsAmount END), null) AS goodsAmount12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsPrice END), null) AS goodsPrice12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsSubtotal END), null) AS goodsSubtotal12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsExpand END), null) AS goodsExpand12,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goods END), null) AS goods13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsAmount END), null) AS goodsAmount13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsPrice END), null) AS goodsPrice13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsSubtotal END), null) AS goodsSubtotal13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsExpand END), null) AS goodsExpand13,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goods END), null) AS goods14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsAmount END), null) AS goodsAmount14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsPrice END), null) AS goodsPrice14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsSubtotal END), null) AS goodsSubtotal14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsExpand END), null) AS goodsExpand14,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goods END), null) AS goods15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsAmount END), null) AS goodsAmount15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsPrice END), null) AS goodsPrice15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsSubtotal END), null) AS goodsSubtotal15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsExpand END), null) AS goodsExpand15
                               FROM  w2_InvoiceAtodeneDetail WITH (NOLOCK)
                           GROUP BY  order_id
                           ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderMasterAtodeneInvoice>

  <!-- 注文商品マスタ情報取得(CSV出力用) -->
  <GetOrderItemMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                [[ ORDER_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_OrderItem.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemMaster>

  <!-- 注文商品マスタ情報取得(PDF出力用) -->
  <GetOrderItemPdf>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        ;WITH TempTableForLimitedTimePoint AS
        (
          SELECT  ROW_NUMBER()
                  OVER
                  (
                    PARTITION BY user_id ORDER BY point_exp ASC
                  ) AS num,
                  w2_UserPoint.user_id,
                  w2_UserPoint.point,
                  w2_UserPoint.effective_date,
                  w2_UserPoint.point_exp
            FROM  w2_UserPoint
           WHERE  w2_UserPoint.point_kbn = '02'
        )        
        SELECT  w2_Order.order_id,
                w2_Order.user_id,
                w2_Order.shop_id,
                w2_Order.supplier_id,
                w2_Order.order_kbn,
                w2_Order.mall_id,
                (CASE
                   WHEN w2_MallCooperationSetting.mall_kbn is null
                   THEN 'OWN_SITE'
                   ELSE w2_MallCooperationSetting.mall_kbn
                 END) AS mall_kbn,
                w2_Order.order_payment_kbn,
                w2_Payment.payment_name,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_recognition_date,
                w2_Order.order_stockreserved_status,
                w2_Order.order_stockreserved_date,
                w2_Order.order_shipping_date,
                w2_Order.order_shipped_status,
                w2_Order.order_shipped_date,
                w2_Order.order_delivering_date,
                w2_Order.order_cancel_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.demand_status,
                w2_Order.demand_date,
                w2_Order.order_item_count,
                w2_Order.order_product_count,
                w2_Order.order_price_subtotal,
                w2_Order.order_price_tax,
                w2_Order.order_price_subtotal_tax,
                w2_Order.order_price_shipping,
                w2_Order.order_price_exchange,
                w2_Order.order_price_regulation + CorrectionPriceInfo.correction_price_total as order_price_regulation,
                w2_Order.order_price_total,
                w2_Order.order_tax_rate,
                w2_Order.order_point_use,
                w2_Order.order_point_use_yen,
                w2_Order.order_point_add,
                w2_Order.order_coupon_use,
                w2_Order.card_kbn,
                w2_Order.card_tran_id,
                w2_Order.shipping_id,
                w2_Order.extend_status1,
                w2_Order.extend_status2,
                w2_Order.extend_status3,
                w2_Order.extend_status4,
                w2_Order.extend_status5,
                w2_Order.extend_status6,
                w2_Order.extend_status7,
                w2_Order.extend_status8,
                w2_Order.extend_status9,
                w2_Order.extend_status10,
                w2_Order.extend_status11,
                w2_Order.extend_status12,
                w2_Order.extend_status13,
                w2_Order.extend_status14,
                w2_Order.extend_status15,
                w2_Order.extend_status16,
                w2_Order.extend_status17,
                w2_Order.extend_status18,
                w2_Order.extend_status19,
                w2_Order.extend_status20,
                w2_Order.extend_status21,
                w2_Order.extend_status22,
                w2_Order.extend_status23,
                w2_Order.extend_status24,
                w2_Order.extend_status25,
                w2_Order.extend_status26,
                w2_Order.extend_status27,
                w2_Order.extend_status28,
                w2_Order.extend_status29,
                w2_Order.extend_status30,
                w2_Order.extend_status31,
                w2_Order.extend_status32,
                w2_Order.extend_status33,
                w2_Order.extend_status34,
                w2_Order.extend_status35,
                w2_Order.extend_status36,
                w2_Order.extend_status37,
                w2_Order.extend_status38,
                w2_Order.extend_status39,
                w2_Order.extend_status40,
                w2_Order.fixed_purchase_id,
                w2_Order.fixed_purchase_order_count,
                w2_Order.fixed_purchase_shipped_count,
                w2_Order.receipt_output_flg,
                w2_Order.order_discount_set_price,
                w2_ShopShipping.shop_shipping_name,
                w2_DeliveryCompany.shipping_time_id1,
                w2_DeliveryCompany.shipping_time_id2,
                w2_DeliveryCompany.shipping_time_id3,
                w2_DeliveryCompany.shipping_time_id4,
                w2_DeliveryCompany.shipping_time_id5,
                w2_DeliveryCompany.shipping_time_id6,
                w2_DeliveryCompany.shipping_time_id7,
                w2_DeliveryCompany.shipping_time_id8,
                w2_DeliveryCompany.shipping_time_id9,
                w2_DeliveryCompany.shipping_time_id10,
                w2_DeliveryCompany.shipping_time_message1,
                w2_DeliveryCompany.shipping_time_message2,
                w2_DeliveryCompany.shipping_time_message3,
                w2_DeliveryCompany.shipping_time_message4,
                w2_DeliveryCompany.shipping_time_message5,
                w2_DeliveryCompany.shipping_time_message6,
                w2_DeliveryCompany.shipping_time_message7,
                w2_DeliveryCompany.shipping_time_message8,
                w2_DeliveryCompany.shipping_time_message9,
                w2_DeliveryCompany.shipping_time_message10,
                w2_Order.payment_memo,
                w2_Order.management_memo,
                w2_Order.shipping_memo,
                w2_Order.relation_memo,
                w2_Order.memo,
                w2_Order.regulation_memo,
                w2_Order.attribute1,
                w2_Order.attribute2,
                w2_Order.attribute3,
                w2_Order.attribute4,
                w2_Order.attribute5,
                w2_Order.attribute6,
                w2_Order.attribute7,
                w2_Order.attribute8,
                w2_Order.attribute9,
                w2_Order.attribute10,
                w2_Order.date_created,
                w2_Order.date_changed,
                w2_Order.member_rank_discount_price,
                w2_Order.subscription_box_course_id,
                w2_Order.order_subscription_box_order_count,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_addr5,
                w2_OrderOwner.owner_addr_country_name,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_sex,
                w2_OrderOwner.owner_birth,
                w2_OrderOwner.disp_language_code,
                w2_OrderOwner.disp_language_locale_id,
                w2_OrderShipping.order_shipping_no,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_name1,
                w2_OrderShipping.shipping_name2,
                w2_OrderShipping.shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_addr5,
                w2_OrderShipping.shipping_country_name,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.another_shipping_flg,
                w2_OrderShipping.shipping_method,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_check_no,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderItem.order_item_no,
                (
                  SELECT  COUNT(order_id)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                     AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS order_item_rowcount,
                (
                  SELECT  MAX(w2_OrderItem.order_shipping_no)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                   --AND  w2_OrderItem.order_shipping_no = w2_OrderShipping.order_shipping_no
                     AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS shipping_no_max,
                (
                  SELECT  SUM(w2_OrderItem.item_price)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                     AND  w2_OrderItem.order_shipping_no = w2_OrderShipping.order_shipping_no
                     AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS product_total_price,
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id,
                w2_OrderItem.product_name,
                w2_OrderItem.product_name_kana,
                w2_OrderItem.product_price,
                w2_OrderItem.item_realstock_reserved,
                w2_OrderItem.item_realstock_shipped,
                w2_OrderItem.item_quantity,
                w2_OrderItem.item_price,
                w2_OrderItem.item_price_tax,
                w2_OrderItem.product_tax_rate,
                w2_OrderItem.download_url,
                w2_OrderItem.cooperation_id1,
                w2_OrderItem.cooperation_id2,
                w2_OrderItem.cooperation_id3,
                w2_OrderItem.cooperation_id4,
                w2_OrderItem.cooperation_id5,
                w2_OrderItem.cooperation_id6,
                w2_OrderItem.cooperation_id7,
                w2_OrderItem.cooperation_id8,
                w2_OrderItem.cooperation_id9,
                w2_OrderItem.cooperation_id10,
                w2_OrderItem.product_option_texts,
                w2_OrderItem.novelty_id,
                w2_OrderItem.item_discounted_price,
                w2_Order.gift_flg,
                w2_Order.digital_contents_flg,
                w2_OrderShipping.sender_name,
                w2_OrderShipping.sender_name1,
                w2_OrderShipping.sender_name2,
                w2_OrderShipping.sender_name_kana,
                w2_OrderShipping.sender_name_kana1,
                w2_OrderShipping.sender_name_kana2,
                w2_OrderShipping.sender_zip,
                w2_OrderShipping.sender_addr1,
                w2_OrderShipping.sender_addr2,
                w2_OrderShipping.sender_addr3,
                w2_OrderShipping.sender_addr4,
                w2_OrderShipping.sender_addr5,
                w2_OrderShipping.sender_country_name,
                w2_OrderShipping.sender_company_name,
                w2_OrderShipping.sender_company_post_name,
                w2_OrderShipping.sender_tel1,
                w2_OrderShipping.wrapping_paper_type,
                w2_OrderShipping.wrapping_paper_name,
                w2_OrderShipping.wrapping_bag_type,
                w2_FixedPurchase.fixed_purchase_id,
                w2_FixedPurchase.fixed_purchase_kbn,
                w2_FixedPurchase.fixed_purchase_setting1,
                w2_FixedPurchase.last_order_date,
                w2_FixedPurchase.order_count,
                w2_FixedPurchase.fixed_purchase_date_bgn,
                w2_FixedPurchase.next_shipping_date,
                w2_FixedPurchase.next_next_shipping_date,
                w2_FixedPurchase.fixed_purchase_management_memo,
                w2_FixedPurchase.next_shipping_use_point,
                w2_Product.name,
                w2_Product.product_type,
                w2_ProductVariation.mall_variation_id1,
                w2_ProductVariation.mall_variation_id2,
                w2_FixedPurchase.fixed_purchase_status,
                (
                  SELECT  SUM(point)
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.user_id = w2_User.user_id
                     AND  w2_UserPoint.point_type = '01'
                ) AS user_point,
                (
                  SELECT SUM(point)
                    FROM w2_UserPoint
                   WHERE w2_UserPoint.user_id = w2_User.user_id
                     AND w2_UserPoint.point_type = '00'
                ) AS user_point_temp,
                w2_Order.setpromotion_product_discount_amount,
                w2_Order.setpromotion_shipping_charge_discount_amount,
                w2_Order.setpromotion_payment_charge_discount_amount,
                w2_OrderSetPromotion.setpromotion_name,
                w2_OrderSetPromotion.setpromotion_disp_name,
                w2_OrderSetPromotion.setpromotion_id,
                w2_User.user_memo,
                w2_Order.fixed_purchase_discount_price,
                w2_Order.fixed_purchase_member_discount_amount,
                w2_Order.receipt_address,
                w2_Order.receipt_proviso,
                -- ↓軽減税率用↓
                ISNULL(PriceTotalByTax.[8.00], 0) AS price_total_8,
                ISNULL(PriceTotalByTax.[10.00], 0) AS price_total_10,
                ISNULL(TaxPriceByRate.[8.00], 0) AS tax_price_8,
                ISNULL(TaxPriceByRate.[10.00], 0) AS tax_price_10,
                -- ↑軽減税率用↑
                (
                  SELECT  COUNT(point)
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.user_id = w2_User.user_id
                     AND  w2_UserPoint.point_kbn = '02'
                ) AS limited_time_point_count,
                LimitedTimePoint.limited_time_point1,
                LimitedTimePoint.limited_time_point2,
                LimitedTimePoint.limited_time_point3,
                LimitedTimePoint.limited_time_point4,
                LimitedTimePoint.limited_time_point5,
                LimitedTimePoint.limited_time_point6,
                LimitedTimePoint.limited_time_point7,
                LimitedTimePoint.limited_time_point8,
                LimitedTimePoint.limited_time_point9,
                LimitedTimePoint.limited_time_point10,
                LimitedTimePoint.limited_time_point_exp1,
                LimitedTimePoint.limited_time_point_exp2,
                LimitedTimePoint.limited_time_point_exp3,
                LimitedTimePoint.limited_time_point_exp4,
                LimitedTimePoint.limited_time_point_exp5,
                LimitedTimePoint.limited_time_point_exp6,
                LimitedTimePoint.limited_time_point_exp7,
                LimitedTimePoint.limited_time_point_exp8,
                LimitedTimePoint.limited_time_point_exp9,
                LimitedTimePoint.limited_time_point_exp10,
                LimitedTimePoint.effective_date1,
                LimitedTimePoint.effective_date2,
                LimitedTimePoint.effective_date3,
                LimitedTimePoint.effective_date4,
                LimitedTimePoint.effective_date5,
                LimitedTimePoint.effective_date6,
                LimitedTimePoint.effective_date7,
                LimitedTimePoint.effective_date8,
                LimitedTimePoint.effective_date9,
                LimitedTimePoint.effective_date10
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                  And
                  w2_OrderItem.order_history_display_type = 'VALID'
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.shop_id = w2_MallCooperationSetting.shop_id
                  AND
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
                INNER JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                price_total_by_rate,
                                key_tax_rate 
                          FROM  w2_OrderPriceByTaxRate
                        ) AS o
                   PIVOT (SUM(price_total_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS PriceTotalByTax
                ON
                (
                  w2_Order.order_id = PriceTotalByTax.order_id
                )
                INNER JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                tax_price_by_rate,
                                key_tax_rate 
                          FROM  w2_OrderPriceByTaxRate
                        ) AS o
                   PIVOT (SUM(tax_price_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS TaxPriceByRate
                ON
                (
                  w2_Order.order_id = TaxPriceByRate.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                LEFT JOIN
                (
                  SELECT  DISTINCT user_id,
                          MAX(CASE num WHEN 1 THEN point END) limited_time_point1,
                          MAX(CASE num WHEN 1 THEN effective_date END) effective_date1,
                          MAX(CASE num WHEN 1 THEN point_exp END) limited_time_point_exp1,
                          MAX(CASE num WHEN 2 THEN point END) limited_time_point2,
                          MAX(CASE num WHEN 2 THEN effective_date END) effective_date2,
                          MAX(CASE num WHEN 2 THEN point_exp END) limited_time_point_exp2,
                          MAX(CASE num WHEN 3 THEN point END) limited_time_point3,
                          MAX(CASE num WHEN 3 THEN effective_date END) effective_date3,
                          MAX(CASE num WHEN 3 THEN point_exp END) limited_time_point_exp3,
                          MAX(CASE num WHEN 4 THEN point END) limited_time_point4,
                          MAX(CASE num WHEN 4 THEN effective_date END) effective_date4,
                          MAX(CASE num WHEN 4 THEN point_exp END) limited_time_point_exp4,
                          MAX(CASE num WHEN 5 THEN point END) limited_time_point5,
                          MAX(CASE num WHEN 5 THEN effective_date END) effective_date5,
                          MAX(CASE num WHEN 5 THEN point_exp END) limited_time_point_exp5,
                          MAX(CASE num WHEN 6 THEN point END) limited_time_point6,
                          MAX(CASE num WHEN 6 THEN effective_date END) effective_date6,
                          MAX(CASE num WHEN 6 THEN point_exp END) limited_time_point_exp6,
                          MAX(CASE num WHEN 7 THEN point END) limited_time_point7,
                          MAX(CASE num WHEN 7 THEN effective_date END) effective_date7,
                          MAX(CASE num WHEN 7 THEN point_exp END) limited_time_point_exp7,
                          MAX(CASE num WHEN 8 THEN point END) limited_time_point8,
                          MAX(CASE num WHEN 8 THEN effective_date END) effective_date8,
                          MAX(CASE num WHEN 8 THEN point_exp END) limited_time_point_exp8,
                          MAX(CASE num WHEN 9 THEN point END) limited_time_point9,
                          MAX(CASE num WHEN 9 THEN effective_date END) effective_date9,
                          MAX(CASE num WHEN 9 THEN point_exp END) limited_time_point_exp9,
                          MAX(CASE num WHEN 10 THEN point END) limited_time_point10,
                          MAX(CASE num WHEN 10 THEN effective_date END) effective_date10,
                          MAX(CASE num WHEN 10 THEN point_exp END) limited_time_point_exp10
                    FROM  TempTableForLimitedTimePoint
                GROUP BY  user_id
                ) AS LimitedTimePoint
                ON
                (
                  w2_Order.user_id = LimitedTimePoint.user_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemPdf>

  <!-- 注文セットプロモーション情報取得（マスタ出力用） -->
  <GetOrderSetPromotionMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderSetPromotionMaster>

  <!-- 注文一覧を取得(ワークフロー) -->
  <GetOrderWorkflowList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        -- 全件数取得
        DECLARE @row_count int
        SELECT  @row_count = ISNULL(COUNT(w2_Order.order_id), 0)
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        -- 該当情報取得
        SELECT  w2_Order.shop_id,
                w2_Order.order_id,
                w2_Order.mall_id,
                w2_Order.user_id,
                CONVERT(nvarchar(10),w2_Order.bundle_order_bak) AS bundle_order_bak,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_Order.order_payment_kbn,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.order_return_exchange_status,
                order_return_exchange_receipt_date,
                w2_Order.order_repayment_status,
                w2_Order.return_exchange_kbn,
                w2_Order.order_kbn,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_Order.order_stockreserved_status,
                w2_Order.order_shipped_status,
                w2_Order.card_tran_id,
                w2_Order.card_instruments,
                w2_Order.payment_order_id,
                w2_Order.extend_status1,
                w2_Order.extend_status2,
                w2_Order.extend_status3,
                w2_Order.extend_status4,
                w2_Order.extend_status5,
                w2_Order.extend_status6,
                w2_Order.extend_status7,
                w2_Order.extend_status8,
                w2_Order.extend_status9,
                w2_Order.extend_status10,
                w2_Order.extend_status11,
                w2_Order.extend_status12,
                w2_Order.extend_status13,
                w2_Order.extend_status14,
                w2_Order.extend_status15,
                w2_Order.extend_status16,
                w2_Order.extend_status17,
                w2_Order.extend_status18,
                w2_Order.extend_status19,
                w2_Order.extend_status20,
                w2_Order.extend_status21,
                w2_Order.extend_status22,
                w2_Order.extend_status23,
                w2_Order.extend_status24,
                w2_Order.extend_status25,
                w2_Order.extend_status26,
                w2_Order.extend_status27,
                w2_Order.extend_status28,
                w2_Order.extend_status29,
                w2_Order.extend_status30,
                w2_Order.extend_status31,
                w2_Order.extend_status32,
                w2_Order.extend_status33,
                w2_Order.extend_status34,
                w2_Order.extend_status35,
                w2_Order.extend_status36,
                w2_Order.extend_status37,
                w2_Order.extend_status38,
                w2_Order.extend_status39,
                w2_Order.extend_status40,
                w2_Order.memo,
                w2_Order.management_memo,
                w2_Order.shipping_memo,
                w2_Order.order_price_shipping,
                w2_Order.order_price_exchange,
                w2_Order.order_price_regulation,
                w2_Order.order_price_repayment,
                w2_Order.order_price_total,
                w2_Order.order_point_use,
                w2_Order.order_point_use_yen,
                w2_Order.order_point_add,
                w2_Order.order_coupon_use,
                w2_Order.date_created,
                w2_Order.gift_flg,
                w2_Order.digital_contents_flg,
                w2_OrderCoupon.dept_id,
                w2_OrderCoupon.coupon_id,
                w2_OrderCoupon.coupon_no,
                w2_OrderCoupon.coupon_code,
                w2_OrderCoupon.coupon_type,
                w2_DeliveryCompany.shipping_time_id1,
                w2_DeliveryCompany.shipping_time_message1,
                w2_DeliveryCompany.shipping_time_id2,
                w2_DeliveryCompany.shipping_time_message2,
                w2_DeliveryCompany.shipping_time_id3,
                w2_DeliveryCompany.shipping_time_message3,
                w2_DeliveryCompany.shipping_time_id4,
                w2_DeliveryCompany.shipping_time_message4,
                w2_DeliveryCompany.shipping_time_id5,
                w2_DeliveryCompany.shipping_time_message5,
                w2_DeliveryCompany.shipping_time_id6,
                w2_DeliveryCompany.shipping_time_message6,
                w2_DeliveryCompany.shipping_time_id7,
                w2_DeliveryCompany.shipping_time_message7,
                w2_DeliveryCompany.shipping_time_id8,
                w2_DeliveryCompany.shipping_time_message8,
                w2_DeliveryCompany.shipping_time_id9,
                w2_DeliveryCompany.shipping_time_message9,
                w2_DeliveryCompany.shipping_time_id10,
                w2_DeliveryCompany.shipping_time_message10,
                w2_ShopShipping.wrapping_paper_flg,
                w2_ShopShipping.wrapping_bag_flg,
                w2_MallCooperationSetting.mall_name,
                w2_User.user_management_level_id,
                @row_count AS row_count,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.delivery_company_id,
                w2_Order.fixed_purchase_order_count,
                w2_Order.fixed_purchase_shipped_count,
                w2_Order.order_count_order,
                w2_Order.demand_status
          FROM  (
                  SELECT  w2_Order.order_id,
                          ROW_NUMBER()
                          OVER
                          (
                            @@ orderby @@
                          ) AS row_num
                    FROM  w2_Order
                          INNER JOIN w2_OrderOwner ON
                          (
                            w2_Order.order_id = w2_OrderOwner.order_id
                          )
                          INNER JOIN w2_User ON
                          (
                            w2_Order.user_id = w2_User.user_id
                          )
                          [[ ORDERWORKFLOW_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_Order ON
                (
                  RowIndex.order_id = w2_Order.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = '1'
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetOrderWorkflowList>

  <!-- 注文商品一覧取得(ワークフロー) （ピッキングリスト用）-->
  <GetOrderItemWorkflowListForPickingList>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  @@ select @@
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                LEFT JOIN w2_ProductStock ON
                (
                  w2_OrderItem.shop_id = w2_ProductStock.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductStock.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductStock.variation_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
                @@ groupby @@
                @@ having @@
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemWorkflowListForPickingList>

  <!-- 注文マスタ件数取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMasterCount>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        ;WITH UserList AS
        (
          SELECT  DISTINCT @@ fields @@
            FROM  #TempTable
                  INNER JOIN w2_Order ON
                  (
                    w2_Order.order_id = #TempTable.order_id
                  )
                  INNER JOIN w2_OrderOwner ON
                  (
                    w2_Order.order_id = w2_OrderOwner.order_id
                  )
                  INNER JOIN w2_OrderShipping ON
                  (
                    w2_Order.order_id = w2_OrderShipping.order_id
                  )
                  LEFT JOIN w2_OrderCoupon ON
                  (
                    w2_Order.order_id = w2_OrderCoupon.order_id
                  )
                  LEFT JOIN w2_Payment ON
                  (
                    w2_Order.shop_id = w2_Payment.shop_id
                    AND
                    w2_Order.order_payment_kbn = w2_Payment.payment_id
                  )
                  LEFT JOIN w2_ShopShipping ON
                  (
                    w2_Order.shop_id = w2_ShopShipping.shop_id
                    AND
                    w2_Order.shipping_id = w2_ShopShipping.shipping_id
                  )
                  LEFT JOIN w2_User ON
                  (
                    w2_Order.user_id = w2_User.user_id
                  )
                  LEFT JOIN w2_FixedPurchase ON
                  (
                    w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                  )
        ),
        TempTL AS
        (
          SELECT  *
            FROM  UserList
           WHERE  UserList.del_flg = '0'
        ),
        TempTLAC AS
        (
          SELECT  COUNT(*) count
            FROM  TempTL
        ),
        TempTLMC AS
        (
          SELECT  COUNT(*) count
            FROM  TempTL
           WHERE  @mail_send_both_pc_and_mobile_enabled = 'True'
             AND  TempTL.mail_addr <> ''
             AND  TempTL.mail_addr2 <> ''
        )
        SELECT  TempTLAC.count + TempTLMC.count
          FROM  TempTLAC,
                TempTLMC
        ]]>
    </Statement>
    <Parameter>
      <Input Name="mail_send_both_pc_and_mobile_enabled" Type="nvarchar" Size="5" />
    </Parameter>
  </GetOrderWorkflowMasterCount>

  <!-- 注文マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMaster>

  <!-- 注文Atodene請求書マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMasterAtodeneInvoice>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_InvoiceAtodene WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceAtodene.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_order.order_payment_kbn = 'K32'
                )
                INNER JOIN (
                             SELECT  order_id,
                                     MAX(CASE detail_no WHEN 1 THEN goods END) AS goods1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsAmount END) AS goodsAmount1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsPrice END) AS goodsPrice1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsSubtotal END) AS goodsSubtotal1,
                                     MAX(CASE detail_no WHEN 1 THEN goodsExpand END) AS goodsExpand1,
                                     MAX(CASE detail_no WHEN 2 THEN goods END) AS goods2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsAmount END) AS goodsAmount2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsPrice END) AS goodsPrice2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsSubtotal END) AS goodsSubtotal2,
                                     MAX(CASE detail_no WHEN 2 THEN goodsExpand END) AS goodsExpand2,
                                     MAX(CASE detail_no WHEN 3 THEN goods END) AS goods3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsAmount END) AS goodsAmount3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsPrice END) AS goodsPrice3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsSubtotal END) AS goodsSubtotal3,
                                     MAX(CASE detail_no WHEN 3 THEN goodsExpand END) AS goodsExpand3,
                                     MAX(CASE detail_no WHEN 4 THEN goods END) AS goods4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsAmount END) AS goodsAmount4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsPrice END) AS goodsPrice4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsSubtotal END) AS goodsSubtotal4,
                                     MAX(CASE detail_no WHEN 4 THEN goodsExpand END) AS goodsExpand4,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goods END), null) AS goods5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsAmount END), null) AS goodsAmount5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsPrice END), null) AS goodsPrice5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsSubtotal END), null) AS goodsSubtotal5,
                                     ISNULL(MAX(CASE detail_no WHEN 5 THEN goodsExpand END), null) AS goodsExpand5,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goods END), null) AS goods6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsAmount END), null) AS goodsAmount6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsPrice END), null) AS goodsPrice6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsSubtotal END), null) AS goodsSubtotal6,
                                     ISNULL(MAX(CASE detail_no WHEN 6 THEN goodsExpand END), null) AS goodsExpand6,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goods END), null) AS goods7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsAmount END), null) AS goodsAmount7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsPrice END), null) AS goodsPrice7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsSubtotal END), null) AS goodsSubtotal7,
                                     ISNULL(MAX(CASE detail_no WHEN 7 THEN goodsExpand END), null) AS goodsExpand7,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goods END), null) AS goods8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsAmount END), null) AS goodsAmount8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsPrice END), null) AS goodsPrice8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsSubtotal END), null) AS goodsSubtotal8,
                                     ISNULL(MAX(CASE detail_no WHEN 8 THEN goodsExpand END), null) AS goodsExpand8,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goods END), null) AS goods9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsAmount END), null) AS goodsAmount9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsPrice END), null) AS goodsPrice9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsSubtotal END), null) AS goodsSubtotal9,
                                     ISNULL(MAX(CASE detail_no WHEN 9 THEN goodsExpand END), null) AS goodsExpand9,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goods END), null) AS goods10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsAmount END), null) AS goodsAmount10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsPrice END), null) AS goodsPrice10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsSubtotal END), null) AS goodsSubtotal10,
                                     ISNULL(MAX(CASE detail_no WHEN 10 THEN goodsExpand END), null) AS goodsExpand10,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goods END), null) AS goods11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsAmount END), null) AS goodsAmount11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsPrice END), null) AS goodsPrice11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsSubtotal END), null) AS goodsSubtotal11,
                                     ISNULL(MAX(CASE detail_no WHEN 11 THEN goodsExpand END), null) AS goodsExpand11,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goods END), null) AS goods12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsAmount END), null) AS goodsAmount12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsPrice END), null) AS goodsPrice12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsSubtotal END), null) AS goodsSubtotal12,
                                     ISNULL(MAX(CASE detail_no WHEN 12 THEN goodsExpand END), null) AS goodsExpand12,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goods END), null) AS goods13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsAmount END), null) AS goodsAmount13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsPrice END), null) AS goodsPrice13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsSubtotal END), null) AS goodsSubtotal13,
                                     ISNULL(MAX(CASE detail_no WHEN 13 THEN goodsExpand END), null) AS goodsExpand13,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goods END), null) AS goods14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsAmount END), null) AS goodsAmount14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsPrice END), null) AS goodsPrice14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsSubtotal END), null) AS goodsSubtotal14,
                                     ISNULL(MAX(CASE detail_no WHEN 14 THEN goodsExpand END), null) AS goodsExpand14,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goods END), null) AS goods15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsAmount END), null) AS goodsAmount15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsPrice END), null) AS goodsPrice15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsSubtotal END), null) AS goodsSubtotal15,
                                     ISNULL(MAX(CASE detail_no WHEN 15 THEN goodsExpand END), null) AS goodsExpand15
                               FROM  w2_InvoiceAtodeneDetail WITH (NOLOCK)
                           GROUP BY  order_id
                           ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMasterAtodeneInvoice>

  <!-- 注文商品マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderItemWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )                
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_OrderItem.order_id = w2_TwOrderInvoice.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemWorkflowMaster>

  <!-- 注文セットプロモーションマスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderSetPromotionWorkflowMaster>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                INNER JOIN w2_OrderSetPromotion ON
                (
                  w2_Order.order_id = w2_OrderSetPromotion.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderSetPromotionWorkflowMaster>

  <!-- 注文商品マスタ情報取得（ワークフロー・PDF出力用） -->
  <GetOrderItemWorkflowPdf>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]

        ;WITH TempTableForLimitedTimePoint AS
        (
          SELECT  ROW_NUMBER()
                  OVER
                  (
                    PARTITION BY user_id ORDER BY point_exp ASC
                  ) AS num,
                  w2_UserPoint.user_id,
                  w2_UserPoint.point,
                  w2_UserPoint.effective_date,
                  w2_UserPoint.point_exp
            FROM  w2_UserPoint
           WHERE  w2_UserPoint.point_kbn = '02'
        )
        SELECT  w2_Order.order_id,
                w2_Order.user_id,
                w2_Order.shop_id,
                w2_Order.supplier_id,
                w2_Order.order_kbn,
                w2_Order.mall_id,
                (CASE
                   WHEN w2_MallCooperationSetting.mall_kbn is null
                   THEN 'OWN_SITE'
                   ELSE w2_MallCooperationSetting.mall_kbn
                 END) AS mall_kbn,
                w2_Order.order_payment_kbn,
                w2_Payment.payment_name,
                w2_Order.order_status,
                w2_Order.order_date,
                w2_Order.order_recognition_date,
                w2_Order.order_stockreserved_status,
                w2_Order.order_stockreserved_date,
                w2_Order.order_shipping_date,
                w2_Order.order_shipped_status,
                w2_Order.order_shipped_date,
                w2_Order.order_delivering_date,
                w2_Order.order_cancel_date,
                w2_Order.order_payment_status,
                w2_Order.order_payment_date,
                w2_Order.demand_status,
                w2_Order.demand_date,
                w2_Order.order_item_count,
                w2_Order.order_product_count,
                w2_Order.order_price_subtotal,
                w2_Order.order_price_tax,
                w2_Order.order_price_subtotal_tax,
                w2_Order.order_price_shipping,
                w2_Order.order_price_exchange,
                w2_Order.order_price_regulation + CorrectionPriceInfo.correction_price_total as order_price_regulation,
                w2_Order.order_price_total,
                w2_Order.order_tax_rate,
                w2_Order.order_point_use,
                w2_Order.order_point_use_yen,
                w2_Order.order_point_add,
                w2_Order.order_coupon_use,
                w2_Order.card_kbn,
                w2_Order.card_tran_id,
                w2_Order.shipping_id,
                w2_Order.extend_status1,
                w2_Order.extend_status2,
                w2_Order.extend_status3,
                w2_Order.extend_status4,
                w2_Order.extend_status5,
                w2_Order.extend_status6,
                w2_Order.extend_status7,
                w2_Order.extend_status8,
                w2_Order.extend_status9,
                w2_Order.extend_status10,
                w2_Order.extend_status11,
                w2_Order.extend_status12,
                w2_Order.extend_status13,
                w2_Order.extend_status14,
                w2_Order.extend_status15,
                w2_Order.extend_status16,
                w2_Order.extend_status17,
                w2_Order.extend_status18,
                w2_Order.extend_status19,
                w2_Order.extend_status20,
                w2_Order.extend_status21,
                w2_Order.extend_status22,
                w2_Order.extend_status23,
                w2_Order.extend_status24,
                w2_Order.extend_status25,
                w2_Order.extend_status26,
                w2_Order.extend_status27,
                w2_Order.extend_status28,
                w2_Order.extend_status29,
                w2_Order.extend_status30,
                w2_Order.extend_status31,
                w2_Order.extend_status32,
                w2_Order.extend_status33,
                w2_Order.extend_status34,
                w2_Order.extend_status35,
                w2_Order.extend_status36,
                w2_Order.extend_status37,
                w2_Order.extend_status38,
                w2_Order.extend_status39,
                w2_Order.extend_status40,
                w2_Order.fixed_purchase_id,
                w2_Order.fixed_purchase_order_count,
                w2_Order.fixed_purchase_shipped_count,
                w2_Product.product_type,
                w2_Order.receipt_output_flg,
                w2_Order.order_discount_set_price,
                w2_ShopShipping.shop_shipping_name,
                w2_DeliveryCompany.shipping_time_id1,
                w2_DeliveryCompany.shipping_time_id2,
                w2_DeliveryCompany.shipping_time_id3,
                w2_DeliveryCompany.shipping_time_id4,
                w2_DeliveryCompany.shipping_time_id5,
                w2_DeliveryCompany.shipping_time_id6,
                w2_DeliveryCompany.shipping_time_id7,
                w2_DeliveryCompany.shipping_time_id8,
                w2_DeliveryCompany.shipping_time_id9,
                w2_DeliveryCompany.shipping_time_id10,
                w2_DeliveryCompany.shipping_time_message1,
                w2_DeliveryCompany.shipping_time_message2,
                w2_DeliveryCompany.shipping_time_message3,
                w2_DeliveryCompany.shipping_time_message4,
                w2_DeliveryCompany.shipping_time_message5,
                w2_DeliveryCompany.shipping_time_message6,
                w2_DeliveryCompany.shipping_time_message7,
                w2_DeliveryCompany.shipping_time_message8,
                w2_DeliveryCompany.shipping_time_message9,
                w2_DeliveryCompany.shipping_time_message10,
                w2_Order.payment_memo,
                w2_Order.management_memo,
                w2_Order.shipping_memo,
                w2_Order.relation_memo,
                w2_Order.memo,
                w2_Order.regulation_memo,
                w2_Order.attribute1,
                w2_Order.attribute2,
                w2_Order.attribute3,
                w2_Order.attribute4,
                w2_Order.attribute5,
                w2_Order.attribute6,
                w2_Order.attribute7,
                w2_Order.attribute8,
                w2_Order.attribute9,
                w2_Order.attribute10,
                w2_Order.date_created,
                w2_Order.date_changed,
                w2_Order.member_rank_discount_price,
                w2_Order.subscription_box_course_id,
                w2_Order.order_subscription_box_order_count,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_addr5,
                w2_OrderOwner.owner_addr_country_name,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_sex,
                w2_OrderOwner.owner_birth,
                w2_OrderOwner.disp_language_code,
                w2_OrderOwner.disp_language_locale_id,
                w2_OrderShipping.order_shipping_no,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_name1,
                w2_OrderShipping.shipping_name2,
                w2_OrderShipping.shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_addr5,
                w2_OrderShipping.shipping_country_name,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.another_shipping_flg,
                w2_OrderShipping.shipping_method,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_check_no,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderItem.order_item_no,
                (
                  SELECT  COUNT(order_id)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                   AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS order_item_rowcount,
                (
                  SELECT  MAX(w2_OrderItem.order_shipping_no)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                   --AND  w2_OrderItem.order_shipping_no = w2_OrderShipping.order_shipping_no
                   AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS shipping_no_max,
                (
                  SELECT  SUM(w2_OrderItem.item_price)
                    FROM  w2_OrderItem
                   WHERE  w2_OrderItem.order_id = w2_Order.order_id
                     AND  w2_OrderItem.order_shipping_no = w2_OrderShipping.order_shipping_no
                     AND  w2_OrderItem.order_history_display_type = 'VALID'
                ) AS product_total_price,
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id,
                w2_OrderItem.product_name,
                w2_OrderItem.product_name_kana,
                w2_OrderItem.product_price,
                w2_OrderItem.item_realstock_reserved,
                w2_OrderItem.item_realstock_shipped,
                w2_OrderItem.item_quantity,
                w2_OrderItem.item_price,
                w2_OrderItem.item_price_tax,
                w2_OrderItem.product_tax_rate,
                w2_OrderItem.download_url,
                w2_OrderItem.cooperation_id1,
                w2_OrderItem.cooperation_id2,
                w2_OrderItem.cooperation_id3,
                w2_OrderItem.cooperation_id4,
                w2_OrderItem.cooperation_id5,
                w2_OrderItem.cooperation_id6,
                w2_OrderItem.cooperation_id7,
                w2_OrderItem.cooperation_id8,
                w2_OrderItem.cooperation_id9,
                w2_OrderItem.cooperation_id10,
                w2_OrderItem.product_option_texts,
                w2_OrderItem.novelty_id,
                w2_OrderItem.item_discounted_price,
                w2_Order.gift_flg,
                w2_Order.digital_contents_flg,
                w2_OrderShipping.sender_name,
                w2_OrderShipping.sender_name1,
                w2_OrderShipping.sender_name2,
                w2_OrderShipping.sender_name_kana,
                w2_OrderShipping.sender_name_kana1,
                w2_OrderShipping.sender_name_kana2,
                w2_OrderShipping.sender_zip,
                w2_OrderShipping.sender_addr1,
                w2_OrderShipping.sender_addr2,
                w2_OrderShipping.sender_addr3,
                w2_OrderShipping.sender_addr4,
                w2_OrderShipping.sender_addr5,
                w2_OrderShipping.sender_country_name,
                w2_OrderShipping.sender_company_name,
                w2_OrderShipping.sender_company_post_name,
                w2_OrderShipping.sender_tel1,
                w2_OrderShipping.wrapping_paper_type,
                w2_OrderShipping.wrapping_paper_name,
                w2_OrderShipping.wrapping_bag_type,
                w2_FixedPurchase.fixed_purchase_id,
                w2_FixedPurchase.fixed_purchase_kbn,
                w2_FixedPurchase.fixed_purchase_setting1,
                w2_FixedPurchase.last_order_date,
                w2_FixedPurchase.order_count,
                w2_FixedPurchase.fixed_purchase_date_bgn,
                w2_FixedPurchase.next_shipping_date,
                w2_FixedPurchase.next_next_shipping_date,
                w2_FixedPurchase.fixed_purchase_management_memo,
                w2_FixedPurchase.next_shipping_use_point,
                w2_Product.name,
                w2_Product.product_type,
                w2_ProductVariation.mall_variation_id1,
                w2_ProductVariation.mall_variation_id2,
                (
                  SELECT  SUM(point)
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.user_id = w2_User.user_id
                     AND  w2_UserPoint.point_type = '01'
                ) AS user_point,
                (
                  SELECT SUM(point)
                    FROM w2_UserPoint
                   WHERE w2_UserPoint.user_id = w2_User.user_id
                     AND w2_UserPoint.point_type = '00'
                ) AS user_point_temp,
                w2_Order.setpromotion_product_discount_amount,
                w2_Order.setpromotion_shipping_charge_discount_amount,
                w2_Order.setpromotion_payment_charge_discount_amount,
                w2_OrderSetPromotion.setpromotion_name,
                w2_OrderSetPromotion.setpromotion_disp_name,
                w2_OrderSetPromotion.setpromotion_id,
                w2_User.user_memo,
                w2_Order.fixed_purchase_discount_price,
                w2_Order.fixed_purchase_member_discount_amount,
                w2_Order.receipt_address,
                w2_Order.receipt_proviso,
                 -- ↓軽減税率用↓
                ISNULL(PriceTotalByTax.[8.00], 0) AS price_total_8,
                ISNULL(PriceTotalByTax.[10.00], 0) AS price_total_10,
                ISNULL(TaxPriceByRate.[8.00], 0) AS tax_price_8,
                ISNULL(TaxPriceByRate.[10.00], 0) AS tax_price_10,
                -- ↑軽減税率用↑
                (
                  SELECT  COUNT(point)
                    FROM  w2_UserPoint
                   WHERE  w2_UserPoint.user_id = w2_User.user_id
                     AND  w2_UserPoint.point_kbn = '02'
                ) AS limited_time_point_count,
                LimitedTimePoint.limited_time_point1,
                LimitedTimePoint.limited_time_point2,
                LimitedTimePoint.limited_time_point3,
                LimitedTimePoint.limited_time_point4,
                LimitedTimePoint.limited_time_point5,
                LimitedTimePoint.limited_time_point6,
                LimitedTimePoint.limited_time_point7,
                LimitedTimePoint.limited_time_point8,
                LimitedTimePoint.limited_time_point9,
                LimitedTimePoint.limited_time_point10,
                LimitedTimePoint.limited_time_point_exp1,
                LimitedTimePoint.limited_time_point_exp2,
                LimitedTimePoint.limited_time_point_exp3,
                LimitedTimePoint.limited_time_point_exp4,
                LimitedTimePoint.limited_time_point_exp5,
                LimitedTimePoint.limited_time_point_exp6,
                LimitedTimePoint.limited_time_point_exp7,
                LimitedTimePoint.limited_time_point_exp8,
                LimitedTimePoint.limited_time_point_exp9,
                LimitedTimePoint.limited_time_point_exp10,
                LimitedTimePoint.effective_date1,
                LimitedTimePoint.effective_date2,
                LimitedTimePoint.effective_date3,
                LimitedTimePoint.effective_date4,
                LimitedTimePoint.effective_date5,
                LimitedTimePoint.effective_date6,
                LimitedTimePoint.effective_date7,
                LimitedTimePoint.effective_date8,
                LimitedTimePoint.effective_date9,
                LimitedTimePoint.effective_date10
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                  AND
                  w2_OrderItem.order_history_display_type = 'VALID'
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.shop_id = w2_MallCooperationSetting.shop_id
                  AND
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
                LEFT JOIN w2_ProductVariation ON
                (
                  w2_OrderItem.shop_id = w2_ProductVariation.shop_id 
                  AND
                  w2_OrderItem.product_id = w2_ProductVariation.product_id
                  AND
                  w2_OrderItem.variation_id = w2_ProductVariation.variation_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_DeliveryCompany ON
                (
                  w2_OrderShipping.delivery_company_id = w2_DeliveryCompany.delivery_company_id
                )
                INNER JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                price_total_by_rate,
                                key_tax_rate 
                          FROM  w2_OrderPriceByTaxRate
                        ) AS o
                   PIVOT (SUM(price_total_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS PriceTotalByTax
                ON
                (
                  w2_Order.order_id = PriceTotalByTax.order_id
                )
                INNER JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                tax_price_by_rate,
                                key_tax_rate 
                          FROM  w2_OrderPriceByTaxRate
                        ) AS o
                   PIVOT (SUM(tax_price_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS TaxPriceByRate
                ON
                (
                  w2_Order.order_id = TaxPriceByRate.order_id
                )
                INNER JOIN
                (
                  SELECT  order_id,
                          SUM(return_price_correction_by_rate) as correction_price_total
                    FROM  w2_OrderPriceByTaxRate
                GROUP BY  order_id
                ) AS CorrectionPriceInfo
                ON
                (
                  w2_Order.order_id = CorrectionPriceInfo.order_id
                )
                LEFT JOIN
                (
                  SELECT  DISTINCT user_id,
                          MAX(CASE num WHEN 1 THEN point END) limited_time_point1,
                          MAX(CASE num WHEN 1 THEN effective_date END) effective_date1,
                          MAX(CASE num WHEN 1 THEN point_exp END) limited_time_point_exp1,
                          MAX(CASE num WHEN 2 THEN point END) limited_time_point2,
                          MAX(CASE num WHEN 2 THEN effective_date END) effective_date2,
                          MAX(CASE num WHEN 2 THEN point_exp END) limited_time_point_exp2,
                          MAX(CASE num WHEN 3 THEN point END) limited_time_point3,
                          MAX(CASE num WHEN 3 THEN effective_date END) effective_date3,
                          MAX(CASE num WHEN 3 THEN point_exp END) limited_time_point_exp3,
                          MAX(CASE num WHEN 4 THEN point END) limited_time_point4,
                          MAX(CASE num WHEN 4 THEN effective_date END) effective_date4,
                          MAX(CASE num WHEN 4 THEN point_exp END) limited_time_point_exp4,
                          MAX(CASE num WHEN 5 THEN point END) limited_time_point5,
                          MAX(CASE num WHEN 5 THEN effective_date END) effective_date5,
                          MAX(CASE num WHEN 5 THEN point_exp END) limited_time_point_exp5,
                          MAX(CASE num WHEN 6 THEN point END) limited_time_point6,
                          MAX(CASE num WHEN 6 THEN effective_date END) effective_date6,
                          MAX(CASE num WHEN 6 THEN point_exp END) limited_time_point_exp6,
                          MAX(CASE num WHEN 7 THEN point END) limited_time_point7,
                          MAX(CASE num WHEN 7 THEN effective_date END) effective_date7,
                          MAX(CASE num WHEN 7 THEN point_exp END) limited_time_point_exp7,
                          MAX(CASE num WHEN 8 THEN point END) limited_time_point8,
                          MAX(CASE num WHEN 8 THEN effective_date END) effective_date8,
                          MAX(CASE num WHEN 8 THEN point_exp END) limited_time_point_exp8,
                          MAX(CASE num WHEN 9 THEN point END) limited_time_point9,
                          MAX(CASE num WHEN 9 THEN effective_date END) effective_date9,
                          MAX(CASE num WHEN 9 THEN point_exp END) limited_time_point_exp9,
                          MAX(CASE num WHEN 10 THEN point END) limited_time_point10,
                          MAX(CASE num WHEN 10 THEN effective_date END) effective_date10,
                          MAX(CASE num WHEN 10 THEN point_exp END) limited_time_point_exp10
                    FROM  TempTableForLimitedTimePoint
                GROUP BY  user_id
                ) AS LimitedTimePoint
                ON
                (
                  w2_Order.user_id = LimitedTimePoint.user_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemWorkflowPdf>

  <!-- 注文情報を取得 -->
  <GetOrder>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id as item_supplier_id,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                w2_OrderSetPromotion.*,
                RIGHT(w2_OrderItem.variation_id, LEN(w2_OrderItem.variation_id) - LEN(w2_OrderItem.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name,
                w2_Product.fixed_purchase_flg AS fixed_purchase_flg_product
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrder>

  <!-- 注文情報を取得 -->
  <GetOrderAndUserPoint>
    <Statement>
      <![CDATA[
        --注文情報
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderItem.supplier_id as item_supplier_id,
                w2_OrderSetPromotion.*,
                w2_OrderCoupon.*,
                w2_User.user_kbn,
                w2_ShopShipping.*,
                RIGHT(w2_OrderItem.variation_id, LEN(w2_OrderItem.variation_id) - LEN(w2_OrderItem.product_id)) AS v_id,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_MallCooperationSetting.mall_name
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )                
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_MallCooperationSetting ON
                (
                  w2_Order.mall_id = w2_MallCooperationSetting.mall_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_Order.order_id = @order_id
          
        -- ユーザーポイント情報
        SELECT  *
          FROM  w2_UserPoint
         WHERE  w2_UserPoint.user_id = @user_id
           AND  w2_UserPoint.kbn1 = @order_id
           AND  w2_UserPoint.point_type = '00'    -- 仮ポイント
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderAndUserPoint>

  <!-- 配送先情報を取得 -->
  <GetOrderShipping>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.*
          FROM  w2_OrderShipping
         WHERE  w2_OrderShipping.order_id = @order_id
        ORDER BY w2_OrderShipping.order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderShipping>

  <!-- 注文商品情報を取得 -->
  <GetOrderItem>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderItem.*,
                w2_Product.stock_management_kbn
          FROM  w2_OrderItem
                LEFT JOIN w2_Product ON
                (
                  w2_OrderItem.shop_id = w2_Product.shop_id
                  AND
                  w2_OrderItem.product_id = w2_Product.product_id
                )
         WHERE  w2_OrderItem.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderItem>

  <!-- 注文セットプロモーション情報を取得 -->
  <GetOrderSetPromotion>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderSetPromotion.*
          FROM  w2_OrderSetPromotion
         WHERE  w2_OrderSetPromotion.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderSetPromotion>

  <!-- 注文情報を取得（ステータス更新メール用） -->
  <GetSendOrderMail>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderOwner.*,
                w2_OrderShipping.*,
                w2_OrderItem.*,
                w2_OrderSetPromotion.*,
                w2_OrderCoupon.*,
                w2_ShopShipping.*,
                w2_Payment.payment_name,
                w2_ShopShipping.shop_shipping_name,
                w2_FixedPurchase.*,
                w2_User.*
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                  AND
                  w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetSendOrderMail>

  <!-- 注文情報に紐づくシリアルキーを取得（ステータス更新メール用） -->
  <GetSendOrderMail_SerialKey>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.*,
                w2_OrderItem.*,
                w2_SerialKey.*
          FROM  w2_Order
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                  --AND
                  --w2_OrderShipping.order_shipping_no = w2_OrderItem.order_shipping_no
                )
                INNER JOIN w2_SerialKey ON
                (
                  w2_OrderItem.order_id = w2_SerialKey.order_id
                  AND
                  w2_OrderItem.order_item_no = w2_SerialKey.order_item_no
                )
         WHERE  w2_Order.order_id = @order_id
           AND  w2_SerialKey.status = 'DELIVERED'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetSendOrderMail_SerialKey>

  <GetIDOnlyForOrderWorkflow>
    <Statement>
      <![CDATA[
        CREATE TABLE ##order_id
        (
          order_id nvarchar(30) NOT NULL
        )

        -- Insert data to table temp order_id
        INSERT  ##order_id
        SELECT  w2_Order.order_id
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
    <Parameter>
      <Input Name="sort_kbn" Type="int" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
      <Input Name="memo" Type="nvarchar" Size="1" />
      <Input Name="management_memo" Type="nvarchar" Size="1" />
      <Input Name="payment_memo" Type="nvarchar" Size="1" />
      <Input Name="relation_memo" Type="nvarchar" Size="1" />
      <Input Name="memo_like_escaped" Type="nvarchar" Size="max"/>
      <Input Name="management_memo_like_escaped" Type="nvarchar" Size="max"/>
      <Input Name="payment_memo_like_escaped" Type="nvarchar" Size="max"/>
      <Input Name="relation_memo_like_escaped" Type="nvarchar" Size="max"/>
    </Parameter>
  </GetIDOnlyForOrderWorkflow>

  <!-- 注文ステータス更新(注文済み) -->
  <UpdateOrderStatusComp>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order. order_status = 'ODR',  -- 注文済み
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusComp>

  <!-- 注文ステータス更新(注文承認) -->
  <UpdateOrderStatusConfirm>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR_RECG',  -- 受注承認
                w2_Order.order_recognition_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusConfirm>

  <!-- 注文ステータス更新(在庫引当済み) -->
  <UpdateOrderStatusReservedStock>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'STK_RSVD',  -- 在庫引当済み
                w2_Order.order_stockreserved_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusReservedStock>

  <!-- 注文ステータス更新(出荷手配済み) -->
  <UpdateOrderStatusShipping>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'SHP_ARGD',  -- 出荷手配済み
                w2_Order.order_shipping_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusShipping>

  <!-- 注文ステータス更新(出荷完了) -->
  <UpdateOrderStatusForwardComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'SHP_COMP',  -- 出荷完了
                w2_Order.order_shipped_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusForwardComplete>

  <!-- 注文ステータス更新(配送完了) -->
  <UpdateOrderStatusDelivering>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'DLV_COMP',  -- 配送完了
                w2_Order.order_delivering_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusDelivering>

  <!-- 注文ステータス更新(キャンセル) -->
  <UpdateOrderStatusCancel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR_CNSL',  -- キャンセル
                w2_Order.order_cancel_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
           AND  w2_Order.order_status <> 'ODR_CNSL'  -- キャンセルは対象外（二重キャンセル防止）
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusCancel>

  <!-- 購入回数更新(同梱により) -->
  <UpdateUserOrderCount>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_count_order = @order_count_order,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="order_count_order" Type="int" />
    </Parameter>
  </UpdateUserOrderCount>

  <!-- 注文ステータス更新(仮注文キャンセル) -->
  <UpdateOrderStatusTempOrderCancel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'TMP_CNSL',  -- 仮注文キャンセル
                w2_Order.order_cancel_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
           AND  w2_Order.order_status <> 'TMP_CNSL'  -- 仮注文キャンセルは対象外（二重キャンセル防止）
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStatusTempOrderCancel>

  <!-- 入金ステータス更新(入金確認待ち) -->
  <UpdateOrderPaymentStatusConfirm>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 0,  -- 入金確認待ち
                w2_Order.order_payment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusConfirm>

  <!-- 入金ステータス更新(入金済み) -->
  <UpdateOrderPaymentStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 1,  -- 入金済み
                w2_Order.order_payment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusComplete>

  <!-- 入金ステータス更新(一部入金) -->
  <UpdateOrderPaymentStatusShortage>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_payment_status = 2,  -- 一部入金
                w2_Order.order_payment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderPaymentStatusShortage>

  <!-- 督促ステータス更新(督促なし) -->
  <UpdateOrderDemandStatusUnKnown>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.demand_status = '0',        -- 督促ステータス
                w2_Order.demand_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderDemandStatusUnKnown>

  <!-- 督促ステータス更新(督促レベル1～) -->
  <UpdateOrderDemandStatusLevel>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.demand_status = @demand_status,  -- 督促ステータス
                w2_Order.demand_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="demand_status" Type="nvarchar" Size="1" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderDemandStatusLevel>

  <!-- 返品交換ステータス更新(返品交換受付) -->
  <UpdateOrderReturnExchangeStatusReceipt>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '01',  -- 返品交換受付
                w2_Order.order_return_exchange_receipt_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusReceipt>

  <!-- 返品交換ステータス更新(返品交換商品到着) -->
  <UpdateOrderReturnExchangeStatusArrival>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '02',  -- 返品交換商品到着
                w2_Order.order_return_exchange_arrival_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusArrival>

  <!-- 返品ステータス更新(返品交換完了) -->
  <UpdateOrderReturnExchangeStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_return_exchange_status = '03',  -- 返品交換完了
                w2_Order.order_return_exchange_complete_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
        WHERE   w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderReturnExchangeStatusComplete>

  <!-- 返金ステータス更新(返金無し) -->
  <UpdateOrderRepaymentStatusNoRepayment>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '01',  -- 返金無し
                w2_Order.order_repayment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusNoRepayment>

  <!-- 返金ステータス更新(未返金) -->
  <UpdateOrderRepaymentStatusConfrim>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '02',  -- 未返金
                w2_Order.order_repayment_date = null,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusConfrim>

  <!-- 返金ステータス更新(返金済み) -->
  <UpdateOrderRepaymentStatusComplete>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_repayment_status = '03',  -- 返金済み
                w2_Order.order_repayment_date = @update_date,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="update_date" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderRepaymentStatusComplete>

  <!-- 交換注文→通常注文に更新 -->
  <!-- ・注文ステータスを「指定無し」→「注文済み」
       ・注文日時を「更新日時」★更新日指定の日時ではない！
       ・入金ステータスを「指定無し」→「入金確認待ち」
       ・督促ステータスを「指定無し」→「督促なし」-->
  <UpdateOrderExchange>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_status = 'ODR',  -- 注文済み
                w2_Order.order_payment_status = '0', -- 入金確認待ち
                w2_Order.demand_status = '0', -- 督促なし
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderExchange>

  <!-- 注文商品情報の実在庫を引当済実在庫数更新 -->
  <UpdateItemRealStockReserved>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.item_realstock_reserved = w2_OrderItem.item_realstock_reserved + @item_realstock_reserved,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="item_realstock_reserved" Type="int" />
    </Parameter>
  </UpdateItemRealStockReserved>

  <!-- 在庫引当ステータス更新 -->
  <UpdateOrderStockReservedStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_stockreserved_status = @order_stockreserved_status,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_stockreserved_status" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderStockReservedStatus>

  <!-- 注文商品情報の実在庫を出荷済実在庫数更新 -->
  <UpdateItemRealStockShipped>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.item_realstock_shipped = w2_OrderItem.item_realstock_shipped + @item_realstock_shipped,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="item_realstock_shipped" Type="int" />
    </Parameter>
  </UpdateItemRealStockShipped>

  <!-- 在庫戻し済みフラグ更新 -->
  <UpdateItemStockReturnedFlag>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.stock_returned_flg = @stock_returned_flg,
                w2_OrderItem.date_changed = getdate()
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.order_item_no = @order_item_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="stock_returned_flg" Type="nvarchar" Size="1" />
    </Parameter>
  </UpdateItemStockReturnedFlag>

  <!-- 出荷ステータス更新 -->
  <UpdateOrderShippedStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.order_shipped_status = @order_shipped_status,
                w2_Order.last_changed = @last_changed,
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipped_status" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateOrderShippedStatus>

  <!-- 配送伝票番号更新 -->
  <UpdateOrderShippingCheckNo>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderShipping
           SET  shipping_check_no = @shipping_check_no
         WHERE  order_id = @order_id
           AND  order_shipping_no = @order_shipping_no
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shipping_check_no" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdateOrderShippingCheckNo>

  <!-- 元注文ID取得 -->
  <GetOrderIdOrg>
    <Statement>
      <![CDATA[
        SELECT  order_id_org
          FROM  w2_Order
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderIdOrg>

  <!-- 注文情報を取得(返品交換注文情報も含む) -->
  <GetRelatedOrder>
    <Statement>
      <![CDATA[
        SELECT  *
          FROM  w2_Order
         WHERE  (
                  order_id = @order_id_org
                  OR
                  (
                    order_id_org = @order_id_org
                    AND
                    order_id like @order_id_org_like_escaped + '%' ESCAPE '#'
                  )
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id_org" Type="nvarchar" Size="30" />
      <Input Name="order_id_org_like_escaped" Type="nvarchar" Size="120" />
    </Parameter>
  </GetRelatedOrder>

  <!-- 商品名称取得 -->
  <GetOrderItemTop1>
    <Statement>
      <![CDATA[
        SELECT  TOP 1
                product_name
          FROM  w2_OrderItem
         WHERE  order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderItemTop1>

  <!-- カセット表示用注文配送先取得-->
  <GetOrderShippingsForCassette>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_OrderShipping.order_id,
                w2_OrderShipping.order_shipping_no,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_addr5,
                w2_OrderShipping.shipping_country_name,
                w2_OrderShipping.shipping_country_iso_code,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_name1,
                w2_OrderShipping.shipping_name2,
                w2_OrderShipping.shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.shipping_check_no,
                w2_OrderShipping.wrapping_paper_type,
                w2_OrderShipping.wrapping_paper_name,
                w2_OrderShipping.wrapping_bag_type
          FROM  w2_OrderShipping
         WHERE  w2_OrderShipping.order_id IN (@@ params @@)
        ORDER BY  w2_OrderShipping.order_id, w2_OrderShipping.order_shipping_no
      ]]>
    </Statement>
  </GetOrderShippingsForCassette>

  <!-- カセット表示用注文商品取得 -->
  <GetOrderItemsForCassette>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_OrderItem.order_id,
                w2_OrderItem.order_item_no,
                w2_OrderItem.order_shipping_no,
                w2_OrderItem.product_id,
                w2_OrderItem.variation_id,
                w2_OrderItem.product_name,
                w2_OrderItem.product_price,
                w2_OrderItem.item_quantity,
                w2_OrderItem.item_price,
                w2_OrderItem.order_setpromotion_no,
                w2_OrderSetPromotion.setpromotion_name
          FROM  w2_OrderItem
                LEFT JOIN w2_OrderSetPromotion ON
                (
                  w2_OrderItem.order_id = w2_OrderSetPromotion.order_id
                  AND
                  w2_OrderItem.order_setpromotion_no = w2_OrderSetPromotion.order_setpromotion_no
                )
         WHERE  w2_OrderItem.order_id IN (@@ params @@)
           AND  w2_OrderItem.del_flg = '0'
      ORDER BY  w2_OrderItem.order_id, w2_OrderItem.order_shipping_no
      ]]>
    </Statement>
  </GetOrderItemsForCassette>

  <!-- 決済種別情報取得 -->
  <GetPayment>
    <Statement>
      <![CDATA[
        SELECT  w2_Payment.*
          FROM  w2_Payment,
                w2_PaymentPrice
         WHERE  w2_Payment.shop_id = @shop_id
           AND  w2_Payment.payment_id = @payment_id
           AND  w2_Payment.shop_id = w2_PaymentPrice.shop_id
           AND  w2_Payment.payment_id = w2_PaymentPrice.payment_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="payment_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetPayment>

  <!-- Get limited payments from paymentIds -->
  <GetLimitedPayments>
    <Statement>
      <![CDATA[
        SELECT  w2_Payment.*
          FROM  w2_Payment
         WHERE  w2_Payment.shop_id = @shop_id
           AND  w2_Payment.payment_id IN (@@ payment_ids @@)
           AND  w2_Payment.valid_flg = '1'
      ORDER BY  w2_Payment.display_order ASC, w2_Payment.payment_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetLimitedPayments>


  <!-- 商品情報取得(商品バリエーションID指定) -->
  <GetProductVariation>
    <Statement>
      <![CDATA[
        SELECT  w2_ProductView.*,
                RIGHT(w2_ProductView.variation_id, LEN(w2_ProductView.variation_id) - LEN(w2_ProductView.product_id)) AS v_id,
                w2_ShopShipping.shop_shipping_name,
                w2_ProductVariationView.variation_cooperation_id1,
                w2_ProductVariationView.variation_cooperation_id2,
                w2_ProductVariationView.variation_cooperation_id3,
                w2_ProductVariationView.variation_cooperation_id4,
                w2_ProductVariationView.variation_cooperation_id5,
                w2_ProductVariationView.variation_cooperation_id6,
                w2_ProductVariationView.variation_cooperation_id7,
                w2_ProductVariationView.variation_cooperation_id8,
                w2_ProductVariationView.variation_cooperation_id9,
                w2_ProductVariationView.variation_cooperation_id10,
                [[ MEMBER_RANK_PRICE_PRODUCTVARIATION ]],
                [[ CLOSED_MARKET_PRICE ]]
          FROM  w2_ProductView
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_ProductView.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_ProductView.shipping_type = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_ProductVariationView ON
                (
                  w2_ProductView.shop_id = w2_ProductVariationView.shop_id
                  AND
                  w2_ProductView.product_id = w2_ProductVariationView.product_id
                  AND
                  w2_ProductView.variation_id = w2_ProductVariationView.variation_id
                )
         WHERE  w2_ProductView.shop_id = @shop_id
           AND  w2_ProductView.product_id = @product_id
           AND  w2_ProductView.variation_id = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="productsale_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetProductVariation>

  <!-- 決済取引ID取得 -->
  <GetOrderCardTranId>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.card_tran_id
          FROM  w2_Order
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetOrderCardTranId>

  <!-- 注文情報追加処理 -->
  <OrderRegist>
    <Statement>
      <![CDATA[
      INSERT  w2_Order
          (
            w2_Order.order_id,
            w2_Order.user_id,
            w2_Order.shop_id,
            w2_Order.order_kbn,
            w2_Order.order_payment_kbn,
            w2_Order.order_status,
            w2_Order.order_date,
            w2_Order.order_stockreserved_status,
            w2_Order.order_shipped_status,
            w2_Order.order_item_count,
            w2_Order.order_product_count,
            w2_Order.order_price_subtotal,
            w2_Order.order_price_shipping,
            w2_Order.order_price_exchange,
            w2_Order.order_price_regulation,
            w2_Order.order_price_total,
            w2_Order.order_discount_set_price,
            w2_Order.order_point_use,
            w2_Order.order_point_use_yen,
            w2_Order.order_point_add,
            w2_Order.order_coupon_use,
            w2_Order.card_kbn,
            w2_Order.card_instruments,
            w2_Order.card_installments_code,
            w2_Order.advcode_first,
            w2_Order.advcode_new,
            w2_Order.career_id,
            w2_Order.remote_addr,
            w2_Order.shipping_id,
            w2_Order.memo,
            w2_Order.management_memo,
            w2_Order.regulation_memo,
            w2_Order.shipping_memo,
            w2_Order.date_created,
            w2_Order.date_changed,
            w2_Order.last_changed,
            w2_Order.member_rank_discount_price,
            w2_Order.member_rank_id,
            w2_Order.gift_flg,
            w2_Order.digital_contents_flg,
            w2_Order.shipping_price_separate_estimates_flg,
            w2_Order.order_tax_included_flg,
            w2_Order.order_tax_rate,
            w2_Order.order_tax_round_type,
            w2_Order.setpromotion_product_discount_amount,
            w2_Order.setpromotion_shipping_charge_discount_amount,
            w2_Order.setpromotion_payment_charge_discount_amount,
            w2_Order.payment_order_id,
            w2_Order.fixed_purchase_discount_price,
            w2_Order.fixed_purchase_member_discount_amount,
            w2_Order.last_billed_amount,
            w2_Order.last_order_point_use,
            w2_Order.last_order_point_use_yen,
            w2_Order.combined_org_order_ids,
            w2_Order.last_auth_flg,
            w2_Order.extend_status39,
            w2_Order.order_price_tax,
            w2_Order.order_price_subtotal_tax,
            w2_Order.settlement_currency,
            w2_Order.settlement_rate,
            w2_Order.settlement_amount,
            w2_Order.shipping_tax_rate,
            w2_Order.payment_tax_rate,
            w2_Order.order_count_order,
            w2_Order.invoice_bundle_flg,
            w2_Order.inflow_contents_id,
            w2_Order.inflow_contents_type,
            w2_Order.receipt_flg,
            w2_Order.receipt_address,
            w2_Order.receipt_proviso,
            w2_Order.external_payment_type,
            w2_Order.attribute1,
            w2_Order.attribute2,
            w2_Order.attribute3,
            w2_Order.attribute4,
            w2_Order.attribute5,
            w2_Order.attribute6,
            w2_Order.attribute7,
            w2_Order.attribute8,
            w2_Order.attribute9,
            w2_Order.attribute10,
            w2_Order.subscription_box_course_id,
            w2_Order.subscription_box_fixed_amount,
            w2_Order.order_subscription_box_order_count,
            w2_Order.storepickup_status
          )
      VALUES  (
            @order_id,
            @user_id,
            @shop_id,
            @order_kbn,
            @order_payment_kbn,
            @order_status,
            @order_date,
            '01',   -- 在庫未引当
            '01',   -- 未出荷
            @order_item_count,
            @order_product_count,
            @order_price_subtotal,
            @order_price_shipping,
            @order_price_exchange,
            @order_price_regulation,
            @order_price_total,
            @order_discount_set_price,
            @order_point_use,
            @order_point_use_yen,
            @order_point_add,
            @order_coupon_use,
            @card_kbn,
            @card_instruments,
            @card_installments_code,
            @advcode_first,
            @advcode_new,
            @career_id,
            @remote_addr,
            @shipping_id,
            @memo,
            @management_memo,
            @regulation_memo,
            @shipping_memo,
            @date_created,
            @date_changed,
            @last_changed,
            @member_rank_discount_price,
            @member_rank_id,
            @gift_flg,
            @digital_contents_flg,
            @shipping_price_separate_estimates_flg,
            @order_tax_included_flg,
            @order_tax_rate,
            @order_tax_round_type,
            @setpromotion_product_discount_amount,
            @setpromotion_shipping_charge_discount_amount,
            @setpromotion_payment_charge_discount_amount,
            @payment_order_id,
            @fixed_purchase_discount_price,
            @fixed_purchase_member_discount_amount,
            @last_billed_amount,
            @last_order_point_use,
            @last_order_point_use_yen,
            @combined_org_order_ids,
            @last_auth_flg,
            @extend_status39,
            @order_price_tax,
            @order_price_subtotal_tax,
            @settlement_currency,
            @settlement_rate,
            @settlement_amount,
            @shipping_tax_rate,
            @payment_tax_rate,
            @order_count_order,
            @invoice_bundle_flg,
            @inflow_contents_id,
            @inflow_contents_type,
            @receipt_flg,
            @receipt_address,
            @receipt_proviso,
            @external_payment_type,
            @attribute1,
            @attribute2,
            @attribute3,
            @attribute4,
            @attribute5,
            @attribute6,
            @attribute7,
            @attribute8,
            @attribute9,
            @attribute10,
            @subscription_box_course_id,
            @subscription_box_fixed_amount,
            @order_subscription_box_order_count,
            @storepickup_status
          )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="order_date" Type="datetime" />
      <Input Name="order_item_count" Type="int" />
      <Input Name="order_product_count" Type="int" />
      <Input Name="order_price_subtotal" Type="decimal" Size="18,3" />
      <Input Name="order_price_shipping" Type="decimal" Size="18,3" />
      <Input Name="order_price_exchange" Type="decimal" Size="18,3" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="order_discount_set_price" Type="decimal" Size="18,3" />
      <Input Name="order_point_use" Type="decimal" />
      <Input Name="order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="order_point_add" Type="decimal" />
      <Input Name="order_coupon_use" Type="decimal" Size="18,3" />
      <Input Name="card_kbn" Type="nvarchar" Size="30" />
      <Input Name="card_instruments" Type="nvarchar" Size="30" />
      <Input Name="card_installments_code" Type="nvarchar" Size="10" />
      <Input Name="advcode_first" Type="nvarchar" Size="30" />
      <Input Name="advcode_new" Type="nvarchar" Size="30" />
      <Input Name="career_id" Type="nvarchar" Size="10" />
      <Input Name="remote_addr" Type="nvarchar" Size="30" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="management_memo" Type="nvarchar" Size="MAX" />
      <Input Name="regulation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="shipping_memo" Type="nvarchar" Size="MAX" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="member_rank_discount_price" Type="decimal" Size="18,3" />
      <Input Name="member_rank_id" Type="nvarchar" Size="30" />
      <Input Name="gift_flg" Type="nvarchar" Size="2" />
      <Input Name="digital_contents_flg" Type="nvarchar" Size="2" />
      <Input Name="shipping_price_separate_estimates_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_rate" Type="decimal" />
      <Input Name="order_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="setpromotion_product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="setpromotion_payment_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="payment_order_id" Type="nvarchar" Size="50" />
      <Input Name="fixed_purchase_discount_price" Type="decimal" Size="18,3" />
      <Input Name="fixed_purchase_member_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="last_billed_amount" Type="decimal" Size="18,3" />
      <Input Name="last_order_point_use" Type="decimal" />
      <Input Name="last_order_point_use_yen" Type="decimal" Size="18,3" />
      <Input Name="combined_org_order_ids" Type="nvarchar" Size="MAX" />
      <Input Name="last_auth_flg" Type="nvarchar" Size="1" />
      <Input Name="extend_status39" Type="nvarchar" Size="10" />
      <Input Name="order_price_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_subtotal_tax" Type="decimal" Size="18,3" />
      <Input Name="settlement_currency" Type="nvarchar" Size="3" />
      <Input Name="settlement_rate" Type="decimal" Size="24,12" />
      <Input Name="settlement_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="payment_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="order_count_order" Type="int" />
      <Input Name="invoice_bundle_flg" Type="nvarchar" Size="1" />
      <Input Name="inflow_contents_id" Type="nvarchar" Size="30" />
      <Input Name="inflow_contents_type" Type="nvarchar" Size="20" />
      <Input Name="receipt_flg" Type="nvarchar" Size="1" />
      <Input Name="receipt_address" Type="nvarchar" Size="100" />
      <Input Name="receipt_proviso" Type="nvarchar" Size="100" />
      <Input Name="external_payment_type" Type="nvarchar" Size="20" />
      <Input Name="attribute1" Type="nvarchar" Size="100" />
      <Input Name="attribute2" Type="nvarchar" Size="100" />
      <Input Name="attribute3" Type="nvarchar" Size="100" />
      <Input Name="attribute4" Type="nvarchar" Size="100" />
      <Input Name="attribute5" Type="nvarchar" Size="100" />
      <Input Name="attribute6" Type="nvarchar" Size="100" />
      <Input Name="attribute7" Type="nvarchar" Size="100" />
      <Input Name="attribute8" Type="nvarchar" Size="100" />
      <Input Name="attribute9" Type="nvarchar" Size="100" />
      <Input Name="attribute10" Type="nvarchar" Size="100" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
      <Input Name="order_subscription_box_order_count" Type="int" />
      <Input Name="storepickup_status" Type="nvarchar" Size="30" />
    </Parameter>
  </OrderRegist>

  <!-- 注文者情報追加処理 -->
  <OrderOwnerRegist>
    <Statement>
      <![CDATA[
      INSERT  w2_OrderOwner
              (
                w2_OrderOwner.order_id,
                w2_OrderOwner.owner_kbn,
                w2_OrderOwner.owner_name,
                w2_OrderOwner.owner_name1,
                w2_OrderOwner.owner_name2,
                w2_OrderOwner.owner_name_kana,
                w2_OrderOwner.owner_name_kana1,
                w2_OrderOwner.owner_name_kana2,
                w2_OrderOwner.owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2,
                w2_OrderOwner.owner_zip,
                w2_OrderOwner.owner_addr1,
                w2_OrderOwner.owner_addr2,
                w2_OrderOwner.owner_addr3,
                w2_OrderOwner.owner_addr4,
                w2_OrderOwner.owner_company_name,
                w2_OrderOwner.owner_company_post_name,
                w2_OrderOwner.owner_tel1,
                w2_OrderOwner.owner_sex,
                w2_OrderOwner.owner_birth,
                w2_OrderOwner.date_created,
                w2_OrderOwner.date_changed,
                w2_OrderOwner.access_country_iso_code,
                w2_OrderOwner.disp_language_code,
                w2_OrderOwner.disp_language_locale_id,
                w2_OrderOwner.disp_currency_code,
                w2_OrderOwner.disp_currency_locale_id,
                w2_OrderOwner.owner_addr_country_iso_code,
                w2_OrderOwner.owner_addr_country_name,
                w2_OrderOwner.owner_addr5
              )
      VALUES  (
                @order_id,
                @owner_kbn,
                @owner_name,
                @owner_name1,
                @owner_name2,
                @owner_name_kana,
                @owner_name_kana1,
                @owner_name_kana2,
                @owner_mail_addr,
                @owner_mail_addr2,
                @owner_zip,
                @owner_addr1,
                @owner_addr2,
                @owner_addr3,
                @owner_addr4,
                @owner_company_name,
                @owner_company_post_name,
                @owner_tel1,
                CASE WHEN @owner_sex <> ''
                  THEN @owner_sex
                  ELSE 'UNKNOWN'
                  END,
                @owner_birth,
                @date_created,
                @date_changed,
                @access_country_iso_code,
                @disp_language_code,
                @disp_language_locale_id,
                @disp_currency_code,
                @disp_currency_locale_id,
                @owner_addr_country_iso_code,
                @owner_addr_country_name,
                @owner_addr5
              )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_name_kana" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana1" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana2" Type="nvarchar" Size="60" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_mail_addr2" Type="nvarchar" Size="256" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_company_name" Type="nvarchar" Size="50" />
      <Input Name="owner_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
      <Input Name="owner_sex" Type="nvarchar" Size="10" />
      <Input Name="owner_birth" Type="datetime" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="access_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="disp_language_code" Type="nvarchar" Size="4" />
      <Input Name="disp_language_locale_id" Type="nvarchar" Size="7" />
      <Input Name="disp_currency_code" Type="nvarchar" Size="4" />
      <Input Name="disp_currency_locale_id" Type="nvarchar" Size="7" />
      <Input Name="owner_addr_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="owner_addr_country_name" Type="nvarchar" Size="100" />
      <Input Name="owner_addr5" Type="nvarchar" Size="50" />
    </Parameter>
  </OrderOwnerRegist>

  <!-- 注文配送先情報追加処理 -->
  <OrderShippingRegist>
    <Statement>
      <![CDATA[
      INSERT  w2_OrderShipping
              (
                w2_OrderShipping.order_id,
                w2_OrderShipping.order_shipping_no,
                w2_OrderShipping.shipping_name,
                w2_OrderShipping.shipping_name1,
                w2_OrderShipping.shipping_name2,
                w2_OrderShipping.shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2,
                w2_OrderShipping.shipping_zip,
                w2_OrderShipping.shipping_addr1,
                w2_OrderShipping.shipping_addr2,
                w2_OrderShipping.shipping_addr3,
                w2_OrderShipping.shipping_addr4,
                w2_OrderShipping.shipping_company_name,
                w2_OrderShipping.shipping_company_post_name,
                w2_OrderShipping.shipping_tel1,
                w2_OrderShipping.sender_name,
                w2_OrderShipping.sender_name1,
                w2_OrderShipping.sender_name2,
                w2_OrderShipping.sender_name_kana,
                w2_OrderShipping.sender_name_kana1,
                w2_OrderShipping.sender_name_kana2,
                w2_OrderShipping.sender_zip,
                w2_OrderShipping.sender_addr1,
                w2_OrderShipping.sender_addr2,
                w2_OrderShipping.sender_addr3,
                w2_OrderShipping.sender_addr4,
                w2_OrderShipping.sender_company_name,
                w2_OrderShipping.sender_company_post_name,
                w2_OrderShipping.sender_tel1,
                w2_OrderShipping.shipping_date,
                w2_OrderShipping.shipping_time,
                w2_OrderShipping.wrapping_paper_type,
                w2_OrderShipping.wrapping_paper_name,
                w2_OrderShipping.wrapping_bag_type,
                w2_OrderShipping.date_created,
                w2_OrderShipping.date_changed,
                w2_OrderShipping.another_shipping_flg,
                w2_OrderShipping.shipping_method,
                w2_OrderShipping.delivery_company_id,
                w2_OrderShipping.shipping_country_iso_code,
                w2_OrderShipping.shipping_country_name,
                w2_OrderShipping.shipping_addr5,
                w2_OrderShipping.sender_country_iso_code,
                w2_OrderShipping.sender_country_name,
                w2_OrderShipping.sender_addr5,
                w2_OrderShipping.scheduled_shipping_date,
                w2_OrderShipping.shipping_receiving_store_flg,
                w2_OrderShipping.shipping_receiving_store_id,
                w2_OrderShipping.shipping_receiving_store_type,
                w2_OrderShipping.storepickup_real_shop_id
              )
      VALUES  (
                @order_id,
                @order_shipping_no,
                @shipping_name,
                @shipping_name1,
                @shipping_name2,
                @shipping_name_kana,
                @shipping_name_kana1,
                @shipping_name_kana2,
                @shipping_zip,
                @shipping_addr1,
                @shipping_addr2,
                @shipping_addr3,
                @shipping_addr4,
                @shipping_company_name,
                @shipping_company_post_name,
                @shipping_tel1,
                @sender_name,
                @sender_name1,
                @sender_name2,
                @sender_name_kana,
                @sender_name_kana1,
                @sender_name_kana2,
                @sender_zip,
                @sender_addr1,
                @sender_addr2,
                @sender_addr3,
                @sender_addr4,
                @sender_company_name,
                @sender_company_post_name,
                @sender_tel1,
                @shipping_date,
                @shipping_time,
                @wrapping_paper_type,
                @wrapping_paper_name,
                @wrapping_bag_type,
                @date_created,
                @date_changed,
                @another_shipping_flg,
                @shipping_method,
                @delivery_company_id,
                @shipping_country_iso_code,
                @shipping_country_name,
                @shipping_addr5,
                @sender_country_iso_code,
                @sender_country_name,
                @sender_addr5,
                @scheduled_shipping_date,
                @shipping_receiving_store_flg,
                @shipping_receiving_store_id,
                @shipping_receiving_store_type,
                @storepickup_real_shop_id
              )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_name_kana" Type="nvarchar" Size="60" />
      <Input Name="shipping_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="shipping_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="shipping_zip" Type="nvarchar" Size="8" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_name" Type="nvarchar" Size="50" />
      <Input Name="shipping_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="sender_name" Type="nvarchar" Size="40" />
      <Input Name="sender_name1" Type="nvarchar" Size="20" />
      <Input Name="sender_name2" Type="nvarchar" Size="20" />
      <Input Name="sender_name_kana" Type="nvarchar" Size="60" />
      <Input Name="sender_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="sender_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="sender_zip" Type="nvarchar" Size="8" />
      <Input Name="sender_addr1" Type="nvarchar" Size="50" />
      <Input Name="sender_addr2" Type="nvarchar" Size="50" />
      <Input Name="sender_addr3" Type="nvarchar" Size="50" />
      <Input Name="sender_addr4" Type="nvarchar" Size="50" />
      <Input Name="sender_company_name" Type="nvarchar" Size="50" />
      <Input Name="sender_company_post_name" Type="nvarchar" Size="50" />
      <Input Name="sender_tel1" Type="nvarchar" Size="16" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="wrapping_paper_type" Type="nvarchar" Size="50" />
      <Input Name="wrapping_paper_name" Type="nvarchar" Size="200" />
      <Input Name="wrapping_bag_type" Type="nvarchar" Size="50" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_method" Type="nvarchar" Size="10" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="shipping_country_name" Type="nvarchar" Size="100" />
      <Input Name="shipping_addr5" Type="nvarchar" Size="50" />
      <Input Name="sender_country_iso_code" Type="nvarchar" Size="3" />
      <Input Name="sender_country_name" Type="nvarchar" Size="100" />
      <Input Name="sender_addr5" Type="nvarchar" Size="50" />
      <Input Name="scheduled_shipping_date" Type="datetime" />
      <Input Name="shipping_receiving_store_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_receiving_store_id" Type="nvarchar" Size="20" />
      <Input Name="shipping_receiving_store_type" Type="nvarchar" Size="5" />
      <Input Name="storepickup_real_shop_id" Type="nvarchar" Size="30" />
    </Parameter>
  </OrderShippingRegist>

  <!-- 注文商品情報追加処理 -->
  <OrderItemRegist>
    <Statement>
      <![CDATA[
        INSERT w2_OrderItem
               (
                  w2_OrderItem.order_id,
                  w2_OrderItem.order_item_no,
                  w2_OrderItem.order_shipping_no,
                  w2_OrderItem.shop_id,
                  w2_OrderItem.product_id,
                  w2_OrderItem.variation_id,
                  w2_OrderItem.supplier_id,
                  w2_OrderItem.product_name,
                  w2_OrderItem.product_name_kana,
                  w2_OrderItem.product_price,
                  w2_OrderItem.product_price_org,
                  w2_OrderItem.product_tax_included_flg,
                  w2_OrderItem.product_tax_rate,
                  w2_OrderItem.product_tax_round_type,
                  w2_OrderItem.product_price_pretax,
                  w2_OrderItem.item_quantity,
                  w2_OrderItem.item_quantity_single,
                  w2_OrderItem.item_price,
                  w2_OrderItem.item_price_single,
                  w2_OrderItem.product_set_id,
                  w2_OrderItem.product_set_no,
                  w2_OrderItem.product_set_count,
                  w2_OrderItem.date_created,
                  w2_OrderItem.date_changed,
                  w2_OrderItem.product_option_texts,
                  w2_OrderItem.brand_id,
                  w2_OrderItem.download_url,
                  w2_OrderItem.productsale_id,
                  w2_OrderItem.cooperation_id1,
                  w2_OrderItem.cooperation_id2,
                  w2_OrderItem.cooperation_id3,
                  w2_OrderItem.cooperation_id4,
                  w2_OrderItem.cooperation_id5,
                  w2_OrderItem.cooperation_id6,
                  w2_OrderItem.cooperation_id7,
                  w2_OrderItem.cooperation_id8,
                  w2_OrderItem.cooperation_id9,
                  w2_OrderItem.cooperation_id10,
                  w2_OrderItem.order_setpromotion_no,
                  w2_OrderItem.order_setpromotion_item_no,
                  w2_OrderItem.novelty_id,
                  w2_OrderItem.fixed_purchase_product_flg,
                  w2_OrderItem.product_bundle_id,
                  w2_OrderItem.bundle_item_display_type,
                  w2_OrderItem.product_point,
                  w2_OrderItem.product_point_kbn,
                  w2_OrderItem.limited_payment_ids,
                  w2_OrderItem.plural_shipping_price_free_flg,
                  w2_OrderItem.shipping_size_kbn,
                  w2_OrderItem.item_price_tax,
                  w2_OrderItem.fixed_purchase_discount_value,
                  w2_OrderItem.fixed_purchase_discount_type,
                  w2_OrderItem.item_discounted_price,
                  w2_OrderItem.subscription_box_course_id,
                  w2_OrderItem.subscription_box_fixed_amount
                )
        VALUES  (
                  @order_id,
                  @order_item_no,
                  @order_shipping_no,
                  @shop_id,
                  @product_id,
                  @variation_id,
                  @supplier_id,
                  @product_name,
                  @product_name_kana,
                  @product_price,
                  @product_price_org,
                  @product_tax_included_flg,
                  @product_tax_rate,
                  @product_tax_round_type,
                  @product_price_pretax,
                  @item_quantity,
                  @item_quantity_single,
                  @item_price,
                  @item_price_single,
                  @product_set_id,
                  @product_set_no,
                  @product_set_count,
                  @date_created,
                  @date_changed,
                  @product_option_texts,
                  @brand_id,
                  @download_url,
                  @productsale_id,
                  @cooperation_id1,
                  @cooperation_id2,
                  @cooperation_id3,
                  @cooperation_id4,
                  @cooperation_id5,
                  @cooperation_id6,
                  @cooperation_id7,
                  @cooperation_id8,
                  @cooperation_id9,
                  @cooperation_id10,
                  @order_setpromotion_no,
                  @order_setpromotion_item_no,
                  @novelty_id,
                  @fixed_purchase_product_flg,
                  @product_bundle_id,
                  @bundle_item_display_type,
                  @product_point,
                  @product_point_kbn,
                  @limited_payment_ids,
                  @plural_shipping_price_free_flg,
                  @shipping_size_kbn,
                  @item_price_tax,
                  @fixed_purchase_discount_value,
                  @fixed_purchase_discount_type,
                  @item_discounted_price,
                  @subscription_box_course_id,
                  @subscription_box_fixed_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="order_shipping_no" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="supplier_id" Type="nvarchar" Size="20" />
      <Input Name="product_name" Type="nvarchar" Size="200" />
      <Input Name="product_name_kana" Type="nvarchar" Size="200" />
      <Input Name="product_price" Type="decimal" Size="18,3" />
      <Input Name="product_price_org" Type="decimal" Size="18,3" />
      <Input Name="product_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="product_tax_rate" Type="decimal" />
      <Input Name="product_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="product_price_pretax" Type="decimal" Size="18,3" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="item_quantity_single" Type="int" />
      <Input Name="item_price" Type="decimal" Size="18,3" />
      <Input Name="item_price_single" Type="decimal" Size="18,3" />
      <Input Name="product_set_id" Type="nvarchar" Size="30" />
      <Input Name="product_set_no" Type="int" />
      <Input Name="product_set_count" Type="int" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="date_changed" Type="datetime" />
      <Input Name="product_option_texts" Type="nvarchar" Size="max" />
      <Input Name="brand_id" Type="nvarchar" Size="30" />
      <Input Name="download_url" Type="nvarchar" Size="max" />
      <Input Name="productsale_id" Type="nvarchar" Size="10" />
      <Input Name="cooperation_id1" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id2" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id3" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id4" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id5" Type="nvarchar" Size="30" />
      <Input Name="cooperation_id6" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id7" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id8" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id9" Type="nvarchar" Size="50" />
      <Input Name="cooperation_id10" Type="nvarchar" Size="50" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="order_setpromotion_item_no" Type="int" />
      <Input Name="novelty_id" Type="nvarchar" Size="30" />
      <Input Name="fixed_purchase_product_flg" Type="nvarchar" Size="1" />
      <Input Name="product_bundle_id" Type="nvarchar" Size="30" />
      <Input Name="bundle_item_display_type" Type="nvarchar" Size="10" />
      <Input Name="product_point" Type="float" />
      <Input Name="product_point_kbn" Type="nvarchar" Size="1" />
      <Input Name="limited_payment_ids" Type="nvarchar" Size="250" />
      <Input Name="plural_shipping_price_free_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_size_kbn" Type="nvarchar" Size="4" />
      <Input Name="item_price_tax" Type="decimal" />
      <Input Name="fixed_purchase_discount_value" Type="decimal" />
      <Input Name="fixed_purchase_discount_type" Type="nvarchar" Size="10" />
      <Input Name="item_discounted_price" Type ="decimal" Size ="18,3" />
      <Input Name="subscription_box_course_id" Type="nvarchar" Size="30" />
      <Input Name="subscription_box_fixed_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </OrderItemRegist>

  <!-- 注文セットプロモーション情報追加処理 -->
  <InsertOrderSetPromotion>
    <Statement>
      <![CDATA[
        INSERT  w2_OrderSetPromotion
                (
                  order_id,
                  order_setpromotion_no,
                  setpromotion_id,
                  setpromotion_name,
                  setpromotion_disp_name,
                  undiscounted_product_subtotal,
                  product_discount_flg,
                  product_discount_amount,
                  shipping_charge_free_flg,
                  shipping_charge_discount_amount,
                  payment_charge_free_flg,
                  payment_charge_discount_amount
                )
        VALUES  (
                  @order_id,
                  @order_setpromotion_no,
                  @setpromotion_id,
                  @setpromotion_name,
                  @setpromotion_disp_name,
                  @undiscounted_product_subtotal,
                  @product_discount_flg,
                  @product_discount_amount,
                  @shipping_charge_free_flg,
                  @shipping_charge_discount_amount,
                  @payment_charge_free_flg,
                  @payment_charge_discount_amount
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_setpromotion_no" Type="int" />
      <Input Name="setpromotion_id" Type="nvarchar" Size="10" />
      <Input Name="setpromotion_name" Type="nvarchar" Size="30" />
      <Input Name="setpromotion_disp_name" Type="nvarchar" Size="30" />
      <Input Name="undiscounted_product_subtotal" Type="decimal" Size="18,3" />
      <Input Name="product_discount_flg" Type="nvarchar" Size="1" />
      <Input Name="product_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="shipping_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="shipping_charge_discount_amount" Type="decimal" Size="18,3" />
      <Input Name="payment_charge_free_flg" Type="nvarchar" Size="1" />
      <Input Name="payment_charge_discount_amount" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertOrderSetPromotion>

  <!-- 決済手数料取得 -->
  <GetPaymentPrice>
    <Statement>
      <![CDATA[
        SELECT  w2_Payment.shop_id,
                w2_Payment.payment_id,
                w2_Payment.payment_name,
                w2_Payment.payment_price_kbn,
                w2_PaymentPrice.*
          FROM  w2_Payment, w2_PaymentPrice
         WHERE  w2_Payment.shop_id = @shop_id
           AND  w2_Payment.payment_id = @payment_id
           AND  w2_Payment.shop_id = w2_PaymentPrice.shop_id
           AND  w2_Payment.payment_id = w2_PaymentPrice.payment_id
           AND
               (
                  w2_Payment.payment_price_kbn = '0'
                  OR
                  (
                    w2_Payment.payment_price_kbn = '1'
                    AND
                    w2_PaymentPrice.tgt_price_bgn <= @sub_total_price
                    AND
                    w2_PaymentPrice.tgt_price_end >= @sub_total_price
                  )
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="payment_id" Type="nvarchar" Size="3" />
      <Input Name="sub_total_price" Type="decimal" />
    </Parameter>
  </GetPaymentPrice>

  <!-- 注文情報削除 -->
  <DeleteOrder>
    <Statement>
      <![CDATA[
        DELETE  w2_Order
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrder>

  <!-- 注文者情報削除 -->
  <DeleteOrderOwner>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderOwner
         WHERE  w2_OrderOwner.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderOwner>

  <!-- 注文配送先情報削除 -->
  <DeleteOrderShipping>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderShipping
         WHERE  w2_OrderShipping.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderShipping>

  <!-- 注文商品情報削除 -->
  <DeleteOrderItem>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderItem
         WHERE  w2_OrderItem.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderItem>

  <!-- 税率毎価格情報削除 -->
  <DeleteOrderPriceByTaxRate>
    <Statement>
      <![CDATA[
        DELETE  w2_OrderPriceByTaxRate
         WHERE  w2_OrderPriceByTaxRate.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteOrderPriceByTaxRate>

  <!-- 決済種別情報一覧取得(店舗内有効なもの、配送種別で許可されているもの) -->
  <GetValidPaymentList>
    <Statement>
      <![CDATA[
        SELECT  w2_Payment.*
          FROM  w2_Payment
         WHERE  w2_Payment.shop_id = @shop_id
           AND  (
                  (((payment_id <> 'K90') AND ((@payment_selection_flg = '0') OR (payment_id IN (@@ payment_ids @@)))) OR (@cart_price_total = 0))
                  AND
                  ((usable_price_min IS NULL) OR (@cart_price_total >= usable_price_min))
                  AND
                  ((usable_price_max IS NULL) OR (@cart_price_total <= usable_price_max))
                  AND
                  ((@restrict_fixedpurchase_payment = '0') OR (payment_id IN (@@ can_fixedpurchase_payment_ids @@)))
                  AND
                  (payment_id NOT LIKE 'M%')
                )
           AND  w2_Payment.mobile_disp_flg IN ('0','1') -- PC&モバイル OR PCのみ
           AND  w2_Payment.valid_flg = '1'
      ORDER BY  w2_Payment.display_order ASC, w2_Payment.payment_id ASC           
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="cart_price_total" Type="decimal" />
      <Input Name="payment_selection_flg" Type="nvarchar" Size="1" />
      <Input Name="restrict_fixedpurchase_payment" Type="nvarchar" Size="1" />
    </Parameter>
  </GetValidPaymentList>

  <!-- 決済種別情報一覧取得(店舗内有効なもの、配送種別で許可されているもの、下限金額チェックなし) -->
  <GetValidPaymentListWithoutCheckUsablePriceMin>
    <Statement>
      <![CDATA[
        SELECT  w2_Payment.*
          FROM  w2_Payment
         WHERE  w2_Payment.shop_id = @shop_id
           AND  (
                  (((payment_id <> 'K90') AND ((@payment_selection_flg = '0') OR (payment_id IN (@@ payment_ids @@)))) OR (@cart_price_total = 0))
                  AND
                  ((usable_price_max IS NULL) OR (@cart_price_total <= usable_price_max))
                  AND
                  ((@restrict_fixedpurchase_payment = '0') OR (payment_id IN (@@ can_fixedpurchase_payment_ids @@)))
                  AND
                  (payment_id NOT LIKE 'M%')
                )
           AND  w2_Payment.mobile_disp_flg IN ('0','1') -- PC&モバイル OR PCのみ
           AND  w2_Payment.valid_flg = '1'
      ORDER BY  w2_Payment.display_order ASC, w2_Payment.payment_id ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="cart_price_total" Type="decimal" />
      <Input Name="payment_selection_flg" Type="nvarchar" Size="1" />
      <Input Name="restrict_fixedpurchase_payment" Type="nvarchar" Size="1" />
    </Parameter>
  </GetValidPaymentListWithoutCheckUsablePriceMin>

  <!-- Get all fixed purchase parent of order combine -->
  <GetParentOrderCombineFixedPurchase>
    <Statement>
    <![CDATA[
      DECLARE @returnListOrderIds TABLE
      (
        order_id NVARCHAR(30)
      )
      DECLARE @order_ids NVARCHAR(MAX)
      DECLARE @exclude_fixed_purchase_id NVARCHAR(30)
      DECLARE @order_id_parent NVARCHAR(30)
      DECLARE @index INT

      SELECT  @order_ids = w2_Order.combined_org_order_ids,
              @exclude_fixed_purchase_id = w2_Order.fixed_purchase_id
        FROM  w2_Order
       WHERE  w2_Order.order_id = @order_id
         AND  w2_Order.combined_org_order_ids <> ''

      WHILE CHARINDEX(',', @order_ids) > 0
      BEGIN
        SELECT @index  = CHARINDEX(',', @order_ids)  
        SELECT @order_id_parent = SUBSTRING(@order_ids, 1, @index - 1)

        INSERT @returnListOrderIds 
        SELECT @order_id_parent

        SET @order_ids = SUBSTRING(@order_ids, @index + 1, LEN(@order_ids) - @index)
      END

      IF (@order_ids <> '')
      BEGIN
        INSERT @returnListOrderIds
             SELECT  @order_ids
      END

      SELECT  w2_FixedPurchase.*
        FROM  w2_FixedPurchase
       WHERE  w2_FixedPurchase.fixed_purchase_id
          IN  (
                SELECT  w2_Order.fixed_purchase_id
                  FROM  w2_Order
                 WHERE  w2_Order.order_id IN (SELECT order_id FROM @returnListOrderIds)
                   AND  w2_Order.fixed_purchase_id <> ''
                   AND  w2_Order.fixed_purchase_id <> @exclude_fixed_purchase_id
               )
    ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetParentOrderCombineFixedPurchase>
  <!-- Get Data Export Shipping-->
  <GetDataExportShipping>
    <Statement>
      <![CDATA[ 
        SELECT  w2_Order.*,
                w2_OrderShipping.*,
                w2_OrderOwner.*,
                w2_OrderItem.*
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Payment WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN  w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDataExportShipping>
  <!-- Get Data Export Return-->
  <GetDataExportReturn>
    <Statement>
      <![CDATA[ 
        SELECT  w2_Order.*,
                w2_OrderShipping.*,
                w2_OrderOwner.*
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN  w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDataExportReturn>
  <!-- Get Data Export Return Order Work Flow -->
  <GetDataExportReturnOrderWorkFlow>
    <Statement>
      <![CDATA[ 
        SELECT  w2_Order.*,
                w2_OrderShipping.*,
                w2_OrderOwner.*
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN  w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDataExportReturnOrderWorkFlow>
  <!-- Get Data Export Shipping Order Work Flow -->
  <GetDataExportShippingOrderWorkFlow>
    <Statement>
      <![CDATA[ 
        SELECT  w2_Order.*,
                w2_OrderShipping.*,
                w2_OrderOwner.*,
                w2_OrderItem.*
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_OrderShipping.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Payment WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN  w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDataExportShippingOrderWorkFlow>

  <!-- Get Delivery Tran Id List -->
  <GetDeliveryTranIdList>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.delivery_tran_id
          FROM  w2_Order
                INNER JOIN w2_OrderShipping WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
       ]]>
    </Statement>
  </GetDeliveryTranIdList>

  <!-- Get Delivery Tran Id List Order Work Flow -->
  <GetDeliveryTranIdListOrderWorkFlow>
    <Statement>
      <![CDATA[
        SELECT  w2_Order.delivery_tran_id
          FROM  w2_Order
                INNER JOIN w2_OrderShipping WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_ShopShipping WITH (NOLOCK) ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
      ]]>
    </Statement>
  </GetDeliveryTranIdListOrderWorkFlow>

  <!-- 受注情報から入金データ一覧取得 -->
  <GetOrderItemMasterForDskDef>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDER_SEARCH_WHERE ]]
                  AND
                  (
                    w2_Order.order_payment_kbn = 'k91'
                  )
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                INNER JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemMasterForDskDef>

  <!-- 受注ワークフローから入金データ一覧取得 -->
  <GetOrderItemWorkflowMasterForDskDef>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
                  AND
                  (
                    w2_Order.order_payment_kbn = 'k91'
                  )
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                INNER JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                INNER JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemWorkflowMasterForDskDef>

  <!-- DSK後払い「債権保証あり」請求書用マスタ情報取得(CSV出力用) -->
  <GetOrderItemMasterForCreditDskDef>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
               INNER JOIN w2_InvoiceDskDeferred WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceDskDeferred.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_Order.order_payment_kbn = 'K32'
                )
                INNER JOIN 
                (
                  SELECT  order_id,
                          MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goodsName1,
                          MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goodsPrice1,
                          MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goodsNum1,
                          MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goodsName2,
                          MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goodsPrice2,
                          MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goodsNum2,
                          MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goodsName3,
                          MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goodsPrice3,
                          MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goodsNum3,
                          MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goodsName4,
                          MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goodsPrice4,
                          MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goodsNum4,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_name END), null) AS goodsName5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_price END), null) AS goodsPrice5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_num END), null) AS goodsNum5,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_name END), null) AS goodsName6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_price END), null) AS goodsPrice6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_num END), null) AS goodsNum6,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_name END), null) AS goodsName7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_price END), null) AS goodsPrice7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_num END), null) AS goodsNum7,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_name END), null) AS goodsName8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_price END), null) AS goodsPrice8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_num END), null) AS goodsNum8,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_name END), null) AS goodsName9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_price END), null) AS goodsPrice9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_num END), null) AS goodsNum9,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_name END), null) AS goodsName10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_price END), null) AS goodsPrice10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_num END), null) AS goodsNum10,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_name END), null) AS goodsName11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_price END), null) AS goodsPrice11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_num END), null) AS goodsNum11,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_name END), null) AS goodsName12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_price END), null) AS goodsPrice12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_num END), null) AS goodsNum12,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_name END), null) AS goodsName13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_price END), null) AS goodsPrice13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_num END), null) AS goodsNum13,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_name END), null) AS goodsName14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_price END), null) AS goodsPrice14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_num END), null) AS goodsNum14,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_name END), null) AS goodsName15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_price END), null) AS goodsPrice15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_num END), null) AS goodsNum15
                    FROM  w2_InvoiceDskDeferredDetail WITH (NOLOCK)
                  GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemMasterForCreditDskDef>

  <!-- 注文DSK後払い「債権保証あり」請求書マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMasterrForCreditDskDefInvoice>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_InvoiceDskDeferred WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceDskDeferred.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_Order.order_payment_kbn = 'K32'
                )
                INNER JOIN 
                (
                  SELECT  order_id,
                          MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goodsName1,
                          MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goodsPrice1,
                          MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goodsNum1,
                          MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goodsName2,
                          MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goodsPrice2,
                          MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goodsNum2,
                          MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goodsName3,
                          MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goodsPrice3,
                          MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goodsNum3,
                          MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goodsName4,
                          MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goodsPrice4,
                          MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goodsNum4,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_name END), null) AS goodsName5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_price END), null) AS goodsPrice5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_num END), null) AS goodsNum5,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_name END), null) AS goodsName6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_price END), null) AS goodsPrice6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_num END), null) AS goodsNum6,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_name END), null) AS goodsName7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_price END), null) AS goodsPrice7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_num END), null) AS goodsNum7,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_name END), null) AS goodsName8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_price END), null) AS goodsPrice8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_num END), null) AS goodsNum8,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_name END), null) AS goodsName9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_price END), null) AS goodsPrice9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_num END), null) AS goodsNum9,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_name END), null) AS goodsName10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_price END), null) AS goodsPrice10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_num END), null) AS goodsNum10,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_name END), null) AS goodsName11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_price END), null) AS goodsPrice11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_num END), null) AS goodsNum11,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_name END), null) AS goodsName12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_price END), null) AS goodsPrice12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_num END), null) AS goodsNum12,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_name END), null) AS goodsName13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_price END), null) AS goodsPrice13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_num END), null) AS goodsNum13,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_name END), null) AS goodsName14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_price END), null) AS goodsPrice14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_num END), null) AS goodsNum14,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_name END), null) AS goodsName15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_price END), null) AS goodsPrice15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_num END), null) AS goodsNum15
                    FROM  w2_InvoiceDskDeferredDetail WITH (NOLOCK)
                  GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMasterrForCreditDskDefInvoice>

  <!-- スコア後払い請求書用マスタ情報取得(CSV出力用) -->
  <GetOrderItemMasterScoreInvoice>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
               INNER JOIN w2_InvoiceScore WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceScore.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_Order.order_payment_kbn = 'K32'
                )
                INNER JOIN 
                (
                  SELECT  order_id,
                          MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goodsName1,
                          MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goodsPrice1,
                          MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goodsNum1,
                          MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goodsName2,
                          MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goodsPrice2,
                          MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goodsNum2,
                          MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goodsName3,
                          MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goodsPrice3,
                          MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goodsNum3,
                          MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goodsName4,
                          MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goodsPrice4,
                          MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goodsNum4,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_name END), null) AS goodsName5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_price END), null) AS goodsPrice5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_num END), null) AS goodsNum5,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_name END), null) AS goodsName6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_price END), null) AS goodsPrice6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_num END), null) AS goodsNum6,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_name END), null) AS goodsName7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_price END), null) AS goodsPrice7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_num END), null) AS goodsNum7,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_name END), null) AS goodsName8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_price END), null) AS goodsPrice8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_num END), null) AS goodsNum8,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_name END), null) AS goodsName9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_price END), null) AS goodsPrice9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_num END), null) AS goodsNum9,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_name END), null) AS goodsName10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_price END), null) AS goodsPrice10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_num END), null) AS goodsNum10,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_name END), null) AS goodsName11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_price END), null) AS goodsPrice11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_num END), null) AS goodsNum11,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_name END), null) AS goodsName12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_price END), null) AS goodsPrice12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_num END), null) AS goodsNum12,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_name END), null) AS goodsName13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_price END), null) AS goodsPrice13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_num END), null) AS goodsNum13,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_name END), null) AS goodsName14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_price END), null) AS goodsPrice14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_num END), null) AS goodsNum14,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_name END), null) AS goodsName15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_price END), null) AS goodsPrice15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_num END), null) AS goodsNum15
                    FROM  w2_InvoiceScoreDetail WITH (NOLOCK)
                  GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderItemMasterScoreInvoice>

  <!-- 注文スコア後払い請求書マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMasterScoreInvoice>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_InvoiceScore WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceScore.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_Order.order_payment_kbn = 'K32'
                )
                INNER JOIN 
                (
                  SELECT  order_id,
                          MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goodsName1,
                          MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goodsPrice1,
                          MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goodsNum1,
                          MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goodsName2,
                          MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goodsPrice2,
                          MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goodsNum2,
                          MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goodsName3,
                          MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goodsPrice3,
                          MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goodsNum3,
                          MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goodsName4,
                          MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goodsPrice4,
                          MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goodsNum4,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_name END), null) AS goodsName5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_price END), null) AS goodsPrice5,
                          ISNULL(MAX(CASE detail_no WHEN 5 THEN goods_num END), null) AS goodsNum5,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_name END), null) AS goodsName6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_price END), null) AS goodsPrice6,
                          ISNULL(MAX(CASE detail_no WHEN 6 THEN goods_num END), null) AS goodsNum6,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_name END), null) AS goodsName7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_price END), null) AS goodsPrice7,
                          ISNULL(MAX(CASE detail_no WHEN 7 THEN goods_num END), null) AS goodsNum7,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_name END), null) AS goodsName8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_price END), null) AS goodsPrice8,
                          ISNULL(MAX(CASE detail_no WHEN 8 THEN goods_num END), null) AS goodsNum8,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_name END), null) AS goodsName9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_price END), null) AS goodsPrice9,
                          ISNULL(MAX(CASE detail_no WHEN 9 THEN goods_num END), null) AS goodsNum9,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_name END), null) AS goodsName10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_price END), null) AS goodsPrice10,
                          ISNULL(MAX(CASE detail_no WHEN 10 THEN goods_num END), null) AS goodsNum10,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_name END), null) AS goodsName11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_price END), null) AS goodsPrice11,
                          ISNULL(MAX(CASE detail_no WHEN 11 THEN goods_num END), null) AS goodsNum11,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_name END), null) AS goodsName12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_price END), null) AS goodsPrice12,
                          ISNULL(MAX(CASE detail_no WHEN 12 THEN goods_num END), null) AS goodsNum12,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_name END), null) AS goodsName13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_price END), null) AS goodsPrice13,
                          ISNULL(MAX(CASE detail_no WHEN 13 THEN goods_num END), null) AS goodsNum13,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_name END), null) AS goodsName14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_price END), null) AS goodsPrice14,
                          ISNULL(MAX(CASE detail_no WHEN 14 THEN goods_num END), null) AS goodsNum14,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_name END), null) AS goodsName15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_price END), null) AS goodsPrice15,
                          ISNULL(MAX(CASE detail_no WHEN 15 THEN goods_num END), null) AS goodsNum15
                    FROM  w2_InvoiceScoreDetail WITH (NOLOCK)
                  GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMasterScoreInvoice>

  <!-- Get order for import shipping -->
  <GetOrderForImportShipping>
    <Statement>
      <![CDATA[
        SELECT  w2_OrderShipping.order_id,
                w2_OrderShipping.order_shipping_no
                @@ select @@
          FROM  w2_Order
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
         WHERE  w2_Order.order_date >= @order_date_from
                @@ where @@
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_date_from" Type="datetime" />
    </Parameter>
  </GetOrderForImportShipping>

  <!-- Get order master WMS -->
  <GetOrderMasterWMS>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:user_memo,user_management_level_id,mail_flg@@>
                INNER JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                </@@hasval:user_memo,user_management_level_id,mail_flg@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice WITH (NOLOCK) ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_InvoiceAtobaraicom ON
                (
                  w2_Order.order_id = w2_InvoiceAtobaraicom.order_id
                )
                LEFT JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                price_total_by_rate,
                                key_tax_rate
                          FROM  w2_OrderPriceByTaxRate
                        ) AS object
                   PIVOT (SUM(price_total_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS PriceTotalByTax
                ON
                (
                  w2_Order.order_id = PriceTotalByTax.order_id
                )
                LEFT JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                tax_price_by_rate,
                                key_tax_rate
                          FROM  w2_OrderPriceByTaxRate
                        ) AS object
                   PIVOT (SUM(tax_price_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS TaxPriceByRate
                ON
                (
                  w2_Order.order_id = TaxPriceByRate.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderMasterWMS>

  <!-- Get order workflow master WMS -->
  <GetOrderWorkflowMasterWMS>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                INNER JOIN w2_OrderItem ON
                (
                  w2_Order.order_id = w2_OrderItem.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                LEFT JOIN w2_InvoiceAtobaraicom ON
                (
                  w2_Order.order_id = w2_InvoiceAtobaraicom.order_id
                )
                LEFT JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                price_total_by_rate,
                                key_tax_rate
                          FROM  w2_OrderPriceByTaxRate
                        ) AS object
                   PIVOT (SUM(price_total_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS PriceTotalByTax
                ON
                (
                  w2_Order.order_id = PriceTotalByTax.order_id
                )
                LEFT JOIN
                (
                  SELECT  *
                    FROM
                        (
                        SELECT  order_id,
                                tax_price_by_rate,
                                key_tax_rate
                          FROM  w2_OrderPriceByTaxRate
                        ) AS object
                   PIVOT (SUM(tax_price_by_rate) FOR key_tax_rate IN ([8.00], [10.00])) AS pvsub
                ) AS TaxPriceByRate
                ON
                (
                  w2_Order.order_id = TaxPriceByRate.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMasterWMS>

  <!-- 注文ベリトランス請求書用マスタ情報取得(CSV出力用) -->
  <GetOrderMasterVeritransInvoice>
    <Statement>
      <![CDATA[ 
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                <@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                </@@hasval:owner_name_like_escaped,owner_name_kana_like_escaped,owner_mail_addr_like_escaped,owner_zip_like_escaped,owner_addr_like_escaped,owner_tel1_like_escaped,owner_kbn,owner_company_name_like_escaped@@>
                <@@hasval:tw_invoice_no,tw_invoice_status@@>
                LEFT JOIN w2_TwOrderInvoice ON
                (
                  w2_Order.order_id = w2_TwOrderInvoice.order_id
                )
                </@@hasval:tw_invoice_no,tw_invoice_status@@>
                [[ ORDER_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                INNER JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_InvoiceVeritrans (NOLOCK) ON
                (
                  w2_Order.order_id = w2_InvoiceVeritrans.order_id AND w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_order.order_payment_kbn = 'K32'
                )
                INNER JOIN
                (
                   SELECT  order_id,
                           MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goods_name1,
                           MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goods_price1,
                           MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goods_num1,
                           MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goods_name2,
                           MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goods_price2,
                           MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goods_num2,
                           MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goods_name3,
                           MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goods_price3,
                           MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goods_num3,
                           MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goods_name4,
                           MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goods_price4,
                           MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goods_num4,
                           MAX(CASE detail_no WHEN 5 THEN goods_name END) AS goods_name5,
                           MAX(CASE detail_no WHEN 5 THEN goods_price END) AS goods_price5,
                           MAX(CASE detail_no WHEN 5 THEN goods_num END) AS goods_num5,
                           MAX(CASE detail_no WHEN 6 THEN goods_name END) AS goods_name6,
                           MAX(CASE detail_no WHEN 6 THEN goods_price END) AS goods_price6,
                           MAX(CASE detail_no WHEN 6 THEN goods_num END) AS goods_num6,
                           MAX(CASE detail_no WHEN 7 THEN goods_name END) AS goods_name7,
                           MAX(CASE detail_no WHEN 7 THEN goods_price END) AS goods_price7,
                           MAX(CASE detail_no WHEN 7 THEN goods_num END) AS goods_num7,
                           MAX(CASE detail_no WHEN 8 THEN goods_name END) AS goods_name8,
                           MAX(CASE detail_no WHEN 8 THEN goods_price END) AS goods_price8,
                           MAX(CASE detail_no WHEN 8 THEN goods_num END) AS goods_num8,
                           MAX(CASE detail_no WHEN 9 THEN goods_name END) AS goods_name9,
                           MAX(CASE detail_no WHEN 9 THEN goods_price END) AS goods_price9,
                           MAX(CASE detail_no WHEN 9 THEN goods_num END) AS goods_num9,
                           MAX(CASE detail_no WHEN 10 THEN goods_name END) AS goods_name10,
                           MAX(CASE detail_no WHEN 10 THEN goods_price END) AS goods_price10,
                           MAX(CASE detail_no WHEN 10 THEN goods_num END) AS goods_num10,
                           MAX(CASE detail_no WHEN 11 THEN goods_name END) AS goods_name11,
                           MAX(CASE detail_no WHEN 11 THEN goods_price END) AS goods_price11,
                           MAX(CASE detail_no WHEN 11 THEN goods_num END) AS goods_num11,
                           MAX(CASE detail_no WHEN 12 THEN goods_name END) AS goods_name12,
                           MAX(CASE detail_no WHEN 12 THEN goods_price END) AS goods_price12,
                           MAX(CASE detail_no WHEN 12 THEN goods_num END) AS goods_num12,
                           MAX(CASE detail_no WHEN 13 THEN goods_name END) AS goods_name13,
                           MAX(CASE detail_no WHEN 13 THEN goods_price END) AS goods_price13,
                           MAX(CASE detail_no WHEN 13 THEN goods_num END) AS goods_num13,
                           MAX(CASE detail_no WHEN 14 THEN goods_name END) AS goods_name14,
                           MAX(CASE detail_no WHEN 14 THEN goods_price END) AS goods_price14,
                           MAX(CASE detail_no WHEN 14 THEN goods_num END) AS goods_num14,
                           MAX(CASE detail_no WHEN 15 THEN goods_name END) AS goods_name15,
                           MAX(CASE detail_no WHEN 15 THEN goods_price END) AS goods_price15,
                           MAX(CASE detail_no WHEN 15 THEN goods_num END) AS goods_num15
                     FROM  w2_InvoiceVeritransDetail
                   GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderMasterVeritransInvoice>

  <!-- 注文Veritrans請求書マスタ情報取得（ワークフロー・CSV出力用） -->
  <GetOrderWorkflowMasterVeritransInvoice>
    <Statement>
      <![CDATA[
        /* ダーティリードを許可して共有ロックを掛けなくする */
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
        
        SELECT  w2_Order.order_id
          INTO  #TempTable
          FROM  w2_Order
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                [[ ORDERWORKFLOW_SEARCH_WHERE ]]
        
        SELECT  @@ fields @@
          FROM  #TempTable
                INNER JOIN w2_Order ON
                (
                  w2_Order.order_id = #TempTable.order_id
                )
                INNER JOIN w2_OrderOwner ON
                (
                  w2_Order.order_id = w2_OrderOwner.order_id
                )
                INNER JOIN w2_OrderShipping ON
                (
                  w2_Order.order_id = w2_OrderShipping.order_id
                )
                LEFT JOIN w2_OrderCoupon ON
                (
                  w2_Order.order_id = w2_OrderCoupon.order_id
                )
                LEFT JOIN w2_Payment ON
                (
                  w2_Order.shop_id = w2_Payment.shop_id
                  AND
                  w2_Order.order_payment_kbn = w2_Payment.payment_id
                )
                LEFT JOIN w2_ShopShipping ON
                (
                  w2_Order.shop_id = w2_ShopShipping.shop_id
                  AND
                  w2_Order.shipping_id = w2_ShopShipping.shipping_id
                )
                LEFT JOIN w2_User ON
                (
                  w2_Order.user_id = w2_User.user_id
                )
                LEFT JOIN w2_FixedPurchase ON
                (
                  w2_Order.fixed_purchase_id = w2_FixedPurchase.fixed_purchase_id
                )
                INNER JOIN w2_InvoiceVeritrans ON
                (
                  w2_Order.order_id = w2_InvoiceVeritrans.order_id
                  AND
                  w2_Order.invoice_bundle_flg = '1'
                  AND
                  w2_order.order_payment_kbn = 'K32'
                )
                INNER JOIN
                (
                   SELECT  order_id,
                           MAX(CASE detail_no WHEN 1 THEN goods_name END) AS goods_name1,
                           MAX(CASE detail_no WHEN 1 THEN goods_price END) AS goods_price1,
                           MAX(CASE detail_no WHEN 1 THEN goods_num END) AS goods_num1,
                           MAX(CASE detail_no WHEN 2 THEN goods_name END) AS goods_name2,
                           MAX(CASE detail_no WHEN 2 THEN goods_price END) AS goods_price2,
                           MAX(CASE detail_no WHEN 2 THEN goods_num END) AS goods_num2,
                           MAX(CASE detail_no WHEN 3 THEN goods_name END) AS goods_name3,
                           MAX(CASE detail_no WHEN 3 THEN goods_price END) AS goods_price3,
                           MAX(CASE detail_no WHEN 3 THEN goods_num END) AS goods_num3,
                           MAX(CASE detail_no WHEN 4 THEN goods_name END) AS goods_name4,
                           MAX(CASE detail_no WHEN 4 THEN goods_price END) AS goods_price4,
                           MAX(CASE detail_no WHEN 4 THEN goods_num END) AS goods_num4,
                           MAX(CASE detail_no WHEN 5 THEN goods_name END) AS goods_name5,
                           MAX(CASE detail_no WHEN 5 THEN goods_price END) AS goods_price5,
                           MAX(CASE detail_no WHEN 5 THEN goods_num END) AS goods_num5,
                           MAX(CASE detail_no WHEN 6 THEN goods_name END) AS goods_name6,
                           MAX(CASE detail_no WHEN 6 THEN goods_price END) AS goods_price6,
                           MAX(CASE detail_no WHEN 6 THEN goods_num END) AS goods_num6,
                           MAX(CASE detail_no WHEN 7 THEN goods_name END) AS goods_name7,
                           MAX(CASE detail_no WHEN 7 THEN goods_price END) AS goods_price7,
                           MAX(CASE detail_no WHEN 7 THEN goods_num END) AS goods_num7,
                           MAX(CASE detail_no WHEN 8 THEN goods_name END) AS goods_name8,
                           MAX(CASE detail_no WHEN 8 THEN goods_price END) AS goods_price8,
                           MAX(CASE detail_no WHEN 8 THEN goods_num END) AS goods_num8,
                           MAX(CASE detail_no WHEN 9 THEN goods_name END) AS goods_name9,
                           MAX(CASE detail_no WHEN 9 THEN goods_price END) AS goods_price9,
                           MAX(CASE detail_no WHEN 9 THEN goods_num END) AS goods_num9,
                           MAX(CASE detail_no WHEN 10 THEN goods_name END) AS goods_name10,
                           MAX(CASE detail_no WHEN 10 THEN goods_price END) AS goods_price10,
                           MAX(CASE detail_no WHEN 10 THEN goods_num END) AS goods_num10,
                           MAX(CASE detail_no WHEN 11 THEN goods_name END) AS goods_name11,
                           MAX(CASE detail_no WHEN 11 THEN goods_price END) AS goods_price11,
                           MAX(CASE detail_no WHEN 11 THEN goods_num END) AS goods_num11,
                           MAX(CASE detail_no WHEN 12 THEN goods_name END) AS goods_name12,
                           MAX(CASE detail_no WHEN 12 THEN goods_price END) AS goods_price12,
                           MAX(CASE detail_no WHEN 12 THEN goods_num END) AS goods_num12,
                           MAX(CASE detail_no WHEN 13 THEN goods_name END) AS goods_name13,
                           MAX(CASE detail_no WHEN 13 THEN goods_price END) AS goods_price13,
                           MAX(CASE detail_no WHEN 13 THEN goods_num END) AS goods_num13,
                           MAX(CASE detail_no WHEN 14 THEN goods_name END) AS goods_name14,
                           MAX(CASE detail_no WHEN 14 THEN goods_price END) AS goods_price14,
                           MAX(CASE detail_no WHEN 14 THEN goods_num END) AS goods_num14,
                           MAX(CASE detail_no WHEN 15 THEN goods_name END) AS goods_name15,
                           MAX(CASE detail_no WHEN 15 THEN goods_price END) AS goods_price15,
                           MAX(CASE detail_no WHEN 15 THEN goods_num END) AS goods_num15
                     FROM  w2_InvoiceVeritransDetail
                   GROUP BY order_id
                ) InvoiceDetail ON
                (
                  w2_Order.order_id = InvoiceDetail.order_id
                )
                @@ orderby @@
      ]]>
    </Statement>
  </GetOrderWorkflowMasterVeritransInvoice>
</Order>
