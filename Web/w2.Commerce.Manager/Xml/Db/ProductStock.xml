<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 商品在庫系SQLステートメントXML(ProductStock.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<ProductStock>
  <!-- 商品在庫情報取得 -->
  <GetProductStockList>
    <Statement>
      <![CDATA[
        -- 該当情報取得
        SELECT  w2_ProductView.product_id,
                w2_ProductView.variation_id,
                RIGHT(w2_ProductView.variation_id, LEN(w2_ProductView.variation_id) - LEN(w2_ProductView.product_id)) AS v_id,
                w2_ProductView.name,
                w2_ProductView.variation_name1,
                w2_ProductView.variation_name2,
                w2_ProductView.variation_name3,
                w2_ProductView.use_variation_flg,
                w2_ProductView.stock,
                w2_ProductView.realstock,
                w2_ProductView.realstock_b,
                w2_ProductView.realstock_c,
                w2_ProductView.realstock_reserved,
                w2_ProductView.stock_alert,
                w2_ProductView.date_created,
                w2_ProductView.date_changed
          FROM  (
                  SELECT  w2_ProductView.shop_id,
                          w2_ProductView.product_id,
                          w2_ProductView.variation_id,
                          ROW_NUMBER()
                          OVER
                          (
                            [[ PRODUCTSTOCK_SEARCH_ORDER_BY ]]
                          ) AS row_num
                    FROM  w2_ProductView
                          [[ PRODUCTSTOCK_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_ProductView ON
                (
                  RowIndex.shop_id = w2_ProductView.shop_id
                  AND
                  RowIndex.product_id = w2_ProductView.product_id
                  AND
                  RowIndex.variation_id = w2_ProductView.variation_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
        ]]>
    </Statement>
    <Parameter>
      <Input Name="srch_key" Type="int" />
      <Input Name="srch_word_like_escaped" Type="nvarchar" Size="8000" />
      <Input Name="srch_stock_key" Type="nvarchar" Size="15" />
      <Input Name="srch_stock_count" Type="int" />
      <Input Name="srch_stock_count_type" Type="nvarchar" Size="10" />
      <Input Name="sort_kbn" Type="int"></Input>
      <Input Name="stock_alert_kbn" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetProductStockList>

  <!-- 商品在庫情報該当件数取得 -->
  <GetProductStockCount>
    <Statement>
      <![CDATA[
        -- 全件数取得
        SELECT  ISNULL(COUNT(w2_ProductView.variation_id), 0) AS row_count
          FROM  w2_ProductView
                [[ PRODUCTSTOCK_SEARCH_WHERE ]]
        ]]>
    </Statement>
    <Parameter>
      <Input Name="srch_key" Type="int" />
      <Input Name="srch_word_like_escaped" Type="nvarchar" Size="8000" />
      <Input Name="srch_stock_key" Type="nvarchar" Size="15" />
      <Input Name="srch_stock_count" Type="int" />
      <Input Name="srch_stock_count_type" Type="nvarchar" Size="10" />
      <Input Name="stock_alert_kbn" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetProductStockCount>

  <!-- 商品在庫マスタ情報取得(CSV出力用) -->
  <GetProductStockMaster>
    <Statement>
      <![CDATA[
        -- 該当情報取得
        SELECT  @@ fields @@
          FROM  (
                  SELECT  w2_ProductView.shop_id,
                          w2_ProductView.product_id,
                          w2_ProductView.variation_id,
                          ROW_NUMBER()
                          OVER
                          (
                            [[ PRODUCTSTOCK_SEARCH_ORDER_BY ]]
                          ) AS row_num
                    FROM  w2_ProductView
                          [[ PRODUCTSTOCK_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_ProductStock ON
                (
                  RowIndex.shop_id = w2_ProductStock.shop_id
                  AND
                  RowIndex.product_id = w2_ProductStock.product_id
                  AND
                  RowIndex.variation_id = w2_ProductStock.variation_id
                )
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="srch_key" Type="int" />
      <Input Name="srch_word_like_escaped" Type="nvarchar" Size="8000" />
      <Input Name="srch_stock_key" Type="nvarchar" Size="15" />
      <Input Name="srch_stock_count" Type="int" />
      <Input Name="srch_stock_count_type" Type="nvarchar" Size="10" />
      <Input Name="sort_kbn" Type="int"></Input>
      <Input Name="stock_alert_kbn" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
    </Parameter>
  </GetProductStockMaster>
  
  <!-- 商品在庫情報更新 -->
  <UpdateProductStock>
    <Statement>
      <![CDATA[
          UPDATE  w2_ProductStock 
             SET  w2_ProductStock.stock = w2_ProductStock.stock + @stock, 
                  w2_ProductStock.realstock = w2_ProductStock.realstock + @realstock, 
                  w2_ProductStock.realstock_b = w2_ProductStock.realstock_b + @realstock_b, 
                  w2_ProductStock.realstock_c = w2_ProductStock.realstock_c + @realstock_c, 
                  w2_ProductStock.realstock_reserved = w2_ProductStock.realstock_reserved + @realstock_reserved,
                  w2_ProductStock.stock_alert = @stock_alert, 
                  w2_ProductStock.date_changed = getdate(), 
                  w2_ProductStock.last_changed = @last_changed 
           WHERE  w2_ProductStock.shop_id = @shop_id 
             AND  w2_ProductStock.product_id = @product_id
             AND  w2_ProductStock.variation_id = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="stock_alert" Type="int" />
      <Input Name="stock" Type="int" />
      <Input Name="realstock" Type="int" />
      <Input Name="realstock_b" Type="int" />
      <Input Name="realstock_c" Type="int" />
      <Input Name="realstock_reserved" Type="int" />
    </Parameter>
  </UpdateProductStock>

  <!--
    商品在庫情報登録
    ※商品情報登録更新時に商品在庫情報が存在しない場合には登録を行う。
  -->
  <InsertProductStock>
    <Statement>
      <![CDATA[
          -- 商品在庫情報取得
          DECLARE @rec_count int
          SELECT @rec_count = COUNT(variation_id) 
            FROM w2_ProductStock 
           WHERE w2_ProductStock.shop_id = @shop_id
             AND w2_ProductStock.product_id = @product_id 
             AND w2_ProductStock.variation_id = @variation_id
             
          -- 商品在庫情報が存在しない場合
          IF @rec_count = 0
            BEGIN
              INSERT w2_ProductStock
              (
                w2_ProductStock.shop_id, 
                w2_ProductStock.product_id, 
                w2_ProductStock.variation_id, 
                w2_ProductStock.last_changed 
              )
              VALUES
              (
                @shop_id,
                @product_id, 
                @variation_id,
                @last_changed 
              )
            END   
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />      
    </Parameter>
  </InsertProductStock>

  <!--
    商品在庫情報削除
    ※在庫管理方法（stock_management_kbn）が『0.在庫管理をしない 』の場合は、商品在庫情報を削除
  -->
  <DeleteProductStockAll>
    <Statement>
      <![CDATA[
        DELETE  w2_ProductStock 
         WHERE  w2_ProductStock.shop_id = @shop_id 
           AND  w2_ProductStock.product_id = @product_id 
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteProductStockAll>

  <!--
    商品在庫情報削除
    ※在庫管理方法（stock_management_kbn）が『0.在庫管理をしない 』の場合は、商品在庫情報を削除
  -->
  <DeleteProductStock>
    <Statement>
      <![CDATA[
        DELETE  w2_ProductStock 
         WHERE  w2_ProductStock.shop_id = @shop_id 
           AND  w2_ProductStock.product_id = @product_id 
           AND  w2_ProductStock.variation_id NOT IN ( @@ update_variation_ids @@ )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
    </Parameter>
  </DeleteProductStock>

  <!-- 商品在庫情報取得 -->
  <GetProductStock>
    <Statement>
      <![CDATA[
        SELECT  w2_ProductStock.*
          FROM  w2_ProductStock
         WHERE  w2_ProductStock.shop_id = @shop_id 
           AND  w2_ProductStock.product_id = @product_id
           AND  w2_ProductStock.variation_id = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
    </Parameter>
  </GetProductStock>

  <!-- 商品在庫情報の論理在庫、実在庫数、引当済実在庫数更新 -->
  <AddProductStock>
    <Statement>
      <![CDATA[
        UPDATE 
            w2_ProductStock 
        SET 
            w2_ProductStock.stock = w2_ProductStock.stock + @stock,
            w2_ProductStock.realstock = w2_ProductStock.realstock + @realstock,
            w2_ProductStock.realstock_b = w2_ProductStock.realstock_b + @realstock_b,
            w2_ProductStock.realstock_c = w2_ProductStock.realstock_c + @realstock_c,
            w2_ProductStock.realstock_reserved = w2_ProductStock.realstock_reserved + @realstock_reserved,
            w2_ProductStock.date_changed = getdate(),
            w2_ProductStock.last_changed = @last_changed
        WHERE 
            w2_ProductStock.shop_id = @shop_id 
          AND
            w2_ProductStock.product_id = @product_id 
          AND
            w2_ProductStock.variation_id = @variation_id 
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="stock" Type="int" />
      <Input Name="realstock" Type="int" />
      <Input Name="realstock_b" Type="int" />
      <Input Name="realstock_c" Type="int" />
      <Input Name="realstock_reserved" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </AddProductStock>

  <!-- 商品在庫履歴情報追加 -->
  <InsertProductStockHistory>
    <Statement>
      <![CDATA[
        INSERT
         w2_ProductStockHistory (
              order_id,
              shop_id,
              product_id,
              variation_id,
              action_status,
              add_stock,
              add_realstock,
              add_realstock_b,
              add_realstock_c,
              add_realstock_reserved,
              update_memo,
              date_created,
              last_changed
          )
          VALUES
          (
              @order_id,
              @shop_id,
              @product_id,
              @variation_id,
              @action_status,
              @add_stock,
              @add_realstock,
              @add_realstock_b,
              @add_realstock_c,
              @add_realstock_reserved,
              @update_memo,
              getdate(),
              @last_changed
          )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="action_status" Type="nvarchar" Size="10" />
      <Input Name="add_stock" Type="int" />
      <Input Name="add_realstock" Type="int" />
      <Input Name="add_realstock_b" Type="int" />
      <Input Name="add_realstock_c" Type="int" />
      <Input Name="add_realstock_reserved" Type="int" />
      <Input Name="update_memo" Type="nvarchar" Size="200" />
      <Input Name="date_created" Type="datetime" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertProductStockHistory>

  <!-- 商品在庫履歴情報取得 -->
  <GetProductStockHistoryList>
    <Statement>
      <![CDATA[
        -- 全件数取得
        DECLARE @row_count int
        SELECT  @row_count = ISNULL(COUNT(w2_ProductStockHistory.history_no), 0)
          FROM  w2_ProductStockHistory
                INNER JOIN w2_ProductView ON
                (
                  w2_ProductStockHistory.shop_id = w2_ProductView.shop_id
                  AND
                  w2_ProductStockHistory.product_id = w2_ProductView.product_id
                  AND
                  w2_ProductStockHistory.variation_id = w2_ProductView.variation_id
                )          
                [[ PRODUCTSTOCKHISTORY_SEARCH_WHERE ]]

        -- 該当情報取得
        SELECT  w2_ProductStockHistory.history_no,
                w2_ProductStockHistory.order_id,
                w2_ProductStockHistory.shop_id,
                w2_ProductStockHistory.product_id,
                w2_ProductStockHistory.variation_id,
                w2_ProductStockHistory.action_status,
                w2_ProductStockHistory.add_stock,
                w2_ProductStockHistory.add_realstock,
                w2_ProductStockHistory.add_realstock_b,
                w2_ProductStockHistory.add_realstock_c,
                w2_ProductStockHistory.add_realstock_reserved,
                w2_ProductStockHistory.update_stock,
                w2_ProductStockHistory.update_realstock,
                w2_ProductStockHistory.update_realstock_b,
                w2_ProductStockHistory.update_realstock_c,
                w2_ProductStockHistory.update_realstock_reserved,
                w2_ProductStockHistory.update_memo,
                w2_ProductView.name,
                w2_ProductView.variation_name1,
                w2_ProductView.variation_name2,
                w2_ProductView.variation_name3,
                w2_ProductView.use_variation_flg,
                w2_ProductStockHistory.date_created,
                w2_ProductStockHistory.last_changed,
                @row_count AS row_count
          FROM  (
                  SELECT  w2_ProductStockHistory.shop_id,
                          w2_ProductStockHistory.product_id,
                          w2_ProductStockHistory.variation_id,
                          w2_ProductStockHistory.history_no,
                          ROW_NUMBER()
                          OVER
                          (
                            [[ PRODUCTSTOCKHISTORY_SEARCH_ORDER_BY ]]
                          ) AS row_num
                    FROM  w2_ProductStockHistory
                          [[ PRODUCTSTOCKHISTORY_SEARCH_WHERE ]]
                ) AS RowIndex
                INNER JOIN w2_ProductStockHistory ON
                (
                  RowIndex.shop_id = w2_ProductStockHistory.shop_id
                  AND
                  RowIndex.product_id = w2_ProductStockHistory.product_id
                  AND
                  RowIndex.variation_id = w2_ProductStockHistory.variation_id
                  AND
                  RowIndex.history_no = w2_ProductStockHistory.history_no
                )
                INNER JOIN w2_ProductView ON
                (
                  w2_ProductStockHistory.shop_id = w2_ProductView.shop_id
                  AND
                  w2_ProductStockHistory.product_id = w2_ProductView.product_id
                  AND
                  w2_ProductStockHistory.variation_id = w2_ProductView.variation_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
        ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </GetProductStockHistoryList>

  <!-- 注文向け商品在庫数取得（更新ロック） -->
  <GetProductStockWithUpdLockForOrder>
    <Statement>
      <![CDATA[
        SELECT  stock
          FROM  w2_ProductStock WITH (UPDLOCK)
         WHERE  shop_id = @shop_id
           AND  product_id = @product_id
           AND  variation_id = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
    </Parameter>
  </GetProductStockWithUpdLockForOrder>

  <!-- 注文向け商品在庫数更新 -->
  <UpdateProductStockForOrder>
    <Statement>
      <![CDATA[
        UPDATE  w2_ProductStock
           SET  w2_ProductStock.stock = w2_ProductStock.stock + @item_quantity,
                w2_ProductStock.date_changed = getdate(),
                w2_ProductStock.last_changed = @last_changed
          FROM  w2_ProductStock
         WHERE  w2_ProductStock.shop_id  = @shop_id
           AND  w2_ProductStock.product_id  = @product_id
           AND  w2_ProductStock.variation_id  = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </UpdateProductStockForOrder>

  <!-- 注文向け商品在庫履歴挿入 -->
  <InsertProductStockHistoryForOrder>
    <Statement>
      <![CDATA[
        INSERT  w2_ProductStockHistory
                (
                order_id,
                shop_id,
                product_id,
                variation_id,
                action_status,
                add_stock,
                add_realstock,
                add_realstock_reserved,
                update_stock,
                update_realstock,
                update_realstock_reserved,
                last_changed
                )
          VALUES
                (
                @order_id,
                @shop_id,
                @product_id,
                @variation_id,
                @action_status,
                @add_stock,
                @add_realstock,
                @add_realstock_reserved,
                @update_stock,
                @update_realstock,
                @update_realstock_reserved,
                @last_changed
                )
			]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="action_status" Type="nvarchar" Size="10" />
      <Input Name="add_stock" Type="int" />
      <Input Name="add_realstock" Type="int" />
      <Input Name="add_realstock_reserved" Type="int" />
      <Input Name="update_stock" Type="int" />
      <Input Name="update_realstock" Type="int" />
      <Input Name="update_realstock_reserved" Type="int" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </InsertProductStockHistoryForOrder>

</ProductStock>