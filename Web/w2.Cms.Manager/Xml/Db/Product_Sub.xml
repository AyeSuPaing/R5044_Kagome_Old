<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 商品系SQLサブステートメントXML(Product_Sub.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<Product_Sub>

  <!-- 商品情報一覧取得用WHERE文 -->
  <PRODUCT_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  w2_Product.shop_id = @shop_id 
           AND  (
                  (@product_id_like_escaped = '' OR w2_Product.product_id like @product_id_like_escaped + '%' ESCAPE '#')      -- 商品ID
                  AND 
                  (@name_like_escaped = '' OR w2_Product.name like '%' + @name_like_escaped + '%' ESCAPE '#')          -- 商品名
                  AND
                  (@supplier_id_like_escaped = '' OR w2_Product.supplier_id like @supplier_id_like_escaped + '%' ESCAPE '#')      -- サプライヤID
                  AND
                  (@shipping_type = '' OR w2_Product.shipping_type = @shipping_type)      -- 配送種別
                  AND
                  (@shipping_size_kbn = '' OR w2_Product.shipping_size_kbn = @shipping_size_kbn)  -- 配送サイズ区分
                  -- 表示期間
                  AND
                  (
                    @disp_kbn = ''
                    OR 
                    (
                      (
                        @disp_kbn = '0'
                        AND NOT
                        (
                          w2_Product.display_from <= GETDATE()
                          AND
                          ((w2_Product.display_to IS NULL) OR (GETDATE() <= w2_Product.display_to))
                        )
                      )
                      OR
                      (
                        @disp_kbn = '1'
                        AND
                        (
                          w2_Product.display_from <= GETDATE()
                          AND
                          ((w2_Product.display_to IS NULL) OR (GETDATE() <= w2_Product.display_to))
                        )
                      )
                    )
                  )
                  -- 販売期間
                  AND
                  (
                    @sell_kbn = ''
                    OR 
                    (
                      (
                        @sell_kbn = '0'
                        AND NOT
                        (
                          w2_Product.sell_from <= GETDATE()
                          AND
                          ((w2_Product.sell_to IS NULL) OR (GETDATE() <= w2_Product.sell_to))
                        )
                      )
                      OR
                      (
                        @sell_kbn = '1'
                        AND
                        (
                          w2_Product.sell_from <= GETDATE()
                          AND
                          ((w2_Product.sell_to IS NULL) OR (GETDATE() <= w2_Product.sell_to))
                        )
                      )
                    )
                  )
                  -- 商品表示区分
                  AND
                  (
                    @display_kbn = '' OR w2_Product.display_kbn = @display_kbn
                  )
                  -- 削除区分
                  AND
                  (
                    @valid_flg = ''
                    OR
                    w2_Product.valid_flg = @valid_flg
                  )
                  AND
                  (
                    @category_id_like_escaped = ''
                    OR 
                    w2_Product.category_id1 LIKE @category_id_like_escaped + '%' ESCAPE '#'                -- カテゴリID1
                    OR 
                    w2_Product.category_id2 LIKE @category_id_like_escaped + '%' ESCAPE '#'                -- カテゴリID2
                    OR 
                    w2_Product.category_id3 LIKE @category_id_like_escaped + '%' ESCAPE '#'                -- カテゴリID3
                    OR 
                    w2_Product.category_id4 LIKE @category_id_like_escaped + '%' ESCAPE '#'                -- カテゴリID4
                    OR 
                    w2_Product.category_id5 LIKE @category_id_like_escaped + '%' ESCAPE '#'                -- カテゴリID5
                  )
                  AND 
                  (
                    @mobile_disp_flg = ''
                    OR
                    w2_Product.mobile_disp_flg = @mobile_disp_flg
                  )  -- モバイル表示フラグ
                  AND
                  (@icon_flg1 = '' OR w2_Product.icon_flg1 = @icon_flg1)          -- アイコン1
                  AND
                  (@icon_flg2 = '' OR w2_Product.icon_flg2 = @icon_flg2)          -- アイコン2
                  AND
                  (@icon_flg3 = '' OR w2_Product.icon_flg3 = @icon_flg3)          -- アイコン3
                  AND
                  (@icon_flg4 = '' OR w2_Product.icon_flg4 = @icon_flg4)          -- アイコン4
                  AND
                  (@icon_flg5 = '' OR w2_Product.icon_flg5 = @icon_flg5)          -- アイコン5
                  AND
                  (@icon_flg6 = '' OR w2_Product.icon_flg6 = @icon_flg6)          -- アイコン6
                  AND
                  (@icon_flg7 = '' OR w2_Product.icon_flg7 = @icon_flg7)          -- アイコン7
                  AND
                  (@icon_flg8 = '' OR w2_Product.icon_flg8 = @icon_flg8)          -- アイコン8
                  AND
                  (@icon_flg9 = '' OR w2_Product.icon_flg9 = @icon_flg9)          -- アイコン9
                  AND
                  (@icon_flg10 = '' OR w2_Product.icon_flg10 = @icon_flg10)          -- アイコン10
                  AND
                  EXISTS (
                    SELECT  variation_cooperation_id1
                      FROM  w2_ProductVariationView
                     WHERE  w2_ProductVariationView.shop_id = w2_Product.shop_id
                       AND  w2_ProductVariationView.product_id = w2_Product.product_id
                       AND  (
                              (
                                @cooperation_id1_like_escaped = ''
                                OR
                                cooperation_id1 LIKE @cooperation_id1_like_escaped + '%' ESCAPE '#' -- 商品連携ID1
                                OR
                                variation_cooperation_id1 LIKE @cooperation_id1_like_escaped + '%' ESCAPE '#'  -- 商品バリエーション連携ID1
                              )
                              AND
                              (
                                @cooperation_id2_like_escaped = ''
                                OR
                                cooperation_id2 LIKE @cooperation_id2_like_escaped + '%' ESCAPE '#' -- 商品連携ID2
                                OR
                                variation_cooperation_id2 LIKE @cooperation_id2_like_escaped + '%' ESCAPE '#'  -- 商品バリエーション連携ID2
                              )
                              -- 商品連携ID3, 商品バリエーション連携ID3
                              AND
                              (
                                @cooperation_id3_like_escaped = ''
                                OR
                                cooperation_id3 LIKE @cooperation_id3_like_escaped + '%' ESCAPE '#' 
                                OR
                                variation_cooperation_id3 LIKE @cooperation_id3_like_escaped + '%' ESCAPE '#'
                              )
                              -- 商品連携ID4, 商品バリエーション連携ID4
                              AND
                              (
                                @cooperation_id4_like_escaped = ''
                                OR
                                cooperation_id4 LIKE @cooperation_id4_like_escaped + '%' ESCAPE '#' 
                                OR
                                variation_cooperation_id4 LIKE @cooperation_id4_like_escaped + '%' ESCAPE '#'
                              )
                              -- 商品連携ID5, 商品バリエーション連携ID5
                              AND
                              (
                                @cooperation_id5_like_escaped = ''
                                OR
                                cooperation_id5 LIKE @cooperation_id5_like_escaped + '%' ESCAPE '#' 
                                OR
                                variation_cooperation_id5 LIKE @cooperation_id5_like_escaped + '%' ESCAPE '#'
                              )
                            )
                  )
                  AND
                  (
                    @member_rank_discount_flg = ''
                    OR
                    w2_Product.member_rank_discount_flg = @member_rank_discount_flg
                  )
                  AND
                  (
                    @display_member_rank = ''
                    OR
                    (
                      (
                        SELECT  w2_MemberRank.member_rank_order
                          FROM  w2_MemberRank
                         WHERE  w2_MemberRank.member_rank_id = w2_Product.display_member_rank
                      )
                      <=
                      (
                        SELECT  w2_MemberRank.member_rank_order
                          FROM  w2_MemberRank
                         WHERE  w2_MemberRank.member_rank_id = @display_member_rank
                      )
                    )
                  )
                  AND
                  (
                    @buyable_member_rank = ''
                    OR
                    (
                      (
                        SELECT  w2_MemberRank.member_rank_order
                          FROM  w2_MemberRank
                         WHERE  w2_MemberRank.member_rank_id = w2_Product.buyable_member_rank
                      )
                      <=
                      (
                        SELECT  w2_MemberRank.member_rank_order
                          FROM  w2_MemberRank
                         WHERE  w2_MemberRank.member_rank_id = @buyable_member_rank
                      )
                    )
                  )
                  AND
                  (
                    @brand_id = ''
                    OR 
                    (
                      w2_Product.brand_id1 = @brand_id -- ブランドID1
                      OR
                      w2_Product.brand_id2 = @brand_id -- ブランドID2
                      OR
                      w2_Product.brand_id3 = @brand_id -- ブランドID3
                      OR
                      w2_Product.brand_id4 = @brand_id -- ブランドID4
                      OR
                      w2_Product.brand_id5 = @brand_id -- ブランドID5
                    )
                  )
                  AND 
                  (
                    @display_priority IS NULL
                    OR
                    w2_Product.display_priority >= @display_priority
                  )  -- 表示優先順
                  AND
                  (@sell_from_from IS NULL OR w2_Product.sell_from >= @sell_from_from)
                  AND
                  (@sell_from_to IS NULL OR w2_Product.sell_from <= @sell_from_to)
                  AND
                  (@sell_to_from IS NULL OR w2_Product.sell_to IS NULL OR w2_Product.sell_to >= @sell_to_from)
                  AND
                  (@sell_to_to IS NULL OR w2_Product.sell_to <= @sell_to_to)
                  AND
                  (
                    @limited_payment_ids_like_escaped = ''
                    OR
                    w2_Product.limited_payment_ids LIKE '%' + @limited_payment_ids_like_escaped + '%' ESCAPE '#'
                  )
                  AND
                  (
                    @product_type = ''
                    OR
                    w2_Product.product_type = @product_type
                  )
                  AND
                  (
                    @bundle_item_display_type = ''
                    OR
                    w2_Product.bundle_item_display_type = @bundle_item_display_type
                  )
                  <@@hasval:product_color_id@@>
                  -- カラー検索用
                  AND
                  (
                    EXISTS
                      (
                        SELECT  *
                          FROM  w2_ProductVariation
                         WHERE  w2_Product.shop_id = @shop_id
                           AND  w2_ProductVariation.product_id = w2_Product.product_id
                           AND  w2_ProductVariation.variation_color_id = @product_color_id
                       )
                     OR
                     w2_Product.product_color_id = @product_color_id
                  )
                  </@@hasval:product_color_id@@>
                  AND
                  (
                    @display_only_fixed_purchase_member_flg = ''
                    OR
                    w2_Product.display_only_fixed_purchase_member_flg = @display_only_fixed_purchase_member_flg
                  )
                  AND
                  (
                    @sell_only_fixed_purchase_member_flg = ''
                    OR
                    w2_Product.sell_only_fixed_purchase_member_flg = @sell_only_fixed_purchase_member_flg
                  )
                  AND
                  (
                    @tax_category_id = ''
                    OR
                    w2_Product.tax_category_id = @tax_category_id
                  )
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="name_like_escaped" Type="nvarchar" Size="200" />
      <Input Name="sort_kbn" Type="int" />
      <Input Name="supplier_id_like_escaped" Type="nvarchar" Size="40" />
      <Input Name="cooperation_id1_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="cooperation_id2_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="cooperation_id3_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="cooperation_id4_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="cooperation_id5_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="shipping_type" Type="nvarchar" Size="10" />
      <Input Name="shipping_size_kbn" Type="nvarchar" Size="4" />
      <Input Name="disp_kbn" Type="nvarchar" Size="1" />
      <Input Name="sell_kbn" Type="nvarchar" Size="1" />
      <Input Name="display_kbn" Type="nvarchar" Size="1" />
      <Input Name="valid_flg" Type="nvarchar" Size="1" />
      <Input Name="category_id_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="mobile_disp_flg" Type="nvarchar" Size="2" />
      <Input Name="icon_flg1" Type="nvarchar" Size="1" />
      <Input Name="icon_flg2" Type="nvarchar" Size="1" />
      <Input Name="icon_flg3" Type="nvarchar" Size="1" />
      <Input Name="icon_flg4" Type="nvarchar" Size="1" />
      <Input Name="icon_flg5" Type="nvarchar" Size="1" />
      <Input Name="icon_flg6" Type="nvarchar" Size="1" />
      <Input Name="icon_flg7" Type="nvarchar" Size="1" />
      <Input Name="icon_flg8" Type="nvarchar" Size="1" />
      <Input Name="icon_flg9" Type="nvarchar" Size="1" />
      <Input Name="icon_flg10" Type="nvarchar" Size="1" />
      <Input Name="current_date" Type="datetime" />
      <Input Name="member_rank_discount_flg" Type="nvarchar" Size="1" />
      <Input Name="display_member_rank" Type="nvarchar" Size="30" />
      <Input Name="buyable_member_rank" Type="nvarchar" Size="30" />
      <Input Name="brand_id" Type="nvarchar" Size="30" />
      <Input Name="display_priority" Type="int" />
      <Input Name="sell_from_from" Type="datetime"/>
      <Input Name="sell_from_to" Type="datetime"/>
      <Input Name="sell_to_from" Type="datetime"/>
      <Input Name="sell_to_to" Type="datetime"/>
      <Input Name="limited_payment_ids_like_escaped" Type="nvarchar" Size="500"/>
      <Input Name="bundle_item_display_type" Type="nvarchar" Size="10" />
      <Input Name="product_type" Type="nvarchar" Size="10" />
      <Input Name="product_color_id" Type="nvarchar" Size="50" />
      <Input Name="display_only_fixed_purchase_member_flg" Type="nvarchar" Size="1" />
      <Input Name="sell_only_fixed_purchase_member_flg" Type="nvarchar" Size="1" />
      <Input Name="tax_category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </PRODUCT_SEARCH_WHERE>

  <!-- 商品情報一覧取得用ORDER_BY -->
  <PRODUCT_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN w2_Product.product_id
            WHEN  2 THEN w2_Product.name
            WHEN  4 THEN w2_Product.name_kana
            ELSE '1'
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  6 THEN w2_Product.date_created
            WHEN  8 THEN w2_Product.date_changed
            ELSE NULL
          END 
          ASC, 
          CASE @sort_kbn
            WHEN  1 THEN w2_Product.product_id
            WHEN  3 THEN w2_Product.name
            WHEN  5 THEN w2_Product.name_kana
            ELSE '1'
          END 
          DESC, 
          CASE @sort_kbn
            WHEN  7 THEN w2_Product.date_created
            WHEN  9 THEN w2_Product.date_changed
            ELSE NULL
          END 
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_Product.shop_id ASC, w2_Product.product_id ASC
      ]]>
    </Statement>
  </PRODUCT_SEARCH_ORDER_BY>

  <!-- 会員ランク価格取得SQL（バリエーション単位） -->
  <MEMBER_RANK_PRICE_PRODUCTVARIATION>
    <Statement>
      <![CDATA[
        (
          SELECT  TOP 1
                  w2_ProductPrice.member_rank_price
            FROM  w2_ProductPrice
                  LEFT JOIN w2_MemberRank ON
                  (
                      w2_ProductPrice.member_rank_id = w2_MemberRank.member_rank_id
                  )
            WHERE  w2_ProductPrice.shop_id = w2_ProductView.shop_id
              AND  w2_ProductPrice.product_id = w2_ProductView.product_id
              AND  w2_ProductPrice.variation_id = ''
              AND  @member_rank_id <> ''
              AND  w2_MemberRank.member_rank_order >= (SELECT ISNULL(MAX(member_rank_order), 999) FROM w2_MemberRank where member_rank_id = @member_rank_id AND valid_flg = 'ON')
              AND  w2_MemberRank.valid_flg = 'ON'
          ORDER BY w2_MemberRank.member_rank_order
        ) AS member_rank_price,
        (
          SELECT  TOP 1
                  w2_ProductPrice.member_rank_price
            FROM  w2_ProductPrice
                  LEFT JOIN w2_MemberRank ON
                  (
                      w2_ProductPrice.member_rank_id = w2_MemberRank.member_rank_id
                  )
            WHERE  w2_ProductPrice.shop_id = w2_ProductView.shop_id
              AND  w2_ProductPrice.product_id = w2_ProductView.product_id
              AND  (w2_ProductPrice.variation_id = w2_ProductView.variation_id OR ((w2_ProductView.use_variation_flg = '0') AND (w2_ProductPrice.variation_id = '')))
              AND  @member_rank_id <> ''
              AND  w2_MemberRank.member_rank_order >= (SELECT ISNULL(MAX(member_rank_order), 999) FROM w2_MemberRank where member_rank_id = @member_rank_id AND valid_flg = 'ON')
              AND  w2_MemberRank.valid_flg = 'ON'
          ORDER BY w2_MemberRank.member_rank_order
        ) AS member_rank_price_variation
      ]]>
    </Statement>
  </MEMBER_RANK_PRICE_PRODUCTVARIATION>

</Product_Sub>