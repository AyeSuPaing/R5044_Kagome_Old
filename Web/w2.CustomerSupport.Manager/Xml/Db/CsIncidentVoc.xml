<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : VOC画面系SQLステートメントXML(CsIncidentVoc.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2013 All Rights Reserved.
=========================================================================================================
-->
<CsIncidentVoc>
  
  <!-- 一覧取得 -->
  <Search>
    <Statement>
      <![CDATA[
       DECLARE  @row_count int
       
        -- 該当件数取得
        SELECT  @row_count = ISNULL(COUNT(dept_id), 0)
          FROM  w2_CsIncidentVoc
         WHERE  w2_CsIncidentVoc.dept_id = @dept_id 
       
        -- 一覧情報取得
        SELECT  w2_CsIncidentVoc.*,
                @row_count as row_count
          FROM  (
                  SELECT  w2_CsIncidentVoc.dept_id,
                          w2_CsIncidentVoc.voc_id,
                          ROW_NUMBER() OVER (ORDER BY w2_CsIncidentVoc.display_order, w2_CsIncidentVoc.voc_id) AS row_num
                    FROM  w2_CsIncidentVoc
                   WHERE  w2_CsIncidentVoc.dept_id = @dept_id 
                ) AS RowIndex
                INNER JOIN w2_CsIncidentVoc ON
                (
                  RowIndex.dept_id = w2_CsIncidentVoc.dept_id
                  AND
                  RowIndex.voc_id = w2_CsIncidentVoc.voc_id
                )
         WHERE  @bgn_row_num <= RowIndex.row_num
           AND  RowIndex.row_num <= @end_row_num
      ORDER BY  RowIndex.row_num ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="bgn_row_num" Type="int" />
      <Input Name="end_row_num" Type="int" />
    </Parameter>
  </Search>
  
  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT  * 
          FROM  w2_CsIncidentVoc
         WHERE  w2_CsIncidentVoc.dept_id = @dept_id
           AND  w2_CsIncidentVoc.voc_id = @voc_id 
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="voc_id" Type="nvarchar" Size="10" />
    </Parameter>
  </Get>

  <!-- 有効なものすべて取得 -->
  <GetValidAll>
    <Statement>
      <![CDATA[
        SELECT	*
          FROM	w2_CsIncidentVoc
         WHERE	w2_CsIncidentVoc.dept_id = @dept_id 
           AND	w2_CsIncidentVoc.valid_flg = '1'
      ORDER BY  w2_CsIncidentVoc.display_order, w2_CsIncidentVoc.voc_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetValidAll>

  <!-- 登録 -->
  <Register>
    <Statement>
      <![CDATA[
        INSERT  w2_CsIncidentVoc
          (
            w2_CsIncidentVoc.dept_id, 
            w2_CsIncidentVoc.voc_id, 
            w2_CsIncidentVoc.voc_text, 
            w2_CsIncidentVoc.display_order, 
            w2_CsIncidentVoc.valid_flg, 
            w2_CsIncidentVoc.date_created, 
            w2_CsIncidentVoc.date_changed, 
            w2_CsIncidentVoc.last_changed 
          ) 
          VALUES
          (
            @dept_id, 
            @voc_id, 
            @voc_text, 
            @display_order, 
            @valid_flg, 
            getdate(),
            getdate(),
            @last_changed  
          )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="voc_id" Type="nvarchar" Size="10" />
      <Input Name="voc_text" Type="nvarchar" Size="30" />
      <Input Name="display_order" Type="int" />
      <Input Name="valid_flg" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </Register>

  <!-- 更新 -->
  <Update>
    <Statement>
      <![CDATA[
        UPDATE  w2_CsIncidentVoc 
           SET  w2_CsIncidentVoc.voc_text = @voc_text, 
                w2_CsIncidentVoc.display_order = @display_order, 
                w2_CsIncidentVoc.valid_flg = @valid_flg, 
                w2_CsIncidentVoc.date_changed = getdate(), 
                w2_CsIncidentVoc.last_changed = @last_changed 
         WHERE  w2_CsIncidentVoc.dept_id = @dept_id
           AND  w2_CsIncidentVoc.voc_id = @voc_id 
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="voc_id" Type="nvarchar" Size="10" />
      <Input Name="voc_text" Type="nvarchar" Size="30" />
      <Input Name="display_order" Type="int" />
      <Input Name="valid_flg" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </Update>

  <!-- 削除チェック -->
  <CheckDeletable>
    <Statement>
      <![CDATA[
        SELECT	COUNT(w2_CsIncident.incident_id) AS count
          FROM	w2_CsIncident
         WHERE	w2_CsIncident.dept_id = @dept_id 
           AND	w2_CsIncident.voc_id = @voc_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="voc_id" Type="nvarchar" Size="10" />
    </Parameter>
  </CheckDeletable>

  <!-- 削除 -->
  <Delete>
    <Statement>
      <![CDATA[
        DELETE 
          FROM  w2_CsIncidentVoc
         WHERE  w2_CsIncidentVoc.dept_id = @dept_id 
           AND  w2_CsIncidentVoc.voc_id = @voc_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="voc_id" Type="nvarchar" Size="10" />
    </Parameter>
  </Delete>

</CsIncidentVoc>
