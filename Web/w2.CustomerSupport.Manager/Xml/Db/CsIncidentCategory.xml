<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : インシデントカテゴリ系SQLステートメントXML(CsIncidentCategory.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2013 All Rights Reserved.
=========================================================================================================
-->
<CsIncidentCategory>
  
  <!-- カテゴリID指定サーチ（指定がなければ全件） -->
  <SearchByCategoryId>
    <Statement>
      <![CDATA[
        -- 全件数取得
        DECLARE @row_count int
        SELECT	@row_count = COUNT(*)
          FROM	w2_CsIncidentCategory 
         WHERE  w2_CsIncidentCategory.dept_id = @dept_id 
           AND  (
                  @category_id = ''
                  OR 
                  w2_CsIncidentCategory.category_id = @category_id
                );
                
        -- カテゴリ階層データを取得(再帰クエリ)
          WITH  categories
            AS  (
                  SELECT  cat1.category_id,
                          cast(1 as int) as rank_no,
                          cast(cat1.category_id as varchar(30)) as ranked_category_id,
                          cast(RIGHT('00' + CONVERT(nvarchar, cat1.display_order), 3) + cat1.category_id as varchar(60)) as ranked_display_order,
                          cast(cat1.valid_flg as int) AS ranked_valid_flg
                    FROM  w2_CsIncidentCategory as cat1
                   WHERE  parent_category_id = ''
               UNION ALL
                  SELECT  cat2.category_id,
                          categories.rank_no + 1,
                          cast(categories.ranked_category_id + cat2.category_id as varchar(30)),
                          cast(categories.ranked_display_order + RIGHT('00' + CONVERT(nvarchar, cat2.display_order), 3) + cat2.category_id as  varchar(60)),
                          categories.ranked_valid_flg & cast(valid_flg as int)
                    FROM  w2_CsIncidentCategory as cat2
                          INNER JOIN categories ON
                          (
                            categories.category_id = cat2.parent_category_id
                          )
                )
                
        SELECT	@row_count as 'row_count',
                w2_CsIncidentCategory.dept_id,
                w2_CsIncidentCategory.category_id,
                w2_CsIncidentCategory.parent_category_id,
                REPLICATE('　　', categories.rank_no - 1) + w2_CsIncidentCategory.category_name as 'category_name',
                categories.rank_no,
                categories.ranked_category_id,
                categories.ranked_display_order,
                cast(categories.ranked_valid_flg as nvarchar(1)) AS ranked_valid_flg,
                w2_CsIncidentCategory.display_order,
                w2_CsIncidentCategory.valid_flg,
                w2_CsIncidentCategory.del_flg,
                w2_CsIncidentCategory.date_created, 
                w2_CsIncidentCategory.date_changed, 
                w2_CsIncidentCategory.last_changed 
          FROM	dbo.w2_CsIncidentCategory 
                INNER JOIN categories ON
                (
                  w2_CsIncidentCategory.category_id = categories.category_id
                )
         WHERE  w2_CsIncidentCategory.dept_id = @dept_id 
           AND  (
                  @category_id = ''
                  OR 
                  w2_CsIncidentCategory.category_id = @category_id
                )
      ORDER BY  categories.ranked_display_order ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </SearchByCategoryId>

  <!-- 全件取得（ドロップダウン等で利用、有効フラグは階層考慮） -->
  <GetAll>
    <Statement>
      <![CDATA[
          -- カテゴリ階層データを取得(再帰クエリ)
          WITH  categories
            AS  (
                  SELECT  cat1.category_id,
                          cast(1 as int) as rank_no,
                          cast('' as varchar(30)) as parent_category_path,
                          cast(RIGHT('00' + CONVERT(nvarchar, cat1.display_order), 3) + cat1.category_id as varchar(60)) as ranked_display_order,
                          cast(cat1.valid_flg as int) AS ranked_valid_flg
                    FROM  w2_CsIncidentCategory as cat1
                   WHERE  parent_category_id = ''
               UNION ALL
                  SELECT  cat2.category_id,
                          categories.rank_no + 1,
                          CASE categories.parent_category_path when '' THEN cast(cat2.parent_category_id as varchar(30)) ELSE cast(categories.parent_category_path + '/' + cat2.parent_category_id as varchar(30)) END,
                          cast(categories.ranked_display_order + RIGHT('00' + CONVERT(nvarchar, cat2.display_order), 3) + cat2.category_id as  varchar(60)),
                          categories.ranked_valid_flg & cast(valid_flg as int)
                    FROM  w2_CsIncidentCategory as cat2
                          INNER JOIN categories ON
                          (
                            categories.category_id = cat2.parent_category_id
                          )
                )
                
        SELECT	w2_CsIncidentCategory.category_id,
                w2_CsIncidentCategory.category_name,
                rank_no,
                parent_category_path,
                cast(categories.ranked_valid_flg as nvarchar(1)) AS ranked_valid_flg
          FROM	w2_CsIncidentCategory 
                INNER JOIN categories ON
                (
                  w2_CsIncidentCategory.category_id = categories.category_id
                )
         WHERE	w2_CsIncidentCategory.dept_id = @dept_id 
      ORDER BY  categories.ranked_display_order ASC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetAll>

  <!-- 取得 -->
  <Get>
    <Statement>
      <![CDATA[
        SELECT	*
          FROM	w2_CsIncidentCategory 
         WHERE	w2_CsIncidentCategory.dept_id = @dept_id 
           AND	w2_CsIncidentCategory.category_id = @category_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </Get>

  <!-- カテゴリ階層リスト取得 -->
  <GetCategoryTrailList>
    <Statement>
      <![CDATA[
          -- カテゴリ階層データを取得(再帰クエリ)
          WITH  categories
            AS  (
                  SELECT  cat1.dept_id,
                          cat1.category_id,
                          cat1.parent_category_id,
                          1 as rank,
                          cat1.category_name
                    FROM  w2_CsIncidentCategory as cat1
                   WHERE  dept_id = @dept_id
                     AND  category_id = @category_id
               UNION ALL
                  SELECT  cat2.dept_id,
                          cat2.category_id,
                          cat2.parent_category_id,
                          rank + 1,
                          cat2.category_name
                    FROM  w2_CsIncidentCategory as cat2
                          INNER JOIN categories ON
                          (
                            categories.dept_id = cat2.dept_id
                            AND
                            categories.parent_category_id = cat2.category_id
                          )
                )

        SELECT  categories.*  
          FROM  categories
      ORDER BY  categories.rank DESC
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetCategoryTrailList>

  <!-- 登録 -->
  <Register>
    <Statement>
      <![CDATA[				
        INSERT	w2_CsIncidentCategory
            (
            dept_id,
            category_id,
            parent_category_id,
            category_name,
            display_order,
            valid_flg,
            date_created, 
            date_changed, 
            last_changed
            )
         VALUES	(
            @dept_id, 
            @category_id, 
            @parent_category_id, 
            @category_name, 
            @display_order, 
            @valid_flg, 
            getdate(), 
            getdate(), 
            @last_changed 
            )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
      <Input Name="parent_category_id" Type="nvarchar" Size="30" />
      <Input Name="category_name" Type="nvarchar" Size="30" />
      <Input Name="display_order" Type="int" />
      <Input Name="valid_flg" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </Register>
  
  <!-- 更新 -->
  <Update>
    <Statement>
      <![CDATA[
        UPDATE  w2_CsIncidentCategory 
           SET  w2_CsIncidentCategory.parent_category_id = @parent_category_id, 
                w2_CsIncidentCategory.category_name = @category_name, 
                w2_CsIncidentCategory.display_order = @display_order, 
                w2_CsIncidentCategory.valid_flg = @valid_flg, 					
                w2_CsIncidentCategory.date_changed = getdate(), 
                w2_CsIncidentCategory.last_changed = @last_changed 
         WHERE  w2_CsIncidentCategory.dept_id = @dept_id 
           AND  w2_CsIncidentCategory.category_id = @category_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
      <Input Name="parent_category_id" Type="nvarchar" Size="30" />
      <Input Name="category_name" Type="nvarchar" Size="30" />
      <Input Name="display_order" Type="int" />
      <Input Name="valid_flg" Type="nvarchar" Size="10" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
    </Parameter>
  </Update>
  
  <!-- インシデント取得（削除チェック用） -->
  <GetIncidents>
    <Statement>
      <![CDATA[
        SELECT	*
          FROM	w2_CsIncident 
         WHERE	w2_CsIncident.dept_id = @dept_id 
           AND	w2_CsIncident.incident_category_id = @category_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetIncidents>

  <!-- 子カテゴリ取得（削除チェック用） -->
  <GetChildCategories>
    <Statement>
      <![CDATA[
        SELECT	*
          FROM	w2_CsIncidentCategory 
         WHERE	w2_CsIncidentCategory.dept_id = @dept_id 
           AND	w2_CsIncidentCategory.parent_category_id = @category_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </GetChildCategories>

  <!-- 削除 -->
  <Delete>
    <Statement>
      <![CDATA[
        -- インシデントカテゴリ情報削除
        DELETE	
          FROM	w2_CsIncidentCategory 
         WHERE	w2_CsIncidentCategory.dept_id = @dept_id 
           AND	w2_CsIncidentCategory.category_id = @category_id
       ]]>
      </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="category_id" Type="nvarchar" Size="30" />
    </Parameter>
  </Delete>
  
</CsIncidentCategory>