<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : Fixed Purchase Repeat Analysis Sub XML (FixedPurchaseRepeatAnalysis_Sub.xml)
  ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2023 All Rights Reserved.
=========================================================================================================
-->
<FixedPurchaseRepeatAnalysis_Sub>

  <!-- Fixed purchase repeat analysis Ltv report target list search where -->
  <FIXEDPURCHASEREPEATANALYSISLTVREPORT_TARGETLIST_SEARCH_WHERE>
    <Statement>
      <![CDATA[
        WHERE  w2_FixedPurchase.fixed_purchase_status NOT IN ('31','01')  -- 定期購入ステータス（仮登録キャンセル、仮登録）
          AND  w2_FixedPurchase.subscription_box_course_id = ''
          AND  w2_FixedPurchase.fixed_purchase_date_bgn >= @fixed_purchase_date_from
          AND  w2_FixedPurchase.fixed_purchase_date_bgn <= @fixed_purchase_date_to
          <@@hasval:user_extend_flg@@>
          -- ユーザー拡張項目
          AND  (
                 <@@val:user_extend_flg:1@@>
                   <@@hasnoval:user_extend_like_escaped@@>
                     (
                       @@ user_extend_field_name @@ <> ''
                       AND
                       @@ user_extend_field_name @@ IS NOT NULL
                     )
                   </@@hasnoval:user_extend_like_escaped@@>
                   <@@hasval:user_extend_like_escaped@@>
                     <@@val:user_extend_type:TB@@>
                       @@ user_extend_field_name @@ LIKE '%' + @user_extend_like_escaped + '%' ESCAPE '#'
                     </@@val:user_extend_type:TB@@>
                     <@@val:user_extend_type:CB@@>
                       (
                         -- 1カラムに複数の値が格納されている場合にもマッチングさせる
                         @@ user_extend_field_name @@ = @user_extend_like_escaped
                         OR
                         @@ user_extend_field_name @@ LIKE '%,' + @user_extend_like_escaped + ',%' ESCAPE '#'
                         OR
                         @@ user_extend_field_name @@ LIKE + @user_extend_like_escaped + ',%' ESCAPE '#'
                         OR
                         @@ user_extend_field_name @@ LIKE '%,' + @user_extend_like_escaped ESCAPE '#'
                       )
                     </@@val:user_extend_type:CB@@>
                     <@@val:user_extend_type:DDL,RB@@>
                       (
                         @@ user_extend_field_name @@ = @user_extend_like_escaped
                       )
                     </@@val:user_extend_type:DDL,RB@@>
                   </@@hasval:user_extend_like_escaped@@>
                 </@@val:user_extend_flg:1@@>
                 <@@val:user_extend_flg:0@@>
                   (
                     @@ user_extend_field_name @@ = ''
                     OR
                     @@ user_extend_field_name @@ IS NULL
                   )
                 </@@val:user_extend_flg:0@@>
               )
          </@@hasval:user_extend_flg@@>
          <@@val:title:0@@>
            AND  w2_Order.return_exchange_kbn = '00' -- 交換・返品以外
            AND  w2_Order.order_status NOT IN ('TMP', 'TMP_CNSL', 'ODR_CNSL')  -- 注文ステータス（仮注文、仮注文キャンセル、キャンセル以外）
            AND  w2_Order.subscription_box_course_id = ''
            AND  w2_Order.order_date >= @order_date_from
            AND  w2_Order.order_date <= @order_date_to
            AND  w2_OrderItem.product_id = @product_id  -- 商品ID
            AND  w2_OrderItem.variation_id = @variation_id  -- バリエーションID
            <@@hasval:order_payment_kbn@@>
            -- 決済種別
            AND  w2_Order.order_payment_kbn = @order_payment_kbn
            </@@hasval:order_payment_kbn@@>
            <@@hasval:advcode_like_escaped@@>
            -- 広告コード
            AND  (
                   (
                     w2_Order.advcode_new <> ''
                     AND
                     w2_Order.advcode_new LIKE '%' + @advcode_like_escaped + '%' ESCAPE '#'
                   )
                   OR
                   (
                     w2_Order.advcode_first <> ''
                     AND
                     w2_Order.advcode_first LIKE '%' + @advcode_like_escaped + '%' ESCAPE '#'
                   )
                 )
            </@@hasval:advcode_like_escaped@@>
            <@@hasval:advcode_media_type_id@@>
            -- 広告媒体区分
            AND  EXISTS
                 (
                   SELECT  w2_AdvCode.advertisement_code
                     FROM  w2_AdvCode
                           INNER JOIN w2_AdvCodeMediaType ON
                           (
                             w2_AdvCodeMediaType.advcode_media_type_id = w2_AdvCode.advcode_media_type_id
                           )
                    WHERE  w2_AdvCode.advcode_media_type_id = @advcode_media_type_id
                      AND  (
                             w2_AdvCode.advertisement_code = w2_Order.advcode_first
                             OR
                             w2_AdvCode.advertisement_code = w2_Order.advcode_new
                           )
                 )
            </@@hasval:advcode_media_type_id@@>
          </@@val:title:0@@>
          <@@val:title:1@@>
          AND  w2_FixedPurchase.fixed_purchase_status = '30'  -- 定期購入ステータス（仮登録キャンセル）
          AND  w2_FixedPurchaseItem.product_id = @product_id  -- 商品ID
          AND  w2_FixedPurchaseItem.variation_id = @variation_id  -- バリエーションID
          AND  w2_FixedPurchase.cancel_date >= @order_date_from
          AND  w2_FixedPurchase.cancel_date <= @order_date_to
          </@@val:title:1@@>
      ]]>
    </Statement>
    <Parameter>
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="advcode_media_type_id" Type="nvarchar" Size="30" />
      <Input Name="advcode_like_escaped" Type="nvarchar" Size="60" />
      <Input Name="user_extend_like_escaped" Type="nvarchar" Size="MAX" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_date_from" Type="datetime" />
      <Input Name="order_date_to" Type="datetime" />
      <Input Name="title" Type="int" />
      <Input Name="fixed_purchase_date_from" Type="datetime" />
      <Input Name="fixed_purchase_date_to" Type="datetime" />
    </Parameter>
  </FIXEDPURCHASEREPEATANALYSISLTVREPORT_TARGETLIST_SEARCH_WHERE>

</FixedPurchaseRepeatAnalysis_Sub>
