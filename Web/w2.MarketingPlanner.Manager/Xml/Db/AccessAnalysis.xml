<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : アクセス分析系SQLステートメントXML(AccessAnalysis.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<AccessAnalysis>
  
  <!-- ＰＶ数 -->
  <GetPVs>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                SUM(total_page_views) AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetPVs>

  <!-- アクセスユーザ数 -->
  <GetUserNum>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                SUM(total_users) AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetUserNum>

  <!-- 訪問数（セッション） -->
  <GetSessionNum>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                SUM(total_sessions) AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetSessionNum>

  <!-- 新規訪問数ユーザー数 -->
  <GetNewUserNum>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                SUM(total_new_users) AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetNewUserNum>
  
  <!-- リピート訪問ユーザー数 -->
  <GetRepUserNum>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                SUM(total_users) -  SUM(total_new_users) AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetRepUserNum>

  <!-- １セッションあたりの平均ＰＶ数 -->
  <GetAveragePVSession>
    <Statement>
      <![CDATA[
        SELECT  tgt_year,
                tgt_month,
                tgt_day,
                CASE SUM(total_sessions)
                  WHEN  0 THEN 0
                  ELSE convert(int, SUM(total_page_views) / SUM(total_sessions)) 
                END AS counts
          FROM  w2_DispAccessAnalysis
         WHERE  dept_id = @dept_id
           AND  tgt_year = @tgt_year
           AND  tgt_month = @tgt_month
           AND  (
                  (@report_type = 'all')
                  OR
                  (@report_type = 'pc' AND access_kbn='0')
                  OR
                  (@report_type = 'mobile' AND access_kbn='1')
                  OR
                  (@report_type = 'smart_phone' AND access_kbn='2')
                )
        GROUP BY tgt_year, tgt_month, tgt_day
      ]]>
    </Statement>
    <Parameter>
      <Input Name="dept_id" Type="nvarchar" Size="30" />
      <Input Name="tgt_year" Type="nvarchar" Size="4" />
      <Input Name="tgt_month" Type="nvarchar" Size="2" />
      <Input Name="report_type" Type="nvarchar" Size="11" />
    </Parameter>
  </GetAveragePVSession>
  
</AccessAnalysis>