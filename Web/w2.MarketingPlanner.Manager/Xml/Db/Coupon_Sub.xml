<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : クーポンテーブル系SQLサブステートメントXML (Coupon_Sub.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2017 All Rights Reserved.
=========================================================================================================
-->
<Coupon_Sub>

  <!-- クーポン情報一覧取得用WHERE文 -->
  <COUPON_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  (
                  (@coupon_code_like_escaped = '' OR w2_Coupon.coupon_code LIKE @coupon_code_like_escaped + '%'  ESCAPE '#')      -- クーポンコード
                  AND
                  (@coupon_type = '' OR w2_Coupon.coupon_type = @coupon_type)        -- クーポン種別
                  AND
                  (@coupon_name_like_escaped = '' OR w2_Coupon.coupon_name LIKE '%' + @coupon_name_like_escaped + '%' ESCAPE '#')        -- 管理用クーポン名
                  AND
                  (
                    @publish_date = ''
                    OR
                    (
                      -- 発行期間前
                      (@publish_date = '0' AND w2_Coupon.publish_date_bgn > @current_date)
                      OR
                      -- 発行期間中
                      (@publish_date = '1' AND (w2_Coupon.publish_date_bgn <= @current_date AND @current_date <= w2_Coupon.publish_date_end))
                      OR
                      -- 発行期間後
                      (@publish_date = '2' AND w2_Coupon.publish_date_end < @current_date)
                    )
                  )
                  AND
                  (@valid_flg = '' OR w2_Coupon.valid_flg = @valid_flg)        -- 有効フラグ
                )
           AND  w2_Coupon.dept_id = @dept_id
      ]]>
    </Statement>
  </COUPON_SEARCH_WHERE>

  <!-- クーポン情報一覧取得用ORDER_BY -->
  <COUPON_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN w2_Coupon.date_created
            WHEN  2 THEN w2_Coupon.date_changed
            ELSE NULL
          END
          ASC,
          CASE @sort_kbn
            WHEN  1 THEN w2_Coupon.date_created
            WHEN  3 THEN w2_Coupon.date_changed
            ELSE NULL
          END
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_Coupon.dept_id ASC, w2_Coupon.coupon_id ASC
      ]]>
    </Statement>
  </COUPON_SEARCH_ORDER_BY>

  <!-- ユーザ情報一覧取得用WHERE文 -->
  <USER_SEARCH_WHERE>
    <Statement>
      <![CDATA[
         WHERE  w2_User.user_kbn IN ('PC_USER','MB_USER','SP_USER','OFF_USER')
           AND  (
                  @srch_key = 0 AND w2_User.user_id LIKE @srch_word_like_escaped + '%'  ESCAPE '#'  -- ユーザーID
                  OR
                  @srch_key = 1 AND w2_User.name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 氏名
                  OR
                  @srch_key = 2 AND w2_User.name_kana LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- フリガナ
                  OR
                  @srch_key = 3
                  AND
                  (
                    w2_User.tel1 LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                    OR
                    w2_User.tel1_1 + w2_User.tel1_2 + w2_User.tel1_3 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 電話番号
                    OR
                    w2_User.tel2 LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                    OR
                    w2_User.tel2_1 + w2_User.tel2_2 + w2_User.tel2_3 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- tel2 number
                  )
                  OR
                  @srch_key = 4 AND w2_User.mail_addr LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- メールアドレス
                  OR
                  @srch_key = 4 AND w2_User.mail_addr2 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- モバイルメールアドレス
                  OR
                  @srch_key = 5
                  AND
                  (
                    w2_User.zip LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                    OR
                    w2_User.zip1 + w2_User.zip2 LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 郵便番号
                  )
                  OR
                  @srch_key = 6 AND w2_User.addr LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'      -- 住所
                  OR
                  @srch_key = 7 AND w2_User.company_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 企業名
                  OR
                  @srch_key = 8 AND w2_User.company_post_name LIKE '%' + @srch_word_like_escaped + '%' ESCAPE '#'  -- 部署名
                  OR
                  @srch_key = 9 AND EXISTS(
                    SELECT  *
                      FROM  w2_UserCoupon
                            INNER JOIN w2_Coupon ON
                            (
                              w2_UserCoupon.coupon_id = w2_Coupon.coupon_id
                            )
                     WHERE  w2_User.user_id = w2_UserCoupon.user_id
                       AND  w2_Coupon.coupon_code LIKE @srch_word_like_escaped + '%' ESCAPE '#'
                  )  -- クーポンコード
                  OR
                  @srch_word_like_escaped = ''                                      -- 条件なし
                )
      ]]>
    </Statement>
  </USER_SEARCH_WHERE>

      <!-- ユーザ情報一覧取得用ORDER_BY -->
  <USER_SEARCH_ORDER_BY>
    <Statement>
      <![CDATA[
        ORDER BY
          CASE @sort_kbn
            WHEN  0 THEN w2_User.name
            WHEN  2 THEN w2_User.name_kana
            WHEN  8 THEN w2_User.user_id
            ELSE '1'
          END
          ASC,
          CASE @sort_kbn
            WHEN  4 THEN ISNULL(Unused_Coupon.unused_coupon,0)
            WHEN  6 THEN ISNULL(Used_Coupon.used_coupon,0)
            ELSE  1
          END
          ASC,
          CASE @sort_kbn
            WHEN  1 THEN w2_User.name
            WHEN  3 THEN w2_User.name_kana
            WHEN  9 THEN w2_User.user_id
            ELSE '1'
          END
          DESC,
          CASE @sort_kbn
            WHEN  5 THEN ISNULL(Unused_Coupon.unused_coupon,0)
            WHEN  7 THEN ISNULL(Used_Coupon.used_coupon,0)
            ELSE 1
          END
          DESC,
          -- 常に一定の結果セットを得るため、主キー（昇順）ソート
          w2_User.user_id ASC
      ]]>
    </Statement>
  </USER_SEARCH_ORDER_BY>

</Coupon_Sub>