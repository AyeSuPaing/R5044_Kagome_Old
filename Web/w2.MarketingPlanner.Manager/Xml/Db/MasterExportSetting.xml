<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : マスタ出力定義系SQLステートメントXML(MasterExportSetting.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright W2 Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<MasterExportSetting>

  <!-- マスタ出力定義情報 -->
  <GetMasterExportSetting>
    <Statement>
      <![CDATA[
        SELECT 
            * 
        FROM 
            w2_MasterExportSetting
        WHERE 
            w2_MasterExportSetting.shop_id = @shop_id 
        AND  
            w2_MasterExportSetting.master_kbn = @master_kbn
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
    </Parameter>
  </GetMasterExportSetting>

  <!-- マスタ出力定義情報追加 -->
  <InsertMasterExportSetting>
    <Statement>
      <![CDATA[
        -- 最大設定ID取得

        DECLARE @setting_id nvarchar (10)
        SELECT @setting_id = RIGHT('00' + CONVERT(nvarchar, COUNT(w2_MasterExportSetting.setting_id) + 1), 3) FROM w2_MasterExportSetting WHERE w2_MasterExportSetting.shop_id = @shop_id AND w2_MasterExportSetting.master_kbn = @master_kbn
        
        INSERT 
          w2_MasterExportSetting
          (
            w2_MasterExportSetting.shop_id, 
            w2_MasterExportSetting.master_kbn, 
            w2_MasterExportSetting.setting_id, 
            w2_MasterExportSetting.setting_name, 
            w2_MasterExportSetting.fields, 
            w2_MasterExportSetting.date_created, 
            w2_MasterExportSetting.date_changed, 
            w2_MasterExportSetting.last_changed,
            w2_MasterExportSetting.export_file_type
          ) 
          VALUES
          (
            @shop_id, 
            @master_kbn, 
            @setting_id, 
            @setting_name, 
            @fields, 
            getdate(),
            getdate(), 
            @last_changed,
            @export_file_type
          )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
      <Input Name="setting_name" Type="nvarchar" Size="30" />
      <Input Name="fields" Type="ntext" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="export_file_type" Type="nvarchar" Size="10" />
    </Parameter>
  </InsertMasterExportSetting>

  <!-- マスタ出力定義情報更新 -->
  <UpdateMasterExportSetting>
    <Statement>
      <![CDATA[
        UPDATE 
            w2_MasterExportSetting 
        SET  
            w2_MasterExportSetting.fields = @fields, 
            w2_MasterExportSetting.date_changed = getdate(), 
            w2_MasterExportSetting.last_changed = @last_changed,
            w2_MasterExportSetting.export_file_type = @export_file_type
        WHERE 
            w2_MasterExportSetting.shop_id = @shop_id 
        AND
            w2_MasterExportSetting.master_kbn = @master_kbn
        AND  
            w2_MasterExportSetting.setting_id = @setting_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
      <Input Name="setting_id" Type="nvarchar" Size="10" />
      <Input Name="fields" Type="ntext" />
      <Input Name="last_changed" Type="nvarchar" Size="20" />
      <Input Name="export_file_type" Type="nvarchar" Size="10" />
    </Parameter>
  </UpdateMasterExportSetting>

  <!-- マスター出力設定削除 -->
  <DeleteMasterExportSetting>
    <Statement>
      <![CDATA[
        DELETE  w2_MasterExportSetting
         WHERE  w2_MasterExportSetting.shop_id = @shop_id
           AND  w2_MasterExportSetting.master_kbn = @master_kbn
           AND  w2_MasterExportSetting.setting_id = @setting_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
      <Input Name="setting_id" Type="nvarchar" Size="10" />
    </Parameter>
  </DeleteMasterExportSetting>

  <!-- マスタ出力設定ID更新 -->
  <UpdateMasterExportSettingId>
    <Statement>
      <![CDATA[
        -- 設定IDリフレッシュ
        UPDATE  w2_MasterExportSetting
           SET  w2_MasterExportSetting.setting_id = RIGHT('00' + CONVERT(nvarchar, w2_MasterExportSetting.setting_id -1), 3)
         WHERE  CONVERT(int, w2_MasterExportSetting.setting_id) > CONVERT(int, @setting_id)
           AND  w2_MasterExportSetting.shop_id = @shop_id 
           AND  w2_MasterExportSetting.master_kbn = @master_kbn
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
      <Input Name="setting_id" Type="nvarchar" Size="10" />
    </Parameter>
  </UpdateMasterExportSettingId>

  <!--マスター出力設定名の重複かどうかチェック-->
  <CheckDuplicationMasterSettingName>
    <Statement>
      <![CDATA[
        SELECT  COUNT(w2_MasterExportSetting.master_kbn) AS count
          FROM  w2_MasterExportSetting
         WHERE  w2_MasterExportSetting.shop_id = @shop_id 
           AND  w2_MasterExportSetting.master_kbn = @master_kbn
           AND  w2_MasterExportSetting.setting_name  = @setting_name
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="master_kbn" Type="nvarchar" Size="30" />
      <Input Name="setting_name" Type="nvarchar" Size="30" />
    </Parameter>
  </CheckDuplicationMasterSettingName>

  <!-- アフィリエイト連携ログマスタフィールドチェック -->
  <CheckAffiliateCoopLogFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_AffiliateCoopLog
      ]]>
    </Statement>
  </CheckAffiliateCoopLogFields>

  <!--ターゲットリスト情報マスタフィールドチェック-->
  <CheckTargetListDataFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_TargetListData 
            INNER JOIN w2_User ON
            (
                  w2_TargetListData.user_id = w2_User.user_id
            )
            LEFT JOIN  w2_UserExtend ON
            (
              w2_User.user_id = w2_UserExtend.user_id
            )
            LEFT JOIN w2_UserAttribute ON
            (
              w2_User.user_id = w2_UserAttribute.user_id
            )
            LEFT JOIN w2_AdvCode ON 
            (
              w2_User.advcode_first = w2_advcode.advertisement_code
            )
      ]]>
    </Statement>
  </CheckTargetListDataFields>

  <!--広告コードマスタフィールドチェック-->
  <CheckAdvCodeFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_AdvCode
      ]]>
    </Statement>
  </CheckAdvCodeFields>

  <!--Check AdvCodeMediaType Fields-->
  <CheckAdvCodeMediaTypeFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_AdvCodeMediaType
      ]]>
    </Statement>
  </CheckAdvCodeMediaTypeFields>

  <!--Check UserPointDetail Fields-->
  <CheckUserPointDetailFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_UserPoint
                  LEFT JOIN w2_User ON
                  (
                    w2_UserPoint.user_id = w2_User.user_id
                  )
      ]]>
    </Statement>
  </CheckUserPointDetailFields>

  <!--クーポンマスタフィールドチェック-->
  <CheckCouponFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_Coupon
      ]]>
    </Statement>
  </CheckCouponFields>

  <!--ユーザクーポンマスタフィールドチェック-->
  <CheckUserCouponFields>
    <Statement>
      <![CDATA[
          SELECT  TOP 1
                  @@ fields @@
            FROM  w2_UserCoupon
                  INNER JOIN w2_Coupon ON
                  (
                    w2_UserCoupon.coupon_id = w2_Coupon.coupon_id
                    AND
                    w2_UserCoupon.dept_id = w2_Coupon.dept_id
                  )
      ]]>
    </Statement>
  </CheckUserCouponFields>

  <!-- クーポン利用ユーザー情報フィールドチェック -->
  <CheckCouponUseUserFields>
    <Statement>
      <![CDATA[
        SELECT  TOP 1
                @@ fields @@
          FROM  w2_CouponUseUser
                INNER JOIN w2_Coupon WITH (NOLOCK) ON
                (
                  w2_CouponUseUser.coupon_id = w2_coupon.coupon_id
                )
                LEFT JOIN w2_Order WITH (NOLOCK) ON
                (
                  w2_CouponUseUser.order_id = w2_Order.order_id
                )
                LEFT JOIN w2_User WITH (NOLOCK) ON
                (
                  w2_User.user_id = 
                    CASE @used_user_judge_type
                      WHEN 'MailAddress' THEN w2_Order.user_id
                      WHEN 'UserId' THEN w2_CouponUseUser.coupon_use_user
                    END
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="used_user_judge_type" Type="nvarchar" Size="15" />
    </Parameter>
  </CheckCouponUseUserFields>

</MasterExportSetting>