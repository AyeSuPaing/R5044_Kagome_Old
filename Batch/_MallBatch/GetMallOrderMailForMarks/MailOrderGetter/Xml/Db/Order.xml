<?xml version="1.0" encoding="utf-8" ?>
<!--
=========================================================================================================
  Module      : 注文系SQLステートメントXML(Order.xml)
 ･･･････････････････････････････････････････････････････････････････････････････････････････････････････
  Copyright   : Copyright w2solution Co.,Ltd. 2009 All Rights Reserved.
=========================================================================================================
-->
<Order>

  <!-- 注文登録 -->
  <InsertOrder>
    <Statement>
      <![CDATA[
        INSERT INTO 
                w2_Order
                (
                  order_id,
                  order_group_id,
                  order_no,
                  user_id,
                  shop_id,
                  order_kbn,
                  mall_id,
                  order_payment_kbn,
                  order_status,
                  order_date,
                  order_stockreserved_status,
                  order_shipped_status,
                  order_payment_status,
                  order_item_count,
                  order_product_count,
                  order_price_subtotal,
                  order_price_pack,
                  order_price_tax,
                  order_price_shipping,
                  order_price_exchange,
                  order_price_regulation,
                  order_price_total,
                  card_kbn,
                  card_tran_id,
                  shipping_id,
                  card_instruments,
                  career_id,
                  memo,
                  wrapping_memo,
                  payment_memo,
                  relation_memo,
                  regulation_memo,
                  del_flg,
                  date_created,
                  date_changed,
                  last_changed,
                  order_tax_included_flg,
                  order_tax_rate,
                  order_tax_round_type,
                  order_price_subtotal_tax,
                  shipping_tax_rate,
                  payment_tax_rate,
                  order_count_order
                )
        VALUES  (
                  @order_id,
                  @order_group_id,
                  @order_no,
                  @user_id,
                  @shop_id,
                  @order_kbn,
                  @mall_id,
                  @order_payment_kbn,
                  @order_status,
                  @order_date,
                  '01',
                  '01',
                  '0',
                  @order_item_count,
                  @order_product_count,
                  @order_price_subtotal,
                  @order_price_pack,
                  @order_price_tax,
                  @order_price_shipping,
                  @order_price_exchange,
                  @order_price_regulation,
                  @order_price_total,
                  @card_kbn,
                  @card_tran_id,
                  @shipping_id,
                  @card_instruments,
                  @career_id,
                  @memo,
                  @wrapping_memo,
                  @payment_memo,
                  @relation_memo,
                  @regulation_memo,
                  '0',
                  getdate(),
                  getdate(),
                  'batch',
                  @order_tax_included_flg,
                  @order_tax_rate,
                  @order_tax_round_type,
                  @order_price_subtotal_tax,
                  @shipping_tax_rate,
                  @payment_tax_rate,
                  @order_count_order
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_group_id" Type="nvarchar" Size="30" />
      <Input Name="order_no" Type="nvarchar" Size="30" />
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="order_payment_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="int" />
      <Input Name="order_date" Type="datetime" />
      <Input Name="order_item_count" Type="int" />
      <Input Name="order_product_count" Type="int" />
      <Input Name="order_price_subtotal" Type="decimal" Size="18,3" />
      <Input Name="order_price_pack" Type="decimal" />
      <Input Name="order_price_tax" Type="decimal" Size="18,3" />
      <Input Name="order_price_shipping" Type="decimal" Size="18,3" />
      <Input Name="order_price_exchange" Type="decimal" Size="18,3" />
      <Input Name="order_price_regulation" Type="decimal" Size="18,3" />
      <Input Name="order_price_total" Type="decimal" Size="18,3" />
      <Input Name="card_kbn" Type="nvarchar" Size="30" />
      <Input Name="card_tran_id" Type="nvarchar" Size="100" />
      <Input Name="shipping_id" Type="nvarchar" Size="10" />
      <Input Name="card_instruments" Type="nvarchar" Size="30" />
      <Input Name="career_id" Type="nvarchar" Size="10" />
      <Input Name="memo" Type="nvarchar" Size="MAX" />
      <Input Name="wrapping_memo" Type="nvarchar" Size="MAX" />
      <Input Name="payment_memo" Type="nvarchar" Size="MAX" />
      <Input Name="relation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="regulation_memo" Type="nvarchar" Size="MAX" />
      <Input Name="order_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="order_tax_rate" Type="decimal" />
      <Input Name="order_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="order_price_subtotal_tax" Type="decimal" Size="18,3" />
      <Input Name="shipping_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="payment_tax_rate" Type="decimal" Size="5,2" />
      <Input Name="order_count_order" Type="int" />
    </Parameter>
  </InsertOrder>

  <!-- 注文者登録 -->
  <InsertOrderOwner>
    <Statement>
      <![CDATA[
        INSERT INTO 
                w2_OrderOwner
                (
                  order_id,
                  owner_kbn,
                  owner_name,
                  owner_name1,
                  owner_name2,
                  owner_name_kana,
                  owner_name_kana1,
                  owner_name_kana2,
                  owner_mail_addr,
                  owner_mail_addr2,
                  owner_zip,
                  owner_addr1,
                  owner_addr2,
                  owner_addr3,
                  owner_addr4,
                  owner_tel1,
                  date_created,
                  date_changed
                )
        VALUES  (
                  @order_id,
                  @owner_kbn,
                  @owner_name,
                  @owner_name1,
                  @owner_name2,
                  @owner_name_kana,
                  @owner_name_kana1,
                  @owner_name_kana2,
                  @owner_mail_addr,
                  @owner_mail_addr2,
                  @owner_zip,
                  @owner_addr1,
                  @owner_addr2,
                  @owner_addr3,
                  @owner_addr4,
                  @owner_tel1,
                  getdate(),
                  getdate()
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_name_kana" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="owner_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_mail_addr2" Type="nvarchar" Size="256" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
    </Parameter>
  </InsertOrderOwner>

  <!-- 注文配送先登録 -->
  <InsertOrderShipping>
    <Statement>
      <![CDATA[
        INSERT INTO 
                w2_OrderShipping
                (
                  order_id,
                  order_shipping_no,
                  shipping_name,
                  shipping_name1,
                  shipping_name2,
                  shipping_name_kana,
                  shipping_name_kana1,
                  shipping_name_kana2,
                  shipping_zip,
                  shipping_addr1,
                  shipping_addr2,
                  shipping_addr3,
                  shipping_addr4,
                  shipping_tel1,
                  shipping_date,
                  shipping_time,
                  date_created,
                  date_changed,
                  another_shipping_flg,
                  delivery_company_id,
                  shipping_method,
                  external_shipping_cooperation_id,
                  scheduled_shipping_date
                )
        VALUES  (
                  @order_id,
                  1,
                  @shipping_name,
                  @shipping_name1,
                  @shipping_name2,
                  @shipping_name_kana,
                  @shipping_name_kana1,
                  @shipping_name_kana2,
                  @shipping_zip,
                  @shipping_addr1,
                  @shipping_addr2,
                  @shipping_addr3,
                  @shipping_addr4,
                  @shipping_tel1,
                  @shipping_date,
                  @shipping_time,
                  getdate(),
                  getdate(),
                  @another_shipping_flg,
                  @delivery_company_id,
                  @shipping_method,
                  @external_shipping_cooperation_id,
                  @scheduled_shipping_date
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_name_kana" Type="nvarchar" Size="60" />
      <Input Name="shipping_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="shipping_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="shipping_zip" Type="nvarchar" Size="8" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="shipping_date" Type="datetime" />
      <Input Name="shipping_time" Type="nvarchar" Size="30" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
      <Input Name="delivery_company_id" Type="nvarchar" Size="10" />
      <Input Name="shipping_method" Type="nvarchar" Size="10" />
      <Input Name="external_shipping_cooperation_id" Type="nvarchar" Size="50" />
      <Input Name="scheduled_shipping_date" Type="datetime" />
    </Parameter>
  </InsertOrderShipping>

  <!-- 注文商品登録 -->
  <InsertOrderItem>
    <Statement>
      <![CDATA[
        -- 入力項目以外は、商品マスタから取得
        DECLARE @brand_id nvarchar(30) = ''
        DECLARE @cooperation_id1 nvarchar(30) = ''
        DECLARE @cooperation_id2 nvarchar(30) = ''
        DECLARE @cooperation_id3 nvarchar(30) = ''
        DECLARE @cooperation_id4 nvarchar(30) = ''
        DECLARE @cooperation_id5 nvarchar(30) = ''
        DECLARE @cooperation_id6 nvarchar(50) = ''
        DECLARE @cooperation_id7 nvarchar(50) = ''
        DECLARE @cooperation_id8 nvarchar(50) = ''
        DECLARE @cooperation_id9 nvarchar(50) = ''
        DECLARE @cooperation_id10 nvarchar(50) = ''

        SELECT  @brand_id = brand_id1,
                @cooperation_id1 = variation_cooperation_id1,
                @cooperation_id2 = variation_cooperation_id2,
                @cooperation_id3 = variation_cooperation_id3,
                @cooperation_id4 = variation_cooperation_id4,
                @cooperation_id5 = variation_cooperation_id5,
                @cooperation_id6 = variation_cooperation_id6,
                @cooperation_id7 = variation_cooperation_id7,
                @cooperation_id8 = variation_cooperation_id8,
                @cooperation_id9 = variation_cooperation_id9,
                @cooperation_id10 = variation_cooperation_id10
          FROM  w2_ProductView
         WHERE  w2_ProductView.shop_id = @shop_id
           AND  w2_ProductView.product_id = @product_id
           AND  w2_ProductView.variation_id = @variation_id

        INSERT INTO 
                w2_OrderItem
                (
                  order_id,
                  order_item_no,
                  order_shipping_no,
                  shop_id,
                  product_id,
                  variation_id,
                  product_name,
                  product_price,
                  product_point,
                  product_tax_included_flg,
                  product_tax_rate,
                  product_tax_round_type,
                  product_price_pretax,
                  product_price_ship,
                  item_quantity,
                  item_quantity_single,
                  item_price,
                  item_price_single,
                  item_price_tax,
                  date_created,
                  date_changed,
                  brand_id,
                  cooperation_id1,
                  cooperation_id2,
                  cooperation_id3,
                  cooperation_id4,
                  cooperation_id5,
                  cooperation_id6,
                  cooperation_id7,
                  cooperation_id8,
                  cooperation_id9,
                  cooperation_id10
                )
        VALUES  (
                  @order_id,
                  @order_item_no,
                  1,
                  @shop_id,
                  @product_id,
                  @variation_id,
                  @product_name,
                  @product_price,
                  @product_point,
                  @product_tax_included_flg,
                  @product_tax_rate,
                  @product_tax_round_type,
                  @product_price_pretax,
                  @product_price_ship,
                  @item_quantity,
                  @item_quantity_single,
                  @item_price,
                  @item_price_single,
                  @item_price_tax,
                  getdate(),
                  getdate(),
                  @brand_id,
                  @cooperation_id1,
                  @cooperation_id2,
                  @cooperation_id3,
                  @cooperation_id4,
                  @cooperation_id5,
                  @cooperation_id6,
                  @cooperation_id7,
                  @cooperation_id8,
                  @cooperation_id9,
                  @cooperation_id10
                )
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="order_item_no" Type="int" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
      <Input Name="product_name" Type="nvarchar" Size="200" />
      <Input Name="product_price" Type="decimal" Size="18,3" />
      <Input Name="product_point" Type="float" />
      <Input Name="product_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="product_tax_rate" Type="decimal" />
      <Input Name="product_tax_round_type" Type="nvarchar" Size="20" />
      <Input Name="product_price_pretax" Type="decimal" Size="18,3" />
      <Input Name="product_price_ship" Type="decimal" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="item_quantity_single" Type="int" />
      <Input Name="item_price" Type="decimal" Size="18,3" />
      <Input Name="item_price_single" Type="decimal" Size="18,3" />
      <Input Name="item_price_tax" Type="decimal" Size="18,3" />
    </Parameter>
  </InsertOrderItem>

  <!-- 拡張ステータス更新 -->
  <UpdateOrderExtendStatus>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.@@ extend_status @@ = @extend_status,
                w2_Order.@@ extend_status_date @@ = getdate(),
                w2_Order.last_changed = 'batch',
                w2_Order.date_changed = getdate()
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="extend_status" Type="nvarchar" Size="10" />
    </Parameter>
  </UpdateOrderExtendStatus>

  <!-- 注文者情報の更新 -->
  <UpdateOrderOwner>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderOwner
           SET  w2_OrderOwner.owner_kbn = @owner_kbn,
                w2_OrderOwner.owner_name = @owner_name,
                w2_OrderOwner.owner_name1 = @owner_name1,
                w2_OrderOwner.owner_name2 = @owner_name2,
                w2_OrderOwner.owner_name_kana = @owner_name_kana,
                w2_OrderOwner.owner_name_kana1 = @owner_name_kana1,
                w2_OrderOwner.owner_name_kana2 = @owner_name_kana2,
                w2_OrderOwner.owner_mail_addr = @owner_mail_addr,
                w2_OrderOwner.owner_mail_addr2 = @owner_mail_addr2,
                w2_OrderOwner.owner_zip = @owner_zip,
                w2_OrderOwner.owner_addr1 = @owner_addr1,
                w2_OrderOwner.owner_addr2 = @owner_addr2,
                w2_OrderOwner.owner_addr3 = @owner_addr3,
                w2_OrderOwner.owner_addr4 = @owner_addr4,
                w2_OrderOwner.owner_tel1 = @owner_tel1,
                w2_OrderOwner.owner_sex = @owner_sex,
                w2_OrderOwner.owner_birth = @owner_birth,
                w2_OrderOwner.date_changed = GETDATE()
         WHERE  w2_OrderOwner.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="owner_kbn" Type="nvarchar" Size="10" />
      <Input Name="owner_name" Type="nvarchar" Size="40" />
      <Input Name="owner_name1" Type="nvarchar" Size="20" />
      <Input Name="owner_name2" Type="nvarchar" Size="20" />
      <Input Name="owner_name_kana" Type="nvarchar" Size="60" />
      <Input Name="owner_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="owner_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="owner_mail_addr" Type="nvarchar" Size="256" />
      <Input Name="owner_mail_addr2" Type="nvarchar" Size="256" />
      <Input Name="owner_zip" Type="nvarchar" Size="8" />
      <Input Name="owner_addr1" Type="nvarchar" Size="50" />
      <Input Name="owner_addr2" Type="nvarchar" Size="50" />
      <Input Name="owner_addr3" Type="nvarchar" Size="50" />
      <Input Name="owner_addr4" Type="nvarchar" Size="50" />
      <Input Name="owner_tel1" Type="nvarchar" Size="16" />
      <Input Name="owner_sex" Type="nvarchar" Size="10" />
      <Input Name="owner_birth" Type="datetime" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </UpdateOrderOwner>

  <!-- 注文者情報の更新 -->
  <UpdateOrder>
    <Statement>
      <![CDATA[
        UPDATE  w2_Order
           SET  w2_Order.user_id = @user_id,
                w2_Order.order_kbn = @order_kbn,
                w2_Order.order_status = @order_status
         WHERE  w2_Order.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="user_id" Type="nvarchar" Size="30" />
      <Input Name="order_kbn" Type="nvarchar" Size="10" />
      <Input Name="order_status" Type="nvarchar" Size="30" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
    </Parameter>
  </UpdateOrder>

  <!-- 注文商品情報の更新 -->
  <UpdateOrderItem>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderItem
           SET  w2_OrderItem.product_price = @product_price,
                w2_OrderItem.product_tax_included_flg = @product_tax_included_flg,
                w2_OrderItem.product_price_pretax = @product_price_pretax,
                w2_OrderItem.item_quantity = @item_quantity,
                w2_OrderItem.item_quantity_single = @item_quantity_single,
                w2_OrderItem.item_price = @item_price,
                w2_OrderItem.item_price_single = @item_price_single
         WHERE  w2_OrderItem.order_id = @order_id
           AND  w2_OrderItem.shop_id = @shop_id
           AND  w2_OrderItem.product_id = @product_id
           AND  w2_OrderItem.variation_id = @variation_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="product_price" Type="decimal" Size="18,3" />
      <Input Name="product_tax_included_flg" Type="nvarchar" Size="1" />
      <Input Name="product_price_pretax" Type="decimal" Size="18,3" />
      <Input Name="item_quantity" Type="int" />
      <Input Name="item_quantity_single" Type="int" />
      <Input Name="item_price" Type="decimal" Size="18,3" />
      <Input Name="item_price_single" Type="decimal" Size="18,3" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="shop_id" Type="nvarchar" Size="10" />
      <Input Name="product_id" Type="nvarchar" Size="30" />
      <Input Name="variation_id" Type="nvarchar" Size="60" />
    </Parameter>
  </UpdateOrderItem>

  <!-- 配送先情報の更新 -->
  <UpdateOrderShipping>
    <Statement>
      <![CDATA[
        UPDATE  w2_OrderShipping
           SET  w2_OrderShipping.shipping_name = @shipping_name,
                w2_OrderShipping.shipping_name1 = @shipping_name1,
                w2_OrderShipping.shipping_name2 = @shipping_name2,
                w2_OrderShipping.shipping_name_kana = @shipping_name_kana,
                w2_OrderShipping.shipping_name_kana1 = @shipping_name_kana1,
                w2_OrderShipping.shipping_name_kana2 = @shipping_name_kana2,
                w2_OrderShipping.shipping_zip = @shipping_zip,
                w2_OrderShipping.shipping_addr1 = @shipping_addr1,
                w2_OrderShipping.shipping_addr2 = @shipping_addr2,
                w2_OrderShipping.shipping_addr3 = @shipping_addr3,
                w2_OrderShipping.shipping_addr4 = @shipping_addr4,
                w2_OrderShipping.shipping_tel1 = @shipping_tel1,
                w2_OrderShipping.another_shipping_flg = @another_shipping_flg,
                w2_OrderShipping.date_changed = GETDATE(),
                w2_OrderShipping.external_shipping_cooperation_id = @external_shipping_cooperation_id
         WHERE  w2_OrderShipping.order_id = @order_id
      ]]>
    </Statement>
    <Parameter>
      <Input Name="shipping_name" Type="nvarchar" Size="40" />
      <Input Name="shipping_name1" Type="nvarchar" Size="20" />
      <Input Name="shipping_name2" Type="nvarchar" Size="20" />
      <Input Name="shipping_name_kana" Type="nvarchar" Size="60" />
      <Input Name="shipping_name_kana1" Type="nvarchar" Size="30" />
      <Input Name="shipping_name_kana2" Type="nvarchar" Size="30" />
      <Input Name="shipping_zip" Type="nvarchar" Size="8" />
      <Input Name="shipping_addr1" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr2" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr3" Type="nvarchar" Size="50" />
      <Input Name="shipping_addr4" Type="nvarchar" Size="50" />
      <Input Name="shipping_tel1" Type="nvarchar" Size="16" />
      <Input Name="another_shipping_flg" Type="nvarchar" Size="1" />
      <Input Name="order_id" Type="nvarchar" Size="30" />
      <Input Name="external_shipping_cooperation_id" Type="nvarchar" Size="50" />
    </Parameter>
  </UpdateOrderShipping>

  <!-- 仮注文ステタースの注文一覧取得 -->
  <!-- 楽天仕様：受注を最大5,000件まで取得できますので、一回に5,000件の注文のみ取得 -->
  <GetTempOrderList>
    <Statement>
      <![CDATA[
        SELECT  TOP 5000 w2_Order.order_id
          FROM  w2_Order
         WHERE  w2_Order.order_date >= @order_date
           AND  w2_Order.mall_id = @mall_id
           AND  w2_Order.order_status = 'TMP'
      ]]>
    </Statement>
    <Parameter>
      <Input Name="mall_id" Type="nvarchar" Size="30" />
      <Input Name="order_date" Type="datetime" />
    </Parameter>
  </GetTempOrderList>

</Order>